<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width initial-scale=1.0"><title>ExpressSessionMaster</title><link href="/css/first-style.css" rel="stylesheet"><link rel="shortcut icon" href="/images/favicon.png"><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet"><link href="/css/highlight/googlecode.css" rel="stylesheet" type="text/css"><link href="/css/style.css" rel="stylesheet"><script src="https://code.jquery.com/jquery-1.12.0.min.js"></script><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- Latest compiled and minified CSS --><script src="/js/elven-help.js"></script></head><body><nav class="navbar navbar-inverse"><div class="container"><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/">Elvenware</a></div><div class="navbar-collapse collapse" id="navbar"><ul class="nav navbar-nav"><li class="trigger-collapse" ng-class="{ active: isActive('/')}"><a href="/">Home</a></li><li><a href="/about.html">About</a></li></ul></div></div></nav><div class="container"><figure><img class="elf-normal" alt="Elvenware" src="/images/elvenwarelogo.png"/></figure><h1>ExpressSessionMaster</h1><p>Welcome to ExpressSessionMaster</p><ul><!--TOC_Start--><li><a href="#overview">Overview</a></li>
<li><a href="#background">Background</a></li>
<li><a href="#getting-started">Getting Started</a></li>
<li><a href="#facebook-client-id">Facebook ClientId</a></li>
<li><a href="#passport-generic-code">Passport Generic Code</a></li>
<li><a href="#sessionstore">SessionStore</a></li>
<li><a href="#read-session-data">Read Session Data</a></li>
<li><a href="#sessionstore-fix-hack">SessionStore Fix/Hack</a></li>
<li><a href="#ui-issues">UI Issues</a></li>
<li><a href="#ui-menus">UI Menus</a></li>
<li><a href="#turn-it-in">Turn it in</a></li>
<li><a href="#moving-to-pug-">Moving to PUG?</a></li><!--TOC_End--></ul></div><div class="container"><a class="anchor" id="overview"></a>
<h2>Overview</h2>
<p>The goal of this assignment is to combine Sessions and Sign-In. It allows you to track who is signed into which session and something of what they did while they werer in the session.</p>
<a class="anchor" id="background"></a>
<h2>Background</h2>
<p>There are several ways to track what the user is doing while using a program. On the client side, the following three options are available:</p>
<ul>
<li>Cookies</li>
<li>LocalStorage</li>
<li>sessionStorage</li>
</ul>
<p>On the server, the following are commonly available:</p>
<ul>
<li>Database</li>
<li>Text file containing XML, JSON, CSV or the like</li>
</ul>
<p>There are several advantages to saving on the server side:</p>
<ul>
<li>The data is saver there. A hacker can get a cookie or LocalStorage, but they will have a hard time reaching the server.</li>
<li>The data is more resiliant. Data stored in a database will not disappear if a session is disrupted.</li>
</ul>
<a class="anchor" id="getting-started"></a>
<h2>Getting Started</h2>
<p>Begin by copying your SessionCouch program to SessionMaster.</p>
<pre>cp -r Week09-SessionCouch/ Week10-SessionMaster
cd Week10-SessionMaster/
</pre>
<p>There are several packages which need to be installed:</p>
<pre>npm install passport --save
npm install passport-facebook --save
npm install passport-google-oauth20 --save
npm install passport-twitter --save
</pre>
<p>You will also want to copy in the code for handling passport sign-in:</p>
<pre>cd routes/
cp ../../Week08-Passport/routes/twitter-login.js .
cp ../../Week08-Passport/routes/google-auth.js .
cp ../../Week08-Passport/routes/facebook.js .
cd ..
</pre>
<pre>cd views/
2129  cp ../../Week08-Passport/views/profile-facebook.jade .
2130  cp ../../Week08-Passport/views/profile-twitter.jade .
2131  cp ../../Week08-Passport/views/account.jade profile-google.jade
cd ..
</pre>
<a class="anchor" id="facebook-client-id"></a>
<h2>Facebook ClientId</h2>
<p>Create a script called <strong>setClientId</strong> which you can source in order to load FACEBOOK_CLIENT_ID. The contents of <strong>setClientID</strong> should look a bit like this:</p>
<pre>export FACEBOOK_CLIENT_ID=<YOUR_CLIENT_ID>
export FACEBOOK_CLIENT_SECRET=<YOUR_CLIENT_SECRET>
</pre>
<p>To use it: <strong>source setClientId</strong>.</p>
<p>Check that it worked:</p>
<pre>echo $FACEBOOK_CLIENT_ID
echo $FACEBOOK_CLIENT_SECRET
</pre>
<a class="anchor" id="passport-generic-code"></a>
<h2>Passport Generic Code</h2>
<p>Copy the code from Week08-Passport <strong>index.js</strong> that is Passport specific:</p>
<ul>
<li><a href="http://www.ccalvert.net/books/CloudNotes/Assignments/Passport.html#generic-code">http://www.ccalvert.net/books/CloudNotes/Assignments/Passport.html#generic-code</a></li>
</ul>
<a class="anchor" id="sessionstore"></a>
<h2>SessionStore</h2>
<p>We will use an object called session store to copy the session data into the database.</p>
<p>Use sessionStore to presist your session state. In <strong>Middleware.js</strong> write this code to iniitialize <strong>sessionStore</strong>:</p>
<pre>var sessionStore = sessionstore.createSessionStore({
    type: 'couchdb',
    host: 'http://192.168.2.27', // optional
    port: 5984, // optional
    dbName: 'sessionstore-calvert', // optional
    collectionName: 'sessions', // optional
    timeout: 10000 // optional
}, function(data) {
    console.log('sessionStore callback', data);
});
</pre>
<p>Now modify our session middleware to use the <strong>sessionStore</strong> package as a <strong>store</strong>:</p>
<pre>router.use(session({
    genid: function(req) {
        'use strict';
        console.log('id generated');
        return uuid.v4(); // use UUIDs for session IDs
    },
    key: 'app.sess',
    secret: process.env.SESSION_SECRET || 'keyboard cat',
    resave: true,
    saveUninitialized: true,
    store: sessionStore
}));
</pre>
<a class="anchor" id="read-session-data"></a>
<h2>Read Session Data</h2>
<p>Using our CouchXXX.js files from the <strong>DataMaster</strong>, write code that will allow the user to read from the <strong>sessionStore</strong> database.</p>
<p>This means you will have to add the following views to <strong>couchDesignDocs.js</strong>:</p>
<pre>var elfSessionStore = function(doc) {
  // if the doc **collectionName** property equals **'sessions'** then emit the **doc._id** and the **doc** itself.
};

var elfSessionExpires = function (doc) {
  // if the doc **collectionName** property equals **'sessions'** and **doc.expires exists** then emit the **doc.expires**.
};
</pre>
<p>Now be sure you can get the views by calling a route in <strong>CouchView.js</strong>.</p>
<a class="anchor" id="sessionstore-fix-hack"></a>
<h2>SessionStore Fix/Hack</h2>
<p>In the source for it, open up lib/databases/couchdb and do this:</p>
<pre>set: function (hash, sess, callback) {
  sess.collectionName = this.collectionName;
  if (sess && sess.cookie && sess.cookie.expires) {
    sess.expires = new Date(sess.cookie.expires);
  } else {
    sess.expires = new Date(Date.now() + this.options.ttl * 1000);
  }
  console.log('couchStore', sess);        <===== HERE
  if (sess.elfStoreData === false) {      <===== HERE
      callback(null)                      <===== HERE
      return;                             <===== HERE
  }                                       <===== HERE
  this.db.save(hash, sess._rev, sess, function(err) {
    console.log('actually saved');    
    if (err && err.error === 'conflict' && err.reason.indexOf('update conflict') >= 0) {
      return callback(new Error('ConcurrencyError: Session was updated by someone else!'));
    }
    callback(err);
  });
},
</pre>
<a class="anchor" id="ui-issues"></a>
<h2>UI Issues</h2>
<p>We have too many buttons and controls on the main page. Use jQuery to hide and expose DIVs so that you can focus on one area at a time. I created the following IDs:</p>
<ul>
<li>.panel.panel-default#basics-page</li>
<li>.panel.panel-default#database-page</li>
<li>.panel.panel-default#authentication-page</li>
</ul>
<p>The user should be able to toggle these properties at will.</p>
<p>Here we are showing only the basics options:</p>
<p><img src="https://s3.amazonaws.com/bucket01.elvenware.com/images/express-session-master-basics.png" alt="basics"></p>
<p><img src="https://s3.amazonaws.com/bucket01.elvenware.com/images/express-session-master-database.png" alt="database"></p>
<p><img src="https://s3.amazonaws.com/bucket01.elvenware.com/images/express-session-master-authentication.png" alt="authentication"></p>
<a class="anchor" id="ui-menus"></a>
<h2>UI Menus</h2>
<p>First learn about mixins by completing the mixins assignment. Then, using mixins, add menus to your app.</p>
<p>Also, change the behavior of the pages so that if you select one menu item, the UI for that feature is visible but the UI for the other features is hidden. For instance, if you select Basics, then the Databases and Authentication pages disappear.</p>
<p><img src="https://s3.amazonaws.com/bucket01.elvenware.com/images/express-session-master-menu.png" alt="menu"></p>
<p><img src="https://s3.amazonaws.com/bucket01.elvenware.com/images/express-session-master-mobile.png" alt="mobile"></p>
<p>The following mixin can be used:</p>
<pre>mixin littleMenu
    nav.navbar.navbar-default.navbar-fixed-top
        .container-fluid
            // Brand
            .navbar-header
                button.navbar-toggle.collapsed(type='button',
                        data-toggle='collapse',
                        data-target='#bs-example-navbar-collapse-1',
                        aria-expanded='false')
                    span.sr-only Toggle navigation
                    span.icon-bar
                    span.icon-bar
                    span.icon-bar

                a.navbar-brand(href='/')
                    img(alt='Elvenware', src='favicon.png')
            // Nav Links
            #bs-example-navbar-collapse-1.collapse.navbar-collapse
                ul.nav.navbar-nav
                    li#basics-menu
                        a.togglePageClick(href='/basics-page')
                            | Basics
                            span.sr-only (current)
                    li#database-menu
                        a.togglePageClick(href="/database-page") Database
                    li#authentication-menu
                        a.togglePageClick(href="/authentication-page") Authentication
</pre>
<a class="anchor" id="turn-it-in"></a>
<h2>Turn it in</h2>
<p>Push your work and submit your assignment.</p>
<a class="anchor" id="moving-to-pug-"></a>
<h2>Moving to PUG?</h2>
<p>If you want to move from Jade to Pug, here are the steps:</p>
<pre>npm install pug --save
npm uninstall jade --save
</pre>
<p>In <strong>app.js</strong> change the single instance of the word <strong>jade</strong> to <strong>pug</strong>.</p>
<p>In the <strong>views</strong> directory, change all files with the extensions <strong>jade</strong> to have the extension <strong>pug</strong>. This script should do the work for you:</p>
<pre>#! /bin/bash

for file in *.jade
do
  git mv "$file" "${file%.jade}.pug"
done
</pre>
<p>Or this:</p>
<pre>ln -s ~/Git/JsObjects/Utilities/NodeInstall/JadeToPug ~/bin/JadeToPug
</pre>
<p>Then run <strong>JadeToPub</strong> in your <strong>views directory</strong>.</p>
</div></body></html>