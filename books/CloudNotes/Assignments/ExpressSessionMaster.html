<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width initial-scale=1.0"><title>ExpressSessionMaster</title><link rel="shortcut icon" href="/charlie/images/favicon.png"><!-- Latest compiled and minified CSS--><link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap.min.css"><!-- Optional theme--><link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap-theme.min.css"><!-- link(href='/libs/css/BootstrapIndex.css', rel='stylesheet', type='text/css')--><link href="/css/style.css" rel="stylesheet" type="text/css"><link href="/css/highlight/googlecode.css" rel="stylesheet" type="text/css"><script src="/components/jquery/dist/jquery.js"></script><script src="/components/angular/angular.js"></script><script src="/components/angular-route/angular-route.js"></script><script src="/components/bootstrap/dist/js/bootstrap.min.js"></script><!-- script(src='/libs/scripts/elvenware.js', type='text/javascript')--><script src="/libs/scripts/Control.js"></script><!-- script(src='http://localhost:35729/livereload.js')--></head><body><div class="navbar navbar-inverse"><div class="container"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target=".navbar-collapse" class="navbar-toggle"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">Elvenware</a></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li class="active"><a href="/index.html">Home</a></li><li><a href="/charlie/About.html">About</a></li><li class="dropdown"><a href="#/" data-toggle="dropdown" class="dropdown-toggle">Dropdown<b class="caret"></b></a><ul class="dropdown-menu"><li class="dropdown-header">Core Code</li><li><a href="/charlie/development/index.html">Strongly Typed</a></li><li><a href="/charlie/development/web/index.html">Web & Scripts</a></li><li><a href="/charlie/development/cloud/index.shtml">Cloud</a></li><li class="divider"></li><li class="dropdown-header">OS and Tools</li><li><a href="/os/index.html">OS</a></li><li><a href="/charlie/development/database/index.html">Database</a></li><li><a href="/books/index.html">My Writing</a></li><li class="divider"></li><li class="dropdown-header">Art</li><li><a href="/charlie/Art/index.html">Poems & Photos</a></li><li><a href="/books/reading/index.html">Book Reviews</a></li><li><a href="/spirit/index.html">Spiritual</a></li><li class="divider"></li><li class="dropdown-header">Links</li><li><a href="/charlie/links.html">My Links</a></li><li><a href="http://www.github.com/charliecalvert">GitHub</a></li><li><a href="http://sourceforge.net/projects/elvenware/">Sourceforge</a></li></ul></li></ul></div><!-- /.nav-collapse--></div></div><div class="container"><figure><img alt="Elvenware" src="/charlie/images/elvenwarelogo.png"/></figure><h1>ExpressSessionMaster</h1><h3>Table of Contents</h3><ul><!--TOC_Start--><li><a href="#overview">Overview</a></li>
<li><a href="#background">Background</a></li>
<li><a href="#getting-started">Getting Started</a></li>
<li><a href="#passport-generic-code">Passport Generic Code</a></li>
<li><a href="#sessionstore">SessionStore</a></li>
<li><a href="#read-session-data">Read Session Data</a></li>
<li><a href="#sessionstore-fix-hack">SessionStore Fix/Hack</a></li>
<li><a href="#ui-issues">UI Issues</a></li>
<li><a href="#ui-menus">UI Menus</a></li>
<li><a href="#turn-it-in">Turn it in</a></li><!--TOC_End--></ul><h2 id="overview">Overview</h2>
<p>The goal of this assignment is to combine Sessions and Sign-In. It allows you to track who is signed into which session and something of what they did while they werer in the session.</p>
<h2 id="background">Background</h2>
<p>There are several ways to track what the user is doing while using a program. On the client side, the following three options are available:</p>
<ul>
<li>Cookies</li>
<li>LocalStorage</li>
<li>sessionStorage</li>
</ul>
<p>On the server, the following are commonly available:</p>
<ul>
<li>Database</li>
<li>Text file containing XML, JSON, CSV or the like</li>
</ul>
<p>There are several advantages to saving on the server side:</p>
<ul>
<li>The data is saver there. A hacker can get a cookie or LocalStorage, but they will have a hard time reaching the server.</li>
<li>The data is more resiliant. Data stored in a database will not disappear if a session is disrupted.</li>
</ul>
<h2 id="getting-started">Getting Started</h2>
<p>Begin by copying your SessionCouch program to SessionMaster.</p>
<pre><code class="lang-bash"><span class="hljs-keyword">cp</span> -<span class="hljs-keyword">r</span> Week09-SessionCouch/ Week10-SessionMaster
<span class="hljs-keyword">cd</span> Week10-SessionMaster/
</code></pre>
<p>There are several packages which need to be installed:</p>
<pre><code class="lang-bash"><span class="hljs-title">npm</span> install pass<span class="hljs-keyword">port</span> <span class="hljs-comment">--save</span>
<span class="hljs-title">npm</span> install pass<span class="hljs-keyword">port</span>-facebook <span class="hljs-comment">--save</span>
<span class="hljs-title">npm</span> install pass<span class="hljs-keyword">port</span>-google-oauth20 <span class="hljs-comment">--save</span>
<span class="hljs-title">npm</span> install pass<span class="hljs-keyword">port</span>-twitter <span class="hljs-comment">--save</span>
</code></pre>
<p>You will also want to copy in the code for handling passport sign-in:</p>
<pre><code class="lang-bash">cd routes/
cp ..<span class="hljs-regexp">/../</span>Week08-Passport<span class="hljs-regexp">/routes/</span>twitter-login.js .
cp ..<span class="hljs-regexp">/../</span>Week08-Passport<span class="hljs-regexp">/routes/</span>google-auth.js .
cp ..<span class="hljs-regexp">/../</span>Week08-Passport<span class="hljs-regexp">/routes/</span>facebook.js .
cd ..
</code></pre>
<pre><code class="lang-bash">cd views/
<span class="hljs-number">2129</span>  cp ../../Week08-Passport/views/profile-facebook<span class="hljs-selector-class">.jade</span> .
<span class="hljs-number">2130</span>  cp ../../Week08-Passport/views/profile-twitter<span class="hljs-selector-class">.jade</span> .
<span class="hljs-number">2131</span>  cp ../../Week08-Passport/views/account<span class="hljs-selector-class">.jade</span> profile-google<span class="hljs-selector-class">.jade</span>
cd ..
</code></pre>
<p>Create a script which you can source in order to load the FAMake sure you have facebook CLIENT_ID loaded:</p>
<p>echo $FACEBOOK_CLIENT_ID</p>
<h2 id="passport-generic-code">Passport Generic Code</h2>
<p>Copy the code from Week08-Passport <strong>index.js</strong> that is Passport specific:</p>
<ul>
<li><a href="http://www.ccalvert.net/books/CloudNotes/Assignments/Passport.html#generic-code">http://www.ccalvert.net/books/CloudNotes/Assignments/Passport.html#generic-code</a></li>
</ul>
<h2 id="sessionstore">SessionStore</h2>
<p>We will use an object called session store to copy the session data into the database.</p>
<p>Use sessionStore to presist your session state. In <strong>Middleware.js</strong> write this code to iniitialize <strong>sessionStore</strong>:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> sessionStore = sessionstore.createSessionStore({
    type: <span class="hljs-string">'couchdb'</span>,
    host: <span class="hljs-string">'http://192.168.2.27'</span>, <span class="hljs-comment">// optional</span>
    port: <span class="hljs-number">5984</span>, <span class="hljs-comment">// optional</span>
    dbName: <span class="hljs-string">'sessionstore-calvert'</span>, <span class="hljs-comment">// optional</span>
    collectionName: <span class="hljs-string">'sessions'</span>, <span class="hljs-comment">// optional</span>
    timeout: <span class="hljs-number">10000</span> <span class="hljs-comment">// optional</span>
}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'sessionStore callback'</span>, data);
});
</code></pre>
<p>Now modify our session middleware to use the <strong>sessionStore</strong> package as a <strong>store</strong>:</p>
<pre><code class="lang-javascript">router.use(session({
    genid: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req</span>) </span>{
<span class="hljs-meta">        'use strict'</span>;
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'id generated'</span>);
        <span class="hljs-keyword">return</span> uuid.v4(); <span class="hljs-comment">// use UUIDs for session IDs</span>
    },
    key: <span class="hljs-string">'app.sess'</span>,
    secret: process.env.SESSION_SECRET || <span class="hljs-string">'keyboard cat'</span>,
    resave: <span class="hljs-literal">true</span>,
    saveUninitialized: <span class="hljs-literal">true</span>,
    store: sessionStore
}));
</code></pre>
<h2 id="read-session-data">Read Session Data</h2>
<p>Using our CouchXXX.js files from the <strong>DataMaster</strong>, write code that will allow the user to read from the <strong>sessionStore</strong> database.</p>
<p>This means you will have to add the following views to <strong>couchDesignDocs.js</strong>:</p>
<pre><code class="lang-javascript">var elfSessionStore = function(doc) {
  // if the doc <span class="hljs-keyword">*</span><span class="hljs-keyword">*</span>collectionName<span class="hljs-keyword">*</span><span class="hljs-keyword">*</span> property equals <span class="hljs-keyword">*</span><span class="hljs-keyword">*</span>'sessions'<span class="hljs-keyword">*</span><span class="hljs-keyword">*</span> then emit the <span class="hljs-keyword">*</span><span class="hljs-keyword">*</span>doc._id<span class="hljs-keyword">*</span><span class="hljs-keyword">*</span> and the <span class="hljs-keyword">*</span><span class="hljs-keyword">*</span>doc<span class="hljs-keyword">*</span><span class="hljs-keyword">*</span> itself.
};

var elfSessionExpires = function (doc) {
  // if the doc <span class="hljs-keyword">*</span><span class="hljs-keyword">*</span>collectionName<span class="hljs-keyword">*</span><span class="hljs-keyword">*</span> property equals <span class="hljs-keyword">*</span><span class="hljs-keyword">*</span>'sessions'<span class="hljs-keyword">*</span><span class="hljs-keyword">*</span> and <span class="hljs-keyword">*</span><span class="hljs-keyword">*</span>doc.expires exists<span class="hljs-keyword">*</span><span class="hljs-keyword">*</span> then emit the <span class="hljs-keyword">*</span><span class="hljs-keyword">*</span>doc.expires<span class="hljs-keyword">*</span><span class="hljs-keyword">*</span>.
};
</code></pre>
<p>Now be sure you can get the views by calling a route in <strong>CouchView.js</strong>.</p>
<h2 id="sessionstore-fix-hack">SessionStore Fix/Hack</h2>
<p>In the source for it, open up lib/databases/couchdb and do this:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">set</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">hash, sess, callback</span>) </span>{
  sess.collectionName = <span class="hljs-keyword">this</span>.collectionName;
  <span class="hljs-keyword">if</span> (sess &amp;&amp; sess.cookie &amp;&amp; sess.cookie.expires) {
    sess.expires = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(sess.cookie.expires);
  } <span class="hljs-keyword">else</span> {
    sess.expires = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-built_in">Date</span>.now() + <span class="hljs-keyword">this</span>.options.ttl * <span class="hljs-number">1000</span>);
  }
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'couchStore'</span>, sess);        &lt;===== HERE
  <span class="hljs-keyword">if</span> (sess.elfStoreData === <span class="hljs-literal">false</span>) {      &lt;===== HERE
      callback(<span class="hljs-literal">null</span>)                      &lt;===== HERE
      <span class="hljs-keyword">return</span>;                             &lt;===== HERE
  }                                       &lt;===== HERE
  <span class="hljs-keyword">this</span>.db.save(hash, sess._rev, sess, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'actually saved'</span>);    
    <span class="hljs-keyword">if</span> (err &amp;&amp; err.error === <span class="hljs-string">'conflict'</span> &amp;&amp; err.reason.indexOf(<span class="hljs-string">'update conflict'</span>) &gt;= <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'ConcurrencyError: Session was updated by someone else!'</span>));
    }
    callback(err);
  });
},
</code></pre>
<h2 id="ui-issues">UI Issues</h2>
<p>We have too many buttons and controls on the main page. Use jQuery to hide and expose DIVs so that you can focus on one area at a time. I created the following IDs:</p>
<ul>
<li>.panel.panel-default#basics-page</li>
<li>.panel.panel-default#database-page</li>
<li>.panel.panel-default#authentication-page</li>
</ul>
<p>The user should be able to toggle these properties at will.</p>
<p>Here we are showing only the basics options:</p>
<p><img src="https://s3.amazonaws.com/bucket01.elvenware.com/images/express-session-master-basics.png" alt="basics"></p>
<p><img src="https://s3.amazonaws.com/bucket01.elvenware.com/images/express-session-master-database.png" alt="database"></p>
<p><img src="https://s3.amazonaws.com/bucket01.elvenware.com/images/express-session-master-authentication.png" alt="authentication"></p>
<h2 id="ui-menus">UI Menus</h2>
<p>First learn about mixins by completing the mixins assignment. Then, using mixins, add menus to your app.</p>
<p>Also, change the behavior of the pages so that if you select one menu item, the UI for that feature is visible but the UI for the other features is hidden. For instance, if you select Basics, then the Databases and Authentication pages disappear.</p>
<p><img src="https://s3.amazonaws.com/bucket01.elvenware.com/images/express-session-master-menu.png" alt="menu"></p>
<p><img src="https://s3.amazonaws.com/bucket01.elvenware.com/images/express-session-master-mobile.png" alt="mobile"></p>
<h2 id="turn-it-in">Turn it in</h2>
<p>Push your work and submit your assignment.</p>
</div></body></html>