<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width initial-scale=1.0"><title>BridgePattern03</title><link href="/css/first-style.css" rel="stylesheet"><link rel="shortcut icon" href="/images/favicon.png"><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet"><link href="/css/highlight/googlecode.css" rel="stylesheet" type="text/css"><link href="/css/style.css" rel="stylesheet"><script src="https://code.jquery.com/jquery-1.12.0.min.js"></script><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- Latest compiled and minified CSS --><script src="/js/elven-help.js"></script></head><body><nav class="navbar navbar-inverse"><div class="container"><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/">Elvenware</a></div><div class="navbar-collapse collapse" id="navbar"><ul class="nav navbar-nav"><li class="trigger-collapse" ng-class="{ active: isActive('/')}"><a href="/">Home</a></li><li><a href="/about.html">About</a></li></ul></div></div></nav><div class="container"><figure><img class="elf-normal" alt="Elvenware" src="/images/elvenwarelogo.png"/></figure><h1>BridgePattern03</h1><p>Welcome to BridgePattern03</p><ul><!--TOC_Start--><li><a href="#some-steps">Some Steps</a></li>
<li><a href="#borrow-what-you-can">Borrow what you Can</a></li>
<li><a href="#create-or-borrow-a-control-class">Create or Borrow a Control Class</a></li>
<li><a href="#launch-the-markdown-editor">Launch the Markdown Editor</a></li>
<li><a href="#data-and-pages">Data and Pages</a></li>
<li><a href="#session-support">Session Support</a></li><!--TOC_End--></ul></div><div class="container"><p>#Bridge Pattern 03</p>
<p>Here is an overview of the assignment:</p>
<ul>
<li>Start with the BridgePattern 02 assignment</li>
<li>Add a new page that contains a markdown editor</li>
<li>The user will be able to:<ul>
<li>Save the markdown to MongoDb</li>
<li>Save the HTML to disk</li>
<li>Display the HTML on a GitHub page.</li>
</ul>
</li>
</ul>
<p>##Creating your GitHub Page</p>
<p>Set up your github pages as described here:</p>
<ul>
<li><a href="https://pages.github.com/">GitHub Pages</a></li>
<li>create a repository called: <strong>username</strong>.github.io</li>
<li>Example <a href="http://charliecalvert.github.io/">http://<strong>charliecalvert</strong>.github.io/</a></li>
<li>Clone the repository: git clone git@github.com:<strong>username</strong>/<strong>username</strong>.github.io.git</li>
<li>Create an index.html page and push it:</li>
</ul>
<pre><!DOCTYPE html>

<html>
    <head>
        <title>Charlie on Github</title>
    </head>
    <body>
        <h1>Charlie on Github</h1>
        <p>Let's get started</p>
    </body>
</html>
</pre>
<p>##Displaying Markdown Files</p>
<p>For now your filelist should contain at least two markdown files:</p>
<pre>{
    "type": "fileList",
    "content": {
        "President01.json": "/home/charlie/Documents/Data/Presidents01.json",
        "President02.json": "/home/charlie/Documents/Data/Presidents02.json",
        "President03.md": "/home/charlie/Documents/Data/Presidents03.md",
        "President04.md": "/home/charlie/Documents/Data/Presidents04.md"
    }
}
</pre>
<p>If the user selects a markdown file, then retrieve it from disk and display it in a page that contains your markdown editor. </p>
<p>The code for displaying the markdown editor page and initializing the object that creates can be exactly the same as in the midterm, but I want you to start using the bridge pattern as well as the factory pattern. This means that the following call should place text into the <strong>input</strong> control in the markdown editor:</p>
<pre>myBridge.loadFile(fileName);
</pre>
<p>Typically the <strong>markdownReader.loadFile</strong> method calls the display method in its callback.    </p>
<p>##Saving Files</p>
<p>Suppose the user choose to edit Presidents04.md. When the user clicks the save button in the markdown editor:</p>
<ul>
<li>Save a new copy of /home/charlie/Documents/Data/Presidents04.md</li>
<li>In your gitHub page directory, save Presidents04.html. You got it by calling <strong>converter.makeHtml(saveMarkdown);</strong></li>
<li>Save the markdown into MongoDb.</li>
</ul>
<p>##MongoDb</p>
<p>For now, the JSON you save to MongoDb should look like this:</p>
<pre>{
    "FileName": fileName,
    "Path" path,
    "markdown": markdown
}
</pre>
<p>Ultimately, we will probably replace or generate FileList.json from these records in the database. So you should see a parallel between these records and the information in <strong>FileList.json</strong>. The big difference, of course, is that the JSON contains a copy of the markdown, rather than just pointing to it. </p>
<a class="anchor" id="some-steps"></a>
<h2>Some Steps</h2>
<p>There are many ways to finish this assignment. You could build off your BridgePattern02 assignment, off of BridgeSailor from JsObjects/Design, from the midterm, or start from scratch. I&#39;ll show how to start from scratch, and hopefully you can pick and choose from what I show depending on your needs.</p>
<p>Create a new project:</p>
<pre>express JsonMarkdown
cd JsonMarkdown
npm install
</pre>
<p>Create a dot project file and sets it name:</p>
<pre><?xml version="1.0" encoding="UTF-8"?>
<projectDescription>
    <name>JsonMarkdown-Calvert</name>
    <comment></comment>
    <projects>
    </projects>
    <buildSpec>
        <buildCommand>
            <name>com.aptana.ide.core.unifiedBuilder</name>
            <arguments>
            </arguments>
        </buildCommand>
    </buildSpec>
    <natures>
        <nature>com.aptana.projects.webnature</nature>
    </natures>
</projectDescription>
</pre>
<p>Open up the project in Eclipse or your favorite editor. (In Eclipse, you use <strong>File | Import</strong>, and then <strong>General | Existing Projects into Workspace</strong>.</p>
<p>Set the port:</p>
<pre>app.set('port', process.env.PORT || 30025);
</pre>
<a class="anchor" id="borrow-what-you-can"></a>
<h2>Borrow what you Can</h2>
<p>From your Week08InClassMarkdown (exact name?) project, take:</p>
<pre>/public/javascripts/Markdown // The whole directory
/public/javascripts/jquery.js // Which ever version you used
/public/javascripts/require.js
/public/javascripts/Main.js
/public/stylesheets/markdown.css
/public/wmd-buttons.png
/views/layout.jade
</pre>
<p>Layout looks like this:</p>
<pre>doctype html
html
  head
    title= title
    link(rel='stylesheet', href='/stylesheets/style.css')
    script(src="javascripts/require.js" data-main="javascripts/Main")
  body
    block content
</pre>
<p>Get MarkShow.js and PagedownSetup.js. </p>
<a class="anchor" id="create-or-borrow-a-control-class"></a>
<h2>Create or Borrow a Control Class</h2>
<p>Put in <strong>/public/javascripts</strong></p>
<pre>define(function() {

    var Control = (function() {

        function Control() {

        }

        return Control;
    }());

    return Control;

});
</pre>
<p>Modify your <strong>Main.js</strong> to load <strong>Control.js</strong> instead of Markshow:</p>
<pre>require.config({
    paths: {
        "jquery": "jquery-2.1.1",
        "Markdown": "Markdown/Converter",
        "Editor": "Markdown/Editor"
    }
});

require(['jquery', "Control"], function(jq, Control) {
    'use strict';
    console.log("Main called");

    var showMark = new Control();
});
</pre>
<p>This is a good time to make sure you can get things up and running. Load your program in Chrome. Press up F12 to bring up the Developer Tools. Turn to the Networking page. You should be able to see:</p>
<ul>
<li>localhost </li>
<li>style.css </li>
<li>markdown.css </li>
<li>require.js </li>
<li>Main.js </li>
<li>jquery*.js</li>
<li>Control.js</li>
</ul>
<p>I don&#39;t see the bitmap loading. Is that just because it doesn&#39;t like me or because we aren&#39;t using it yet? I&#39;ll come back to this.</p>
<p>##Create New Routes</p>
<p>Create your new route:</p>
<pre>/routes/Markdown.js
/views/Markdown.jade
</pre>
<p>Markdown.jade will at least start like this:</p>
<p>extends layout</p>
<pre>block content
link(rel='stylesheet', href='/stylesheets/markdown.css')

  h1= title
  p Welcome to #{title}

  div#markdown.clearfix
    div.wmd-panel
      div#wmd-button-bar-elf
      textarea.wmd-input#wmd-input-elf

    div#wmd-preview-elf.wmd-panel.wmd-preview
</pre>
<p><strong>Markdown.js</strong> can be almost identical to the default <strong>index.js</strong>, but it should contain a line like this:</p>
<pre>  res.render('Markdown', { title: 'Markdown' });
</pre>
<p>The same thing is done in the <a href="http://elvenware.com/charlie/books/CloudNotes/Assignments/Prog282Midterm2014.html#add-a-new-page">midterm</a> when you add a <a href="http://elvenware.com/charlie/books/CloudNotes/Assignments/Prog282Midterm2014.html#add-a-new-page">NewPage</a>, so base your work on that. But instead of readering a NewPage, render the markdown, as shown above. Also add the appropriate <strong>require</strong> and <strong>app.use</strong> statements to <strong>app.js</strong>, as explained in the same section of the <a href="http://elvenware.com/charlie/books/CloudNotes/Assignments/Prog282Midterm2014.html#add-a-new-page">midterm</a>. </p>
<a class="anchor" id="launch-the-markdown-editor"></a>
<h2>Launch the Markdown Editor</h2>
<p>Define two buttons in <strong>index.jade</strong>:</p>
<p>  button#showJson Show Json
  button#showMarkdown Show Markdown</p>
<p>Edit <strong>Control.js</strong> to Respond to clicks on the <strong>markdown</strong> button.</p>
<pre>define(function(requre) {

    var Control = (function() {

        function Control() {
            $("#showMarkdown").click(showMarkdown);
        }


        var showMarkdown = function() {
            window.location.href = '/Markdown';
        };

        return Control;
    }());

    return Control;

});
</pre>
<p>When you page load, everything looks fine, but the controls are not initialized. MarkShow is crucial to us, because it initializes our markdown editor with code that begins like this:</p>
<pre>var pagedownSetup = new PagedownSetup();
converter = pagedownSetup.setupConverter(Markdown);
</pre>
<p>So we have to load <strong>MarkShow</strong> and we have to do it after the new page is loaded. The question is when and where?</p>
<p>We could place a button on the <strong>markDown</strong> Jade page:</p>
<pre>button#editLoad Edit Load
</pre>
<p>We would then respond to button clicks in order to initialize the editor:</p>
<pre>define(["MarkShow"], function(MarkShow) {

    var Control = (function() {

        function Control() {
            $("#showMarkdown").click(showMarkdown);
            $("#editLoad").click(editLoad); // Clicks on the MarkDown page.
        }

        var showMarkdown = function() {            
            window.location.href = '/Markdown';
        };

        var editLoad = function() {
            var markShow = new MarkShow();
        }

        return Control;
    }());

    return Control;

});
</pre>
<p>The problem with this approach is that it forces the user to perform an extra button click. A better approach is to restore Control.js to the state we were in before our experiment:</p>
<pre>define(function(requre) {

    var Control = (function() {

        function Control() {
            $("#showMarkdown").click(showMarkdown);
        }

        var showMarkdown = function() {            
            window.location.href = '/Markdown';
        };

        return Control;
    }());

    return Control;

});
</pre>
<p>You will also want to remove the button from Markdown.jade.</p>
<p>Now edit <strong>Main.js</strong> to behave one way when the main page is loaded, and another way when the Markdown page is loaded:</p>
<pre>require(['jquery', "Control", "MarkShow"], function(jq, Control, MarkShow) {
    'use strict';
    console.log("Main called");

    $(document).ready(function() {

        if (document.URL === "http://localhost:30025/Markdown") {
            var showMark = new MarkShow();
        } else {
            var control = new Control();
        }
    })
});
</pre>
<p>The key line is this one:</p>
<pre>if (document.URL === "http://localhost:30025/Markdown") {
</pre>
<p>This tests if we are loading <a href="http://localhost:30025">http://localhost:30025</a> or <a href="http://localhost:30025/Markdown">http://localhost:30025/Markdown</a>. Obviously this won&#39;t work in a production environment. This should do the same thing, but work anywhere, even if it is a bit more difficult to read:</p>
<pre>function endsWith(value, suffix) {
    return value.indexOf(suffix, this.length - suffix.length) !== -1;
}

require([ 'jquery', "Control", "MarkShow" ], function(jq, Control, MarkShow) {
    'use strict';
    console.log("Main called");

    $(document).ready(function() {

        if (endsWith(document.URL, "Markdown")) {
            var showMark = new MarkShow();
        } else {
            var control = new Control();
        }
    })
});
</pre>
<p>Ultimately, I believe it makes more sense to simply insert the appropriate HTML into our current page rather than load an entirely new page. However, we&#39;ll do that later. Or you can do it now if you want.</p>
<a class="anchor" id="data-and-pages"></a>
<h2>Data and Pages</h2>
<p>When we load the /Markdown page our data gets refreshed. So how do we keep track of the data selected by the user? There are several ways to do this. Here&#39;s what we&#39;ll do for now:</p>
<p>Let&#39;s start by adding some new methods to <strong>routes/index.js</strong>:</p>
<pre>var express = require('express');
var router = express.Router();
var pick = "";

/* GET home page. */
router.get('/', function(req, res) {
  res.render('index', { title: 'Express' });
});

router.get('/setPick', function(request, response) {
    pick = request.query.pick;
    response.send({"result": "success"})
});

router.get('/getPick', function(request, response) {
    console.log("GetPick: " + pick);    
    response.send({"userPick": pick})
});

module.exports = router;
</pre>
<p>In Control update <strong>showMarkdown</strong>:</p>
<pre>var showMarkdown = function() {
    $.getJSON('/setPick', {pick: "SomeFileNameOrPath"}, function(result){
        if (result.result !== "success") {
            throw "Error";
        }
        window.location.href = '/Markdown';
    });
};
</pre>
<p>In MarkShow, create a method to get the user&#39;s pick:</p>
<pre>MarkShow.prototype.getPick = function(event) {
    $.getJSON('/getPick', function(result) {
        inputText.html((result.userPick));
    });
}
</pre>
<p>In Main call <strong>MarkShow.getPick</strong>:</p>
<pre>require([ 'jquery', "Control", "MarkShow" ], function(jq, Control, MarkShow) {
    'use strict';
    console.log("Main called");

    $(document).ready(function() {

        if (endsWith(document.URL, "Markdown")) {
            var showMark = new MarkShow();
            showMark.getPick();
        } else {            
            var control = new Control();
        }
    })
});
</pre>
<p>The key lines, of course, are these, where the second has been added to our code:</p>
<pre>var showMark = new MarkShow();
showMark.getPick();
</pre>
<p>The steps:</p>
<ul>
<li>The user asks for the Markdown page.</li>
<li>In <strong>Control.showMarkdown</strong> use <strong>\$.getJson</strong> to save the file the user choose to see in the page back on the server. (Eventually we will have to deal with users on the server, but just save it globally for now.)
Still in <strong>Control.showMarkdown</strong>, Launch the new page (window.location.href)
In MarkShow, ask the server for the file pick with <strong>\$.getJSON</strong>.
Display the pick to the user</li>
</ul>
<a class="anchor" id="session-support"></a>
<h2>Session Support</h2>
<pre>npm install express-session --save-dev
</pre>
<p>##Turn it In</p>
<p>Save your work in a Week08BridgePattern03 folder in your repository. Include a .project that has your last name appended to the directory name: Week08BridgePattern03-LastName.</p>
</div></body></html>