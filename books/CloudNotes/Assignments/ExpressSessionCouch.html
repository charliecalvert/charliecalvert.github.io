<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width initial-scale=1.0"><title>ExpressSessionCouch</title><link rel="shortcut icon" href="/charlie/images/favicon.png"><!-- Latest compiled and minified CSS--><link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap.min.css"><!-- Optional theme--><link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap-theme.min.css"><!-- link(href='/libs/css/BootstrapIndex.css', rel='stylesheet', type='text/css')--><link href="/css/style.css" rel="stylesheet" type="text/css"><link href="/css/highlight/googlecode.css" rel="stylesheet" type="text/css"><script src="/components/jquery/dist/jquery.js"></script><script src="/components/angular/angular.js"></script><script src="/components/angular-route/angular-route.js"></script><script src="/components/bootstrap/dist/js/bootstrap.min.js"></script><!-- script(src='/libs/scripts/elvenware.js', type='text/javascript')--><script src="/libs/scripts/Control.js"></script><!-- script(src='http://localhost:35729/livereload.js')--></head><body><div class="navbar navbar-inverse"><div class="container"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target=".navbar-collapse" class="navbar-toggle"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">Elvenware</a></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li class="active"><a href="/index.html">Home</a></li><li><a href="/charlie/About.html">About</a></li><li class="dropdown"><a href="#/" data-toggle="dropdown" class="dropdown-toggle">Dropdown<b class="caret"></b></a><ul class="dropdown-menu"><li class="dropdown-header">Core Code</li><li><a href="/charlie/development/index.html">Strongly Typed</a></li><li><a href="/charlie/development/web/index.html">Web & Scripts</a></li><li><a href="/charlie/development/cloud/index.shtml">Cloud</a></li><li class="divider"></li><li class="dropdown-header">OS and Tools</li><li><a href="/os/index.html">OS</a></li><li><a href="/charlie/development/database/index.html">Database</a></li><li><a href="/books/index.html">My Writing</a></li><li class="divider"></li><li class="dropdown-header">Art</li><li><a href="/charlie/Art/index.html">Poems & Photos</a></li><li><a href="/books/reading/index.html">Book Reviews</a></li><li><a href="/spirit/index.html">Spiritual</a></li><li class="divider"></li><li class="dropdown-header">Links</li><li><a href="/charlie/links.html">My Links</a></li><li><a href="http://www.github.com/charliecalvert">GitHub</a></li><li><a href="http://sourceforge.net/projects/elvenware/">Sourceforge</a></li></ul></li></ul></div><!-- /.nav-collapse--></div></div><div class="container"><figure><img alt="Elvenware" src="/charlie/images/elvenwarelogo.png"/></figure><h1>ExpressSessionCouch</h1><h3>Table of Contents</h3><ul><!--TOC_Start--><li><a href="#overview">Overview</a></li>
<li><a href="#session-design">Setup Session Design Views</a></li>
<li><a href="#add-couch-connect">Add Couch Connect Support</a></li>
<li><a href="#add-sessionstore">Add SessionStore</a></li>
<li><a href="#read-sessions">Read Sessions</a></li>
<li><a href="#client-side">Client Side</a></li>
<li><a href="#turn-it-in">Turn it in</a></li>
<li><a href="#images">Images</a></li><!--TOC_End--></ul><h2 id="overview">Overview</h2>
<p>Do you work in a branch called <strong>Week09</strong>.</p>
<pre><code class="lang-bash">cp -r Week09-SessionBasics/ Week09-SessionCouch
cd Week09-SessionCouch/
npm <span class="hljs-keyword">install</span> <span class="hljs-keyword">connect</span>-couchdb <span class="hljs-comment">--save</span>
npm <span class="hljs-keyword">install</span> nano <span class="hljs-comment">--save</span>
</code></pre>
<h2 id="session-design">Setup Session Design Views</h2>
<p>Run set up like this:</p>
<pre><code><span class="hljs-built_in">cd</span> node_modules/connect-couchdb/tools
</code></pre><p>Now edit <strong>setup.js</strong> like this, but use your ip address:</p>
<pre><code class="lang-javascript">var opts = {
    <span class="hljs-string">"host"</span>: <span class="hljs-string">"192.168.2.19"</span>,
    <span class="hljs-string">"name"</span>: process.argv<span class="hljs-string">[2]</span>,
  <span class="hljs-string">"revs_limit"</span>: process.argv<span class="hljs-string">[3]</span>};
</code></pre>
<p>Run it like this:</p>
<pre><code><span class="hljs-keyword">node</span> <span class="hljs-title">setup</span>.js couch-session-lastname <span class="hljs-number">1000</span>
</code></pre><h2 id="add-couch-connect">Add Couch Connect Support</h2>
<p>Put this near the top of <strong>middleware.js</strong>:</p>
<pre><code class="lang-javascript">var ConnectCouchDB = require('connect-couchdb')(<span class="hljs-name">session</span>)<span class="hljs-comment">;</span>
</code></pre>
<p>And here is the mothod we use to initialize our couch session object:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> couchStore = <span class="hljs-keyword">new</span> ConnectCouchDB({
    <span class="hljs-comment">// Name of the database you would like to use for sessions.</span>
    name: <span class="hljs-string">'myapp-sessions'</span>,

    <span class="hljs-comment">// Optional. Database connection details. See yacw documentation</span>
    <span class="hljs-comment">// for more informations</span>
    username: <span class="hljs-string">'username'</span>,
    password: <span class="hljs-string">'password'</span>,
    host: <span class="hljs-string">'localhost'</span>,

    <span class="hljs-comment">// Optional. How often expired sessions should be cleaned up.</span>
    <span class="hljs-comment">// Defaults to 600000 (10 minutes).</span>
    reapInterval: <span class="hljs-number">600000</span>,

    <span class="hljs-comment">// Optional. How often to run DB compaction against the session</span>
    <span class="hljs-comment">// database. Defaults to 300000 (5 minutes).</span>
    <span class="hljs-comment">// To disable compaction, set compactInterval to -1</span>
    compactInterval: <span class="hljs-number">300000</span>,

    <span class="hljs-comment">// Optional. How many time between two identical session store</span>
    <span class="hljs-comment">// Defaults to 60000 (1 minute)</span>
    setThrottle: <span class="hljs-number">60000</span>
});
</code></pre>
<p>You probably won&#39;t use either the userName or password so you can comment those lines out. You will also have to change the name of the database to match the database you created with their <strong>setup</strong> tool.</p>
<p>And now we change the way we handle the store when we initialize the session:</p>
<pre><code class="lang-javascript">router.use(session({
    genid: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req</span>) </span>{
<span class="hljs-meta">        'use strict'</span>;
        <span class="hljs-keyword">return</span> uuid.v4(); <span class="hljs-comment">// use UUIDs for session IDs</span>
    },
    secret: process.env.SESSION_SECRET || <span class="hljs-string">'keyboard cat'</span>,
    resave: <span class="hljs-literal">true</span>,
    saveUninitialized: <span class="hljs-literal">true</span>,
    store: couchStore   &lt;==== HERE
}));
</code></pre>
<h2 id="add-sessionstore">Add SessionStore</h2>
<p>Here is an alternative session store. The nice things about this one is that it will work with a number of different databases.</p>
<ul>
<li><a href="https://github.com/adrai/sessionstore">https://github.com/adrai/sessionstore</a></li>
</ul>
<p>Here are some things that need to be installed:</p>
<pre><code>npm <span class="hljs-keyword">install</span> express-<span class="hljs-keyword">session</span> <span class="hljs-comment">--save</span>
npm <span class="hljs-keyword">install</span> sessionstore <span class="hljs-comment">--save</span>
npm <span class="hljs-keyword">install</span> cradle <span class="hljs-comment">--save</span>
</code></pre><p>The code:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> sessionStore = sessionstore.createSessionStore({
    type: <span class="hljs-string">'couchdb'</span>,
    host: <span class="hljs-string">'http://192.168.2.19'</span>,  <span class="hljs-comment">// optional</span>
    port: <span class="hljs-number">5984</span>,                <span class="hljs-comment">// optional</span>
    dbName: <span class="hljs-string">'sessionstore-calvert'</span>,<span class="hljs-comment">// optional</span>
    collectionName: <span class="hljs-string">'sessions'</span>,<span class="hljs-comment">// optional</span>
    timeout: <span class="hljs-number">10000</span>             <span class="hljs-comment">// optional</span>
});

router.use(session({
    genid: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req</span>) </span>{
<span class="hljs-meta">        'use strict'</span>;
        <span class="hljs-keyword">return</span> uuid.v4(); <span class="hljs-comment">// use UUIDs for session IDs</span>
    },
    secret: process.env.SESSION_SECRET || <span class="hljs-string">'keyboard cat'</span>,
    resave: <span class="hljs-literal">true</span>,
    saveUninitialized: <span class="hljs-literal">true</span>,
    store: sessionStore
}));
</code></pre>
<h2 id="read-sessions">Read Sessions</h2>
<p>Install Nano:</p>
<pre><code>npm <span class="hljs-keyword">install</span> nano <span class="hljs-comment">--save</span>
</code></pre><p>Copy in the couch files from your DataMaster program or other source. You will, of course, put them in the <strong>routes</strong> folder.</p>
<ul>
<li>Modify the top of index.js to load the Couch files that you just added to your project.</li>
<li>Modify the database name at the top of <strong>routes/Couch.js</strong></li>
<li>You will also have to modify <strong>CouchDesignDocs</strong> and <strong>CouchViews</strong>.</li>
</ul>
<p>In <strong>CouchDesignDocs</strong> your new couch view will look like this:</p>
<pre><code class="lang-javascript">var elfSessions = <span class="hljs-keyword">function</span>(<span class="hljs-meta">doc</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-meta">doc</span>.type === <span class="hljs-string">'connect-session'</span>) {
                emit(<span class="hljs-meta">doc</span>.<span class="hljs-number">_</span>id, <span class="hljs-meta">doc</span>);
        }
};
</code></pre>
<p>This will get all the documents in your database that describe the sessions used by your app. That is, it will retrieve:</p>
<ul>
<li>All the couch documents with <strong>type</strong> property that is set to <strong>&#39;connect-session&#39;</strong></li>
<li>All of those documents will have names of this shape: <strong>connect-session_LOTS_OF_NUMBERS_AND_LETTERS</strong><ul>
<li>for instance: <strong>connect-session_27014d18-d80d-4224-aa1d-c117ee35fffc</strong></li>
</ul>
</li>
</ul>
<p>You will want to delete the other design docs, each of which should have names with the words NPC or STATE in them. You will also need to modify the route called &#39;/design/doc&#39;:</p>
<pre><code class="lang-javascript">router.<span class="hljs-keyword">get</span>(<span class="hljs-string">'/designDoc'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(request, response)</span> </span>{
        console.log(<span class="hljs-string">'Design Doc Called'</span>);

        <span class="hljs-keyword">var</span> designName = <span class="hljs-string">'_design/elf-session'</span>;
        <span class="hljs-keyword">var</span> designDocument = {
                <span class="hljs-string">'views'</span>: {
                        <span class="hljs-string">'elfSesions'</span>: {
                                <span class="hljs-string">'map'</span>: WHAT_SHOULD_IT_MAP_TO
                        }
                }
        };

    createDesignDocument(designDocument, designName, response);
});
</code></pre>
<p>You will also want to modify <strong>CouchViews</strong> to contain a route called <strong>/viewSessions</strong>. This view should, at least for now, return the entire <strong>body</strong>.</p>
<h2 id="client-side">Client Side</h2>
<p>Add some buttons:</p>
<pre>
div
        button.btn.btn-info#designDoc Insert Design Doc
        button.btn.btn-info#sessionView View Sessions
</pre>

<p>Add some more click handlers in <strong>control.js</strong>. Hint, here is how to call the view:</p>
<pre><code class="lang-javascript"> showPage('/viewSessions?designDoc=elf-session&amp;view=elf-sessions')
</code></pre>
<p>For now we simply showing all the results for the sessions you have created.</p>
<h2 id="turn-it-in">Turn it in</h2>
<p>Run <strong>grunt check</strong> and make sure it passes. Push your work to the cloud.</p>
<p>In the comments or text page, specify the branch and folder name for your project.</p>
<h2 id="images">Images</h2>
<p>Here are some screenshots that will help you get some idea of what I&#39;m expecting to see.</p>
<p><img src="https://s3.amazonaws.com/bucket01.elvenware.com/images/session-couch-view.png" alt="Viewing the session documents from the couch-session-lastname database"></p>
<p><strong>Image</strong>: <em>Viewing the session documents from the couch-session-lastname database.</em></p>
<p>When looking at futon, you ought to see two design docs:</p>
<ul>
<li>connect-sessions</li>
<li>elf-session</li>
</ul>
<p>And also one or more session documents. These documents have names that begin something like this <strong>connect-session_XXX</strong>, where XXX is the beginning of a long set of numbers and letters. I have two because I ran the app both in Chrome and Firefox.</p>
<p><img src="https://s3.amazonaws.com/bucket01.elvenware.com/images/session-couch-futon.png" alt="Viewing Futon"></p>
<p><strong>Image</strong>: <em>What futon looks like with the two design docs and two sessions added. I have two sessions because I ran the application once from chrome and once in FireFox.</em></p>
</div></body></html>