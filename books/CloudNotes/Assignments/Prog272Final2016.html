<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width initial-scale=1.0"><title>Prog272Final2016</title><link href="/css/first-style.css" rel="stylesheet"><link rel="shortcut icon" href="/images/favicon.png"><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet"><link href="/css/highlight/googlecode.css" rel="stylesheet" type="text/css"><link href="/css/style.css" rel="stylesheet"><script src="https://code.jquery.com/jquery-1.12.0.min.js"></script><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- Latest compiled and minified CSS --><script src="/js/elven-help.js"></script></head><body><nav class="navbar navbar-inverse"><div class="container"><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/">Elvenware</a></div><div class="navbar-collapse collapse" id="navbar"><ul class="nav navbar-nav"><li class="trigger-collapse" ng-class="{ active: isActive('/')}"><a href="/">Home</a></li><li><a href="/about.html">About</a></li></ul></div></div></nav><div class="container"><figure><img class="elf-normal" alt="Elvenware" src="/images/elvenwarelogo.png"/></figure><h1>Prog272Final2016</h1><p>Welcome to Prog272Final2016</p><ul><!--TOC_Start--><li><a href="#overview">Overview</a></li>
<li><a href="#images">Images</a></li>
<li><a href="#bootswatch">Bootswatch</a></li>
<li><a href="#settings">Settings</a></li>
<li><a href="#settings-model">Settings-Model</a></li>
<li><a href="#settings-database">Settings-Database</a></li>
<li><a href="#settings-home-page">Settings Home Page</a></li>
<li><a href="#settings-options">Settings Options</a></li>
<li><a href="#database-notes">Database Notes</a></li>
<li><a href="#data-choice">Data Choice</a></li>
<li><a href="#containers">Containers</a></li>
<li><a href="#testing">Testing</a></li>
<li><a href="#jade-routes">Jade Routes</a></li>
<li><a href="#menu">Menu</a></li>
<li><a href="#disable-buttons">Disable Buttons</a></li>
<li><a href="#errors">Trouble Shoot Errors</a></li>
<li><a href="#ignore">Ignore Files Written to Disk</a></li>
<li><a href="#turn-it-in">Turn it in</a></li><!--TOC_End--></ul></div><div class="container"><a class="anchor" id="overview"></a>
<h2>Overview</h2>
<p>The Prog 272 Final for 2016 is broken out into their tiers, three sets of priorities. I&#39;ll list the basic priorities first, intermediate level priorities second, and advanced priorities third. The more experience you have as a developer, the deeper into this list you should go. Those with little experience may complete only features from the basic tier and perhaps one or two items from the intermediate level. Those with lots of experience should get deeper into the list of advanced priorities.</p>
<p><strong>NOTE</strong>: <em>To some degree, you are being graded based on your relationship with others in the class who have a similar level of experience. Exactly what grade people with little experience will get depends in part on how other students with little experience did. Likewise, experienced students will be graded in relationship to other experienced students.</em></p>
<ol>
<li>Home and About pages</li>
<li>Renewables, Renewables by Index and Renewables by Year Pages</li>
<li>A Bootswatch theme</li>
<li>Karma tests run smoothly</li>
<li><strong>grunt check</strong> comes back clean</li>
<li>Running your program on Heroku</li>
</ol>
<p>These features of your final demonstrate that you understand the basics taught in the course, that you came to class regularly, and made a good faith effort to complete the course.</p>
<p>Your next set of priorities include:</p>
<ul>
<li>Ensuring your code is thoroughly refactored into<ul>
<li>Renewable and Energy Types folders on the client and server (public/javascripts, views)</li>
<li>Files in the routes directory for handling various tasks such as responding to requests for  <strong>renewables</strong> data, <strong>high-tech-energy</strong> data and <strong>settings</strong> data.</li>
</ul>
</li>
<li>At least one of the following:<ul>
<li>High Tech Energy Overview Page</li>
<li>High Tech Energy Types Page</li>
</ul>
</li>
<li>Menu works on both desktop and mobile device</li>
</ul>
<p>This demonstrates your ability to take some of the concepts taught in the core portion of the course and implement them on your own with a minimum of hand holding.</p>
<p>Finally, if you have completed the features outlined above, you can attempt to produce a complete, well structured application:</p>
<ul>
<li>An Energy Types page with clickable <strong>msnTypes</strong> that filter your data</li>
<li>Database page to import JSON data into MongoDB and display it.</li>
<li>Settings page pulling and setting data in MongoDB</li>
<li>Ability to use either JSON or MongoDB as your datasource for the renewables page.</li>
<li>Ability to use the settings page to dynamically switch back and forth between displaying JSON data and MongoDB data for the renewables page.</li>
</ul>
<p>I&#39;m expecting that most students won&#39;t be able to complete all the features of the final. Consider adopting the following strategies:</p>
<ul>
<li>Put only your best work Heroku. This is your <strong>release</strong> and should contain only working features.<ul>
<li>Suppose you could only get one page working properly. Then put only that one page on Heroku.</li>
</ul>
</li>
<li>The code in your main repository can optionally contain broken features if you want to show that you nearly completed X or Y. In general, it will help to show that you at least tried to complete a page rather than never tried at all. For instance, if you got parts of the Energy Types page working, but not all of it, then include that page even if it is buggy. In your repository, but not on Heroku, I want to see what you tried to do as well as what you completed successfully. Again, put only your best work on Heroku.</li>
<li>Don&#39;t work too hard. A sane approach to a course like this is to work steadily throughout the quarter. It is very hard to solve an entire quarters worth of problems in two days.<ul>
<li>I understand that not everyone came into this course with the same level of experience. Don&#39;t compare your work to the work of other students. I divided the features of the final into priorities in part to give students who are new to this kind of development some guidance. In some cases, just completing the first set of priorities will be enough to get you a respectable grade in this course. In other cases, I will expect to see nearly all the features in the third set of priorities completed. I think most of you know what I expect, but if you are unsure you can ask me for additional guidance. Consider, however, surprising me. Sometimes students do better than I expect. That&#39;s always nice.</li>
</ul>
</li>
<li>Go to this page (the one you are reading right now) on the web frequently. Refresh the page at least once every time you visit it. At this stage, it will be difficult for me to add or remove features of the final, but it is likely that I will add hints or clarifications. You don&#39;t won&#39;t miss seeing a hint that could help you create a better program.</li>
</ul>
<p>Extra credit</p>
<ul>
<li>Dynamically switch back and forth between using mLab and local data.</li>
<li>Have the ability to switch back and forth between MongoDB and JSON as the datasource on all your pages.<ul>
<li>This would include, on the database page, the ability to import Energy Types data.</li>
</ul>
</li>
</ul>
<a class="anchor" id="images"></a>
<h2>Images</h2>
<p><img src="https://s3.amazonaws.com/bucket01.elvenware.com/images/prog272-final-2016-01.png" alt="Main Page"></p>
<p><strong>Figure 01</strong>: <em>The home page of the final.</em></p>
<p><img src="https://s3.amazonaws.com/bucket01.elvenware.com/images/prog272-final-2016-02.png" alt="Database Page"></p>
<p><strong>Figure 01</strong>: <em>The database page is import JSON data into the MongoDb database. In this screenshot you can see many of the menu items.</em></p>
<a class="anchor" id="bootswatch"></a>
<h2>Bootswatch</h2>
<p><a href="https://bootswatch.com/">Bootswatch</a> provides themes for bootstrap.</p>
<p>Install it:</p>
<pre>
bower install bootswatch --save
</pre>

<p>In bower.json, you will probably have to edit the entry so it looks like this:</p>
<pre><code class="lang-javascript"><span class="hljs-string">"bootswatch"</span>: <span class="hljs-string">"^3.3.6"</span>
</code></pre>
<p>Make sure it does <strong>not</strong> contain <strong>&quot;^3.3.6+2&quot;</strong>.</p>
<p>Use it in <strong>layout.jade</strong>. Modify the line that loads <strong>bootstrap.css</strong> so that it looks something like this:</p>
<pre>
link(rel='stylesheet', href='/components/bootswatch/cyborg/bootstrap.css')
</pre>

<p>Cyborg is just one of the many themes available from bootswatch.</p>
<ul>
<li><a href="https://bootswatch.com/cerulean/">Cerulean</a></li>
<li><a href="https://bootswatch.com/cosmo/">Cosmo</a></li>
<li><a href="https://bootswatch.com/darkly/">Darkly</a></li>
<li><a href="https://bootswatch.com/superhero/">Superhero</a></li>
<li>And so on. They are all linked from the main menu at the bootswatch site.</li>
</ul>
<p>Note that some of the controls, such as selects, won&#39;t render correctly with some bootswatch themes unless you decorate them with the proper class. Here the <strong>form-control</strong> class provides support needed to allow bootswatch themes such as darkly to render correctly. This particular examples is from the <strong>settings</strong> page:</p>
<pre>
select.form-control#dataType(name='dataType')
</pre>

<p>Add the <strong>.form-confol</strong> CSS class to all your HTML <strong>SELECT</strong> and <strong>INPUT</strong> controls. I just opened each jade file, looked for <strong>SELECT</strong> and <strong>INPUT</strong> controls, and added the class. Without it, I was having trouble reading the text in some of my controls when using certain bootswatch themes. In particular, I was sometimes finding that the text was rendering as black on a black background or white on a white background, making the text difficult or impossible to read. Just use the appropriate <a href="http://getbootstrap.com/css/">bootstrap CSS</a> to fix these kinds of problems.</p>
<p><img src="https://s3.amazonaws.com/bucket01.elvenware.com/images/prog272-final-2016-03.png" alt="Bootswatch Darkly Theme"></p>
<p><strong>Figure03</strong>: <em>Bootswatch Darkly Theme.</em></p>
<a class="anchor" id="settings"></a>
<h2>Settings</h2>
<p>To help you get started using database in your app, let&#39;s add the ability to track some settings in MongoDB.</p>
<p>Some key files and commands involved in implementing the settings page and its link to MongoDB:</p>
<ul>
<li>models/settings.js</li>
<li>routes/connect.js</li>
<li>routes/all-mongo.js</li>
<li>public/javascript/database.js</li>
</ul>
<p>Some files that need to change:</p>
<ul>
<li>public/javascript/app.js</li>
<li>app.js</li>
</ul>
<p>npm install mongoose --save</p>
<a class="anchor" id="settings-model"></a>
<h2>Settings-Model</h2>
<p>We want to save settings:</p>
<p>The model looks like this, only use your last name:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);

<span class="hljs-keyword">var</span> settingsSchema = mongoose.Schema({
    <span class="hljs-string">"keyNote"</span>: <span class="hljs-built_in">String</span>,
    <span class="hljs-string">"dataSource"</span>: <span class="hljs-built_in">String</span>,
    <span class="hljs-string">"dataType"</span>: <span class="hljs-built_in">String</span>,
    <span class="hljs-string">"comment"</span>: <span class="hljs-built_in">String</span>
});

<span class="hljs-built_in">module</span>.exports = mongoose.model(<span class="hljs-string">'prog272_lastname_setting'</span>, settingsSchema);
</code></pre>
<p><strong>NOTE</strong>: <em>Please do not use hypens (-) in your model (collection) names. They work okay in mongoose, but the mongo shell has a hard time with them. Use underscores instead.</em></p>
<p>Good: <strong>module.exports = mongoose.model(&#39;prog272_lastname_setting&#39;, settingsSchema);</strong>
Bad: <strong>module.exports = mongoose.model(&#39;prog272-lastname-setting&#39;, settingsSchema);</strong>
Bad: <strong>module.exports = mongoose.model(&#39;prog272LastnameSetting&#39;, settingsSchema);</strong></p>
<a class="anchor" id="settings-database"></a>
<h2>Settings-Database</h2>
<p>Create a file in <strong>routes</strong> called <strong>database-settings.js</strong>. Make appropriate changes in <strong>app.js</strong>. Beside the standard code, such as requiring <strong>connect.js</strong>, also include this:</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// CODE OMITTED HERE</span>

<span class="hljs-keyword">var</span> settings = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../models/settings'</span>);

<span class="hljs-comment">// CODE OMITTED HERE</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">saveSettings</span>(<span class="hljs-params">request, response</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'request body'</span>, request.body);

    <span class="hljs-keyword">var</span> newSettings = <span class="hljs-keyword">new</span> settings({
        <span class="hljs-string">"keyNote"</span>: <span class="hljs-string">'settings'</span>,
        <span class="hljs-string">"dataSource"</span>: request.body.dataSource,
        <span class="hljs-string">"dataType"</span>: request.body.dataType,
        <span class="hljs-string">"comment"</span>: request.body.comment
    });

    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'inserting'</span>, newSettings.comment);

    newSettings.save(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'saved: '</span>, newSettings.dataSource, newSettings.dataType, newSettings.comment);
        response.send({ <span class="hljs-attr">result</span>: <span class="hljs-string">'success'</span>, <span class="hljs-attr">query</span>: request.body});

    });
}

router.post(<span class="hljs-string">'/updateSettings'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'request body'</span>, request.body);
    <span class="hljs-keyword">if</span> (!connect.connected) {
        connect.doConnection();
    }

    settings.findOne({<span class="hljs-attr">keyNote</span>: <span class="hljs-string">'settings'</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, doc</span>) </span>{
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'findone'</span>, err, doc);
        <span class="hljs-keyword">if</span> (err) {
            response.send({<span class="hljs-attr">result</span>: <span class="hljs-string">'error'</span>});
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span>(doc === <span class="hljs-literal">null</span>) {
                saveSettings(request, response);
            } <span class="hljs-keyword">else</span> {
                doc.dataType = request.body.dataType;
                doc.dataSource = request.body.dataSource;
                doc.comment = request.body.comment;
                doc.save();
                response.send( {<span class="hljs-attr">result</span>: <span class="hljs-string">'success'</span>, <span class="hljs-attr">query</span>: request.body });
            }
        }
    });
});

router.get(<span class="hljs-string">'/getSettings'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'request body'</span>, request.body);
    <span class="hljs-keyword">if</span> (!connect.connected) {
        connect.doConnection();
    }

    settings.findOne({<span class="hljs-attr">keyNote</span>: <span class="hljs-string">'settings'</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, doc</span>) </span>{
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'findone'</span>, err, doc);
        <span class="hljs-keyword">if</span> (err) {
            response.send({<span class="hljs-attr">result</span>: <span class="hljs-string">'error'</span>});
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span>(doc === <span class="hljs-literal">null</span>) {
                response.send({<span class="hljs-attr">settings</span>: {<span class="hljs-attr">dataType</span>: <span class="hljs-string">'Database'</span>, <span class="hljs-attr">dataSource</span>: <span class="hljs-string">'Local MongoDb'</span>, <span class="hljs-attr">comment</span>: <span class="hljs-string">'Default Comment'</span>}})
            } <span class="hljs-keyword">else</span> {
                response.send({<span class="hljs-attr">settings</span>: doc});
            }
        }
    });
});
</code></pre>
<p>In <strong>connect.js</strong> you need to change this line:</p>
<pre><code class="lang-javascripts">db.once(<span class="hljs-string">'open'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span></span> {
    connect.connected = <span class="hljs-literal">true</span>;   &lt;== THIS IS CORRECT
    console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'Opened connection to mongo'</span>);
});
</code></pre>
<p>If you see <strong>connected = true;</strong> then you need to change it as shown above. Change in both simple and mLab. This is around lines 20 and 42 of <strong>routes/connect.js</strong>.</p>
<a class="anchor" id="settings-home-page"></a>
<h2>Settings Home Page</h2>
<p>Update <strong>home.jade</strong></p>
<pre>
.container
    .jumbotron
        h1 Home Page

    .panel.panel-default
        .panel-heading Renewable
        .panel-body
            form#target(method='post', action='/bar')
                select#dataType(name='dataType')
                    option Database
                    option JSON
                hr
                select#dataSource(name='dataSource')
                    option Local MongoDb
                    option MLab
                hr
                input#comment(type="text", name='comment' value='foo')
                hr
                input.btn.btn-success(type="submit", value='Submit')

    .panel.panel-default
        .panel-heading Renewable
        .panel-body
            .alert.alert-info
                pre#debug

</pre>

<p>Update <strong>home.js</strong></p>
<pre><code class="lang-javascript"><span class="hljs-comment">/**
 * Created by charlie on 5/18/16.
 */</span>

define(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">    'use strict'</span>;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSettings</span>(<span class="hljs-params"></span>) </span>{
        $.getJSON(<span class="hljs-string">'/databaseSettings/getSettings'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
            $(<span class="hljs-string">'#debug'</span>).html(<span class="hljs-built_in">JSON</span>.stringify(response, <span class="hljs-literal">null</span>, <span class="hljs-number">4</span>));
            $(<span class="hljs-string">'#dataType'</span>).val(response.settings.dataType);
            $(<span class="hljs-string">'#dataSource'</span>).val(response.settings.dataSource);
            $(<span class="hljs-string">'#comment'</span>).val(response.settings.comment);
        })
            .fail(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">a, b, c</span>) </span>{
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Error'</span>, a, b, c);
                $(<span class="hljs-string">'#debug'</span>).html(<span class="hljs-string">'Error occured: '</span>, a.status);
            })
            .done(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'second success'</span>);
            })
            .always(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'complete'</span>);
            });
    }

    <span class="hljs-keyword">var</span> home = {
        <span class="hljs-attr">color</span>: <span class="hljs-string">'red'</span>,
        <span class="hljs-attr">size</span>: <span class="hljs-string">'big'</span>,
        <span class="hljs-attr">init</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-built_in">console</span>.log(home.color);
            $(<span class="hljs-string">'#elf-view'</span>).load(<span class="hljs-string">'/home'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                $(<span class="hljs-string">'#display'</span>).html(home.color);
                $(<span class="hljs-string">'#display2'</span>).html(home.size);
                getSettings();
                $(<span class="hljs-string">"#target"</span>).submit(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
                    event.preventDefault();
                    <span class="hljs-keyword">var</span> userFormData = $(<span class="hljs-keyword">this</span>).serialize();
                    $(<span class="hljs-string">'#debug'</span>).html(userFormData);
                    <span class="hljs-keyword">var</span> userData = {
                        <span class="hljs-attr">dataType</span>: $(<span class="hljs-string">'#dataType'</span>).val(),
                        <span class="hljs-attr">dataSource</span>: $(<span class="hljs-string">'#dataSource'</span>).val(),
                        <span class="hljs-attr">comment</span>: $(<span class="hljs-string">'#comment'</span>).val()
                    };
                    $.post(<span class="hljs-string">'/databaseSettings/updateSettings'</span>, userData, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">result</span>) </span>{
                        $(<span class="hljs-string">'#debug'</span>).html(<span class="hljs-built_in">JSON</span>.stringify(result, <span class="hljs-literal">null</span>, <span class="hljs-number">4</span>));
                        <span class="hljs-built_in">console</span>.log(settings);
                    });
                });

            });
        }
    };
    <span class="hljs-keyword">return</span> home;
});
</code></pre>
<a class="anchor" id="settings-options"></a>
<h2>Settings Options</h2>
<p>You know how to load and save the settings for your application. The next step is to change the behavior of the application based on those settings.</p>
<p>The user can choose to read data from either the database or a JSON file:</p>
<ul>
<li>Database</li>
<li>JSON</li>
</ul>
<p>Let&#39;s capture that choice in a simple object to be stored in its own file called <strong>public/javascripts/settings.js</strong>:</p>
<pre><code class="lang-javascript">define(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
   <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">useDatabase</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">useLocalMongoDb</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">report</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'useDatabase'</span>, <span class="hljs-keyword">this</span>.useDatabase);
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'useLocalMongoDb'</span>, <span class="hljs-keyword">this</span>.useLocalMongoDb)
        },
        <span class="hljs-attr">setSettings</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">settings</span>) </span>{
            <span class="hljs-keyword">this</span>.useDatabase = settings.dataType.toLowerCase() === <span class="hljs-string">'database'</span>;
            <span class="hljs-keyword">this</span>.useLocalMongoDb = settings.dataSource.toLowerCase() === <span class="hljs-string">'local mongodb'</span>;
            <span class="hljs-keyword">this</span>.report()
        }
    };
});
</code></pre>
<p>Given this object, we can now decide whether to get our data from the database or from a JSON file depending on the options the user choose. For instance, in <strong>public/javascripts/renewables/renewables.js</strong>, we can use the require js dependency injection to access the settings object and decide whether or not to use the mongodb database:</p>
<pre><code class="lang-javascript">define([<span class="hljs-string">'jquery'</span>, <span class="hljs-string">'settings'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$, settings</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;

    <span class="hljs-keyword">var</span> index = <span class="hljs-number">0</span>;
    <span class="hljs-comment">//var useDatabase = true;</span>

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getRenewable</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-comment">//console.log('getRenewable called');</span>
        <span class="hljs-keyword">var</span> routeType = settings.useDatabase ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>;

        <span class="hljs-keyword">var</span> renewableRoutes = [<span class="hljs-string">'/allRenewables'</span>, <span class="hljs-string">'/renewables'</span>];
        $.getJSON(renewableRoutes[routeType], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
            <span class="hljs-comment">// CODE OMITTED HERE</span>
        });
    }
});
</code></pre>
<p>Your job is to make sure the settings are set correctly when the user either loads or saves the settings from the database. This typically takes place in <strong>home.js</strong> Again, you will use dependency injection to access the settings object:</p>
<pre><code class="lang-javascript">define([<span class="hljs-string">'settings'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(settings)</span> </span>{
  <span class="hljs-comment">// MAKE SURE THE SETTINGS ARE SAVED TO THE settings OBJECT</span>
  <span class="hljs-comment">// CODE OMITTED HERE</span>
});
</code></pre>
<p>The exact details of what happens in <strong>home.js</strong> are left as an exercise. You will have to add only a small amount of code that saves the settings to the <strong>settings</strong> object. This will involve a call to <strong>settings.setSettings()</strong>.</p>
<a class="anchor" id="database-notes"></a>
<h2>Database Notes</h2>
<p>If you get <strong>Unclean shutdown detected.</strong>, run this to fix it:</p>
<pre>
cd
./mongod --repair
</pre>

<p>On Cloud 9, To shutdown we should be able to do <strong>CTRL-C</strong> in the window where mongo is running. Or, try this from inside the mongo shell:</p>
<pre>
db.shutdownServer()
</pre>

<p>For more details on shuting down, go here:</p>
<ul>
<li><a href="https://docs.mongodb.com/manual/tutorial/recover-data-following-unexpected-shutdown/">https://docs.mongodb.com/manual/tutorial/recover-data-following-unexpected-shutdown/</a></li>
</ul>
<p>In mongo shell, to empty a collection: <strong>db.myCollection.remove({})</strong>.</p>
<p>Make sure you put your preface your collections with prog219 and end them with your last name:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">module</span>.<span class="hljs-keyword">exports</span> = mongoose.model(<span class="hljs-string">'prog219_calvert_renewables'</span>, renewablesSchema);
</code></pre>
<p><strong>NOTE</strong>: <em>Please do not use hypens (-) in your model (collection) names. They work okay in mongoose, but the mongo shell has a hard time with them. Let&#39;s use underscores instead.</em></p>
<p>In <strong>routes/connect.js</strong>, set your simple url to use a dbs called renew:</p>
<pre><code class="lang-javascript"><span class="hljs-attribute">var url</span>= <span class="hljs-string">'mongodb://127.0.0.1:27017/renew'</span>;
</code></pre>
<p><strong>NOTE</strong>: <em>Recall that I will be grading many assignments. I don&#39;t want the data in my Mongo Lab (MLab) database as there will be too much of it. So I&#39;m going to put it in my local database. There will be a lot of data in there, and I need to know who created which collections. As a result, this naming scheme is essential.</em></p>
<p>If you are in both prog219 and prog272, and your last name is ng, then I&#39;m expecting to see something like this in the mongo shell:</p>
<pre>
> show collections
prog219_calvert_renewables
prog272_calvert_renewables
prog219_ng_renewables
prog272_ng_renewables
</pre>

<a class="anchor" id="data-choice"></a>
<h2>Data Choice</h2>
<p>The database has already translated the unusable keys from our raw data into usable keys. But if we read directly from the JSON, then we have not done so. This means we have to have a special case for when we use JSON data and when we use Database data.</p>
<p>Create a variable called <strong>useDatabase</strong>.</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> useDatabase = <span class="hljs-literal">false</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getRenewable</span></span>() {
    <span class="hljs-comment">//console.log('getRenewable called');</span>
    <span class="hljs-keyword">var</span> routeType = useDatabase ? <span class="hljs-number">0</span> : <span class="hljs-type">1</span>;

    <span class="hljs-keyword">var</span> renew<span class="hljs-type">ableRoutes</span> = [<span class="hljs-string">'/allRenewables'</span>, <span class="hljs-string">'/renewables'</span>];
    $.getJSON(renew<span class="hljs-type">ableRoutes</span>[routeType], <span class="hljs-function"><span class="hljs-keyword">function</span></span>(response) {
            renew<span class="hljs-type">ables</span>.renew<span class="hljs-type">ablesList</span> = response.renew<span class="hljs-type">ables</span>;
            showRenew<span class="hljs-type">able</span>(renew<span class="hljs-type">ables</span>.renew<span class="hljs-type">ablesList</span>[index]);
            etc....
    })
</code></pre>
<p>Then in <strong>showRenewable</strong>:</p>
<pre><code class="lang-javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">showRenewable</span></span>(renew<span class="hljs-type">able</span>) {
    <span class="hljs-keyword">if</span> (!useDatabase) {
        renew<span class="hljs-type">able</span> = getSimpleKeys(renew<span class="hljs-type">able</span>);
    }
</code></pre>
<a class="anchor" id="containers"></a>
<h2>Containers</h2>
<p>I&#39;ve noticed a lot of student&#39;s applications don&#39;t look quite right on a large screen. The problem is that the various &quot;pages&quot; we are loading are not restricted to the middle of the screen, but instead &quot;bleed&quot; off to the right and left. To fix this, put them inside a container. Consider the jade for our standard <strong>about.jade</strong> page. This is not right because there is no container:</p>
<pre>
h1 About
p version 2.0

p#display

p#display2
</pre>

<p>This is right because the content is inside a container:</p>
<pre>
.container
    h1 About
    p version 2.0

    p#display

    p#display2
</pre>

<p>Try adding a container to all your pages. Not to the jade for a directive, but the jade used to define the appearance of a page. For instance, <strong>renewables-page.jade</strong>.</p>
<p><strong>NOTE</strong>: <em>On a low resolution screen, or on a mobile device, you can&#39;t tell the difference between the two sets of jade shown above. But on a big screen, when the app is maximized, it becomes obvious. The screens at school are certainly big enough to show this.</em></p>
<a class="anchor" id="testing"></a>
<h2>Testing</h2>
<p>If you are having trouble getting your tests to run, don&#39;t forget to review the <a href="https://www.ccalvert.net/books/CloudNotes/Assignments/Prog272Midterm2016.html#testing">testing section from the midterm</a>. Focus on comparing your karma.conf.js file with the one in the my [JasmineRequireJs][jas-req-js] example program.</p>
<p>You will find the tests for the midterm here:</p>
<ul>
<li><a href="https://github.com/charliecalvert/JsObjects/tree/master/Utilities/Templates/UnitTest/SolarVoyager">JsObjects/Utilities/Templates/UnitTest/SolarVoyager</a></li>
</ul>
<a class="anchor" id="jade-routes"></a>
<h2>Jade Routes</h2>
<p>A number of students have been confused about how to load jade. In particular, they have had trouble:</p>
<ul>
<li>Building the URLs for their routes on the client side.</li>
<li>Setting up the routes for loading jade on the server side.</li>
</ul>
<p>To get a better understanding of these issues:</p>
<ul>
<li>Read the <a href="http://www.elvenware.com/charlie/development/web/JavaScript/NodeJade.html#loading-jade">Loading Jade</a> section in the Elvenware Jade page.</li>
<li>See the <a href="https://github.com/charliecalvert/JsObjects/tree/master/JavaScript/NodeCode/JadeRoutes">JadeRoutes</a> demo program from JsObjects.</li>
</ul>
<a class="anchor" id="menu"></a>
<h2>Menu</h2>
<p>You should have menu that works both on a mobile device and on desktop. Be sure the hamburger manu closes automatically after you make a selection. In <strong>main.js</strong>, near the bottom, add code to hide the main when an anchor is selected:</p>
<pre><code class="lang-javascript">requirejs([<span class="hljs-string">'jquery'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;
    requirejs([<span class="hljs-string">'bootstrap'</span>, <span class="hljs-string">'control'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">bootstrap, control</span>) </span>{
        control.init();
        $(<span class="hljs-string">'.navbar-nav li.trigger-collapse a'</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
            $(<span class="hljs-string">'.navbar-collapse'</span>).collapse(<span class="hljs-string">'hide'</span>);
        });
    });
});
</code></pre>
<p>The three new lines which we use to close the menu after a selection are listed directly after the call to <strong>control.init()</strong>:</p>
<pre><code class="lang-javascript">$(<span class="hljs-string">'.navbar-nav li.trigger-collapse a'</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
    $(<span class="hljs-string">'.navbar-collapse'</span>).collapse(<span class="hljs-string">'hide'</span>);
});
</code></pre>
<p>Remember that if you have a link from the menu, and a link from a button, don&#39;t try to use IDs to form the link between the button/menu and the code that you want to execute. When setting up the event handler, use a class instead. Here is the menu with a class called <strong>.renewablesMenu</strong>:</p>
<pre>
li.trigger-collapse(ng-class="{ active: isActive('/renewables')}")
    a.renewablesMenu Renewables
</pre>

<p>And here is your button:</p>
<pre>
button.renewablesMenu.btn.btn-info Renewables
</pre>

<p>And here is the code that sets up the event handler:</p>
<pre><code class="lang-javascript"><span class="hljs-meta">$</span><span class="bash">(<span class="hljs-string">'.renewablesMenu'</span>).click(renewables.init);</span>
</code></pre>
<a class="anchor" id="disable-buttons"></a>
<h2>Disable Buttons</h2>
<p>In some cases, such as the Database page, you want to prevent the user from clicking buttons too quickly. In other words, if a call is going to take a long time, such as inserting the data on mLab, then you don&#39;t want the user to try to view or empty the collection until the insert is completed. Here are some very broad hints on how to proceed:</p>
<pre><code class="lang-javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">enableAll</span>(<span class="hljs-params">disable</span>) </span>{
    $(<span class="hljs-string">'#convertRenewables'</span>).prop(<span class="hljs-string">'disabled'</span>, disable);
    $(<span class="hljs-string">'#allRenewables'</span>).prop(<span class="hljs-string">'disabled'</span>, disable);
    $(<span class="hljs-string">'#emptyRenewables'</span>).prop(<span class="hljs-string">'disabled'</span>, disable);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">insertCollection</span>(<span class="hljs-params"></span>) </span>{
    $(<span class="hljs-string">'#allRenewables'</span>).prop(<span class="hljs-string">'disabled'</span>, <span class="hljs-literal">true</span>);
    $(<span class="hljs-string">'#emptyRenewables'</span>).prop(<span class="hljs-string">'disabled'</span>, <span class="hljs-literal">true</span>);
    $.getJSON(<span class="hljs-string">'/insertRenewables'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
            enableAll(<span class="hljs-literal">false</span>);
            <span class="hljs-comment">// ETC</span>
    });
</code></pre>
<p>Adopt this code as appropriate to your project. For instance, the route I call in the first parameter to <strong>getJSON</strong> may not be write for your final project.</p>
<a class="anchor" id="errors"></a>
<h2>Trouble Shoot Errors</h2>
<p>Always approach errors one at a time. If something is not working:</p>
<ul>
<li>Run <strong>grunt check</strong> and your unit tests. Get them to pass. (If you can&#39;t run your tests, move on and come back to them later.)</li>
<li>Load your program in Chrome with the developer tools open</li>
<li>Go to the network page and make sure it is free of any errors</li>
<li>Go to the console page and fix errors you see there</li>
<li>Also look in the bash shell to see if errors are showing up there.</li>
<li>Finally, go to the source page and step through any code that is still broken.</li>
</ul>
<a class="anchor" id="ignore"></a>
<h2>Ignore Files Written to Disk</h2>
<p>Some of you are writing a file to disk when you insert data into the database. Remember that in MongooseBasics we learned how to teach nodemon to ignore that file so that it did not restart the project while you were in the middle of an operation:</p>
<ul>
<li><a href="https://www.ccalvert.net/books/CloudNotes/Assignments/MongooseBasics.html#ignore-scientists">Ignore Scientists</a></li>
</ul>
<p>That may not be the name of the file you want to ignore in this case, but be sure you do teach nodemon to ignore any JSON files that you write to disk during program operation. Either that, or start the program with <strong>node</strong> rather than <strong>nodemon</strong> when turning in the final.</p>
<p>This was a bug on my end, yet at least a few students should have been able to fix it.</p>
<p>If you insert multiple times in one session, then <strong>totalRenewablesSaved</strong> gets increment past 12, and the program never sends a message back to the client that it has completed inserting data. The fix is simple: just set <strong>totalRenewablesSaved</strong> to zero before each insert:</p>
<pre><code class="lang-javascript">allMongo.readDataAndInsert = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;
    fs.readFile(<span class="hljs-string">'data/Renewable.json'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, renewables</span>) </span>{
        <span class="hljs-keyword">if</span> (err) {
            <span class="hljs-keyword">throw</span> (err);
        }
        renewables = <span class="hljs-built_in">JSON</span>.parse(renewables);
        totalRenewablesSaved = <span class="hljs-number">0</span>;    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">=================</span> <span class="hljs-attr">FIX</span> <span class="hljs-attr">IS</span> <span class="hljs-attr">HERE</span>
        <span class="hljs-attr">allMongo.numberOfRenewables</span> = <span class="hljs-string">renewables.length;</span>
        <span class="hljs-attr">for</span> (<span class="hljs-attr">var</span> <span class="hljs-attr">i</span> = <span class="hljs-string">0;</span> <span class="hljs-attr">i</span> &lt; <span class="hljs-attr">renewables.length</span>; <span class="hljs-attr">i</span>++) {
            <span class="hljs-attr">insertRenewable</span>(<span class="hljs-attr">renewables</span>[<span class="hljs-attr">i</span>], <span class="hljs-attr">response</span>);
        }
    });
};</span></span>
</code></pre>
<a class="anchor" id="turn-it-in"></a>
<h2>Turn it in</h2>
<p>Put your work in a branch called <strong>Final</strong> in a folder called <strong>SolarVoyager</strong>. If you do anything else other than this, please spell it out carefully when you turn in the Final. I will <strong>take off points</strong> and will likely ask you to re-submit if I don&#39;t immediately know where to look for final.</p>
<p>Submit the URL of your program running on Heroku.</p>
<p><strong>NOTE:</strong> <em>It might also be helpful to submit the Heroku git URL. You can find it with this command issued in the root of your heroku project: <strong>git remote -v</strong>.</em></p>
</div></body></html>