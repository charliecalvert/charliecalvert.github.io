<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><title>MongooseSignInComments</title><link rel="shortcut icon" href="/charlie/images/favicon.png"><!-- Latest compiled and minified CSS--><link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap.min.css"><!-- Optional theme--><link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap-theme.min.css"><link href="/libs/css/BootstrapIndex.css" rel="stylesheet" type="text/css"><link href="/css/style.css" rel="stylesheet" type="text/css"><script src="/components/jquery/dist/jquery.js"></script><script src="/components/angular/angular.js"></script><script src="/components/angular-route/angular-route.js"></script><script src="/components/bootstrap/dist/js/bootstrap.min.js"></script><script src="/libs/scripts/elvenware.js" type="text/javascript"></script><script src="/libs/scripts/Control.js"></script></head><body ng-app="elfApp"><div class="navbar navbar-inverse"><div class="container"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target=".navbar-collapse" class="navbar-toggle"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">Elvenware</a></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li class="active"><a href="/index.html">Home</a></li><li><a href="/about">About</a></li><li class="dropdown"><a href="#/" data-toggle="dropdown" class="dropdown-toggle">Dropdown<b class="caret"></b></a><ul class="dropdown-menu"><li class="dropdown-header">Core Code</li><li><a href="/development/index.html">Strongly Typed</a></li><li><a href="/development/web/index.html">Web & Scripts</a></li><li><a href="/development/cloud/index.shtml">Cloud</a></li><li class="divider"></li><li class="dropdown-header">OS and Tools</li><li><a href="/os/index.html">OS</a></li><li><a href="/development/database/index.html">Database</a></li><li><a href="/books/index.html">My Writing</a></li><li class="divider"></li><li class="dropdown-header">Art</li><li><a href="/charlie/Art/index.html">Poems & Photos</a></li><li><a href="/books/reading/index.html">Book Reviews</a></li><li><a href="/spirit/index.html">Spiritual</a></li><li class="divider"></li><li class="dropdown-header">Links</li><li><a href="/charlie/links.html">My Links</a></li><li><a href="http://www.github.com/charliecalvert">GitHub</a></li><li><a href="http://sourceforge.net/projects/elvenware/">Sourceforge</a></li></ul></li></ul></div><!-- /.nav-collapse--></div></div><div class="container"><figure><img alt="Elvenware" src="/charlie/images/elvenwarelogo.png"/></figure><h1>MongooseSignInComments</h1><h3>Table of Contents</h3><ul><!--TOC_Start--><li><a href="#description">Description</a></li>
<li><a href="#step-one">Step One</a></li>
<li><a href="#step-two">Step Two</a></li>
<li><a href="#step-three">Step Three</a></li>
<li><a href="#step-four">Step Four</a></li>
<li><a href="#step-five">Step Five</a></li>
<li><a href="#step-six">Step Six</a></li>
<li><a href="#step-seven">Step Seven</a></li>
<li><a href="#hints">Hints</a></li><!--TOC_End--></ul><h2 id="description">Description</h2>
<p>SignIn and Comments in one program with a menu.</p>
<p>Found a <a href="https://vickev.com/#!/article/authentication-in-single-page-applications-node-js-passportjs-angularjs">good article</a> on passport and angular. The <a href="https://github.com/Anomen/AuthenticationAngularJS">code</a> is available and that is how I knew to replace the method shown above.</p>
<h2 id="step-one">Step One</h2>
<p>Copy the MongooseComments program into a new folder:</p>
<pre><code>robocopy Week11-MongooseComments Week11-SignInComment /mir
</code></pre><p>Open the project in WebStorm and rename it the project to <strong>SignInComment</strong>.</p>
<p>Install the tools we will need:</p>
<pre><code>npm install bcrypt-nodejs --save
npm install passport --save
npm install passport-local --save
npm install express-session --save
bower install angular-route --save
</code></pre><h2 id="step-two">Step Two</h2>
<p>Add a menu</p>
<p>In <strong>layout.jade</strong>, copy in meta tags to prepare for use in a mobile device:</p>
<pre><code>doctype html
html
    head
        meta(charset=&#39;utf-8&#39;)
        meta(name=&#39;description&#39;, content=&#39;Final by Charlie Calvert for Prog 219 Spring 2015&#39;)
        meta(name=&#39;viewport&#39;, content=&#39;width=device-width, initial-scale=1&#39;)
        title= title
</code></pre><p>Then also load <strong>angular-route</strong> and <strong>app.js</strong></p>
<pre><code>    script(src=&quot;components/angular-route/angular-route.js&quot;)
    script(src=&quot;javascripts/app.js&quot;)
</code></pre><p>Then in <strong>index.jade</strong>, paste in the menu we have used in other programs, where I have include a few extra lines to provide context:</p>
<pre><code class="lang-jade">extends layout
block content
    nav.navbar-default.navbar-fixed-top
        .container-fluid
            .navbar-header
                button(type=&quot;button&quot; class=&quot;navbar-toggle collapsed&quot; data-toggle=&quot;collapse&quot; data-target=&quot;#myTarget&quot;)
                    span.sr-only Toggle navigation
                    span.icon-bar
                    span.icon-bar
                    span.icon-bar
                a.navbar-brand(href=&quot;#/&quot;) Final
            #myTarget.collapse.navbar-collapse
                ul.nav.navbar-nav
                    li(ng-class=&quot;{ active: isActive(&#39;/&#39;)}&quot;)
                        a(ng-href=&#39;#/&#39;) Home
                    li(ng-class=&quot;{ active: isActive(&#39;/comments&#39;)}&quot;)
                        a(ng-href=&#39;#/comments&#39;) Comments
                    li(ng-class=&quot;{ active: isActive(&#39;/about&#39;)}&quot;)
                        a(ng-href=&#39;#/about&#39;) About
                    li(ng-class=&quot;{ active: isActive(&#39;/signin&#39;)}&quot;)
                        a(ng-href=&#39;#/{{themeController.signinMenuItem}}&#39;) {{themeController.signinMenuText}}
                    li(ng-switch=&quot;themeController.loggedIn&quot; ng-class=&quot;{ active: isActive(&#39;/login&#39;)}&quot;)
                        a(ng-switch-when=&quot;true&quot; ng-href=&#39;#/logout&#39;) Logout
                        a(ng-switch-default ng-href=&#39;#/login&#39;) Login

    h1= title
    p Welcome to #{title}
    div(data-ng-view=&quot;&quot;)
</code></pre>
<p>Here is a reference for ng-switch:</p>
<ul>
<li><a href="https://docs.angularjs.org/api/ng/directive/ngSwitch">ng-switch angular docs</a></li>
<li><a href="http://stackoverflow.com/a/14297556">ng-switch stackOverflow</a></li>
</ul>
<h2 id="step-three">Step Three</h2>
<p>Link in the passport sign in code.</p>
<ul>
<li>Copy the passport folder from the <a href="http://www.ccalvert.net/books/CloudNotes/Assignments/MongooseSignIn.html">sign in project</a>. It includes three files:<ul>
<li>init.js</li>
<li>login.js</li>
<li>signup.js</li>
</ul>
</li>
</ul>
<p>Here is init:</p>
<pre><code class="lang-javascript">var login = require(&#39;./login&#39;);
var signup = require(&#39;./signup&#39;);
var User = require(&#39;../models/user&#39;);

module.exports = function(passport) {

    // Passport needs to be able to serialize and deserialize
    // users to support persistent login sessions
    passport.serializeUser(function(user, done) {
        console.log(&#39;serializing user: &#39;);
        console.log(user);
        done(null, user._id);
    });

    passport.deserializeUser(function(id, done) {
        User.findById(id, function(err, user) {
            console.log(&#39;deserializing user:&#39;, user);
            done(err, user);
        });
    });

    // Setting up Passport Strategies for Login and SignUp/Registration
    login(passport);
    signup(passport);

};
</code></pre>
<p>Here is login:</p>
<pre><code class="lang-javascript">var LocalStrategy   = require(&#39;passport-local&#39;).Strategy;
var User = require(&#39;../models/user&#39;);
var bCrypt = require(&#39;bcrypt-nodejs&#39;);

module.exports = function(passport) {

    passport.use(&#39;login&#39;, new LocalStrategy({
            passReqToCallback : true
        },
        function(req, username, password, done) { 
            // check in mongo if a user with username exists or not
            User.findOne({ &#39;username&#39; :  username }, 
                function(err, user) {
                    // In case of any error, return using the done method
                    if (err)
                        return done(err);
                    // Username does not exist, log the error and redirect back
                    if (!user){
                        console.log(&#39;User Not Found with username &#39;+username);
                        return done(null, false);
                    }
                    // User exists but wrong password, log the error 
                    if (!isValidPassword(user, password)){
                        console.log(&#39;Invalid Password&#39;);
                        return done(null, false); // redirect back to login page
                    }
                    // User and password both match, return user from done method
                    // which will be treated like success
                    return done(null, user);
                }
            );

        })
    );


    var isValidPassword = function(user, password){
        return bCrypt.compareSync(password, user.password);
    }

};
</code></pre>
<p>Here is signup:</p>
<pre><code class="lang-javascript">var LocalStrategy   = require(&#39;passport-local&#39;).Strategy;
var User = require(&#39;../models/user&#39;);
var bCrypt = require(&#39;bcrypt-nodejs&#39;);

module.exports = function(passport){

    passport.use(&#39;signup&#39;, new LocalStrategy({
            passReqToCallback : true // allows us to pass back the entire request to the callback
        },
        function(req, username, password, done) {

            findOrCreateUser = function(){
                // find a user in Mongo with provided username
                User.findOne({ &#39;username&#39; :  username }, function(err, user) {
                    // In case of any error, return using the done method
                    if (err){
                        console.log(&#39;Error in SignUp: &#39;+err);
                        return done(err);
                    }
                    // already exists
                    if (user) {
                        console.log(&#39;User already exists with username: &#39;+username);
                        return done(null, false, req.flash(&#39;message&#39;,&#39;User Already Exists&#39;));
                    } else {
                        // if there is no user with that email
                        // create the user
                        var newUser = new User();

                        // set the user&#39;s local credentials
                        newUser.username = username;
                        newUser.password = createHash(password);
                        newUser.email = req.param(&#39;email&#39;);
                        newUser.firstName = req.param(&#39;firstName&#39;);
                        newUser.lastName = req.param(&#39;lastName&#39;);

                        // save the user
                        newUser.save(function(err) {
                            if (err){
                                console.log(&#39;Error in Saving user: &#39;+err);  
                                throw err;  
                            }
                            console.log(&#39;User Registration succesful&#39;);    
                            return done(null, newUser);
                        });
                    }
                });
            };
            // Delay the execution of findOrCreateUser and execute the method
            // in the next tick of the event loop
            process.nextTick(findOrCreateUser);
        })
    );

    // Generates hash using bCrypt
    var createHash = function(password){
        return bCrypt.hashSync(password, bCrypt.genSaltSync(10), null);
    }

};
</code></pre>
<p>From the sign in project, copy <strong>models/user.js</strong> and place it in the <strong>models</strong> folder of this project.</p>
<pre><code class="lang-javascript">var mongoose = require(&#39;mongoose&#39;);

var userSchema = mongoose.Schema({
    id: String,
    firstName: String,
    lastName: String,
    username: String,
    password: String,
    email: String
});

module.exports = mongoose.model(&#39;User&#39;, userSchema);
</code></pre>
<p>Copy <strong>SpaceNeedle.png</strong> or some similar file into <strong>public/images</strong>.</p>
<p>Copy in the CSS from the <a href="http://www.ccalvert.net/books/CloudNotes/Assignments/MongooseSignIn.html">SignIn</a> assignment.</p>
<h2 id="step-four">Step Four</h2>
<p>Most things on the backend for passport are the same. Just make sure you get rid of all references to <strong>flash</strong>.</p>
<p>We are going to create a file called <strong>routes/login.js</strong>. It provides new middleware routes for logging in. This is like the example code from the previous example that was found in <strong>routes/index.js</strong>, but now we don&#39;t invoke it off the main route (&#39;/&#39;), instead we have <strong>login</strong> route (&#39;/login&#39;).</p>
<p>Here are the changes to make in <strong>app.js</strong>. You can keep the loading of routes middleware the same:</p>
<pre><code>var routes = require(&#39;./routes/index&#39;);
var users = require(&#39;./routes/users&#39;);
var comments = require(&#39;./routes/comments&#39;);
</code></pre><p>And then further down we have code that is quite similar to the original example:</p>
<pre><code>// Configuring Passport
var passport = require(&#39;passport&#39;);
var expressSession = require(&#39;express-session&#39;);
app.use(expressSession({
      secret: &#39;mySecretKey&#39;,
      resave: true,
      saveUninitialized: true
    })
);
app.use(passport.initialize());
app.use(passport.session());

// Initialize Passport
var initPassport = require(&#39;./passport/init&#39;);
initPassport(passport);

var login = require(&#39;./routes/login&#39;)(passport);
app.use(&#39;/&#39;, routes);
app.use(&#39;/users&#39;, users);
app.use(&#39;/comments&#39;, comments);
app.use(&#39;/login&#39;, login);
</code></pre><p>Notice the last line, where we load the new middleware for handling our new <strong>login</strong> route.</p>
<p>And below you see <strong>routes/login.js</strong>. Notice that this is pretty much the same as in our login example, but the <strong>post(&#39;/login&#39;</strong> method has been replaced (I commented out the old version):</p>
<pre><code>/**
 * Created by charlie on 6/11/2015.
 */

var express = require(&#39;express&#39;);
var router = express.Router();

module.exports = function(passport) {

    router.post(&#39;/login&#39;, passport.authenticate(&#39;login&#39;),
        function(req, res) {
            res.send(req.user);
        }
    );

    router.get(&#39;/logout&#39;, function(request, response){
        request.logOut();
        response.sendStatus(200);
    });

    router.get(&#39;/loggedin&#39;, function(request, response) {
        response.send(request.isAuthenticated() ? true : false);
    });

    router.get(&#39;/signup&#39;, function(req, res) {
        console.log(&#39;Get signup&#39;);
        res.render(&#39;register&#39;, {});
    });

    /* Handle Registration POST */
    router.post(&#39;/signup&#39;, passport.authenticate(&#39;signup&#39;, {
        successRedirect: &#39;/#/login&#39;,
        failureRedirect: &#39;/signup&#39;
    }));


    return router;
};
</code></pre><p>Notice that we have replaced this method from the routes folder:</p>
<pre><code>router.post(&#39;/login&#39;, passport.authenticate(&#39;login&#39;, {
    successRedirect: &#39;/#/home&#39;,
    failureRedirect: &#39;/&#39;
}));
</code></pre><p>With this one:</p>
<pre><code>router.post(&#39;/login&#39;, passport.authenticate(&#39;login&#39;),
    function(req, res) {
        res.send(req.user);
        }
);
</code></pre><h2 id="step-five">Step Five</h2>
<p>We need a login route in app.js:</p>
<p>Put this code in <strong>public/javascripts/app.js</strong>:</p>
<pre><code>var myModule = angular.module(&quot;elvenApp&quot;, [ &#39;ngRoute&#39; ]);

myModule.config(function($routeProvider, $httpProvider, $locationProvider) {

    //================================================
    // Check if the user is connected
    //================================================
    var checkLoggedin = function($q, $timeout, $http, $location, $rootScope){
        // Initialize a new promise
        var deferred = $q.defer();

        // Make an AJAX call to check if the user is logged in
        $http.get(&#39;/login/loggedin&#39;).success(function(result){
            // Authenticated
            if (result !== false)
            /*$timeout(deferred.resolve, 0);*/
                deferred.resolve();

            // Not Authenticated
            else {
                $rootScope.message = &#39;You need to log in.&#39;;
                //$timeout(function(){deferred.reject();}, 0);
                deferred.reject();
                $location.url(&#39;/login&#39;);
            }
        });

        return deferred.promise;
    };

    //================================================
    // Add an interceptor for AJAX errors
    //================================================
    $httpProvider.interceptors.push(function($q, $location) {
        return {
            response: function(response) {
                // do something on success
                return response;
            },
            responseError: function(response) {
                if (response.status === 401) {
                    console.log(&#39;status 401&#39;);
                    $location.url(&#39;/login&#39;);
                }
                return $q.reject(response);
            }
        };
    });    

    //================================================
    // Define all the routes
    //================================================
    $routeProvider.when(&quot;/&quot;, {
        templateUrl : &quot;main&quot;,
        controller : &quot;MainController&quot;,
        controllerAs: &quot;mainController&quot;
    }).when(&#39;/comments&#39;, {
        templateUrl : &quot;comments&quot;,
        controller : &quot;CommentsController&quot;,
        controllerAs: &#39;commentsController&#39;,
        resolve: {
            loggedin: checkLoggedin
        }
    }).when(&#39;/about&#39;, {
        templateUrl : &quot;about&quot;,
        controller : &quot;AboutController&quot;,
        controllerAs: &#39;aboutController&#39;
    }).when(&#39;/login&#39;, {
        templateUrl : &quot;login&quot;,
        controller : &quot;LoginController&quot;,
        controllerAs: &#39;loginController&#39;
    }).when(&#39;/logout&#39;, {
        templateUrl : &quot;logout&quot;,
        controller : &quot;LogoutController&quot;,
        controllerAs: &#39;logoutController&#39;
    }).when(&#39;/register&#39;, {
        templateUrl : &quot;register&quot;
    }).otherwise({
        redirectTo : &#39;/&#39;
    });
});
</code></pre><p>Near the top of the file, you will have to inject the <strong>$httpProvider</strong> in the signature for the config provider:</p>
<pre><code>myModule.config(function($routeProvider, $httpProvider, $locationProvider) {
</code></pre><p>This is your updated login jade, which has been adapted to work with angular:</p>
<pre><code>extends layout
block content
   div.container
      #main.row
         div.col-sm-6.col-md-4.col-md-offset-4
            h1.text-center.login-title {{loginController.hint}}
               div.account-wall
                  img(class=&#39;profile-img&#39;, src=&#39;images/SpaceNeedle.png&#39;)
                  form.form-signin(novalidate=&#39;&#39;)
                     input.form-control(type=&#39;text&#39;, ng-model=&#39;loginController.userName&#39; placeholder=&#39;UserName&#39;,required, autofocus)
                     input.form-control(type=&#39;password&#39;, ng-model=&#39;loginController.password&#39; placeholder=&#39;Password&#39;, required)
                     button.btn.btn-lg.btn-primary.btn-block(type=&#39;submit&#39;, ng-click=&#39;loginController.update()&#39;) Sign in
                     span.clearfix
               a(href=&#39;/login/signup&#39;, class=&#39;text-center new-account&#39;) Create an account
               #message
               if message
                  h1.text-center.error-message #{message}
</code></pre><p>This is your login controller:</p>
<pre><code>var app = angular.module(&#39;elvenApp&#39;);

app.controller(&#39;LoginController&#39;, function($http, $location, themeFactory) {
    var loginController = this;
    loginController.hint = &quot;Sign in&quot;;

    loginController.update = function() {
        console.log(&#39;update&#39;);
        var user = {
            &quot;username&quot;: loginController.userName,
            &quot;password&quot;: loginController.password
        };

        $http.post(&#39;/login/login/&#39;, user).success(function(user) {
            themeFactory.setLogin(true);
            console.log(user);
            $location.path(&#39;/&#39;);
        }).error(function(err) {
            loginController.hint = &#39;Bad Password/User. Try again&#39;;
        })
    }
});
</code></pre><p>Notice how it works. We have two paths:</p>
<ul>
<li>success</li>
<li>error</li>
</ul>
<p>If the user is logged in successfully the success path is invoked and the user is redirected back to the home page. We are also passed information about the user from our database. That is, we are passed the user name, email, etc. If the error path is invoked, then a hint is displayed telling the user to try again.</p>
<p>Here is the register (signup) jade file:</p>
<pre><code>extends layout

block content
    div.container
        div.row
            div.col-sm-6.col-md-4.col-md-offset-4
                h1.text-center.login-title Registration Details
                    div.signup-wall
                        form(class=&#39;form-signin&#39;, action=&#39;/login/signup&#39;, method=&#39;POST&#39;)
                            input(type=&#39;text&#39;, name=&#39;username&#39;, class=&#39;form-control&#39;, placeholder=&#39;Username&#39;,required, autofocus)
                            input(type=&#39;password&#39;, name=&#39;password&#39;, class=&#39;form-control nomargin&#39;, placeholder=&#39;Password&#39;, required)
                            input(type=&#39;email&#39;, name=&#39;email&#39;, class=&#39;form-control&#39;, placeholder=&#39;Email&#39;,required)
                            input(type=&#39;text&#39;, name=&#39;firstName&#39;, class=&#39;form-control&#39;, placeholder=&#39;First Name&#39;,required)
                            input(type=&#39;text&#39;, name=&#39;lastName&#39;, class=&#39;form-control&#39;, placeholder=&#39;Last Name&#39;,required)
                            button(class=&#39;btn btn-lg btn-primary btn-block&#39;, type=&#39;submit&#39;) Register
                            span.clearfix
                    #message
                        if message
                            h1.text-center.error-message #{message}
</code></pre><p>We now have signup working. If you need be, however, you can create a user using the signup <a href="http://www.ccalvert.net/books/CloudNotes/Assignments/MongooseSignIn.html">assignment</a> example. Then switch back to this code.</p>
<h2 id="step-six">Step Six</h2>
<p>Logging out.</p>
<p>Here is the logout controller:</p>
<pre><code class="lang-javascript">var app = angular.module(&#39;elvenApp&#39;);

app.controller(&#39;LogoutController&#39;, function($http, $sce, $location, themeFactory) {
    var logoutController = this;
    logoutController.hint = &quot;Sign in&quot;;
    logoutController.loggedInStatus = &quot;unknown&quot;;

    logoutController.logout = function() {
        console.log(&#39;logout&#39;);

        $http.get(&#39;/login/logout/&#39;).success(function(user) {
            themeFactory.setLogin(false);
            console.log(user);
        }).error(function(err) {
            logoutController.hint = &#39;Could not call logout&#39;;
            logoutController.error = $sce.trustAsHtml(err);
        })
    };

    logoutController.isLoggedIn = function() {

        $http.get(&#39;/login/loggedin/&#39;).success(function(user) {
            logoutController.loggedInStatus = user;
        }).error(function(err) {
            logoutController.hint = &#39;Bad Password/User. Try again&#39;;
        });
    };

    logoutController.logout();
});
</code></pre>
<p>We have already added the following at the bottom of <strong>routes/login.js</strong>. </p>
<pre><code>router.get(&#39;/logout&#39;, function(request, response){
    request.logOut();
    response.sendStatus(200);
});

router.get(&#39;/loggedin&#39;, function(request, response) {
    response.send(request.isAuthenticated() ? true : false);
});
</code></pre><p>Tie together the login and log out code and provide support for switching themes:</p>
<pre><code>(function () {

    var app = angular.module(&#39;elvenApp&#39;);

    app.factory(&#39;themeFactory&#39;, function() {
        var themeFactory = {
            themeController: null,
            setLogin: function(init) {
                themeFactory.themeController.loggedIn = init;
            }
        }

        return themeFactory;
    });

    app.controller(&#39;ThemeController&#39;, function (themeFactory) {
        var themeController = this;
        themeController.loggedIn = false;
        themeFactory.themeController = themeController;
        themeController.bootStrapCss = &quot;cosmo&quot;;
        themeController.bootStrapThemes = [
            {name: &quot;Cerulean&quot;, url: &quot;cerulean&quot;},
            {name: &quot;Cosmo&quot;, url: &quot;cosmo&quot;},
            {name: &quot;Cyborg&quot;, url: &quot;cyborg&quot;},
                        etc...
        ];
    });

})();
</code></pre><p>Notice that the themeFactory is used in the <strong>login</strong> and <strong>logout</strong> controllers.</p>
<h2 id="step-seven">Step Seven</h2>
<p>Here is <strong>public/javascripts/comments.jade</strong></p>
<pre><code>(function() {

    var app = angular.module(&#39;elvenApp&#39;);

    app.controller(&#39;CommentsController&#39;, function(mongoFactory, commentFactory) {
        var commentsController = this;

        commentsController.updateComment = function() {
            commentFactory.updateComment(commentsController.scientist);
        };

        // Code omitted here....

        function getScientist() {
            mongoFactory.getScientistById(mongoFactory.currentId, commentsController);
        }

        getScientist();
    });

})();
</code></pre><p>Here is the code from <strong>mongo-factory</strong> that provides you with a <strong>name</strong> property you can display at the top of the <strong>edit</strong>, <strong>comments</strong>, and <strong>subjects</strong> pages of your final:</p>
<pre><code class="lang-javascript">    setControllerName: function(controller) {
        controller.name = controller.scientist.firstName + &#39; &#39; + controller.scientist.lastName;
    },
</code></pre>
<p>Call it from <strong>getScientistById</strong>.</p>
<p>This means that a file like <strong>comments.jade</strong> will would begin like this:</p>
<pre><code>h1 Comments: {{commentsController.name}}
div.names
    ul
        li(ng-repeat=&#39;comment in commentsController.scientist.comments&#39;)
            a(ng-click=&quot;commentsController.selectComment(comment)&quot;) {{comment.commentText}}
</code></pre><p>The fist line shows how to use the new <strong>name</strong> property.</p>
<h2 id="hints">Hints</h2>
<p>You may get a warning &#39;Synchronous XMLHttpRequest on the main thread is deprecated&#39;. I believe this has something to do with the dialog we are loading to login and the related code. I don&#39;t think it has to do with the way we are rerouting events. In other words, it happens when we go directly to the login page, not just when we get there from the comments link. For now we are ignorning this warning.</p>
</div></body></html>