<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width initial-scale=1.0"><title>PointerLock</title><link rel="shortcut icon" href="/charlie/images/favicon.png"><!-- Latest compiled and minified CSS--><link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap.min.css"><!-- Optional theme--><link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap-theme.min.css"><!-- link(href='/libs/css/BootstrapIndex.css', rel='stylesheet', type='text/css')--><link href="/css/style.css" rel="stylesheet" type="text/css"><link href="/css/highlight/googlecode.css" rel="stylesheet" type="text/css"><script src="/components/jquery/dist/jquery.js"></script><script src="/components/angular/angular.js"></script><script src="/components/angular-route/angular-route.js"></script><script src="/components/bootstrap/dist/js/bootstrap.min.js"></script><!-- script(src='/libs/scripts/elvenware.js', type='text/javascript')--><script src="/libs/scripts/Control.js"></script><!-- script(src='http://localhost:35729/livereload.js')--></head><body><div class="navbar navbar-inverse"><div class="container"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target=".navbar-collapse" class="navbar-toggle"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">Elvenware</a></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li class="active"><a href="/index.html">Home</a></li><li><a href="/about">About</a></li><li class="dropdown"><a href="#/" data-toggle="dropdown" class="dropdown-toggle">Dropdown<b class="caret"></b></a><ul class="dropdown-menu"><li class="dropdown-header">Core Code</li><li><a href="/charlie/development/index.html">Strongly Typed</a></li><li><a href="/charlie/development/web/index.html">Web & Scripts</a></li><li><a href="/charlie/development/cloud/index.shtml">Cloud</a></li><li class="divider"></li><li class="dropdown-header">OS and Tools</li><li><a href="/os/index.html">OS</a></li><li><a href="/charlie/development/database/index.html">Database</a></li><li><a href="/books/index.html">My Writing</a></li><li class="divider"></li><li class="dropdown-header">Art</li><li><a href="/charlie/Art/index.html">Poems & Photos</a></li><li><a href="/books/reading/index.html">Book Reviews</a></li><li><a href="/spirit/index.html">Spiritual</a></li><li class="divider"></li><li class="dropdown-header">Links</li><li><a href="/charlie/links.html">My Links</a></li><li><a href="http://www.github.com/charliecalvert">GitHub</a></li><li><a href="http://sourceforge.net/projects/elvenware/">Sourceforge</a></li></ul></li></ul></div><!-- /.nav-collapse--></div></div><div class="container"><figure><img alt="Elvenware" src="/charlie/images/elvenwarelogo.png"/></figure><h1>PointerLock</h1><h3>Table of Contents</h3><ul><!--TOC_Start--><li><a href="#pointerlock">PointerLock</a></li>
<li><a href="#get-started">Get Started</a></li>
<li><a href="#the-html">The HTML</a></li>
<li><a href="#set-up-pointerlock">Set up PointerLock</a></li>
<li><a href="#render-or-animate">Render or Animate</a></li>
<li><a href="#collision-detection">Collision Detection</a></li>
<li><a href="#text">Text</a></li>
<li><a href="#jscs-ignore">JSCS Ignore</a></li><!--TOC_End--></ul><h1 id="pointerlock">PointerLock</h1>
<p>As mentioned earlier, navigating through a scene with the keyboard and mouse can be a tricky task. Fortunately, there is existing code for doing. In this assignment, we will add that code to our existing project.</p>
<h2 id="get-started">Get Started</h2>
<p>Copy the ThreeFloor program into a new folder called <strong>Week04-PointerLock</strong>.</p>
<h2 id="the-html">The HTML</h2>
<p>The next step is to show HTML that tells the user to start game. Put this code in index.jade:</p>
<pre><code>extends layout

block content

  div#blocker(<span class="hljs-name">style=</span>'display: -webkit-box<span class="hljs-comment">;')</span>
    div#instructions(<span class="hljs-name">style=</span>'')
      span(<span class="hljs-name">style=</span>'font-size:<span class="hljs-number">40</span>px') Click to play
      p (<span class="hljs-name">W</span>, A, S, D = Move, SPACE = Jump, MOUSE = Look around)
</code></pre><p>Here is the CSS:</p>
<pre><code>
<span class="hljs-selector-tag">html</span>, <span class="hljs-selector-tag">body</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
}

<span class="hljs-selector-tag">body</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ffffff</span>;
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">overflow</span>: hidden;
    <span class="hljs-attribute">font-family</span>: arial;
}

<span class="hljs-selector-id">#content</span> {
    <span class="hljs-attribute">display</span>: block;
}


<span class="hljs-selector-id">#blocker</span> {

    <span class="hljs-attribute">position</span>: absolute;

    <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;

    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.5</span>);

}

<span class="hljs-selector-id">#instructions</span> {

    <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;

    <span class="hljs-attribute">display</span>: -webkit-box;
    <span class="hljs-attribute">display</span>: -moz-box;
    <span class="hljs-attribute">display</span>: box;

    <span class="hljs-attribute">-webkit-box-orient</span>: horizontal;
    <span class="hljs-attribute">-moz-box-orient</span>: horizontal;
    <span class="hljs-attribute">box-orient</span>: horizontal;

    <span class="hljs-attribute">-webkit-box-pack</span>: center;
    <span class="hljs-attribute">-moz-box-pack</span>: center;
    <span class="hljs-attribute">box-pack</span>: center;

    <span class="hljs-attribute">-webkit-box-align</span>: center;
    <span class="hljs-attribute">-moz-box-align</span>: center;
    <span class="hljs-attribute">box-align</span>: center;

    <span class="hljs-attribute">color</span>: <span class="hljs-number">#ffffff</span>;
    <span class="hljs-attribute">text-align</span>: center;

    <span class="hljs-attribute">cursor</span>: pointer;

}
</code></pre><p>##PointerLock Implementation</p>
<p>Here is my (slightly modified) version of the the boilerplate PointerLock code. This is from the <a href="https://github.com/mrdoob/three.js/blob/master/examples/js/controls/PointerLockControls.js">Three.js site</a>, and is used widely. Put it in a file called <strong>PointerLockControls.js</strong>:</p>
<pre><code><span class="hljs-comment">/**
 * @author mrdoob / http://mrdoob.com/
 */</span>

THREE.PointerLockControls = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">camera</span>) </span>{

    <span class="hljs-keyword">var</span> scope = <span class="hljs-keyword">this</span>;

    camera.rotation.set(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

    <span class="hljs-keyword">var</span> pitchObject = <span class="hljs-keyword">new</span> THREE.Object3D();
    pitchObject.add(camera);

    <span class="hljs-keyword">var</span> yawObject = <span class="hljs-keyword">new</span> THREE.Object3D();
    yawObject.position.y = <span class="hljs-number">10</span>;
    yawObject.add(pitchObject);

    <span class="hljs-keyword">var</span> moveForward = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> moveBackward = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> moveLeft = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> moveRight = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">var</span> isOnObject = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> canJump = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">var</span> prevTime = performance.now();

    <span class="hljs-keyword">var</span> velocity = <span class="hljs-keyword">new</span> THREE.Vector3();

    <span class="hljs-keyword">var</span> PI_2 = <span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">2</span>;

    <span class="hljs-keyword">var</span> onMouseMove = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{

        <span class="hljs-keyword">if</span> (scope.enabled === <span class="hljs-literal">false</span>) <span class="hljs-keyword">return</span>;

        <span class="hljs-keyword">var</span> movementX = event.movementX || event.mozMovementX || event.webkitMovementX || <span class="hljs-number">0</span>;
        <span class="hljs-keyword">var</span> movementY = event.movementY || event.mozMovementY || event.webkitMovementY || <span class="hljs-number">0</span>;

        yawObject.rotation.y -= movementX * <span class="hljs-number">0.002</span>;
        pitchObject.rotation.x -= movementY * <span class="hljs-number">0.002</span>;

        pitchObject.rotation.x = <span class="hljs-built_in">Math</span>.max(-PI_2, <span class="hljs-built_in">Math</span>.min(PI_2, pitchObject.rotation.x));

    };

    <span class="hljs-keyword">var</span> onKeyDown = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{

        <span class="hljs-keyword">switch</span> (event.keyCode) {

            <span class="hljs-keyword">case</span> <span class="hljs-number">38</span>: <span class="hljs-comment">// up</span>
            <span class="hljs-keyword">case</span> <span class="hljs-number">87</span>: <span class="hljs-comment">// w</span>
                moveForward = <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-number">37</span>: <span class="hljs-comment">// left</span>
            <span class="hljs-keyword">case</span> <span class="hljs-number">65</span>: <span class="hljs-comment">// a</span>
                moveLeft = <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-number">40</span>: <span class="hljs-comment">// down</span>
            <span class="hljs-keyword">case</span> <span class="hljs-number">83</span>: <span class="hljs-comment">// s</span>
                moveBackward = <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-number">39</span>: <span class="hljs-comment">// right</span>
            <span class="hljs-keyword">case</span> <span class="hljs-number">68</span>: <span class="hljs-comment">// d</span>
                moveRight = <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-number">32</span>: <span class="hljs-comment">// space</span>
                <span class="hljs-keyword">if</span> (canJump === <span class="hljs-literal">true</span>) velocity.y += <span class="hljs-number">350</span>;
                canJump = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">break</span>;

        }

    };

    <span class="hljs-keyword">var</span> onKeyUp = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{

        <span class="hljs-keyword">switch</span> (event.keyCode) {

            <span class="hljs-keyword">case</span> <span class="hljs-number">38</span>: <span class="hljs-comment">// up</span>
            <span class="hljs-keyword">case</span> <span class="hljs-number">87</span>: <span class="hljs-comment">// w</span>
                moveForward = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-number">37</span>: <span class="hljs-comment">// left</span>
            <span class="hljs-keyword">case</span> <span class="hljs-number">65</span>: <span class="hljs-comment">// a</span>
                moveLeft = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-number">40</span>: <span class="hljs-comment">// down</span>
            <span class="hljs-keyword">case</span> <span class="hljs-number">83</span>: <span class="hljs-comment">// s</span>
                moveBackward = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-number">39</span>: <span class="hljs-comment">// right</span>
            <span class="hljs-keyword">case</span> <span class="hljs-number">68</span>: <span class="hljs-comment">// d</span>
                moveRight = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">break</span>;

        }

    };

    <span class="hljs-built_in">document</span>.addEventListener(<span class="hljs-string">'mousemove'</span>, onMouseMove, <span class="hljs-literal">false</span>);
    <span class="hljs-built_in">document</span>.addEventListener(<span class="hljs-string">'keydown'</span>, onKeyDown, <span class="hljs-literal">false</span>);
    <span class="hljs-built_in">document</span>.addEventListener(<span class="hljs-string">'keyup'</span>, onKeyUp, <span class="hljs-literal">false</span>);

    <span class="hljs-keyword">this</span>.enabled = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">this</span>.getObject = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">return</span> yawObject;

    };

    <span class="hljs-keyword">this</span>.isOnObject = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">boolean</span>) </span>{

        isOnObject = boolean;
        canJump = boolean;

    };

    <span class="hljs-keyword">this</span>.getDirection = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        <span class="hljs-comment">// assumes the camera itself is not rotated</span>

        <span class="hljs-keyword">var</span> direction = <span class="hljs-keyword">new</span> THREE.Vector3(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>);
        <span class="hljs-keyword">var</span> rotation = <span class="hljs-keyword">new</span> THREE.Euler(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"YXZ"</span>);

        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v</span>) </span>{

            rotation.set(pitchObject.rotation.x, yawObject.rotation.y, <span class="hljs-number">0</span>);

            v.copy(direction).applyEuler(rotation);

            <span class="hljs-keyword">return</span> v;

        }

    }();

    <span class="hljs-keyword">this</span>.update = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">if</span> (scope.enabled === <span class="hljs-literal">false</span>) <span class="hljs-keyword">return</span>;

        <span class="hljs-keyword">var</span> time = performance.now();
        <span class="hljs-keyword">var</span> delta = (time - prevTime) / <span class="hljs-number">1000</span>;

        velocity.x -= velocity.x * <span class="hljs-number">10.0</span> * delta;
        velocity.z -= velocity.z * <span class="hljs-number">10.0</span> * delta;

        velocity.y -= <span class="hljs-number">9.8</span> * <span class="hljs-number">100.0</span> * delta; <span class="hljs-comment">// 100.0 = mass</span>

        <span class="hljs-keyword">if</span> (moveForward) velocity.z -= <span class="hljs-number">400.0</span> * delta;
        <span class="hljs-keyword">if</span> (moveBackward) velocity.z += <span class="hljs-number">400.0</span> * delta;

        <span class="hljs-keyword">if</span> (moveLeft) velocity.x -= <span class="hljs-number">400.0</span> * delta;
        <span class="hljs-keyword">if</span> (moveRight) velocity.x += <span class="hljs-number">400.0</span> * delta;

        <span class="hljs-comment">// I've changed this code to stop all movement if we</span>
        <span class="hljs-comment">// are about to hit something. Compare to original</span>
        <span class="hljs-comment">// which only set y.</span>
        <span class="hljs-keyword">if</span> (isOnObject === <span class="hljs-literal">true</span>) {

            velocity.y = <span class="hljs-built_in">Math</span>.max(<span class="hljs-number">0</span>, velocity.y);
            velocity.x = <span class="hljs-number">0</span>;
            velocity.z = <span class="hljs-number">0</span>;

        }

        yawObject.translateX(velocity.x * delta);
        yawObject.translateY(velocity.y * delta);
        yawObject.translateZ(velocity.z * delta);

        <span class="hljs-keyword">if</span> (yawObject.position.y &lt; <span class="hljs-number">10</span>) {

            velocity.y = <span class="hljs-number">0</span>;
            yawObject.position.y = <span class="hljs-number">10</span>;

            canJump = <span class="hljs-literal">true</span>;

        }

        prevTime = time;

    };

};
</code></pre><p>Remember that you will need to modify both <strong>Main.js</strong> and the top of <strong>Control.js</strong>. You need to make these changes so that <strong>require</strong> will know how to load these two new files. We have already seen how to make those changes with <strong>Floors.js</strong>, now apply the same knowledge to <strong>PointerLockControls</strong> and <strong>PointerLockSetup</strong>. Remember that <strong>PointerLockControls.js</strong> will need to be shimmed in.</p>
<p>##PointerLockSetup</p>
<p>Here is a file I put together to help automate the process of loading the PointerLockControl code:</p>
<pre><code>define([<span class="hljs-string">'PointerLockControls'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pointerLock</span>) </span>{
<span class="hljs-meta">
    'use strict'</span>;

    <span class="hljs-keyword">var</span> element;
    <span class="hljs-keyword">var</span> blocker;
    <span class="hljs-keyword">var</span> instructions;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">PointerLockSetup</span>(<span class="hljs-params">controls</span>) </span>{

        blocker = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'blocker'</span>);
        instructions = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'instructions'</span>);

        <span class="hljs-keyword">var</span> havePointerLock = <span class="hljs-string">'pointerLockElement'</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">document</span> || <span class="hljs-string">'mozPointerLockElement'</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">document</span> || <span class="hljs-string">'webkitPointerLockElement'</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">document</span>;

        <span class="hljs-keyword">if</span> (havePointerLock) {

            element = <span class="hljs-built_in">document</span>.body;

            <span class="hljs-keyword">var</span> pointerlockchange = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{

                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">document</span>.pointerLockElement === element || <span class="hljs-built_in">document</span>.mozPointerLockElement === element || <span class="hljs-built_in">document</span>.webkitPointerLockElement === element) {

                    controls.enabled = <span class="hljs-literal">true</span>;

                    blocker.style.display = <span class="hljs-string">'none'</span>;

                } <span class="hljs-keyword">else</span> {

                    controls.enabled = <span class="hljs-literal">false</span>;

                    blocker.style.display = <span class="hljs-string">'-webkit-box'</span>;
                    blocker.style.display = <span class="hljs-string">'-moz-box'</span>;
                    blocker.style.display = <span class="hljs-string">'box'</span>;

                    instructions.style.display = <span class="hljs-string">''</span>;

                }
            };

            <span class="hljs-keyword">var</span> pointerlockerror = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{

                instructions.style.display = <span class="hljs-string">''</span>;

            };

            <span class="hljs-comment">// Hook pointer lock state change events</span>
            <span class="hljs-built_in">document</span>.addEventListener(<span class="hljs-string">'pointerlockchange'</span>, pointerlockchange, <span class="hljs-literal">false</span>);
            <span class="hljs-built_in">document</span>.addEventListener(<span class="hljs-string">'mozpointerlockchange'</span>, pointerlockchange, <span class="hljs-literal">false</span>);
            <span class="hljs-built_in">document</span>.addEventListener(<span class="hljs-string">'webkitpointerlockchange'</span>, pointerlockchange, <span class="hljs-literal">false</span>);

            <span class="hljs-built_in">document</span>.addEventListener(<span class="hljs-string">'pointerlockerror'</span>, pointerlockerror, <span class="hljs-literal">false</span>);
            <span class="hljs-built_in">document</span>.addEventListener(<span class="hljs-string">'mozpointerlockerror'</span>, pointerlockerror, <span class="hljs-literal">false</span>);
            <span class="hljs-built_in">document</span>.addEventListener(<span class="hljs-string">'webkitpointerlockerror'</span>, pointerlockerror, <span class="hljs-literal">false</span>);

            instructions.addEventListener(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{

                instructions.style.display = <span class="hljs-string">'none'</span>;

                <span class="hljs-comment">// Ask the browser to lock the pointer</span>
                element.requestPointerLock = element.requestPointerLock || element.mozRequestPointerLock || element.webkitRequestPointerLock;

                <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/Firefox/i</span>.test(navigator.userAgent)) {

                    <span class="hljs-keyword">var</span> fullscreenchange = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{

                        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">document</span>.fullscreenElement === element || <span class="hljs-built_in">document</span>.mozFullscreenElement === element || <span class="hljs-built_in">document</span>.mozFullScreenElement === element) {

                            <span class="hljs-built_in">document</span>.removeEventListener(<span class="hljs-string">'fullscreenchange'</span>, fullscreenchange);
                            <span class="hljs-built_in">document</span>.removeEventListener(<span class="hljs-string">'mozfullscreenchange'</span>, fullscreenchange);

                            element.requestPointerLock();
                        }

                    };

                    <span class="hljs-built_in">document</span>.addEventListener(<span class="hljs-string">'fullscreenchange'</span>, fullscreenchange, <span class="hljs-literal">false</span>);
                    <span class="hljs-built_in">document</span>.addEventListener(<span class="hljs-string">'mozfullscreenchange'</span>, fullscreenchange, <span class="hljs-literal">false</span>);

                    element.requestFullscreen = element.requestFullscreen || element.mozRequestFullscreen || element.mozRequestFullScreen || element.webkitRequestFullscreen;

                    element.requestFullscreen();

                } <span class="hljs-keyword">else</span> {
                    element.requestPointerLock();
                }

            }, <span class="hljs-literal">false</span>);

        } <span class="hljs-keyword">else</span> {

            instructions.innerHTML = <span class="hljs-string">'Your browser doesn\'t seem to support Pointer Lock API'</span>;

        }
    }

    <span class="hljs-keyword">return</span> PointerLockSetup;

});
</code></pre><p>##Initialize</p>
<p>Let&#39;s move the code to initialize the engine out of the constructor and into a method called <strong>init</strong>:</p>
<pre><code><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Control</span><span class="hljs-params">()</span> </span>{
    init();
    animate();
}
</code></pre><p>We now start the app by first initializing our engine, and by then rendering the game in our render loop.</p>
<p>You will need to declare a object scoped variables called <strong>size</strong> and <strong>cubes</strong>. Set <strong>size</strong> equal to 20. In <strong>addCube</strong>, when you create the cube, make it size X size X size square, like this:</p>
<pre><code>var geometry = <span class="hljs-keyword">new</span> THREE.BoxGeometry(<span class="hljs-keyword">size</span>, <span class="hljs-keyword">size</span>, <span class="hljs-keyword">size</span>);
</code></pre><p>And when you create a cube, in <strong>addCube</strong>, you need to call <strong>cubes.push(cube)</strong>, where cubes is an object scoped array (var cubes = []).</p>
<p>After you make the cubes bigger, you are going to have to change the way you lay out the boxes. They are now much bigger than they were before and so they will be further apart.</p>
<p>The init method looks like this:</p>
<pre><code><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span>(<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">var</span> screenWidth = <span class="hljs-built_in">window</span>.innerWidth / <span class="hljs-built_in">window</span>.innerHeight;
    camera = <span class="hljs-keyword">new</span> THREE.PerspectiveCamera(<span class="hljs-number">75</span>, screenWidth, <span class="hljs-number">1</span>, <span class="hljs-number">1000</span>);

    scene = <span class="hljs-keyword">new</span> THREE.Scene();
    scene.fog = <span class="hljs-keyword">new</span> THREE.Fog(<span class="hljs-number">0xffffff</span>, <span class="hljs-number">0</span>, <span class="hljs-number">750</span>);

    addCubes(scene, camera, <span class="hljs-literal">false</span>);

    doPointerLock();

    addLights();

    <span class="hljs-keyword">var</span> floors = <span class="hljs-keyword">new</span> Floors();
    floors.drawFloor(scene);

    raycaster = <span class="hljs-keyword">new</span> THREE.Raycaster(<span class="hljs-keyword">new</span> THREE.Vector3(),
        <span class="hljs-keyword">new</span> THREE.Vector3(<span class="hljs-number">0</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>), <span class="hljs-number">0</span>, <span class="hljs-number">10</span>);

    renderer = <span class="hljs-keyword">new</span> THREE.WebGLRenderer({ antialias : <span class="hljs-literal">true</span> });

    renderer.setSize(<span class="hljs-built_in">window</span>.innerWidth, <span class="hljs-built_in">window</span>.innerHeight);
    <span class="hljs-built_in">document</span>.body.appendChild(renderer.domElement);

    <span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">'resize'</span>, onWindowResize, <span class="hljs-literal">false</span>);
}
</code></pre><h2 id="set-up-pointerlock">Set up PointerLock</h2>
<p>Here is a function to instantiate an instance of the PointerLockControls:</p>
<pre><code><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doPointerLock</span><span class="hljs-params">()</span> </span>{
    controls = <span class="hljs-keyword">new</span> THREE.PointerLockControls(camera);
    <span class="hljs-keyword">var</span> yawObject = controls.getObject();
    scene.add(yawObject);

    <span class="hljs-comment">// Move camera to the 1, 1 position</span>
    yawObject.position.x = size;
    yawObject.position.z = size;

    <span class="hljs-keyword">var</span> ps = <span class="hljs-keyword">new</span> PointerLockSetup(controls);
}
</code></pre><p>Note that we create an instance of <strong>PointerLockControls</strong> and store it in a variable called controls. That instance is scoped to be visible inside the entirety of the Controls. It has object scope.</p>
<h2 id="render-or-animate">Render or Animate</h2>
<p>Here is a function to replace our previous render method. Note that I have changed the name from <strong>render</strong> to <strong>animate</strong>.</p>
<pre><code><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">animate</span><span class="hljs-params">()</span> </span>{

    requestAnimationFrame(animate);

    <span class="hljs-keyword">var</span> xAxis = <span class="hljs-keyword">new</span> THREE.Vector3(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

    controls.isOnObject(<span class="hljs-literal">false</span>);

    <span class="hljs-keyword">var</span> controlObject = controls.getObject();
    <span class="hljs-keyword">var</span> position = controlObject.position;

    <span class="hljs-comment">// drawText(controlObject, position);</span>

    collisionDetection(position);

    <span class="hljs-comment">// Move the camera</span>
    controls.update();

    renderer.render(scene, camera);
}
</code></pre><h2 id="collision-detection">Collision Detection</h2>
<p>Another complicated subject is collision detection. In particular, we need to know if our main character (the camera) bumps into a wall. We can&#39;t have the main character walking through walls if we want this world to make sense to the user.</p>
<p>In a 2D world it is fairly easy to decide when the main character has bumped into something. Writing such code a 3D world is more complex because objects could be not only in front, behind, or the side of our main character, but also above or below or at some odd angle.</p>
<p>It turns out that the solution for this problem is found by &quot;looking around&quot; with a technology called ray casting. A &quot;ray&quot; shoots out from the camera at various angles. If it pumps into something, then that information is stored and can be acted upon.</p>
<p>Here is some code to that does at least a fair job of detecting collisions:</p>
<pre><code>function collisionDetection(position) {
    <span class="hljs-comment">// Collision detection</span>
    raycaster.ray.origin.copy(position)<span class="hljs-comment">;</span>
    <span class="hljs-comment">// raycaster.ray.origin.y -= 10;</span>
    var dir = controls.getDirection(new THREE.Vector3(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)).clone()<span class="hljs-comment">;</span>
    raycaster.ray.direction.copy(dir)<span class="hljs-comment">;</span>

    var intersections = raycaster.intersectObjects(cubes)<span class="hljs-comment">;</span>

    <span class="hljs-comment">// If we hit something (a wall) then stop moving in</span>
    <span class="hljs-comment">// that direction</span>
    <span class="hljs-keyword">if</span> (intersections.<span class="hljs-keyword">length</span> &gt; <span class="hljs-number">0</span> &amp;&amp; intersections[<span class="hljs-number">0</span>].distance &lt;= <span class="hljs-number">215</span>) {
        console.log(intersections.<span class="hljs-keyword">length</span>)<span class="hljs-comment">;</span>
        controls.isOnObject(true)<span class="hljs-comment">;</span>
    }
}
</code></pre><p>Note that the code sets <strong>controls.isOnObject</strong> to true if a collision occurrs.</p>
<h2 id="text">Text</h2>
<p>Let&#39;s add some text.</p>
<p>Put this in your CSS:</p>
<pre><code><span class="hljs-selector-id">#message</span> {
    <span class="hljs-comment">/* background-color: #7777AA; */</span>
    <span class="hljs-attribute">background-color</span>:<span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">255</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.5</span>);
    <span class="hljs-attribute">position</span>: absolute;
    <span class="hljs-attribute">left</span>: <span class="hljs-number">0.5em</span>;    
    <span class="hljs-attribute">width</span>: <span class="hljs-number">250px</span>;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">10px</span>;
    <span class="hljs-attribute">border</span>: solid black <span class="hljs-number">2px</span>;
}
</code></pre><p>Add some text to index.jade that says <strong>Isit320_LastName</strong>, where LastName is your last name. On the next line, put three paragraph elments and assign it an ID. Implement the stubbed out <strong>drawText</strong> in the animation loop. Have it use jQuery or standard HTML to show the position of the main character. Use this data to display values in the HTML elements:</p>
<pre><code><span class="hljs-variable">$(</span><span class="hljs-string">'#cameraX'</span>).html(position.x);
</code></pre><p>And so on for y and z and anything else you want to display. The HTML will be generated by a jade script that includes this:</p>
<pre><code>  div<span class="hljs-selector-id">#message</span>
    <span class="hljs-selector-tag">p</span>
      <span class="hljs-selector-tag">strong</span> CameraX:
        span<span class="hljs-selector-id">#cameraX</span> Foo
</code></pre><h2 id="jscs-ignore">JSCS Ignore</h2>
<p>We should ignore certain files in <strong>.jscsrc</strong>:</p>
<pre>
"excludeFiles": ["**/node_modules/**", "**/components/**",
  "**/bower_components/**", "\*\*/three.js", "\*\*/pointer-lock-controls.js"],
</pre>

<p>We can set max line length in to 200 in this case.</p>
<p>##Turn it in</p>
<p>Check the code into your BitBucket repository as <strong>Week03_PointerLock</strong>. When you submit the code, include the URL of your repository.</p>
<blockquote>
<p>by <a href="http://elvenware.com/charlie">Charlie Calvert</a>.</p>
</blockquote>
</div></body></html>