<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width initial-scale=1.0"><title>PointerLock</title><link href="/css/first-style.css" rel="stylesheet"><link rel="shortcut icon" href="/images/favicon.png"><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet"><link href="/css/highlight/googlecode.css" rel="stylesheet" type="text/css"><link href="/css/style.css" rel="stylesheet"><script src="https://code.jquery.com/jquery-1.12.0.min.js"></script><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- Latest compiled and minified CSS --><script src="/js/elven-help.js"></script></head><body><nav class="navbar navbar-inverse"><div class="container"><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/">Elvenware</a></div><div class="navbar-collapse collapse" id="navbar"><ul class="nav navbar-nav"><li class="trigger-collapse" ng-class="{ active: isActive('/')}"><a href="/">Home</a></li><li><a href="/about.html">About</a></li></ul></div></div></nav><div class="container"><figure><img class="elf-normal" alt="Elvenware" src="/images/elvenwarelogo.png"/></figure><h1>PointerLock</h1><p>Welcome to PointerLock</p><ul><!--TOC_Start--><li><a href="#pointerlock">PointerLock</a></li>
<li><a href="#get-started">Get Started</a></li>
<li><a href="#the-html">The HTML</a></li>
<li><a href="#pointerlock-implementation">PointerLock Implementation</a></li>
<li><a href="#pointerlocksetup">PointerLockSetup</a></li>
<li><a href="#initialize">Initialize</a></li>
<li><a href="#set-up-pointerlock">Set up PointerLock</a></li>
<li><a href="#render-or-animate">Render or Animate</a></li>
<li><a href="#collision-detection">Collision Detection</a></li>
<li><a href="#text">Text</a></li>
<li><a href="#jscs-ignore">JSCS Ignore</a></li><!--TOC_End--></ul></div><div class="container"><a class="anchor" id="pointerlock"></a>
<h1>PointerLock</h1>
<p>As mentioned earlier, navigating through a scene with the keyboard and mouse can be a tricky task. Fortunately, there is existing code for doing. In this assignment, we will add that code to our existing project.</p>
<p>Our code is based on this example:</p>
<ul>
<li><a href="https://threejs.org/examples/?q=pointer#misc_controls_pointerlock">https://threejs.org/examples/?q=pointer#misc_controls_pointerlock</a></li>
</ul>
<a class="anchor" id="get-started"></a>
<h2>Get Started</h2>
<p>Copy the ThreeFloor program into a new folder called <strong>Week04-PointerLock</strong>.</p>
<a class="anchor" id="the-html"></a>
<h2>The HTML</h2>
<p>The next step is to show HTML that tells the user to start game. Put this code in index.jade:</p>
<pre>extends layout

block content

    div#blocker
        .instructions
            div.instructions-item.instructions-item--bottom Click to play
        .instructions
            div.instructions-item.instructions-item--top (W, A, S, D = Move, SPACE = Jump, MOUSE = Look around)
</pre>
<p>Here is the CSS:</p>
<pre>
html, body {
    width: 100%;
    height: 100%;
}

body {
    background-color: #ffffff;
    margin: 0;
    overflow: hidden;
    font-family: arial;
}

#content {
    display: block;
}

#blocker {

    position: absolute;

    width: 100%;
    height: 100%;

    background-color: rgba(0,0,0,0.5);

}

.instructions {
    display: flex;
    height: 50%;
    color: #ffffff;
}

.instructions-item {
    flex: 1;
    text-align: center;
}

.instructions-item--top {
    align-self: flex-start;
}

.instructions-item--bottom {
    font-size: 40px;
    align-self: flex-end;
}
</pre>
<a class="anchor" id="pointerlock-implementation"></a>
<h2>PointerLock Implementation</h2>
<p>Here is my (slightly modified) version of the boilerplate <strong>PointerLockControls</strong> code that <a href="https://twitter.com/mrdoob">Mr Doob</a> of ThreeJs fame wrote. This is from the <a href="https://github.com/mrdoob/three.js/blob/master/examples/js/controls/PointerLockControls.js">Three.js site</a>, and is used widely. Note that I have recently (10-12-16) converted the code to support <strong>require.js</strong>, as explained below the declaration of the object. Put this code in a file called <strong>PointerLockControls.js</strong>:</p>
<pre>/**
 * @author mrdoob / http://mrdoob.com/
 * Modified by Charlie Calvert to support requirejs.
 */

 define(['floor'], function (Floor) {

     var PointerLockControls = function (camera, threeInit) {

         var scope = this;
         var THREE = threeInit;

         camera.rotation.set(0, 0, 0);

         var pitchObject = new THREE.Object3D();
         pitchObject.add(camera);

         var yawObject = new THREE.Object3D();
         yawObject.position.y = 10;
         yawObject.add(pitchObject);

         var moveForward = false;
         var moveBackward = false;
         var moveLeft = false;
         var moveRight = false;

         var isOnObject = false;
         var canJump = false;

         var prevTime = performance.now();

         var velocity = new THREE.Vector3();

         var PI_2 = Math.PI / 2;

         var onMouseMove = function (event) {

             if (scope.enabled === false) return;

             var movementX = event.movementX || event.mozMovementX || event.webkitMovementX || 0;
             var movementY = event.movementY || event.mozMovementY || event.webkitMovementY || 0;

             yawObject.rotation.y -= movementX * 0.002;
             pitchObject.rotation.x -= movementY * 0.002;

             pitchObject.rotation.x = Math.max(-PI_2, Math.min(PI_2, pitchObject.rotation.x));

         };

         var onKeyDown = function (event) {

             switch (event.keyCode) {

                 case 38: // up
                 case 87: // w
                     moveForward = true;
                     break;

                 case 37: // left
                 case 65: // a
                     moveLeft = true;
                     break;

                 case 40: // down
                 case 83: // s
                     moveBackward = true;
                     break;

                 case 39: // right
                 case 68: // d
                     moveRight = true;
                     break;

                 case 32: // space
                     if (canJump === true) velocity.y += 350;
                     canJump = false;
                     break;

             }

         };

         var onKeyUp = function (event) {

             switch (event.keyCode) {

                 case 38: // up
                 case 87: // w
                     moveForward = false;
                     break;

                 case 37: // left
                 case 65: // a
                     moveLeft = false;
                     break;

                 case 40: // down
                 case 83: // s
                     moveBackward = false;
                     break;

                 case 39: // right
                 case 68: // d
                     moveRight = false;
                     break;

             }

         };

         document.addEventListener('mousemove', onMouseMove, false);
         document.addEventListener('keydown', onKeyDown, false);
         document.addEventListener('keyup', onKeyUp, false);

         this.enabled = false;

         this.getObject = function () {

             return yawObject;

         };

         this.isOnObject = function (boolean) {

             isOnObject = boolean;
             canJump = boolean;

         };

         this.getDirection = function () {

             // assumes the camera itself is not rotated

             var direction = new THREE.Vector3(0, 0, -1);
             var rotation = new THREE.Euler(0, 0, 0, "YXZ");

             return function (v) {

                 rotation.set(pitchObject.rotation.x, yawObject.rotation.y, 0);

                 v.copy(direction).applyEuler(rotation);

                 return v;

             }

         }();

         this.update = function () {

             if (scope.enabled === false) return;

             var time = performance.now();
             var delta = (time - prevTime) / 1000;

             velocity.x -= velocity.x * 10.0 * delta;
             velocity.z -= velocity.z * 10.0 * delta;

             velocity.y -= 9.8 * 100.0 * delta; // 100.0 = mass

             if (moveForward) velocity.z -= 400.0 * delta;
             if (moveBackward) velocity.z += 400.0 * delta;

             if (moveLeft) velocity.x -= 400.0 * delta;
             if (moveRight) velocity.x += 400.0 * delta;

             // I've changed this code to stop all movement if we
             // are about to hit something. Compare to original
             // which only set y.
             if (isOnObject === true) {

                 velocity.y = Math.max(0, velocity.y);
                 velocity.x = 0;
                 velocity.z = 0;

             }

             yawObject.translateX(velocity.x * delta);
             yawObject.translateY(velocity.y * delta);
             yawObject.translateZ(velocity.z * delta);

             if (yawObject.position.y < 10) {

                 velocity.y = 0;
                 yawObject.position.y = 10;

                 canJump = true;

             }

             prevTime = time;

         };

     };

     return PointerLockControls;
 });
</pre>
<p>Remember that you will need to modify both <strong>main.js</strong> and the top of <strong>control.js</strong>. You need to make these changes so that <strong>require</strong> will know how to load these two new files. We have already seen how to make those changes with <strong>floor.js</strong>, now apply the same knowledge to <strong>PointerLockControls</strong> and <strong>PointerLockSetup</strong>. Because <strong>PointLockControls.js</strong> has been updated to include support for RequireJs, it will not need to be shimmed in.</p>
<p>I will take one moment to explain how I converted <strong>ThreePointerLock</strong> to support RequireJs. The declaration for the code originally began like this:</p>
<pre>THREE.PointerLockControls = function ( camera ) {

    var scope = this;
  etc...
};
</pre>
<p>I adopted for <strong>RequireJs</strong> by adding the <strong>define</strong> method and returning the anonymous function we store in the <strong>PointerLockControls</strong> variable. The goal here is simply to define and return out <strong>PointerLockControls</strong> object:</p>
<pre>define(['floor'], function (Floor) {

    var PointerLockControls = function (camera, threeInit) {

        var scope = this;
        var THREE = threeInit;

        // CODE OMITTED HERE
    };

return PointerLockControls;
});
</pre>
<p>Later in this document, we will see how to use this object with code that looks, in part, like this, where the first line uses <a href="https://en.wikipedia.org/wiki/Dependency_injection">dependency injection</a> to load our <strong>PointerLockControls</strong> object:</p>
<pre>define(['floor', 'PointerLockControls'], function (Floor, PointerLockControls) {

  // LOTS OF CODE OMITTED
  controls = new PointerLockControls(camera, THREE);
  // LOTS OF CODE OMITTED
});
</pre>
<p>This is our standard dance for using a RequireJs module:</p>
<ul>
<li>In the target module (<strong>PointerLockControls</strong>) use the RequireJs <strong>define</strong> method and have it return an instance of the object you want to create.</li>
<li>In the <strong>define</strong> method for the object that will consume the target, use dependency injection to load the target.</li>
<li>Use the target object.</li>
</ul>
<a class="anchor" id="pointerlocksetup"></a>
<h2>PointerLockSetup</h2>
<p>Here is a file I put together to help automate the process of loading the PointerLockControl code. Save it as <strong>PointerLockSetup.js</strong>:</p>
<pre>define(['PointerLockControls'], function(pointerLock) {

    'use strict';

    var element;
    var blocker;
    var instructions;

    function PointerLockSetup(controls) {

        blocker = document.getElementById('blocker');
        instructions = document.getElementsByClassName('instructions')[0];

        var havePointerLock = 'pointerLockElement' in document ||
            'mozPointerLockElement' in document ||
            'webkitPointerLockElement' in document;

        if (havePointerLock) {

            element = document.body;

            var pointerlockchange = function(event) {

                if (document.pointerLockElement === element ||
                    document.mozPointerLockElement === element ||
                    document.webkitPointerLockElement === element) {

                    controls.enabled = true;

                    blocker.style.display = 'none';

                } else {

                    controls.enabled = false;

                    blocker.style.display = 'block';
                    instructions.style.display = '';

                }
            };

            var pointerlockerror = function(event) {

                instructions.style.display = '';

            };

            // Hook pointer lock state change events
            document.addEventListener('pointerlockchange', pointerlockchange, false);
            document.addEventListener('mozpointerlockchange', pointerlockchange, false);
            document.addEventListener('webkitpointerlockchange', pointerlockchange, false);

            document.addEventListener('pointerlockerror', pointerlockerror, false);
            document.addEventListener('mozpointerlockerror', pointerlockerror, false);
            document.addEventListener('webkitpointerlockerror', pointerlockerror, false);

            instructions.addEventListener('click', function(event) {

                instructions.style.display = 'none';

                // Ask the browser to lock the pointer
                element.requestPointerLock = element.requestPointerLock ||
                    element.mozRequestPointerLock ||
                    element.webkitRequestPointerLock;

                if (/Firefox/i.test(navigator.userAgent)) {

                    var fullscreenchange = function(event) {

                        if (document.fullscreenElement === element ||
                            document.mozFullscreenElement === element ||
                            document.mozFullScreenElement === element) {

                            document.removeEventListener('fullscreenchange', fullscreenchange);
                            document.removeEventListener('mozfullscreenchange', fullscreenchange);

                            element.requestPointerLock();
                        }

                    };

                    document.addEventListener('fullscreenchange', fullscreenchange, false);
                    document.addEventListener('mozfullscreenchange', fullscreenchange, false);

                    element.requestFullscreen = element.requestFullscreen ||
                        element.mozRequestFullscreen ||
                        element.mozRequestFullScreen ||
                        element.webkitRequestFullscreen;

                    element.requestFullscreen();

                } else {
                    element.requestPointerLock();
                }

            }, false);

        } else {

            instructions.innerHTML = 'Your browser doesn\'t seem to support Pointer Lock API';

        }
    }

    return PointerLockSetup;

});
</pre>
<a class="anchor" id="initialize"></a>
<h2>Initialize</h2>
<p>Let&#39;s move the code to initialize the engine out of the constructor and into a method called <strong>init</strong>:</p>
<pre>function Control() {
    init();
    animate();  
}
</pre>
<p>The <strong>render</strong> method from ThreeFloor has been, and should be, renamed to <strong>animate</strong>. We now start the app by first initializing our engine, and by then animating the game in our <strong>animate</strong> loop.</p>
<p>You will need to declare a object scoped variables called <strong>size</strong> and <strong>cubes</strong>. Set <strong>size</strong> equal to 20. Declare cubes to be an empty array.</p>
<p>In <strong>addCube</strong>, when you create the cube, make it a square with a width, height and depth of <strong>size</strong>. It looks like this:</p>
<pre>    var geometry = new THREE.BoxGeometry(size, size, size);
</pre>
<p>And when you create a cube, in <strong>addCube</strong>, you need to call <strong>cubes.push(cube)</strong>, where cubes is an object scoped array (var cubes = []).</p>
<p>After you make the cubes bigger, you are going to have to change the way you lay out the boxes. They are now much bigger than they were before and so they will be further apart.</p>
<p>The init method looks like this:</p>
<pre>function init() {

    var screenWidth = window.innerWidth / window.innerHeight;
    camera = new THREE.PerspectiveCamera(75, screenWidth, 1, 1000);

    scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0xffffff, 0, 750);

    addCubes(scene, camera, false);

    doPointerLock();

    addLights();

    var floor = new Floor(THREE);
    floor.drawFloor(scene);

    raycaster = new THREE.Raycaster(new THREE.Vector3(),
        new THREE.Vector3(0, -1, 0), 0, 10);

    renderer = new THREE.WebGLRenderer({ antialias : true });

    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    window.addEventListener('resize', onWindowResize, false);
}
</pre>
<a class="anchor" id="set-up-pointerlock"></a>
<h2>Set up PointerLock</h2>
<p>Here is a function to instantiate an instance of <strong>PointerLockControls</strong>:</p>
<pre>function doPointerLock() {
  controls = new PointerLockControls(camera, THREE);
    var yawObject = controls.getObject();
    scene.add(yawObject);

    yawObject.position.x = size;
    yawObject.position.z = size;

    var ps = new PointerLockSetup(controls);
}
</pre>
<p>Note that we create an instance of <strong>PointerLockControls</strong> and store it in a variable called controls. That instance is scoped to be visible inside the entirety of the Controls. It has object scope.</p>
<a class="anchor" id="render-or-animate"></a>
<h2>Render or Animate</h2>
<p>Here is a function to replace our previous render method. Note that I have changed the name from <strong>render</strong> to <strong>animate</strong>.</p>
<pre>function animate() {

    requestAnimationFrame(animate);

    var xAxis = new THREE.Vector3(1, 0, 0);

    controls.isOnObject(false);

    var controlObject = controls.getObject();
    var position = controlObject.position;

    // drawText(controlObject, position);

  collisionDetection(controls, cubes);

    // Move the camera
    controls.update();

    renderer.render(scene, camera);
}
</pre>
<p>Note that the code for handling key strokes such as up, down, left and right, have moved into the <strong>PointLockControls</strong> object created by Mr. Doob.</p>
<a class="anchor" id="collision-detection"></a>
<h2>Collision Detection</h2>
<p>Another complicated subject is collision detection. In particular, we need to know if our main character (the camera) bumps into a wall. We can&#39;t have the main character walking through walls if we want this world to make sense to the user.</p>
<p>In a 2D world it is fairly easy to decide when the main character has bumped into something. Writing such code a 3D world is more complex because objects could be not only in front, behind, or the side of our main character, but also above or below or at some odd angle.</p>
<p>It turns out that the solution for this problem is found by &quot;looking around&quot; with a technology called ray casting. A &quot;ray&quot; shoots out from the camera at various angles. If it pumps into something, then that information is stored and can be acted upon.</p>
<p>Here is some old code to that does at least a fair job of detecting collisions:</p>
<pre>function collisionDetection(position) {
    // Collision detection
    raycaster.ray.origin.copy(position);

    var dir = controls.getDirection(new THREE.Vector3(0, 0, 0)).clone();
    raycaster.ray.direction.copy(dir);

    var intersections = raycaster.intersectObjects(cubes);

    // If we hit something (a wall) then stop moving in
    // that direction
    if (intersections.length > 0 && intersections[0].distance <= 215) {
        console.log(intersections.length);
        controls.isOnObject(true);
    }
}
</pre>
<p>Note that the code sets <strong>controls.isOnObject</strong> to true if a collision occurrs.</p>
<p>Here is updated code that should work a bit better:</p>
<pre>var collisionDetection = function(controls, cubes) {

    function bounceBack(position, ray) {
        position.x -= ray.bounceDistance.x;
        position.y -= ray.bounceDistance.y;
        position.z -= ray.bounceDistance.z;
    }

    var rays = [
        //   Time    Degrees      words
        new THREE.Vector3(0, 0, 1),  // 0 12:00,   0 degrees,  deep
        new THREE.Vector3(1, 0, 1),  // 1  1:30,  45 degrees,  right deep
        new THREE.Vector3(1, 0, 0),  // 2  3:00,  90 degress,  right
        new THREE.Vector3(1, 0, -1), // 3  4:30, 135 degrees,  right near
        new THREE.Vector3(0, 0, -1), // 4  6:00  180 degress,  near
        new THREE.Vector3(-1, 0, -1),// 5  7:30  225 degrees,  left near
        new THREE.Vector3(-1, 0, 0), // 6  9:00  270 degrees,  left
        new THREE.Vector3(-1, 0, 1)  // 7 11:30  315 degrees,  left deep
    ];

    var position = controls.getObject().position;
    var rayHits = [];
    for (var index = 0; index < rays.length; index += 1) {

        // Set bounce distance for each vector
        var bounceSize = 0.01;
        rays[index].bounceDistance = {
            x: rays[index].x * bounceSize,
            y: rays[index].y * bounceSize,
            z: rays[index].z * bounceSize
        };

        raycaster.set(position, rays[index]);

        var intersections = raycaster.intersectObjects(cubes);

        if (intersections.length > 0 && intersections[0].distance <= 3) {
            controls.isOnObject(true);
            bounceBack(position, rays[index]);
        }
    }

    return false;
};
</pre>
<a class="anchor" id="text"></a>
<h2>Text</h2>
<p>Let&#39;s add some text.</p>
<p>Put this in your CSS:</p>
<pre>#message {
    /* background-color: #7777AA; */
    background-color:rgba(0,255,0,0.5);
    position: absolute;
    left: 0.5em;    
    width: 250px;
    font-size: 10px;
    border: solid black 2px;
}
</pre>
<p>Add some text to index.jade that says <strong>Isit320_LastName</strong>, where LastName is your last name. On the next line, put three paragraph elments and assign it an ID. Implement the stubbed out <strong>drawText</strong> in the animation loop. Have it use jQuery or standard HTML to show the position of the main character. Use this data to display values in the HTML elements:</p>
<pre>$('#cameraX').html(position.x);
</pre>
<p>And so on for y and z and anything else you want to display. The HTML will be generated by a jade script that includes this:</p>
<pre>  div#message
    p
      strong CameraX:
        span#cameraX Foo
</pre>
<a class="anchor" id="jscs-ignore"></a>
<h2>JSCS Ignore</h2>
<p>We should ignore certain files in <strong>.jscsrc</strong>:</p>
<pre>
"excludeFiles": ["**/node_modules/**", "**/components/**",
  "**/bower_components/**", "\*\*/three.js", "\*\*/pointer-lock-controls.js"],
</pre>

<p>We can set max line length in to 200 in this case.</p>
<p>##Turn it in</p>
<p>Check the code into your BitBucket repository as <strong>Week03_PointerLock</strong>. When you submit the code, include the URL of your repository.</p>
<blockquote>
<p>by <a href="http://elvenware.com/charlie">Charlie Calvert</a>.</p>
</blockquote>
</div></body></html>