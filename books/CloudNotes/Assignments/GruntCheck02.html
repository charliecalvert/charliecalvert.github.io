<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width initial-scale=1.0"><title>GruntCheck02</title><link href="/css/first-style.css" rel="stylesheet"><link rel="shortcut icon" href="/images/favicon.png"><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet"><link href="/css/highlight/googlecode.css" rel="stylesheet" type="text/css"><link href="/css/style.css" rel="stylesheet"><script src="https://code.jquery.com/jquery-1.12.0.min.js"></script><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- Latest compiled and minified CSS --><script src="/js/elven-help.js"></script></head><body><nav class="navbar navbar-inverse"><div class="container"><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/">Elvenware</a></div><div class="navbar-collapse collapse" id="navbar"><ul class="nav navbar-nav"><li class="trigger-collapse" ng-class="{ active: isActive('/')}"><a href="/">Home</a></li><li><a href="/about.html">About</a></li></ul></div></div></nav><div class="container"><figure><img class="elf-normal" alt="Elvenware" src="/images/elvenwarelogo.png"/></figure><h1>GruntCheck02</h1><p>Welcome to GruntCheck02</p><ul><!--TOC_Start--><li><a href="#overview">Overview</a></li>
<li><a href="#the-error-handler">The Error Handler</a></li>
<li><a href="#get-recent-templates-">Get Recent Templates.</a></li>
<li><a href="#create-start-function">Create start Function</a></li>
<li><a href="#create-launcher">Create Launcher</a></li>
<li><a href="#ignore-skipped">Spec Reporter Ignore Skipped Test</a></li>
<li><a href="#bitly-refine-files">Bitly Refine Files</a></li>
<li><a href="#elf-bitly-tests">Elf Bitly Tests</a></li>
<li><a href="#bitly-refine-downloads">Bitly Refine Downloads</a></li>
<li><a href="#run-one-test-manual">Manually Run One Test</a></li>
<li><a href="#automatically-run-one-test">Automatically Run One Test</a></li>
<li><a href="#support-npm-test">Support Npm Test</a></li><!--TOC_End--></ul></div><div class="container"><a class="anchor" id="overview"></a>
<h2>Overview</h2>
<p>Grunt Check Part II provides more information on Grunt.</p>
<a class="anchor" id="the-error-handler"></a>
<h2>The Error Handler</h2>
<p>I want you to modify the error handler in <strong>app.js</strong>. The updated code does two things:</p>
<ul>
<li>It makes you aware that the node environment (env) is set to <strong>development</strong>.</li>
<li>When something goes wrong in your code, it helps you more clearly see the type of errors that are being thrown.</li>
</ul>
<p>The changes are the addition of two <strong>console.log statements</strong>:</p>
<pre>if (app.get('env') === 'development') {
    console.log('Using Development error handler');
    app.use(function(err, req, res, next) {
        'use strict';
        console.log('Development error handler called');
        res.status(err.status || 500);
        console.log('About to render error', err);
        res.render('error', {
            message: err.message,
            error: err
        });
    });
}
</pre>
<p>Before I put in this error handler, this is what I saw at the command line when I hit an error:</p>
<pre>GET /delicious 500 48.191 ms - 2369
</pre>
<p>After I installed the error handler, this is what I saw:</p>
<pre>
GET /bitly 304 552.907 ms - -
Development error handler called
About to render error { [TypeError: .../Week08-Midterm-Gan/views/delicious.jade:6
    4| block content
    5|
  > 6|    +elfPanel("Image Display").elfDiv#imagePanel
    7|       img#image
    8|
    9|    div.panel.panel-default

Cannot read property 'call' of undefined]
  path: '/home/charlie/Git/isit320-2015/etc.../views/delicious.jade' }
GET /delicious 500 93.348 ms - 2369
</pre>

<p>As you can see, without the extended error handler, it is almost impossible to know what is wrong, with it, the problem becomes obvious right away. In particular, this error usually results from a missing <strong>include mixins...</strong> statement in our jade.</p>
<a class="anchor" id="get-recent-templates-"></a>
<h2>Get Recent Templates.</h2>
<p>Start by getting the tests from <strong>$ELF_TEMPLATES/UnitTest/BitlyRefine</strong>. In <strong>JsObjects</strong> do a <strong>git pull.</strong>. Then from your git repository root folder:</p>
<p>  meld spec $ELF_TEMPLATES/UnitTest/BitlyRefine</p>
<p>or</p>
<p>  cp $ELF_TEMPLATES/UnitTest/BitlyRefine/* spec/.</p>
<a class="anchor" id="create-start-function"></a>
<h2>Create start Function</h2>
<pre>    start: function() {
        $('#localData').prop('checked', true);
        elfMidterm.getBitlyLinks(elfDownloads.dataTypes.dtLocal);
        $('#dataSource').click(elfDownloads.dataTypeSelection);
    }
</pre>
<a class="anchor" id="create-launcher"></a>
<h2>Create Launcher</h2>
<p>When we run our tests, we get a miscellaneous 404 (file not found) error on <strong>data/bitly-links.json</strong>. This is because of the code in our <strong>document ready</strong> method from <strong>control.js</strong>:</p>
<pre>$(document).ready(function() {
    'use strict';
    $('#localData').prop('checked', true);
    elfBitly.getBitlyLinks(elfDownloads.dataTypes.dtLocal);
    $('#dataSource').click(elfDownloads.dataTypeSelection);
});
</pre>
<p>The problem is that our tests have to get at the <strong>elfBitly</strong> object, but they don&#39;t want to get at the <strong>document ready</strong> call that attempts to load a file that our tests can&#39;t reach. Our main program can reach it, but our tests can not and should not.</p>
<p>To fix this problem, let&#39;s move <strong>elfBitly</strong> into <strong>elf-bitly.js</strong>, and leave only the <strong>document ready</strong> function in <strong>control.js</strong>.</p>
<p>You will also need to:</p>
<ul>
<li>Load <strong>elf-bitly</strong> in <strong>layout.jade</strong></li>
<li>Stop loading <strong>control.js</strong> in the <strong>exclude</strong> property of <strong>karma.conf.js</strong>.</li>
</ul>
<pre>        files: [
            'public/components/jquery/dist/jquery.min.js',
            'public/javascripts/*.js',
            'spec/test*.js',
            'spec/bitly-links.js'
        ],

        // list of files to exclude
        exclude: ['**/control.js'],
</pre>
<a class="anchor" id="ignore-skipped"></a>
<h2>Spec Reporter Ignore Skipped Test</h2>
<p>In <strong>karma.conf.js</strong>:</p>
<pre>reporters: ['spec'],

specReporter: {
    suppressSkipped: true  // do not print information about skipped tests
},

plugins: ['karma-jasmine',
    'karma-spec-reporter',
    'karma-phantomjs-launcher',
    'karma-chrome-launcher'
]
</pre>
<p>If necessary:</p>
<pre>npm install karma-spec-reporter --save-dev
npm install karma-phantomjs-launcher --save-dev
npm install karma-chrome-launcher --save-dev
</pre>
<p>We can can run a specific test Suite or Test like this:</p>
<ul>
<li>Change <strong>describe</strong> to <strong>fdescribe</strong> to run only one specific suite</li>
<li>Change <strong>it</strong> to <strong>fit</strong> to run only one specific test</li>
</ul>
<p>Run only one stuite:</p>
<pre>fdescribe('Downloads Suite', function() {
    'use strict';

    it('expects elfDownloads to be defined', function() {
        var isDefined = typeof elfDownloads !== 'undefined';
        expect(isDefined).toBe(true);
    });
});
</pre>
<p>Run only one test:</p>
<pre>describe('Downloads Suite', function() {
    'use strict';

    fit('expects elfDownloads to be defined', function() {
        var isDefined = typeof elfDownloads !== 'undefined';
        expect(isDefined).toBe(true);
    });
});
</pre>
<a class="anchor" id="bitly-refine-files"></a>
<h2>Bitly Refine Files</h2>
<p>Save the following in your <strong>BitlyRefine</strong> folder as <strong>spec/test-files.js</strong> and make sure all the tests pass:</p>
<pre>describe('File Suite', function() {
    'use strict';

    it('expects elfBitly to be defined', function() {
        var isDefined = typeof elfBitly !== 'undefined';
        expect(isDefined).toBe(true);
    });

    it('expects elfDownloads to be defined', function() {
        var isDefined = typeof elfDownloads !== 'undefined';
        expect(isDefined).toBe(true);
    });

    it('expects elfMovement to be defined', function() {
        var isDefined = typeof elfMovement !== 'undefined';
        expect(isDefined).toBe(true);
    });

    it('expects elfDisplay to be defined', function() {
        var isDefined = typeof elfDisplay !== 'undefined';
        expect(isDefined).toBe(true);
    });
});
</pre>
<a class="anchor" id="elf-bitly-tests"></a>
<h2>Elf Bitly Tests</h2>
<p>Save the following in your <strong>BitlyRefine</strong> folder as <strong>spec/test-elf-bitly.js</strong> and make sure all the tests pass:</p>
<pre>describe('Test ElfBitly Suite', function() {
    'use strict';

    var elfBitlyKeys;

    beforeEach(function() {
        elfBitlyKeys = Object.keys(elfBitly);
    });

    it('Expects there to be at least 10 properties or methods in elfBitly', function() {
        console.log(elfBitlyKeys);
        expect(elfBitlyKeys.length).toBeGreaterThan(10);

    });

    it('Expects elfDownloads to contain linkIndex', function() {
        expect(elfBitlyKeys.indexOf('linkIndex')).toBeGreaterThan(-1);
    });

    it('Expects elfDownloads to contain bitlyLinks', function() {
        expect(elfBitlyKeys.indexOf('bitlyLinks')).toBeGreaterThan(-1);
    });

    it('Expects elfDownloads to contain baseUrl', function() {
        expect(elfBitlyKeys.indexOf('baseUrl')).toBeGreaterThan(-1);
    });

    it('Expects elfDownloads to contain localUrl', function() {
        expect(elfBitlyKeys.indexOf('localUrl')).toBeGreaterThan(-1);
    });

    it('checks for the value of elfBitly baseUrl', function () {
        expect(elfBitly.baseUrl).toContain('https://api-ssl.bitly.com/v3/user/link_history');
    });

    it('checks for the value of elfBitly localUrl', function () {
        expect(elfBitly.localUrl).toContain('data/bitly-links.json');
    });

    it('Expects elfDownloads to contain getLinkHistoryArray', function() {
        expect(elfBitlyKeys.indexOf('getLinkHistoryArray')).toBeGreaterThan(-1);
    });

    it('Expects elfDownloads to contain getLinkHistoryItem', function() {
        expect(elfBitlyKeys.indexOf('getLinkHistoryItem')).toBeGreaterThan(-1);
    });

    it('Expects elfDownloads to contain getBitlyLinks', function() {
        expect(elfBitlyKeys.indexOf('getBitlyLinks')).toBeGreaterThan(-1);
    });

    it('Expects elfDownloads to contain getUrl', function() {
        expect(elfBitlyKeys.indexOf('getUrl')).toBeGreaterThan(-1);
    });

    it('Expects elfDownloads to contain getStatusText', function() {
        expect(elfBitlyKeys.indexOf('getStatusText')).toBeGreaterThan(-1);
    });

    it('Expects elfDownloads to contain getStatusCode', function() {
        expect(elfBitlyKeys.indexOf('getStatusCode')).toBeGreaterThan(-1);
    });
});
</pre>
<p>Here we are testing for two new properties:</p>
<pre>    localUrl: 'data/bitly-links.json',

    baseUrl: 'https://api-ssl.bitly.com/v3/user/link_history',

    getUrl: function(accessToken) {
        'use strict';

        var params = '?access_token=';

        if (accessToken === elfDownloads.dataTypes.dtLocal) {
            return this.localUrl;
        } else {
            var url = this.baseUrl + params;
            return url += accessToken;
        }
    },
</pre>
<a class="anchor" id="bitly-refine-downloads"></a>
<h2>Bitly Refine Downloads</h2>
<p>Save the following in your <strong>BitlyRefine</strong> folder as <strong>spec/test-downloads.js</strong> and make sure all the tests pass:</p>
<pre>describe('Downloads Suite', function() {
    'use strict';

    var downloadKeys;

    beforeEach(function() {
        downloadKeys = Object.keys(elfDownloads);
    });

    it('expects elfDownloads to be defined', function() {
        var isDefined = typeof elfDownloads !== 'undefined';
        expect(isDefined).toBe(true);
    });

    it('Expects elfDownloads to contain Keys', function() {
        var downloadKeys = Object.keys(elfDownloads);
        expect(downloadKeys).toBeTruthy();
    });

    it('Expects elfDownloads to contain accessToken', function() {
        expect(downloadKeys.indexOf('accessToken')).toBeGreaterThan(-1);
    });

    it('Expects elfDownloads to contain dataTypes', function() {
        expect(downloadKeys.indexOf('dataTypes')).toBeGreaterThan(-1);
    });

    it('Expects elfDownloads to contain dataType', function() {
        expect(downloadKeys.indexOf('dataType')).toBeGreaterThan(-1);
    });

    it('Expects elfDownloads to contain dataTypeSelection', function() {
        expect(downloadKeys.indexOf('dataTypeSelection')).toBeGreaterThan(-1);
    });

    it('Expects elfDownloads to contain getBitlyData', function() {
        expect(downloadKeys.indexOf('getBitlyData')).toBeGreaterThan(-1);
    });

    it('Expects elfDownloads to contain clearControls', function() {
        expect(downloadKeys.indexOf('clearControls')).toBeGreaterThan(-1);
    });

    it('Expects elfDownloads.dataTypes to be defined', function() {
        expect(elfDownloads.dataTypes).toBeTruthy();
    });

    it('Expects elfDownloads.dataTypes to be an object', function() {
        expect(elfDownloads.dataTypes instanceof Object).toBeTruthy();
    });

    it('Expects elfDownloads.dataTypes to contain two elements', function() {
        var keys = Object.keys(elfDownloads.dataTypes);
        expect(keys.length).toBe(2);
    });

    it('Expects elfDownloads.dataType to be of type string', function() {
        expect(typeof elfDownloads.dataType).toBe('number');
    });

    it('Shows that elfDownloads.getBitlyData is a function', function() {
        expect(typeof elfDownloads.getBitlyData).toBe('function');
    });

    it('Shows that elfDownloads.dataTypeSelection is a function', function() {
        expect(typeof elfDownloads.dataTypeSelection).toBe('function');
    });

    it('Shows that elfDownloads.clearControls is a function', function() {
        expect(typeof elfDownloads.clearControls).toBe('function');
    });

});
</pre>
<a class="anchor" id="run-one-test-manual"></a>
<h2>Manually Run One Test</h2>
<p>If you want to run only one test, change, <strong>it</strong> to <strong>fit</strong>. To run only one suite, change <strong>describe</strong> to <strong>fdescribe</strong>. In this example, the <strong>elfMidterm</strong> test will be run but the <strong>elfDownloads</strong> test will not be run:</p>
<pre>describe('File Suite', function() {
    'use strict';

    fit('expects elfMidterm to be defined', function() {
        var isDefined = typeof elfMidterm !== 'undefined';
        expect(isDefined).toBe(true);
    });

    it('expects elfDownloads to be defined', function() {
        var isDefined = typeof elfDownloads !== 'undefined';
        expect(isDefined).toBe(true);
    });
});
</pre>
<a class="anchor" id="automatically-run-one-test"></a>
<h2>Automatically Run One Test</h2>
<p>Open up two terminal windows. In one window, start your tests with either of these commands:</p>
<pre>grunt test
karma start
</pre>
<p>In the other termainl window, run this command:</p>
<pre>karma run -- --grep="status code of 200"
</pre>
<p>This tells karma to run the tests, and display the output, but to show the results for only the test that includes the text <strong>status code of 200</strong>. In particular, that would be a test that looks like this:</p>
<pre>it('shows we have a status code of 200', function() {
    elfMidterm.getBitlyLinks();
    var statusCode = elfMidterm.getStatusCode();
    expect(statusCode).toBe(200);
});
</pre>
<p>The string you pass to <strong>grep</strong> can be any regular expression. We have not covered reg-ex in this class, but there is a vast amount of information on that topic on the web.</p>
<a class="anchor" id="support-npm-test"></a>
<h2>Support Npm Test</h2>
<p>Add at <strong>test</strong> property to the <strong>scripts</strong> object in <strong>package.json</strong>:</p>
<pre>{
  "name": "Week08-Midterm",
  "version": "0.0.0",
  "private": true,
  "scripts": {
    "start": "nodemon ./bin/www",
    "test": "karma start"
  },
  "dependencies": {
    "body-parser": "~1.14.1",
    etc...
  }
}
</pre>
<p>Whether you run <strong>karma start</strong> or <strong>grunt test</strong> is optional. You may choose either one, or some variant of those options. But if you choose <strong>karma start</strong> be sure that you <strong>grunt jshint</strong> runs cleanly before you turn in your assignment.</p>
<p>If you want to create a script other <strong>start</strong> and <strong>test</strong> then you may need to run it like this:</p>
<pre>npm run-script run
</pre>
<p>This would run this <strong>run</strong> option</p>
<pre>"scripts": {
    "start": "nodemon ./bin/www",
    "test": "karma start",
    "run": "karma run -- --grep='status code of 200'"
},
</pre>
</div></body></html>