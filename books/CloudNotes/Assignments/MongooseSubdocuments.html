<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><title>MongooseSubdocuments</title><link rel="shortcut icon" href="/charlie/images/favicon.png"><!-- Latest compiled and minified CSS--><link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap.min.css"><!-- Optional theme--><link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap-theme.min.css"><link href="/libs/css/BootstrapIndex.css" rel="stylesheet" type="text/css"><link href="/css/style.css" rel="stylesheet" type="text/css"><script src="/components/jquery/dist/jquery.js"></script><script src="/components/angular/angular.js"></script><script src="/components/angular-route/angular-route.js"></script><script src="/components/bootstrap/dist/js/bootstrap.min.js"></script><script src="/libs/scripts/elvenware.js" type="text/javascript"></script><script src="/libs/scripts/Control.js"></script></head><body ng-app="elfApp"><div class="navbar navbar-inverse"><div class="container"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target=".navbar-collapse" class="navbar-toggle"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">Elvenware</a></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li class="active"><a href="/index.html">Home</a></li><li><a href="/about">About</a></li><li class="dropdown"><a href="#/" data-toggle="dropdown" class="dropdown-toggle">Dropdown<b class="caret"></b></a><ul class="dropdown-menu"><li class="dropdown-header">Core Code</li><li><a href="/development/index.html">Strongly Typed</a></li><li><a href="/development/web/index.html">Web & Scripts</a></li><li><a href="/development/cloud/index.shtml">Cloud</a></li><li class="divider"></li><li class="dropdown-header">OS and Tools</li><li><a href="/os/index.html">OS</a></li><li><a href="/development/database/index.html">Database</a></li><li><a href="/books/index.html">My Writing</a></li><li class="divider"></li><li class="dropdown-header">Art</li><li><a href="/charlie/Art/index.html">Poems & Photos</a></li><li><a href="/books/reading/index.html">Book Reviews</a></li><li><a href="/spirit/index.html">Spiritual</a></li><li class="divider"></li><li class="dropdown-header">Links</li><li><a href="/charlie/links.html">My Links</a></li><li><a href="http://www.github.com/charliecalvert">GitHub</a></li><li><a href="http://sourceforge.net/projects/elvenware/">Sourceforge</a></li></ul></li></ul></div><!-- /.nav-collapse--></div></div><div class="container"><figure><img alt="Elvenware" src="/charlie/images/elvenwarelogo.png"/></figure><h1>MongooseSubdocuments</h1><h3>Table of Contents</h3><ul><!--TOC_Start--><li><a href="#description">Description</a></li>
<li><a href="#step-one">Step One</a></li>
<li><a href="#step-two">Step Two</a></li>
<li><a href="#step-three">Step Three</a></li>
<li><a href="#step-four">Step Four</a></li>
<li><a href="#step-five">Step Five</a></li>
<li><a href="#turn-it-in">Turn it in</a></li>
<li><a href="#hints">Hints</a></li><!--TOC_End--></ul><h2 id="description">Description</h2>
<p>Working with Mongoose subdocuments. </p>
<p>Reference: <a href="http://mongoosejs.com/docs/subdocs.html">http://mongoosejs.com/docs/subdocs.html</a></p>
<h2 id="step-one">Step One</h2>
<p>Create the project</p>
<pre><code>express Week10-MongooseSubdocs
cd Week10-MongooseSubdocs
npm install mongoose --save
npm install
copy %ELF_TEMPLATES%\.bowerrc
bower init
</code></pre><p>Then after bower init, do this:</p>
<pre><code>bower install angular --save
bower install angular-route --save
bower install bootstrap --save
</code></pre><p>Set the port to 30025 and in <strong>routes/index.js</strong> set the title to <strong>Mongoose SubDocs LastName</strong>. Add <strong>nodemon</strong> to the <strong>start</strong> script in <strong>package.json</strong>.</p>
<p>Save JSON data as <strong>ValidScientists.json</strong>:</p>
<ul>
<li><a href="https://gist.github.com/charliecalvert/059f2f74d5bf2d98c6f8">Scientists JSON data</a></li>
</ul>
<h2 id="step-two">Step Two</h2>
<p>Define the Mongoose documents.</p>
<p>The key thing to notice is that we have a main document and an array of sub-documents. In particular, each scientist document has zero or more comments associated with it. The comments take the form of sub-documents. Notice how the <strong>comments</strong> field of the <strong>scientistSchema</strong> is declared.   </p>
<pre><code>var mongoose = require(&#39;mongoose&#39;);

var commentSchema = mongoose.Schema({
    commentText: String,
    date: { type: Date, default: Date.now }
});

var scientistsSchema = mongoose.Schema({
    &quot;firstName&quot;: String,
    &quot;lastName&quot;: String,
    &quot;subject&quot;: String,
    &quot;subjects&quot;: [String],
    comments: [commentSchema]
});

module.exports = {
    comment: mongoose.model(&#39;comment&#39;, commentSchema),
    scientist: mongoose.model(&#39;scientist&#39;, scientistsSchema)
};
</code></pre><h2 id="step-three">Step Three</h2>
<p>Define the views</p>
<p>Here is layout.jade:</p>
<pre><code>doctype html
html
    head
        title= title
        link(rel=&#39;stylesheet&#39;, href=&#39;/stylesheets/style.css&#39;)
        link(rel=&#39;stylesheet&#39;, href=&#39;/components/bootstrap/dist/css/bootstrap.css&#39;)
        script(src=&quot;components/jquery/dist/jquery.js&quot;)
        script(src=&quot;components/bootstrap/dist/js/bootstrap.js&quot;)
        script(src=&quot;components/angular/angular.js&quot;)
        script(src=&quot;javascripts/control.js&quot;)
        script(src=&quot;javascripts/comment-factory.js&quot;)
    body(ng-app=&#39;elvenApp&#39;)
        block content
</code></pre><p>Here is index.jade:</p>
<pre><code>extends layout

block content
    h1= title
    p Welcome to #{title}

    div(ng-controller=&#39;MainController as mainController&#39;)

        div.names
            div.btn-group
                button.btn.btn-default(ng-click=&#39;mainController.emptyCollection()&#39;) Empty Collection
                button.btn.btn-default(ng-click=&#39;mainController.insertValidCollection()&#39;) Insert Valid Collection

        div.names
            ul
                li(ng-repeat=&#39;scientist in mainController.scientists&#39;)
                    a(ng-click=&quot;mainController.selectScientist(scientist)&quot;) {{scientist.name}}

        div.names
            div
                label(class=&#39;col-sm-2, control-label&#39;) First:
                span {{mainController.scientist.firstName}}
            div
                label(class=&#39;col-sm-2, control-label&#39;) Last:
                span {{mainController.scientist.lastName}}
            div
                label(class=&#39;col-sm-2, control-label&#39;) Subject:
                span {{mainController.scientist.subject}}

        div.names
            ul
                li(ng-repeat=&#39;comment in mainController.scientist.comments&#39;)
                    a(ng-click=&quot;mainController.selectComment(comment)&quot;) {{comment.commentText}}

        div.names(ng-form=&quot;newCommentForm&quot;)
            button.btn.btn-default(ng-click=&#39;mainController.newComment()&#39;) New Comment
            hr
            label(class=&#39;col-sm-2, control-label&#39;) Text
            input.form-control(type=&#39;text&#39;, ng-model=&#39;mainController.newCommentText&#39;)

        div.names(ng-form=&quot;myform&quot;)
            button.btn.btn-default(ng-click=&#39;mainController.updateComment()&#39;) Update Comment
            button.btn.btn-default(ng-click=&#39;mainController.deleteComment()&#39;) Delete Comment
            hr
            label(class=&#39;col-sm-2, control-label&#39;) Text
            input.form-control(type=&#39;text&#39;, ng-model=&#39;mainController.comment.commentText&#39;)
            br
            label(class=&#39;col-sm-2, control-label&#39;) Date
            input.form-control(type=&#39;text&#39;, ng-model=&#39;mainController.comment.date&#39;)
            br
            label(class=&#39;col-sm-2, control-label&#39;) Id
            input.form-control(type=&#39;text&#39;, ng-model=&#39;mainController.comment._id&#39;)
</code></pre><h2 id="step-four">Step Four</h2>
<p>Define the back end</p>
<p>Here is <strong>index.js</strong></p>
<pre><code>var express = require(&#39;express&#39;);
var router = express.Router();
var mongoose = require(&#39;mongoose&#39;);
var scientistSchema = require(&#39;../models/scientists&#39;);
var scientists = scientistSchema.scientist;
var comments = scientistSchema.comment;
var fs = require(&#39;fs&#39;);


/* GET home page. */
router.get(&#39;/&#39;, function(req, res, next) {
    res.render(&#39;index&#39;, {title: &#39;Express&#39;});
});

var allData;
var connected = false;
var numberOfScientists = 0;
var totalScientistsSaved = 0;

function doConnection() {
    connected = true;
    var userName = &#39;csc&#39;;
    var password = &#39;Re*lD*t*22#&#39;;
    var siteAndPort = &#39;ds049848.mongolab.com:49848&#39;;
    var databaseName = &#39;elvenlab01&#39;;
    var url = &#39;mongodb://&#39; + userName + &#39;:&#39; + password + &#39;@&#39; + siteAndPort + &#39;/&#39; + databaseName;
    console.log(url);
    mongoose.connect(url);
}

function insertScientist(scientist, response) {
    if (!connected) {
        doConnection();
    }
    var newScientist = new scientists({
        &quot;firstName&quot;: scientist.firstName,
        &quot;lastName&quot;: scientist.lastName,
        &quot;subject&quot;: scientist.subject,
        &quot;subjects&quot;: scientist.subjects,
        &quot;comments&quot;: scientist.comments
    });

    console.log(&#39;inserting&#39;, newScientist.lastName);

    newScientist.save(function(err) {
        console.log(&#39;saved: &#39;, newScientist.lastName);
        totalScientistsSaved++;
        if (totalScientistsSaved === numberOfScientists) {
            //mongoose.disconnect();
            response.send({result: &#39;Success&#39;});
        }
    });
}

function writeData(fileName, data) {
    var data = JSON.stringify(data, null, 4);
    fs.writeFile(fileName, data, function(err, data) {
        if (err) throw(err);
        console.log(&#39;success writing file&#39;);
    });
}

function readDataAndInsert(response) {
    fs.readFile(&#39;ValidScientists.json&#39;, function(err, scientists) {
        if (err) throw (err);
        numberOfScientists = scientists.length;
        scientists = JSON.parse(scientists);
        for (var i = 0; i &lt; scientists.length; i++) {
            insertScientist(scientists[i], response);
        }
    });
}

router.get(&#39;/all-data&#39;, function(request, response) {
    if (!connected) {
        doConnection();
    }

    scientists.find({}, function(err, data) {
        console.log(data.length);
        console.log(data[0]);
        allData = data;

        writeData(&#39;scientists.json&#39;, allData);

        response.send({
            result: &#39;Success&#39;,
            allData: data
        });
    });
});

router.post(&#39;/emptyCollection&#39;, function(request, response) {
    scientists.remove({}, function(err) {
        response.send({result: &#39;collection removed&#39;});
    });
});

router.post(&#39;/insertValidCollection&#39;, function(request, response) {
    readDataAndInsert(response);
});

router.post(&#39;/newComment&#39;, function(request, response) {
    if (!connected) {
        doConnection();
    }

    console.log(&#39;newComments called. Body is next: &#39;);
    console.log(request.body);
    var scientist = request.body.scientist;
    var comment = request.body.comment;

    scientists.findOne({&quot;_id&quot;: scientist._id }, function(err, scientist) {
        console.log(&#39;After Find.&#39;);
        console.log(scientist);
        if (scientist.comments) {
            scientist.comments.push(comment);
            scientist.markModified(&#39;comments&#39;);
            scientist.save(function(err, data) {
                console.log(&#39;After save.&#39;);
                console.log(&quot;Error:&quot;, err);
                console.log(&quot;Data: &quot;, data);
                response.send({result: &#39;Success&#39;, data: data});
            });
        } else {
            response.send({result: &#39;Error&#39;});
        }
    });
});

function remove(arr, item) {        
    for(var i = arr.length; i--;) {        
        if(arr[i]._id == item._id) {            
            arr.splice(i, 1);
        }
    }
}

router.post(&#39;/deleteComment&#39;, function(request, response) {
//    throw(&quot;not implemented&quot;);
    if (!connected) {
        doConnection();
    }

    var scientist = request.body.scientist;
    var comment = request.body.comment;
    console.log(comment);
    scientists.findOne({&quot;_id&quot;: scientist._id }, function(err, scientist) {
        if (scientist.comments) {
            remove(scientist.comments, comment);
            scientist.markModified(&#39;comments&#39;);
            scientist.save(function(err, updatedScientist) {
                console.log(updatedScientist);
                console.log(&#39;After save.&#39;);
                response.send({result: &#39;Success&#39;, update: updatedScientist});
            });
        } else {
            response.send({result: &#39;Error&#39;});
        }
    });
});

router.post(&#39;/updateComments&#39;, function(request, response) {
    if (!connected) {
        doConnection();
    }

    console.log(&#39;updateComments called. Body is next: &#39;);
    console.log(request.body);
    scientists.update({_id: request.body.id}, {
            $set: {
                comments: request.body.comments
            }
        },
        function(err, electionObject) {
            console.log(err, electionObject);
            if (err) {
                console.log(err);
            }
            response.send({result: &#39;Success&#39;, electionObject: electionObject});
        }
    );
});

module.exports = router;
</code></pre><h2 id="step-five">Step Five</h2>
<p>Define the front end</p>
<p>Here is <strong>public/javascripts/control.js</strong>:</p>
<pre><code>(function() {

    var app = angular.module(&#39;elvenApp&#39;, []);

    app.controller(&#39;MainController&#39;, function(commentFactory) {

        var mainController = this;

        mainController.newComment = function() {
            commentFactory.newComment(mainController.scientist, mainController.newCommentText);
        };

        mainController.updateComment = function() {
            commentFactory.updateComment(mainController.scientist);
        };

        mainController.selectScientist = function(scientist) {
            commentFactory.getScientistById(scientist.id, mainController)
        };

        mainController.selectComment = function(comment) {
            mainController.comment = comment;
        };

        mainController.insertValidCollection = function() {
            commentFactory.insertValidCollection();
        };

        mainController.emptyCollection = function() {
            commentFactory.emptyCollection();
        };

        mainController.deleteComment = function() {
            commentFactory.deleteComment(mainController.scientist, mainController.comment);
        };


        commentFactory.getScientists(mainController);
        console.log(mainController.scientists);
    });

})();
</code></pre><p>Here is <strong>public/javascripts/comment-factory.js</strong>:</p>
<pre><code>(function() {

    var app = angular.module(&#39;elvenApp&#39;);

    app.factory(&#39;commentFactory&#39;, function($http) {

        var mongoFactory = {

            allData: null,

            currentId: null,

            getScientists: function(controller) {
                $http.get(&#39;/all-data&#39;).success(function(data) {
                    if (data.allData.length &gt; 0) {
                        mongoFactory.allData = data.allData;
                        allDataNames = data.allData.map(function(scientist) {
                            return {id: scientist._id, name: scientist.firstName + &#39; &#39; + scientist.lastName};
                        });
                        controller.scientists = allDataNames;
                        mongoFactory.getScientistById(allDataNames[0].id, controller);
                    }
                }).error(function() {
                    console.log(&quot;error&quot;);
                });

            },

            newComment: function(scientist, text) {
                var comment = {
                    commentText: text,
                    date: new Date().toJSON().slice(0, 10)
                };
                if (scientist.comments === null) {
                    scientist.comments = [];
                }
                var payLoad = {scientist: scientist, comment: comment};
                $http.post(&#39;/newComment&#39;, payLoad).success(function(result) {
                    console.log(result.data.comments[result.data.comments.length - 1]._id);
                    scientist.comments.push(result.data.comments[result.data.comments.length - 1]);
                }).error(function(err) {
                    console.log(err);
                });
            },

            updateComment: function(scientist) {
                var payLoad = {id: scientist._id, comments: scientist.comments};
                $http.post(&#39;/updateComments&#39;, payLoad).success(function(result) {
                    console.log(result.electionObject);
                }).error(function(err) {
                    console.log(err);
                });
            },

            getScientistById: function(id, controller) {
                mongoFactory.currentId = id;
                var items = mongoFactory.allData.filter(function(scientist) {
                    return scientist._id === id;
                });
                return controller.scientist = items[0];
            },

            insertValidCollection: function() {
                $http.post(&#39;/insertValidCollection&#39;, {}).success(function(result) {
                    console.log(result);
                }).error(function() {
                    console.log(err);
                });
            },

            emptyCollection: function() {
                $http.post(&#39;/emptyCollection&#39;, {}).success(function(result) {
                    console.log(result);
                }).error(function(err) {
                    console.log(err);
                });
            },

            deleteComment: function(scientist, comment) {
                $http.post(&#39;/deleteComment&#39;, {scientist: scientist, comment: comment}).success(function(result) {
                    console.log(result);
                    scientist.comments = result.update.comments;
                }).error(function(err) {
                    console.log(err);
                });
            }
        };

        return mongoFactory;
    });

})();
</code></pre><h2 id="turn-it-in">Turn it in</h2>
<p>Submit the project in your repository in a folder called <strong>Week10-MongooseSubdocs</strong></p>
<h2 id="hints">Hints</h2>
<p>Please see this information:</p>
<ul>
<li>Sending a <a href="http://elvenware.com/charlie/development/web/JavaScript/Angular.html#http">new comment</a> from the browser to server to database. </li>
</ul>
</div></body></html>