<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width initial-scale=1.0"><title>MongooseSubdocuments</title><link rel="shortcut icon" href="/charlie/images/favicon.png"><!-- Latest compiled and minified CSS--><link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap.min.css"><!-- Optional theme--><link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap-theme.min.css"><link href="/libs/css/BootstrapIndex.css" rel="stylesheet" type="text/css"><link href="/css/style.css" rel="stylesheet" type="text/css"><link href="/css/highlight/googlecode.css" rel="stylesheet" type="text/css"><script src="/components/jquery/dist/jquery.js"></script><script src="/components/angular/angular.js"></script><script src="/components/angular-route/angular-route.js"></script><script src="/components/bootstrap/dist/js/bootstrap.min.js"></script><script src="/libs/scripts/elvenware.js" type="text/javascript"></script><script src="/libs/scripts/Control.js"></script></head><body><div class="navbar navbar-inverse"><div class="container"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target=".navbar-collapse" class="navbar-toggle"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">Elvenware</a></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li class="active"><a href="/index.html">Home</a></li><li><a href="/about">About</a></li><li class="dropdown"><a href="#/" data-toggle="dropdown" class="dropdown-toggle">Dropdown<b class="caret"></b></a><ul class="dropdown-menu"><li class="dropdown-header">Core Code</li><li><a href="/development/index.html">Strongly Typed</a></li><li><a href="/development/web/index.html">Web & Scripts</a></li><li><a href="/development/cloud/index.shtml">Cloud</a></li><li class="divider"></li><li class="dropdown-header">OS and Tools</li><li><a href="/os/index.html">OS</a></li><li><a href="/development/database/index.html">Database</a></li><li><a href="/books/index.html">My Writing</a></li><li class="divider"></li><li class="dropdown-header">Art</li><li><a href="/charlie/Art/index.html">Poems & Photos</a></li><li><a href="/books/reading/index.html">Book Reviews</a></li><li><a href="/spirit/index.html">Spiritual</a></li><li class="divider"></li><li class="dropdown-header">Links</li><li><a href="/charlie/links.html">My Links</a></li><li><a href="http://www.github.com/charliecalvert">GitHub</a></li><li><a href="http://sourceforge.net/projects/elvenware/">Sourceforge</a></li></ul></li></ul></div><!-- /.nav-collapse--></div></div><div class="container"><figure><img alt="Elvenware" src="/charlie/images/elvenwarelogo.png"/></figure><h1>MongooseSubdocuments</h1><h3>Table of Contents</h3><ul><!--TOC_Start--><li><a href="#description">Description</a></li>
<li><a href="#step-one">Step One</a></li>
<li><a href="#step-two">Step Two</a></li>
<li><a href="#step-three">Step Three</a></li>
<li><a href="#step-four">Step Four</a></li>
<li><a href="#step-five">Step Five</a></li>
<li><a href="#turn-it-in">Turn it in</a></li>
<li><a href="#hints">Hints</a></li><!--TOC_End--></ul><h2 id="description">Description</h2>
<p>Working with Mongoose subdocuments. </p>
<p>Reference: <a href="http://mongoosejs.com/docs/subdocs.html">http://mongoosejs.com/docs/subdocs.html</a></p>
<h2 id="step-one">Step One</h2>
<p>Create the project</p>
<pre><code>express Week10-MongooseSubdocs
cd Week10-MongooseSubdocs
npm <span class="hljs-keyword">install </span>mongoose --save
npm <span class="hljs-keyword">install
</span>copy %ELF_TEMPLATES%\.<span class="hljs-keyword">bowerrc
</span><span class="hljs-keyword">bower </span>init
</code></pre><p>Then after bower init, do this:</p>
<pre><code><span class="hljs-keyword">bower </span><span class="hljs-keyword">install </span>angular --save
<span class="hljs-keyword">bower </span><span class="hljs-keyword">install </span>angular-route --save
<span class="hljs-keyword">bower </span><span class="hljs-keyword">install </span><span class="hljs-keyword">bootstrap </span>--save
</code></pre><p>Set the port to 30025 and in <strong>routes/index.js</strong> set the title to <strong>Mongoose SubDocs LastName</strong>. Add <strong>nodemon</strong> to the <strong>start</strong> script in <strong>package.json</strong>.</p>
<p>Save JSON data as <strong>ValidScientists.json</strong>:</p>
<ul>
<li><a href="https://gist.github.com/charliecalvert/059f2f74d5bf2d98c6f8">Scientists JSON data</a></li>
</ul>
<h2 id="step-two">Step Two</h2>
<p>Define the Mongoose documents.</p>
<p>The key thing to notice is that we have a main document and an array of sub-documents. In particular, each scientist document has zero or more comments associated with it. The comments take the form of sub-documents. Notice how the <strong>comments</strong> field of the <strong>scientistSchema</strong> is declared.   </p>
<pre><code><span class="hljs-keyword">var</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);

<span class="hljs-keyword">var</span> commentSchema = mongoose.Schema({
    commentText: <span class="hljs-built_in">String</span>,
    date: { <span class="hljs-keyword">type</span>: <span class="hljs-built_in">Date</span>, <span class="hljs-keyword">default</span>: <span class="hljs-built_in">Date</span>.now }
});

<span class="hljs-keyword">var</span> scientistsSchema = mongoose.Schema({
    <span class="hljs-string">"firstName"</span>: <span class="hljs-built_in">String</span>,
    <span class="hljs-string">"lastName"</span>: <span class="hljs-built_in">String</span>,
    <span class="hljs-string">"subject"</span>: <span class="hljs-built_in">String</span>,
    <span class="hljs-string">"subjects"</span>: [<span class="hljs-built_in">String</span>],
    comments: [commentSchema]
});

<span class="hljs-keyword">module</span>.exports = {
    comment: mongoose.model(<span class="hljs-string">'comment'</span>, commentSchema),
    scientist: mongoose.model(<span class="hljs-string">'scientist'</span>, scientistsSchema)
};
</code></pre><h2 id="step-three">Step Three</h2>
<p>Define the views</p>
<p>Here is layout.jade:</p>
<pre><code>doctype html
html
    head
        title= title
        link(<span class="hljs-name">rel=</span>'stylesheet', href='/stylesheets/style.css')
        link(<span class="hljs-name">rel=</span>'stylesheet', href='/components/bootstrap/dist/css/bootstrap.css')
        script(<span class="hljs-name">src=</span><span class="hljs-string">"components/jquery/dist/jquery.js"</span>)
        script(<span class="hljs-name">src=</span><span class="hljs-string">"components/bootstrap/dist/js/bootstrap.js"</span>)
        script(<span class="hljs-name">src=</span><span class="hljs-string">"components/angular/angular.js"</span>)
        script(<span class="hljs-name">src=</span><span class="hljs-string">"javascripts/control.js"</span>)
        script(<span class="hljs-name">src=</span><span class="hljs-string">"javascripts/comment-factory.js"</span>)
    body(<span class="hljs-name">ng-app=</span>'elvenApp')
        block content
</code></pre><p>Here is index.jade:</p>
<pre><code><span class="hljs-keyword">extends</span> layout

block content
    h1= title
    p <span class="hljs-type">Welcome</span> to #{title}

    div(ng-controller=<span class="hljs-symbol">'MainController</span> as mainController')

        div.names
            div.btn-group
                button.btn.btn-<span class="hljs-keyword">default</span>(ng-click=<span class="hljs-symbol">'mainController</span>.emptyCollection()') <span class="hljs-type">Empty</span> <span class="hljs-type">Collection</span>
                button.btn.btn-<span class="hljs-keyword">default</span>(ng-click=<span class="hljs-symbol">'mainController</span>.insertValidCollection()') <span class="hljs-type">Insert</span> <span class="hljs-type">Valid</span> <span class="hljs-type">Collection</span>

        div.names
            ul
                li(ng-repeat=<span class="hljs-symbol">'scientist</span> in mainController.scientists')
                    a(ng-click=<span class="hljs-string">"mainController.selectScientist(scientist)"</span>) {{scientist.name}}

        div.names
            div
                label(<span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-symbol">'col</span>-sm<span class="hljs-number">-2</span>, control-label') <span class="hljs-type">First</span>:
                span {{mainController.scientist.firstName}}
            div
                label(<span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-symbol">'col</span>-sm<span class="hljs-number">-2</span>, control-label') <span class="hljs-type">Last</span>:
                span {{mainController.scientist.lastName}}
            div
                label(<span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-symbol">'col</span>-sm<span class="hljs-number">-2</span>, control-label') <span class="hljs-type">Subject</span>:
                span {{mainController.scientist.subject}}

        div.names
            ul
                li(ng-repeat=<span class="hljs-symbol">'comment</span> in mainController.scientist.comments')
                    a(ng-click=<span class="hljs-string">"mainController.selectComment(comment)"</span>) {{comment.commentText}}

        div.names(ng-form=<span class="hljs-string">"newCommentForm"</span>)
            button.btn.btn-<span class="hljs-keyword">default</span>(ng-click=<span class="hljs-symbol">'mainController</span>.newComment()') <span class="hljs-type">New</span> <span class="hljs-type">Comment</span>
            hr
            label(<span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-symbol">'col</span>-sm<span class="hljs-number">-2</span>, control-label') <span class="hljs-type">Text</span>
            input.form-control(<span class="hljs-class"><span class="hljs-keyword">type</span></span>=<span class="hljs-symbol">'tex</span>t', ng-model=<span class="hljs-symbol">'mainController</span>.newCommentText')

        div.names(ng-form=<span class="hljs-string">"myform"</span>)
            button.btn.btn-<span class="hljs-keyword">default</span>(ng-click=<span class="hljs-symbol">'mainController</span>.updateComment()') <span class="hljs-type">Update</span> <span class="hljs-type">Comment</span>
            button.btn.btn-<span class="hljs-keyword">default</span>(ng-click=<span class="hljs-symbol">'mainController</span>.deleteComment()') <span class="hljs-type">Delete</span> <span class="hljs-type">Comment</span>
            hr
            label(<span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-symbol">'col</span>-sm<span class="hljs-number">-2</span>, control-label') <span class="hljs-type">Text</span>
            input.form-control(<span class="hljs-class"><span class="hljs-keyword">type</span></span>=<span class="hljs-symbol">'tex</span>t', ng-model=<span class="hljs-symbol">'mainController</span>.comment.commentText')
            br
            label(<span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-symbol">'col</span>-sm<span class="hljs-number">-2</span>, control-label') <span class="hljs-type">Date</span>
            input.form-control(<span class="hljs-class"><span class="hljs-keyword">type</span></span>=<span class="hljs-symbol">'tex</span>t', ng-model=<span class="hljs-symbol">'mainController</span>.comment.date')
            br
            label(<span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-symbol">'col</span>-sm<span class="hljs-number">-2</span>, control-label') <span class="hljs-type">Id</span>
            input.form-control(<span class="hljs-class"><span class="hljs-keyword">type</span></span>=<span class="hljs-symbol">'tex</span>t', ng-model=<span class="hljs-symbol">'mainController</span>.comment._id')
</code></pre><h2 id="step-four">Step Four</h2>
<p>Define the back end</p>
<p>Here is <strong>index.js</strong></p>
<pre><code><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">var</span> router = express.Router();
<span class="hljs-keyword">var</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);
<span class="hljs-keyword">var</span> scientistSchema = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../models/scientists'</span>);
<span class="hljs-keyword">var</span> scientists = scientistSchema.scientist;
<span class="hljs-keyword">var</span> comments = scientistSchema.comment;
<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);


<span class="hljs-comment">/* GET home page. */</span>
router.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
    res.render(<span class="hljs-string">'index'</span>, {title: <span class="hljs-string">'Express'</span>});
});

<span class="hljs-keyword">var</span> allData;
<span class="hljs-keyword">var</span> connected = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">var</span> numberOfScientists = <span class="hljs-number">0</span>;
<span class="hljs-keyword">var</span> totalScientistsSaved = <span class="hljs-number">0</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doConnection</span>(<span class="hljs-params"></span>) </span>{
    connected = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">var</span> userName = <span class="hljs-string">'csc'</span>;
    <span class="hljs-keyword">var</span> password = <span class="hljs-string">'Re*lD*t*22#'</span>;
    <span class="hljs-keyword">var</span> siteAndPort = <span class="hljs-string">'ds049848.mongolab.com:49848'</span>;
    <span class="hljs-keyword">var</span> databaseName = <span class="hljs-string">'elvenlab01'</span>;
    <span class="hljs-keyword">var</span> url = <span class="hljs-string">'mongodb://'</span> + userName + <span class="hljs-string">':'</span> + password + <span class="hljs-string">'@'</span> + siteAndPort + <span class="hljs-string">'/'</span> + databaseName;
    <span class="hljs-built_in">console</span>.log(url);
    mongoose.connect(url);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">insertScientist</span>(<span class="hljs-params">scientist, response</span>) </span>{
    <span class="hljs-keyword">if</span> (!connected) {
        doConnection();
    }
    <span class="hljs-keyword">var</span> newScientist = <span class="hljs-keyword">new</span> scientists({
        <span class="hljs-string">"firstName"</span>: scientist.firstName,
        <span class="hljs-string">"lastName"</span>: scientist.lastName,
        <span class="hljs-string">"subject"</span>: scientist.subject,
        <span class="hljs-string">"subjects"</span>: scientist.subjects,
        <span class="hljs-string">"comments"</span>: scientist.comments
    });

    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'inserting'</span>, newScientist.lastName);

    newScientist.save(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'saved: '</span>, newScientist.lastName);
        totalScientistsSaved++;
        <span class="hljs-keyword">if</span> (totalScientistsSaved === numberOfScientists) {
            <span class="hljs-comment">//mongoose.disconnect();</span>
            response.send({result: <span class="hljs-string">'Success'</span>});
        }
    });
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writeData</span>(<span class="hljs-params">fileName, data</span>) </span>{
    <span class="hljs-keyword">var</span> data = <span class="hljs-built_in">JSON</span>.stringify(data, <span class="hljs-literal">null</span>, <span class="hljs-number">4</span>);
    fs.writeFile(fileName, data, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
        <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span>(err);
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'success writing file'</span>);
    });
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readDataAndInsert</span>(<span class="hljs-params">response</span>) </span>{
    fs.readFile(<span class="hljs-string">'ValidScientists.json'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, scientists</span>) </span>{
        <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> (err);
        numberOfScientists = scientists.length;
        scientists = <span class="hljs-built_in">JSON</span>.parse(scientists);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; scientists.length; i++) {
            insertScientist(scientists[i], response);
        }
    });
}

router.get(<span class="hljs-string">'/all-data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
    <span class="hljs-keyword">if</span> (!connected) {
        doConnection();
    }

    scientists.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
        <span class="hljs-built_in">console</span>.log(data.length);
        <span class="hljs-built_in">console</span>.log(data[<span class="hljs-number">0</span>]);
        allData = data;

        writeData(<span class="hljs-string">'scientists.json'</span>, allData);

        response.send({
            result: <span class="hljs-string">'Success'</span>,
            allData: data
        });
    });
});

router.post(<span class="hljs-string">'/emptyCollection'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
    scientists.remove({}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
        response.send({result: <span class="hljs-string">'collection removed'</span>});
    });
});

router.post(<span class="hljs-string">'/insertValidCollection'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
    readDataAndInsert(response);
});

router.post(<span class="hljs-string">'/newComment'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
    <span class="hljs-keyword">if</span> (!connected) {
        doConnection();
    }

    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'newComments called. Body is next: '</span>);
    <span class="hljs-built_in">console</span>.log(request.body);
    <span class="hljs-keyword">var</span> scientist = request.body.scientist;
    <span class="hljs-keyword">var</span> comment = request.body.comment;

    scientists.findOne({<span class="hljs-string">"_id"</span>: scientist._id }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, scientist</span>) </span>{
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'After Find.'</span>);
        <span class="hljs-built_in">console</span>.log(scientist);
        <span class="hljs-keyword">if</span> (scientist.comments) {
            scientist.comments.push(comment);
            scientist.markModified(<span class="hljs-string">'comments'</span>);
            scientist.save(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'After save.'</span>);
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Error:"</span>, err);
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Data: "</span>, data);
                response.send({result: <span class="hljs-string">'Success'</span>, data: data});
            });
        } <span class="hljs-keyword">else</span> {
            response.send({result: <span class="hljs-string">'Error'</span>});
        }
    });
});

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">remove</span>(<span class="hljs-params">arr, item</span>) </span>{        
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = arr.length; i--;) {        
        <span class="hljs-keyword">if</span>(arr[i]._id == item._id) {            
            arr.splice(i, <span class="hljs-number">1</span>);
        }
    }
}

router.post(<span class="hljs-string">'/deleteComment'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
<span class="hljs-comment">//    throw("not implemented");</span>
    <span class="hljs-keyword">if</span> (!connected) {
        doConnection();
    }

    <span class="hljs-keyword">var</span> scientist = request.body.scientist;
    <span class="hljs-keyword">var</span> comment = request.body.comment;
    <span class="hljs-built_in">console</span>.log(comment);
    scientists.findOne({<span class="hljs-string">"_id"</span>: scientist._id }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, scientist</span>) </span>{
        <span class="hljs-keyword">if</span> (scientist.comments) {
            remove(scientist.comments, comment);
            scientist.markModified(<span class="hljs-string">'comments'</span>);
            scientist.save(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, updatedScientist</span>) </span>{
                <span class="hljs-built_in">console</span>.log(updatedScientist);
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'After save.'</span>);
                response.send({result: <span class="hljs-string">'Success'</span>, update: updatedScientist});
            });
        } <span class="hljs-keyword">else</span> {
            response.send({result: <span class="hljs-string">'Error'</span>});
        }
    });
});

router.post(<span class="hljs-string">'/updateComments'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
    <span class="hljs-keyword">if</span> (!connected) {
        doConnection();
    }

    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'updateComments called. Body is next: '</span>);
    <span class="hljs-built_in">console</span>.log(request.body);
    scientists.update({_id: request.body.id}, {
            $set: {
                comments: request.body.comments
            }
        },
        <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, electionObject</span>) </span>{
            <span class="hljs-built_in">console</span>.log(err, electionObject);
            <span class="hljs-keyword">if</span> (err) {
                <span class="hljs-built_in">console</span>.log(err);
            }
            response.send({result: <span class="hljs-string">'Success'</span>, electionObject: electionObject});
        }
    );
});

<span class="hljs-built_in">module</span>.exports = router;
</code></pre><h2 id="step-five">Step Five</h2>
<p>Define the front end</p>
<p>Here is <strong>public/javascripts/control.js</strong>:</p>
<pre><code>(<span class="hljs-name">function</span>() {

    var app = angular.module(<span class="hljs-name">'elvenApp'</span>, [])<span class="hljs-comment">;</span>

    app.controller(<span class="hljs-name">'MainController'</span>, function(<span class="hljs-comment">comment</span><span class="hljs-name">Factory</span>) {

        var mainController = this;

        mainController.newComment = function() {
            commentFactory.newComment(<span class="hljs-name">mainController.scientist</span>, mainController.newCommentText)<span class="hljs-comment">;</span>
        }<span class="hljs-comment">;</span>

        mainController.updateComment = function() {
            commentFactory.updateComment(<span class="hljs-name">mainController.scientist</span>)<span class="hljs-comment">;</span>
        }<span class="hljs-comment">;</span>

        mainController.selectScientist = function(<span class="hljs-name">scientist</span>) {
            commentFactory.getScientistById(<span class="hljs-name">scientist.id</span>, mainController)
        }<span class="hljs-comment">;</span>

        mainController.selectComment = function(<span class="hljs-comment">comment</span>) {
            mainController.comment = comment;
        }<span class="hljs-comment">;</span>

        mainController.insertValidCollection = function() {
            commentFactory.insertValidCollection()<span class="hljs-comment">;</span>
        }<span class="hljs-comment">;</span>

        mainController.emptyCollection = function() {
            commentFactory.emptyCollection()<span class="hljs-comment">;</span>
        }<span class="hljs-comment">;</span>

        mainController.deleteComment = function() {
            commentFactory.deleteComment(<span class="hljs-name">mainController.scientist</span>, mainController.comment)<span class="hljs-comment">;</span>
        }<span class="hljs-comment">;</span>


        commentFactory.getScientists(<span class="hljs-name">mainController</span>)<span class="hljs-comment">;</span>
        console.log(<span class="hljs-name">mainController.scientists</span>)<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>

})()<span class="hljs-comment">;</span>
</code></pre><p>Here is <strong>public/javascripts/comment-factory.js</strong>:</p>
<pre><code>(<span class="hljs-name">function</span>() {

    var app = angular.module(<span class="hljs-name">'elvenApp'</span>)<span class="hljs-comment">;</span>

    app.factory(<span class="hljs-name">'commentFactory'</span>, function($http) {

        var mongoFactory = {

            allData: null,

            currentId: null,

            getScientists: function(<span class="hljs-name">controller</span>) {
                $http.get(<span class="hljs-name">'/all-data'</span>).success(<span class="hljs-name">function</span>(<span class="hljs-name">data</span>) {
                    if (<span class="hljs-name">data.allData.length</span> &gt; <span class="hljs-number">0</span>) {
                        mongoFactory.allData = data.allData;
                        allDataNames = data.allData.map(<span class="hljs-name">function</span>(<span class="hljs-name">scientist</span>) {
                            return {id: scientist._id, name: scientist.firstName + ' ' + scientist.lastName}<span class="hljs-comment">;</span>
                        })<span class="hljs-comment">;</span>
                        controller.scientists = allDataNames;
                        mongoFactory.getScientistById(<span class="hljs-name">allDataNames</span>[<span class="hljs-number">0</span>].id, controller)<span class="hljs-comment">;</span>
                    }
                }).error(<span class="hljs-name">function</span>() {
                    console.log(<span class="hljs-string">"error"</span>)<span class="hljs-comment">;</span>
                })<span class="hljs-comment">;</span>

            },

            newComment: function(<span class="hljs-name">scientist</span>, text) {
                var comment = {
                    commentText: text,
                    date: new Date().toJSON().slice(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>)
                }<span class="hljs-comment">;</span>
                if (<span class="hljs-name">scientist.comments</span> === null) {
                    scientist.comments = []<span class="hljs-comment">;</span>
                }
                var payLoad = {scientist: scientist, comment: comment}<span class="hljs-comment">;</span>
                $http.post(<span class="hljs-name">'/newComment'</span>, payLoad).success(<span class="hljs-name">function</span>(<span class="hljs-name">result</span>) {
                    console.log(<span class="hljs-name">result.data.comments</span>[result.data.comments.length - <span class="hljs-number">1</span>]._id)<span class="hljs-comment">;</span>
                    scientist.comments.push(<span class="hljs-name">result.data.comments</span>[result.data.comments.length - <span class="hljs-number">1</span>])<span class="hljs-comment">;</span>
                }).error(<span class="hljs-name">function</span>(<span class="hljs-name">err</span>) {
                    console.log(<span class="hljs-name">err</span>)<span class="hljs-comment">;</span>
                })<span class="hljs-comment">;</span>
            },

            updateComment: function(<span class="hljs-name">scientist</span>) {
                var payLoad = {id: scientist._id, comments: scientist.comments}<span class="hljs-comment">;</span>
                $http.post(<span class="hljs-name">'/updateComments'</span>, payLoad).success(<span class="hljs-name">function</span>(<span class="hljs-name">result</span>) {
                    console.log(<span class="hljs-name">result.electionObject</span>)<span class="hljs-comment">;</span>
                }).error(<span class="hljs-name">function</span>(<span class="hljs-name">err</span>) {
                    console.log(<span class="hljs-name">err</span>)<span class="hljs-comment">;</span>
                })<span class="hljs-comment">;</span>
            },

            getScientistById: function(<span class="hljs-name">id</span>, controller) {
                mongoFactory.currentId = id;
                var items = mongoFactory.allData.filter(<span class="hljs-name">function</span>(<span class="hljs-name">scientist</span>) {
                    return scientist._id === id;
                })<span class="hljs-comment">;</span>
                return controller.scientist = items[<span class="hljs-number">0</span>]<span class="hljs-comment">;</span>
            },

            insertValidCollection: function() {
                $http.post(<span class="hljs-name">'/insertValidCollection'</span>, {}).success(<span class="hljs-name">function</span>(<span class="hljs-name">result</span>) {
                    console.log(<span class="hljs-name">result</span>)<span class="hljs-comment">;</span>
                }).error(<span class="hljs-name">function</span>() {
                    console.log(<span class="hljs-name">err</span>)<span class="hljs-comment">;</span>
                })<span class="hljs-comment">;</span>
            },

            emptyCollection: function() {
                $http.post(<span class="hljs-name">'/emptyCollection'</span>, {}).success(<span class="hljs-name">function</span>(<span class="hljs-name">result</span>) {
                    console.log(<span class="hljs-name">result</span>)<span class="hljs-comment">;</span>
                }).error(<span class="hljs-name">function</span>(<span class="hljs-name">err</span>) {
                    console.log(<span class="hljs-name">err</span>)<span class="hljs-comment">;</span>
                })<span class="hljs-comment">;</span>
            },

            deleteComment: function(<span class="hljs-name">scientist</span>, comment) {
                $http.post(<span class="hljs-name">'/deleteComment'</span>, {scientist: scientist, comment: comment}).success(<span class="hljs-name">function</span>(<span class="hljs-name">result</span>) {
                    console.log(<span class="hljs-name">result</span>)<span class="hljs-comment">;</span>
                    scientist.comments = result.update.comments;
                }).error(<span class="hljs-name">function</span>(<span class="hljs-name">err</span>) {
                    console.log(<span class="hljs-name">err</span>)<span class="hljs-comment">;</span>
                })<span class="hljs-comment">;</span>
            }
        }<span class="hljs-comment">;</span>

        return mongoFactory;
    })<span class="hljs-comment">;</span>

})()<span class="hljs-comment">;</span>
</code></pre><h2 id="turn-it-in">Turn it in</h2>
<p>Submit the project in your repository in a folder called <strong>Week10-MongooseSubdocs</strong></p>
<h2 id="hints">Hints</h2>
<p>Please see this information:</p>
<ul>
<li>Sending a <a href="http://elvenware.com/charlie/development/web/JavaScript/Angular.html#http">new comment</a> from the browser to server to database. </li>
</ul>
</div></body></html>