<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width initial-scale=1.0"><title>ExpressSessionBasics</title><link rel="shortcut icon" href="/charlie/images/favicon.png"><!-- Latest compiled and minified CSS--><link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap.min.css"><!-- Optional theme--><link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap-theme.min.css"><!-- link(href='/libs/css/BootstrapIndex.css', rel='stylesheet', type='text/css')--><link href="/css/style.css" rel="stylesheet" type="text/css"><link href="/css/highlight/googlecode.css" rel="stylesheet" type="text/css"><script src="/components/jquery/dist/jquery.js"></script><script src="/components/angular/angular.js"></script><script src="/components/angular-route/angular-route.js"></script><script src="/components/bootstrap/dist/js/bootstrap.min.js"></script><!-- script(src='/libs/scripts/elvenware.js', type='text/javascript')--><script src="/libs/scripts/Control.js"></script><!-- script(src='http://localhost:35729/livereload.js')--></head><body><div class="navbar navbar-inverse"><div class="container"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target=".navbar-collapse" class="navbar-toggle"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">Elvenware</a></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li class="active"><a href="/index.html">Home</a></li><li><a href="/charlie/About.html">About</a></li><li class="dropdown"><a href="#/" data-toggle="dropdown" class="dropdown-toggle">Dropdown<b class="caret"></b></a><ul class="dropdown-menu"><li class="dropdown-header">Core Code</li><li><a href="/charlie/development/index.html">Strongly Typed</a></li><li><a href="/charlie/development/web/index.html">Web & Scripts</a></li><li><a href="/charlie/development/cloud/index.shtml">Cloud</a></li><li class="divider"></li><li class="dropdown-header">OS and Tools</li><li><a href="/os/index.html">OS</a></li><li><a href="/charlie/development/database/index.html">Database</a></li><li><a href="/books/index.html">My Writing</a></li><li class="divider"></li><li class="dropdown-header">Art</li><li><a href="/charlie/Art/index.html">Poems & Photos</a></li><li><a href="/books/reading/index.html">Book Reviews</a></li><li><a href="/spirit/index.html">Spiritual</a></li><li class="divider"></li><li class="dropdown-header">Links</li><li><a href="/charlie/links.html">My Links</a></li><li><a href="http://www.github.com/charliecalvert">GitHub</a></li><li><a href="http://sourceforge.net/projects/elvenware/">Sourceforge</a></li></ul></li></ul></div><!-- /.nav-collapse--></div></div><div class="container"><figure><img alt="Elvenware" src="/charlie/images/elvenwarelogo.png"/></figure><h1>ExpressSessionBasics</h1><h3>Table of Contents</h3><ul><!--TOC_Start--><li><a href="#overview">Overview</a></li>
<li><a href="#step-01">Step 01</a></li>
<li><a href="#step-02">Step 02</a></li>
<li><a href="#middleware">Step 03</a></li>
<li><a href="#step-04">Step 04</a></li>
<li><a href="#step05">Step05</a></li>
<li><a href="#step06">Step06</a></li>
<li><a href="#page-views">Page Views</a></li>
<li><a href="#file-store">File Store</a></li>
<li><a href="#server-feedback">Additional Server Side Feedback</a></li>
<li><a href="#turn-it-in">Turn it in</a></li><!--TOC_End--></ul><h2 id="overview">Overview</h2>
<p>Session Basics</p>
<h2 id="step-01">Step 01</h2>
<p>CreateAllExpress Week04-SessionBasics</p>
<p>nodemon.json:</p>
<pre><code>{
  "<span class="hljs-attr">verbose</span>": <span class="hljs-literal">true</span>,
  "<span class="hljs-attr">ignore</span>": [<span class="hljs-string">"**/components/**"</span>, <span class="hljs-string">"**/sessions/**"</span>]
}
</code></pre><p><a href="https://github.com/twilson63/express-couchUser">https://github.com/twilson63/express-couchUser</a></p>
<p>Use NPM to install the libraries we will need:</p>
<pre>
npm install session-file-store express-session parseurl uuid
</pre>

<h2 id="step-02">Step 02</h2>
<p>If you have not done so already, at some point we need to install redis. Details are here:</p>
<ul>
<li><a href="http://www.elvenware.com/charlie/development/database/NoSql/redis.html">http://www.elvenware.com/charlie/development/database/NoSql/redis.html</a></li>
</ul>
<h2 id="middleware">Step 03</h2>
<p>Now lets learn about middleware. We can employ the <strong>app.use</strong> method to add in middleware (code) that we want to be called every time a request comes in, or when certain types of requests come in. In other words, when the user in the browser sends a request our way, then we can set things up so our middleware will be called.</p>
<p>In <strong>app.js</strong>, just before you use <strong>index</strong> and <strong>users</strong> (around line 26) insert the following sample bit of middleware:</p>
<pre><code class="lang-javascript">app.use(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response, next</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Sample middleware with useful output'</span>);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'request cookies'</span>, request.cookies);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'request secret'</span>, request.secret);
    <span class="hljs-comment">// Uncomment the following line for one run, perhaps.</span>
    <span class="hljs-comment">// It is too verbose to use everytime</span>
    <span class="hljs-comment">// console.log(Object.getOwnPropertyNames(request));</span>
    next();
});
</code></pre>
<p>Order can be important here. To help you understand how this works, recall that this code in <strong>app.js</strong> links in, that is, it <strong>uses</strong>, your <strong>routes/index.js</strong> file:</p>
<pre><code class="lang-javascript">var <span class="hljs-keyword">index</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">'./routes/index'</span>);
<span class="hljs-regexp">//</span> === Insert Middleware here <span class="hljs-keyword">if</span> you want <span class="hljs-keyword">index</span>.js to <span class="hljs-keyword">use</span> it. ===
app.<span class="hljs-keyword">use</span>(<span class="hljs-string">'/'</span>, <span class="hljs-keyword">index</span>);
</code></pre>
<p>You want to define your middleware before you <strong>use</strong> a particular route. For instance, define this middleware before you use the <strong>/</strong> route in <strong>app.js</strong> if you want the code in <strong>index.js</strong> to trigger a call to this middleware. If you don&#39;t want <strong>index.js</strong> to use this code, then define your middleware after you link in the <strong>/</strong> route. You can insert middleware in multiple places. The only constraint would be performance, and performance is not likely to be an issue for us in this course.</p>
<p>The point is that this middleware is <strong>used</strong> every time a request is made that involves code from <strong>index.js</strong> or from any other module that is linked in after the middleware is defined.</p>
<h2 id="step-04">Step 04</h2>
<p>In <strong>routes/index.js</strong> include the following two methods. Note that the second method replaces an existing method in the file:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> routeParamMiddleware = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response, next</span>) </span>{
<span class="hljs-meta">  'use strict'</span>;  
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'My middleware called by this route:'</span>, request.originalUrl);
  next();
};

router.get(<span class="hljs-string">'/'</span>, routeParamMiddleware, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{ <span class="hljs-string">'use strict'</span>;
  <span class="hljs-string">'use strict'</span>;
  res.render(<span class="hljs-string">'index'</span>, { title: <span class="hljs-string">'Week09-SessionBasics'</span> });
});
</code></pre>
<p>This middleware is used every time the <strong>/</strong> route is used. The two types of middleware shown here in steps 3 and 4, cover most of our needs for creating custom middleware.</p>
<h2 id="step05">Step05</h2>
<p>Be sure you have installed the following packages:</p>
<pre><code>npm <span class="hljs-keyword">install</span> express-<span class="hljs-keyword">session</span> <span class="hljs-comment">--save</span>
npm <span class="hljs-keyword">install</span> <span class="hljs-keyword">uuid</span> <span class="hljs-comment">--save</span>
</code></pre><p>Put this code near the top of <strong>app.js</strong>, perhaps right after <strong>body-parser</strong> is linked in:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> session = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express-session'</span>);
<span class="hljs-keyword">var</span> uuid = <span class="hljs-built_in">require</span>(<span class="hljs-string">'uuid'</span>);
</code></pre>
<p>Put this code further down, right before the sample middleware we inserted previously:</p>
<pre><code class="lang-javascript">
app.use(session({
    genid: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req</span>) </span>{
<span class="hljs-meta">        'use strict'</span>;
        <span class="hljs-keyword">return</span> uuid.v4(); <span class="hljs-comment">// use UUIDs for session IDs</span>
    },
    secret: process.env.SESSION_SECRET || <span class="hljs-string">'keyboard cat'</span>,
    resave: <span class="hljs-literal">true</span>,
    saveUninitialized: <span class="hljs-literal">true</span>
}));
</code></pre>
<ul>
<li><a href="https://www.npmjs.com/package/uuid">https://www.npmjs.com/package/uuid</a></li>
</ul>
<h2 id="step06">Step06</h2>
<p>One common trick used to help people understand how sessions work is to keep track of the previous page visited. This can be useful if you want to walk the user back through the pages they have visitied, but it is mostly done as a learning exercise.</p>
<p>Put this code in <strong>routes/index.js</strong> after the &#39;/&#39; route:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> pageReport = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;
    <span class="hljs-keyword">var</span> previousPage = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">if</span> (request.session.lastPage) {
        previousPage = request.session.lastPage;
    }

    request.session.lastPage = request.url;
    <span class="hljs-keyword">var</span> welcome = <span class="hljs-string">'Welcome to '</span> + request.url;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'welcome'</span>, welcome);
    response.send({
        currentPage: request.url,
        previousPage: previousPage,
        <span class="hljs-string">'session'</span>: request.session
    });
};
router.get(<span class="hljs-string">'/page01'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;
    pageReport(request, response);
});

router.get(<span class="hljs-string">'/page02'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;
    pageReport(request, response);
});

router.get(<span class="hljs-string">'/page03'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;
    pageReport(request, response);
});
</code></pre>
<p>To make this work, you are going to want to put some buttons on the main page, then respond to clicks on those buttons. Do you work in <strong>views/index.jade</strong> and in <strong>public/javascript/control.js</strong>.</p>
<p><strong>NOTE</strong>: <em>If, by this time, it is not fairly obvious to you how to do this, then you need to do several things:</em></p>
<ol>
<li>Review the <strong>Week03-ExpressRoutes</strong> and <strong>Week03-JQuery</strong> programs</li>
<li>Internalize the techniques for handling button clicks and retrieving JSON from the server with <strong>$.getJSON</strong>.</li>
<li>Consider learning to write these kinds of programs by heart, without referring to instructions or notes.</li>
</ol>
<p>Because the server side code is nearly identical for each route, you should be able to write the code for calling the server in a single method called <strong>showpage</strong> that needs to only the route to call:</p>
<pre><code class="lang-javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">showPage</span>(<span class="hljs-params">pageRoute</span>) </span>{
    <span class="hljs-comment">// YOUR CODE HERE</span>
    <span class="hljs-comment">// Be sure to handle the .done .fail and .always chained methods for</span>
    <span class="hljs-comment">// your call to the server. See the jQuery docs for details.</span>
}

$(<span class="hljs-string">'#page01'</span>).click(<span class="hljs-comment">/* CALL showPage AND PASS THE APPROPRIATE ROUTE */</span>);
$(<span class="hljs-string">'#page02'</span>).click(<span class="hljs-comment">/* CALL showPage AND PASS THE APPROPRIATE ROUTE */</span>);
$(<span class="hljs-string">'#page03'</span>).click(<span class="hljs-comment">/* CALL showPage AND PASS THE APPROPRIATE ROUTE */</span>);
</code></pre>
<p>The .fail chained method might look a bit like this:</p>
<pre><code class="lang-javascript">.fail(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">jq, status, error</span>) </span>{
    $(<span class="hljs-string">'#displayArea'</span>).html(<span class="hljs-string">'error: '</span> + jq.responseText);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'error: '</span>, status);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'error: '</span>, error);
})
</code></pre>
<p>Consider putting this code in <strong>style.css</strong>. For this to work properly, you will have to load <strong>style.css</strong> after you load <strong>bootstrap.css</strong>.</p>
<pre><code class="lang-css"><span class="hljs-selector-tag">div</span> {
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">5px</span>;
}

<span class="hljs-selector-tag">button</span> {
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">5px</span>;
}

<span class="hljs-selector-tag">pre</span> {
  <span class="hljs-attribute">font-size</span>: large;
}
</code></pre>
<h2 id="page-views">Page Views</h2>
<p>Now let&#39;s track how many views each page gets.</p>
<p>Create a file called <strong>routes/middleware.js</strong>. Load it from <strong>app.js</strong> the same way you load <strong>index.js</strong> and <strong>user.js</strong>, but load the middleware page first, before the other pages. Interestingly, we don&#39;t need to specify which route is associated with this file. For instance:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">app</span>.<span class="hljs-keyword">use</span>(middleware);        &lt;=== <span class="hljs-keyword">NO</span> ROUTE
<span class="hljs-keyword">app</span>.<span class="hljs-keyword">use</span>('/users', users);   &lt;=== INCLUDES ROUTE
</code></pre>
<p>Here is the code to put in <strong>middleware.js</strong>:</p>
<pre><code class="lang-javascript">
<span class="hljs-comment">// LOAD PARSEURL:</span>
<span class="hljs-keyword">var</span> parseurl = <span class="hljs-built_in">require</span>(<span class="hljs-string">'parseurl'</span>);
<span class="hljs-comment">// WHAT OTHER PACKAGES NEED TO BE LOADED BEFORE THIS CODE WILL WORK?</span>

router.use(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response, next</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;
    <span class="hljs-keyword">var</span> views = request.session.views;

    <span class="hljs-keyword">if</span> (!views) {
        views = request.session.views = {};
    }

    <span class="hljs-comment">// get the url pathname</span>
    <span class="hljs-keyword">var</span> pathname = parseurl(request).pathname;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'pathname'</span>, pathname);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'views'</span>, views);

    <span class="hljs-comment">// count the views</span>
    views[pathname] = (views[pathname] || <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>;

    next();
});

<span class="hljs-comment">// WHAT DO YOU NEED TO DO HERE TO EXPORT THIS CODE FROM THIS MODULE?</span>
</code></pre>
<p>Create another file called <strong>routes/views.js</strong>. Load it from <strong>app.js</strong>. This time, however, you can <strong>use</strong> it last, after <strong>middleware, routes</strong> and <strong>users</strong>.</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">var</span> router = express.Router();

<span class="hljs-comment">// WRITE IT THIS WAY SO WE ONLY NEED TO INCLUDE ONE 'use strict'; STATEMENT</span>
<span class="hljs-built_in">module</span>.exports = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">    'use strict'</span>;

    router.get(<span class="hljs-string">'/page01'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response, next</span>) </span>{
        response.send(<span class="hljs-string">'you viewed this page '</span> + request.session.views[<span class="hljs-string">'/views/page01'</span>] + <span class="hljs-string">' times'</span>);
    });

    router.get(<span class="hljs-string">'/page02'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response, next</span>) </span>{
        response.send(<span class="hljs-string">'you viewed this page '</span> + request.session.views[<span class="hljs-string">'/views/page02'</span>] + <span class="hljs-string">' times'</span>);
    });
    <span class="hljs-keyword">return</span> router;
})();
</code></pre>
<h2 id="file-store">File Store</h2>
<p>Later, we will start saving session and user data to a database. For now, however, let&#39;s simplify things by saving some information to a file. At the top of app.js:</p>
<pre><code class="lang-javascript">var FileStore = require('session-file-store')(<span class="hljs-name">session</span>)<span class="hljs-comment">;</span>
</code></pre>
<p>Then modify the way we use the session object so that it references the file store:</p>
<pre><code class="lang-javascript">app.use(session({
    genid: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req</span>) </span>{
<span class="hljs-meta">        'use strict'</span>;
        <span class="hljs-keyword">return</span> uuid.v4(); <span class="hljs-comment">// use UUIDs for session IDs</span>
    },    
    secret: process.env.SESSION_SECRET || <span class="hljs-string">'keyboard cat'</span>,
    resave: <span class="hljs-literal">true</span>,
    saveUninitialized: <span class="hljs-literal">true</span>,
    store: <span class="hljs-keyword">new</span> FileStore();  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">====</span> <span class="hljs-attr">HERE</span> <span class="hljs-attr">IT</span> <span class="hljs-attr">IS</span>
}));</span></span>
</code></pre>
<p>By default, the code will be saved into a folder off the root of your project called <strong>sessions</strong>, under your cookie name.</p>
<p>As a final step for this part of the project, move the <strong>app.use(session)</strong> middleware to the <strong>routes/middleware.js</strong> file. While you are at it, also move the first piece of middleware that we created at the start of this assignment to <strong>middleware.js</strong>. That is the code that begins like this:</p>
<pre><code class="lang-javascript">app.use(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response, next</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Sample middleware with useful output'</span>);
    ETC...
});
</code></pre>
<h2 id="server-feedback">Additional Server Side Feedback</h2>
<p>Let&#39;s define a few more routes on the server that will help us track exactly what is happening on the server side. Put this code in <strong>routes/views.js</strong>:</p>
<pre><code class="lang-javascript">router.<span class="hljs-keyword">get</span>(<span class="hljs-comment">'/file-store', function(request, response, next) {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">request</span>.session.viewCount) {
        <span class="hljs-built_in">request</span>.session.viewCount++;
        <span class="hljs-built_in">response</span>.send({
            viewCount: <span class="hljs-built_in">request</span>.session.viewCount
        });
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">request</span>.session.viewCount = <span class="hljs-number">1</span>;
        <span class="hljs-built_in">response</span>.send({
            <span class="hljs-comment">'hello': 'Click another button and return here!'</span>
        });
    }
});

router.<span class="hljs-keyword">get</span>(<span class="hljs-comment">'/request', function(request, response, next) {</span>

    var requester = {
        cookies: <span class="hljs-built_in">request</span>.cookies,
        signedCookies: <span class="hljs-built_in">request</span>.signedCookies,
        originalUrl: <span class="hljs-built_in">request</span>.originalUrl,
        baseUrl: <span class="hljs-built_in">request</span>.baseUrl,
        url: <span class="hljs-built_in">request</span>.url,
        method: <span class="hljs-built_in">request</span>.method,
        secret: <span class="hljs-built_in">request</span>.secret || <span class="hljs-comment">'undefined',</span>
        sessionID: <span class="hljs-built_in">request</span>.sessionID,
        route: <span class="hljs-built_in">request</span>.route
    };
    console.<span class="hljs-built_in">log</span>(<span class="hljs-comment">'==========================');</span>
    <span class="hljs-keyword">for</span> (var foo <span class="hljs-keyword">in</span> <span class="hljs-built_in">request</span>.connection) {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">request</span>.hasOwnProperty(foo)) {
            console.<span class="hljs-built_in">log</span>(foo);
        }
    }
    console.<span class="hljs-built_in">log</span>(<span class="hljs-comment">'==========================');</span>
    console.<span class="hljs-built_in">log</span>(requester);
    <span class="hljs-built_in">response</span>.send({
        <span class="hljs-built_in">request</span>: requester
    });
});
</code></pre>
<p>Be sure to create buttons and handlers in <strong>control.js</strong> that call these routes and display the data returned from them. This should be very simple, as we can continue to use our unaltered <strong>showPage</strong> method to display this information.</p>
<p>Finally, let&#39;s add a route to <strong>routes/views.js</strong> that returns the <strong>request.session</strong> object. The route should be called <strong>&#39;/session-status&#39;</strong>. All it need do is return an object literal with one property called <strong>session</strong> that has a value of <strong>request.session</strong>. Be sure to call this method from <strong>control.js</strong> and display the output to the user using the <strong>showPage</strong> method.</p>
<h2 id="turn-it-in">Turn it in</h2>
<p>Push the repository and submit the assignment.</p>
</div></body></html>