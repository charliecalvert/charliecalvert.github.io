<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width initial-scale=1.0"><title>MongooseSignIn</title><link rel="shortcut icon" href="/charlie/images/favicon.png"><!-- Latest compiled and minified CSS--><link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap.min.css"><!-- Optional theme--><link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap-theme.min.css"><!-- link(href='/libs/css/BootstrapIndex.css', rel='stylesheet', type='text/css')--><link href="/css/style.css" rel="stylesheet" type="text/css"><link href="/css/highlight/googlecode.css" rel="stylesheet" type="text/css"><script src="/components/jquery/dist/jquery.js"></script><script src="/components/angular/angular.js"></script><script src="/components/angular-route/angular-route.js"></script><script src="/components/bootstrap/dist/js/bootstrap.min.js"></script><!-- script(src='/libs/scripts/elvenware.js', type='text/javascript')--><!-- script(src="/libs/scripts/Control.js")--><!-- script(src='http://localhost:35729/livereload.js')--></head><body><div class="navbar navbar-inverse"><div class="container"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target=".navbar-collapse" class="navbar-toggle"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">Elvenware</a></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li class="active"><a href="/index.html">Home</a></li><li><a href="/about">About</a></li><li class="dropdown"><a href="#/" data-toggle="dropdown" class="dropdown-toggle">Dropdown<b class="caret"></b></a><ul class="dropdown-menu"><li class="dropdown-header">Core Code</li><li><a href="/development/index.html">Strongly Typed</a></li><li><a href="/development/web/index.html">Web & Scripts</a></li><li><a href="/development/cloud/index.shtml">Cloud</a></li><li class="divider"></li><li class="dropdown-header">OS and Tools</li><li><a href="/os/index.html">OS</a></li><li><a href="/development/database/index.html">Database</a></li><li><a href="/books/index.html">My Writing</a></li><li class="divider"></li><li class="dropdown-header">Art</li><li><a href="/charlie/Art/index.html">Poems & Photos</a></li><li><a href="/books/reading/index.html">Book Reviews</a></li><li><a href="/spirit/index.html">Spiritual</a></li><li class="divider"></li><li class="dropdown-header">Links</li><li><a href="/charlie/links.html">My Links</a></li><li><a href="http://www.github.com/charliecalvert">GitHub</a></li><li><a href="http://sourceforge.net/projects/elvenware/">Sourceforge</a></li></ul></li></ul></div><!-- /.nav-collapse--></div></div><div class="container"><figure><img alt="Elvenware" src="/charlie/images/elvenwarelogo.png"/></figure><h1>MongooseSignIn</h1><h3>Table of Contents</h3><ul><!--TOC_Start--><li><a href="#description">Description</a></li>
<li><a href="#step-one">Step One</a></li>
<li><a href="#step-two">Step Two</a></li>
<li><a href="#step-two">Step Two</a></li>
<li><a href="#step-three">Step Three</a></li>
<li><a href="#step-four">Step Four</a></li>
<li><a href="#step-five">Step Five</a></li>
<li><a href="#mongolab">MongoLab</a></li><!--TOC_End--></ul><h2 id="description">Description</h2>
<p>Mongoose sign in has three major parts:</p>
<ul>
<li>A collection for your users in <a href="https://mongolab.com/">MongoLab</a>. If you don&#39;t have an account create one.</li>
<li>An interface built in express and jade (no angular) that allows the user to enter a username and password</li>
<li>A Mongooose library for storing and retrieving the user names and passwords</li>
</ul>
<p>The code also encrypts and validates user names and passwords.</p>
<p>The sign in Screen:</p>
<p><img src="https://s3.amazonaws.com/bucket01.elvenware.com/images/SignIn01.png" alt="Sign In"></p>
<p>Register a new users:</p>
<p><img src="https://s3.amazonaws.com/bucket01.elvenware.com/images/SignIn02.png" alt="Sign In"></p>
<p>Logged in:</p>
<p><img src="https://s3.amazonaws.com/bucket01.elvenware.com/images/SignIn03.png" alt="Sign In"></p>
<h2 id="step-one">Step One</h2>
<p>Create an express app</p>
<pre><code>CreateAllExpress Week05-MongooseSignIn
<span class="hljs-built_in">cd</span> Week05-MongooseSignIn
</code></pre><ul>
<li><a href="https://drive.google.com/file/d/0B25UTAlOfPRGVXR3SHFJa05sNjQ/view?usp=sharing">https://drive.google.com/file/d/0B25UTAlOfPRGVXR3SHFJa05sNjQ/view?usp=sharing</a></li>
</ul>
<p>Some npm packages we are using. You need do nothing as <strong>AllInclusive</strong> should handle this. So this is a no-op, it is just an fyi:</p>
<pre><code>npm <span class="hljs-keyword">install</span> bcrypt-nodejs <span class="hljs-comment">--save</span>
npm <span class="hljs-keyword">install</span> mongoose <span class="hljs-comment">--save</span>
npm <span class="hljs-keyword">install</span> passport <span class="hljs-comment">--save</span>
npm <span class="hljs-keyword">install</span> passport-<span class="hljs-keyword">local</span> <span class="hljs-comment">--save</span>
npm <span class="hljs-keyword">install</span> express-<span class="hljs-keyword">session</span> <span class="hljs-comment">--save</span>
</code></pre><h2 id="step-two">Step Two</h2>
<p>Setup Mongoose in a file called <strong>routes/db.js</strong>.
The <strong>getUrl</strong> method is designed to work with <a href="https://mongolab.com/">MongoLab</a>. Fill
in your own <strong>userName</strong>, <strong>password</strong>, <strong>siteAndPort</strong> and database name:</p>
<pre><code><span class="hljs-built_in">module</span>.exports = {
    getUrl: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> baseUrl = <span class="hljs-string">'mongodb://'</span>;
        <span class="hljs-keyword">var</span> userName = <span class="hljs-string">'USER-NAME'</span>;
        <span class="hljs-keyword">var</span> password = <span class="hljs-string">'PASSWORD'</span>;
        <span class="hljs-keyword">var</span> siteAndPort = <span class="hljs-string">'ds?????.mongolab.com:?????'</span>;
        <span class="hljs-keyword">var</span> databaseName = <span class="hljs-string">'DB-NAME'</span>;
        <span class="hljs-keyword">var</span> url = baseUrl + userName + <span class="hljs-string">':'</span> + password + <span class="hljs-string">'@'</span> + siteAndPort + <span class="hljs-string">'/'</span> + databaseName;
        <span class="hljs-built_in">console</span>.log(url);
        <span class="hljs-keyword">return</span> url;
    }
}
</code></pre><p>If working with a local database, then do something like this:</p>
<pre><code><span class="hljs-symbol">'url</span>' : <span class="hljs-symbol">'mongodb</span>:<span class="hljs-comment">//localhost/test'</span>
</code></pre><p>Define the schema for your database in <strong>models/user.js</strong>. To get a working copy of the file:</p>
<pre><code class="lang-bash">cp -r $ELF_TEMPLATES/SignIn/models/ .
</code></pre>
<h2 id="step-two">Step Two</h2>
<p>Let&#39;s work on the front end. Retrieve the jade for the various dialogs needed to complete the sign in process:</p>
<pre><code>cp $ELF_TEMPLATES/SignIn/views/*.jade views/.
</code></pre><p>We just copied in three files:</p>
<pre><code>login<span class="hljs-selector-class">.jade</span>
logout<span class="hljs-selector-class">.jade</span>
register.jade
</code></pre><h2 id="step-three">Step Three</h2>
<p>Set up Passport. Also setup the MongoDb database for storing the user name. To accomplish these tasks We will use three libraries
called <strong>express-session</strong>, <strong>Mongoose</strong> and <strong>Passport</strong>, all of which should already be in <strong>AllInclusive</strong>.</p>
<p>In <strong>app.js</strong>, about line 8.</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> dbConfig = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./routes/db'</span>);
<span class="hljs-keyword">var</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);
<span class="hljs-comment">// Connect to DB</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Mongoose URL:'</span>, dbConfig.getUrl());
mongoose.connect(dbConfig.getUrl());
</code></pre>
<p>And remove the line that reads, as we will include it later:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> routes = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./routes/index'</span>)
</code></pre>
<p>On about line 13, comment out the existing routes call:</p>
<pre><code>// <span class="hljs-keyword">var</span> routes = require(<span class="hljs-string">'./routes/index'</span>);
</code></pre><p>In app.js around line 28:</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// Configuring Passport</span>
<span class="hljs-keyword">var</span> passport = <span class="hljs-keyword">require</span>(<span class="hljs-string">'passport'</span>);
<span class="hljs-keyword">var</span> expressSession = <span class="hljs-keyword">require</span>(<span class="hljs-string">'express-session'</span>);
app.<span class="hljs-keyword">use</span>(expressSession({
    secret: <span class="hljs-string">'mySecretKey'</span>,
    resave: <span class="hljs-keyword">true</span>,
    saveUninitialized: <span class="hljs-keyword">true</span>
}));
app.<span class="hljs-keyword">use</span>(passport.initialize());
app.<span class="hljs-keyword">use</span>(passport.session());

<span class="hljs-comment">// Initialize Passport</span>
<span class="hljs-keyword">var</span> initPassport = <span class="hljs-keyword">require</span>(<span class="hljs-string">'./passport/init'</span>);
initPassport(passport);

<span class="hljs-keyword">var</span> routes = <span class="hljs-keyword">require</span>(<span class="hljs-string">'./routes/index'</span>)(passport);
</code></pre>
<h2 id="step-four">Step Four</h2>
<p>Copy in passport specific JavaScript files:</p>
<pre><code class="lang-bash">cp -r $ELF_TEMPLATES/SignIn/passport/ .
</code></pre>
<p>You just copied the following files into a folder called <strong>passport</strong> :</p>
<ul>
<li>init.js</li>
<li>login.js</li>
<li>signup.js</li>
</ul>
<h2 id="step-five">Step Five</h2>
<p>Set up the routes for logging in and signing up.</p>
<p>Passport provides authentication. If the user can be authenticated, then they will be allowed to do something, otherwise will they will be redirected to another screen:</p>
<ul>
<li>Success: You get to do it</li>
<li>Failure: Access denied!</li>
</ul>
<p>Here is the classic <strong>authenticate</strong> middleware in action:</p>
<pre><code><span class="hljs-selector-tag">router</span><span class="hljs-selector-class">.post</span>(<span class="hljs-string">'/login'</span>, passport.authenticate(<span class="hljs-string">'login'</span>, {
    <span class="hljs-attribute">successRedirect</span>: <span class="hljs-string">'/'</span>,
    <span class="hljs-attribute">failureRedirect</span>: <span class="hljs-string">'/login'</span>
  }));
</code></pre><p>In <strong>routes/index.js</strong></p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">var</span> router = express.Router();

<span class="hljs-keyword">var</span> isAuthenticated = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{
    <span class="hljs-comment">// Passport added the this method to the request object.</span>
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'isAuthenticated called'</span>);
    <span class="hljs-keyword">if</span> (req.isAuthenticated()) {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'successfully authenticated'</span>);
        <span class="hljs-keyword">return</span> next();
    }

    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'in isAuthenticated, user not authenticate, send to login'</span>);
    res.redirect(<span class="hljs-string">'/login'</span>);
};

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">passport</span>) </span>{
    <span class="hljs-comment">/* GET home page. */</span>
    router.get(<span class="hljs-string">'/'</span>, isAuthenticated, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{
<span class="hljs-meta">        'use strict'</span>;
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'about to send root page'</span>);
        res.render(<span class="hljs-string">'index'</span>, {title: <span class="hljs-string">'BarFoo'</span>});
    });

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">foo</span>(<span class="hljs-params">req, res, next</span>) </span>{
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'calling login'</span>);
        next();
    }

    router.get(<span class="hljs-string">'/login'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'in get login'</span>);
        res.render(<span class="hljs-string">'login'</span>, {user: req.user});
    });

    router.post(<span class="hljs-string">'/loginUser'</span>, passport.authenticate(<span class="hljs-string">'login'</span>, {
            successRedirect: <span class="hljs-string">'/'</span>,
            failureRedirect: <span class="hljs-string">'/login'</span>
    }));

    router.get(<span class="hljs-string">'/loggedin'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
        response.send(request.isAuthenticated() ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>);
    });

    router.get(<span class="hljs-string">'/signup'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Get signup'</span>);
        res.render(<span class="hljs-string">'register'</span>, {});
    });

    <span class="hljs-comment">/* Handle Registration POST */</span>
    router.post(<span class="hljs-string">'/signup'</span>, passport.authenticate(<span class="hljs-string">'signup'</span>, {
        successRedirect: <span class="hljs-string">'/#/login'</span>,
        failureRedirect: <span class="hljs-string">'/signup'</span>
    }));

    <span class="hljs-keyword">return</span> router;
};
</code></pre>
<p>##Turn it in</p>
<p>Submit four screen shots as PNG attachments. Model your screen shots after the four images found in this assignment. Instead of the logged in image, take one of the bash shell showing serializing and deserializing of the user. (Just convince me you got it to work....)</p>
<p>Also check in your code in <strong>Week10-MongooseSignIn</strong> or some similar name beginning with <strong>Week10</strong>. If there might be any question at all as to where I would find your code, please include the folder name when you submit the assignment.</p>
<h2 id="mongolab">MongoLab</h2>
<p>In MongoLab you should be able to see the <strong>Users</strong> table where your users are stored.</p>
<p>When viewing the data on MongoLab, you can optionally select <strong>edit table view</strong> in the view of your <strong>users</strong> collection and paste in the following code:</p>
<pre><code>{
    "<span class="hljs-attr">_id</span>": <span class="hljs-string">"id"</span>,
    "<span class="hljs-attr">username</span>": <span class="hljs-string">"username"</span>,
    "<span class="hljs-attr">email</span>": <span class="hljs-string">"email"</span>,
    "<span class="hljs-attr">firstName</span>": <span class="hljs-string">"firstName"</span>,
    "<span class="hljs-attr">lastName</span>": <span class="hljs-string">"lastName"</span>,
    "<span class="hljs-attr">password</span>": <span class="hljs-string">"password"</span>
}
</code></pre><p>When you are done, you are view of the data could look something like this:</p>
<p><img src="https://s3.amazonaws.com/bucket01.elvenware.com/images/SignIn04.png" alt="MongoLab"></p>
</div></body></html>