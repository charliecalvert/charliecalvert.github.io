<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width initial-scale=1.0"><title>MongooseSignIn</title><link rel="shortcut icon" href="/charlie/images/favicon.png"><!-- Latest compiled and minified CSS--><link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap.min.css"><!-- Optional theme--><link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap-theme.min.css"><link href="/libs/css/BootstrapIndex.css" rel="stylesheet" type="text/css"><link href="/css/style.css" rel="stylesheet" type="text/css"><link href="/css/highlight/googlecode.css" rel="stylesheet" type="text/css"><script src="/components/jquery/dist/jquery.js"></script><script src="/components/angular/angular.js"></script><script src="/components/angular-route/angular-route.js"></script><script src="/components/bootstrap/dist/js/bootstrap.min.js"></script><script src="/libs/scripts/elvenware.js" type="text/javascript"></script><script src="/libs/scripts/Control.js"></script></head><body><div class="navbar navbar-inverse"><div class="container"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target=".navbar-collapse" class="navbar-toggle"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">Elvenware</a></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li class="active"><a href="/index.html">Home</a></li><li><a href="/about">About</a></li><li class="dropdown"><a href="#/" data-toggle="dropdown" class="dropdown-toggle">Dropdown<b class="caret"></b></a><ul class="dropdown-menu"><li class="dropdown-header">Core Code</li><li><a href="/development/index.html">Strongly Typed</a></li><li><a href="/development/web/index.html">Web & Scripts</a></li><li><a href="/development/cloud/index.shtml">Cloud</a></li><li class="divider"></li><li class="dropdown-header">OS and Tools</li><li><a href="/os/index.html">OS</a></li><li><a href="/development/database/index.html">Database</a></li><li><a href="/books/index.html">My Writing</a></li><li class="divider"></li><li class="dropdown-header">Art</li><li><a href="/charlie/Art/index.html">Poems & Photos</a></li><li><a href="/books/reading/index.html">Book Reviews</a></li><li><a href="/spirit/index.html">Spiritual</a></li><li class="divider"></li><li class="dropdown-header">Links</li><li><a href="/charlie/links.html">My Links</a></li><li><a href="http://www.github.com/charliecalvert">GitHub</a></li><li><a href="http://sourceforge.net/projects/elvenware/">Sourceforge</a></li></ul></li></ul></div><!-- /.nav-collapse--></div></div><div class="container"><figure><img alt="Elvenware" src="/charlie/images/elvenwarelogo.png"/></figure><h1>MongooseSignIn</h1><h3>Table of Contents</h3><ul><!--TOC_Start--><li><a href="#description">Description</a></li>
<li><a href="#step-one">Step One</a></li>
<li><a href="#step-two">Step Two</a></li>
<li><a href="#step-two">Step Two</a></li>
<li><a href="#step-three">Step Three</a></li>
<li><a href="#step-four">Step Four</a></li>
<li><a href="#step-five">Step Five</a></li>
<li><a href="#step-six">Step Six</a></li>
<li><a href="#step-seven-view-data-on-mongolab">Step Seven View Data on MongoLab</a></li>
<li><a href="#turn-it-in">Turn it in</a></li><!--TOC_End--></ul><h2 id="description">Description</h2>
<p>Mongoose sign in has two major parts:</p>
<ul>
<li>An interface built in express and jade (no angular) that allows the user to enter a username and password</li>
<li>A Mongooose library for storing and retrieving the user names and passwords</li>
</ul>
<p>The code also encrypts and validates user names and passwords.</p>
<p>The sign in Screen:</p>
<p><img src="https://s3.amazonaws.com/bucket01.elvenware.com/images/SignIn01.png" alt="Sign In"></p>
<p>Register a new users:</p>
<p><img src="https://s3.amazonaws.com/bucket01.elvenware.com/images/SignIn02.png" alt="Sign In"></p>
<p>Logged in:</p>
<p><img src="https://s3.amazonaws.com/bucket01.elvenware.com/images/SignIn03.png" alt="Sign In"></p>
<p>The users in MongoLab:</p>
<h2 id="step-one">Step One</h2>
<p>Create an express app</p>
<pre><code>express Week10-MongooseSignIn
cd Week10-MongooseSignIn
npm <span class="hljs-operator"><span class="hljs-keyword">install</span>
npm <span class="hljs-keyword">install</span> bcrypt-nodejs <span class="hljs-comment">--save</span>
npm <span class="hljs-keyword">install</span> mongoose <span class="hljs-comment">--save</span>
npm <span class="hljs-keyword">install</span> passport <span class="hljs-comment">--save</span>
npm <span class="hljs-keyword">install</span> passport-<span class="hljs-keyword">local</span> <span class="hljs-comment">--save</span>
npm <span class="hljs-keyword">install</span> express-<span class="hljs-keyword">session</span> <span class="hljs-comment">--save</span></span>
</code></pre><p>Don&#39;t forget port 30025, the title and <strong>nodemon</strong>.</p>
<ul>
<li><a href="https://drive.google.com/file/d/0B25UTAlOfPRGVXR3SHFJa05sNjQ/view?usp=sharing">https://drive.google.com/file/d/0B25UTAlOfPRGVXR3SHFJa05sNjQ/view?usp=sharing</a></li>
</ul>
<h2 id="step-two">Step Two</h2>
<p>Setup Mongoose</p>
<p>In /db.js:</p>
<pre><code>module.exports = {
    'url' : 'mongodb://csc:Re<span class="hljs-keyword">*</span>lD<span class="hljs-keyword">*</span>t<span class="hljs-keyword">*</span>22<span class="hljs-comment">#@ds049848.mongolab.com:49848/elvenlab01'</span>
}
</code></pre><p>If working with a local database, then do this:</p>
<pre><code><span class="hljs-string">'url</span>' : <span class="hljs-string">'mongodb</span>:<span class="hljs-comment">//localhost/test'</span>
</code></pre><p>In <strong>models/user.js</strong>:</p>
<pre><code><span class="hljs-keyword">var</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);

<span class="hljs-keyword">var</span> userSchema = mongoose.Schema({
    id: <span class="hljs-built_in">String</span>,
    firstName: <span class="hljs-built_in">String</span>,
    lastName: <span class="hljs-built_in">String</span>,
    username: <span class="hljs-built_in">String</span>,
    password: <span class="hljs-built_in">String</span>,
    email: <span class="hljs-built_in">String</span>
});

<span class="hljs-built_in">module</span>.exports = mongoose.model(<span class="hljs-string">'User'</span>, userSchema);
</code></pre><h2 id="step-two">Step Two</h2>
<p>Front end</p>
<p>In <strong>views/layout.jade</strong></p>
<pre><code>doctype <span class="hljs-tag">html</span>
<span class="hljs-tag">html</span>
  head
    title= title
    <span class="hljs-function"><span class="hljs-title">link</span><span class="hljs-params">(rel=<span class="hljs-string">'stylesheet'</span>, href=<span class="hljs-string">'/stylesheets/style.css'</span>)</span></span>
    <span class="hljs-function"><span class="hljs-title">link</span><span class="hljs-params">(rel=<span class="hljs-string">'stylesheet'</span>, href=<span class="hljs-string">'http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css'</span>)</span></span>
  <span class="hljs-tag">body</span>
    block <span class="hljs-attribute">content</span>
</code></pre><p>In <strong>views/index.jade</strong></p>
<pre><code>extends layout
<span class="hljs-keyword">block</span> content
    h1= title
    p Welcome <span class="hljs-keyword">to</span> #<span class="hljs-comment">{title}</span>
    <span class="hljs-keyword">div</span>.container
        <span class="hljs-keyword">div</span>.row
            <span class="hljs-keyword">div</span>.col-sm-<span class="hljs-number">6</span>.col-md-<span class="hljs-number">4</span>.col-md-offset-<span class="hljs-number">4</span>
                h1.text-center.login-title Sign <span class="hljs-keyword">in</span> <span class="hljs-keyword">to</span> our Passport app
                    <span class="hljs-keyword">div</span>.account-wall
                        img(<span class="hljs-keyword">class</span>=<span class="hljs-string">'profile-img'</span>, src=<span class="hljs-string">'images/SpaceNeedle.png'</span>)
                        form(<span class="hljs-keyword">class</span>=<span class="hljs-string">'form-signin'</span>, action=<span class="hljs-string">'/login'</span>, <span class="hljs-function"><span class="hljs-keyword">method</span>='<span class="hljs-title">POST</span>')
                            <span class="hljs-title">input</span><span class="hljs-params">(<span class="hljs-keyword">type</span>=<span class="hljs-string">'text'</span>, name=<span class="hljs-string">'username'</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">'form-control'</span>, placeholder=<span class="hljs-string">'UserName'</span>,required, autofocus)</span>
                            <span class="hljs-title">input</span><span class="hljs-params">(<span class="hljs-keyword">type</span>=<span class="hljs-string">'password'</span>, name=<span class="hljs-string">'password'</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">'form-control'</span>, placeholder=<span class="hljs-string">'Password'</span>, required)</span>
                            <span class="hljs-title">button</span><span class="hljs-params">(<span class="hljs-keyword">class</span>=<span class="hljs-string">'btn btn-lg btn-primary btn-block'</span>, <span class="hljs-keyword">type</span>=<span class="hljs-string">'submit'</span>)</span> <span class="hljs-title">Sign</span> <span class="hljs-title">in</span>
                            <span class="hljs-title">span</span>.<span class="hljs-title">clearfix</span>
                    <span class="hljs-title">a</span><span class="hljs-params">(href=<span class="hljs-string">'/signup'</span>, <span class="hljs-keyword">class</span>=<span class="hljs-string">'text-center new-account'</span>)</span> <span class="hljs-title">Create</span> <span class="hljs-title">an</span> <span class="hljs-title">account</span>
                    #<span class="hljs-title">message</span>
                    <span class="hljs-title">if</span> <span class="hljs-title">message</span>
                        <span class="hljs-title">h1</span>.<span class="hljs-title">text</span>-<span class="hljs-title">center</span>.<span class="hljs-title">error</span>-<span class="hljs-title">message</span> #<span class="hljs-comment">{message}</span></span>
</code></pre><p>in <strong>views/register.jade</strong></p>
<pre><code>extends layout

<span class="hljs-keyword">block</span> content
    <span class="hljs-keyword">div</span>.container
        <span class="hljs-keyword">div</span>.row
            <span class="hljs-keyword">div</span>.col-sm-<span class="hljs-number">6</span>.col-md-<span class="hljs-number">4</span>.col-md-offset-<span class="hljs-number">4</span>
                h1.text-center.login-title Registration Details
                    <span class="hljs-keyword">div</span>.signup-wall
                        form(<span class="hljs-keyword">class</span>=<span class="hljs-string">'form-signin'</span>, action=<span class="hljs-string">'/signup'</span>, <span class="hljs-function"><span class="hljs-keyword">method</span>='<span class="hljs-title">POST</span>')
                            <span class="hljs-title">input</span><span class="hljs-params">(<span class="hljs-keyword">type</span>=<span class="hljs-string">'text'</span>, name=<span class="hljs-string">'username'</span>, <span class="hljs-keyword">class</span>=<span class="hljs-string">'form-control'</span>, placeholder=<span class="hljs-string">'Username'</span>,required, autofocus)</span>
                            <span class="hljs-title">input</span><span class="hljs-params">(<span class="hljs-keyword">type</span>=<span class="hljs-string">'password'</span>, name=<span class="hljs-string">'password'</span>, <span class="hljs-keyword">class</span>=<span class="hljs-string">'form-control nomargin'</span>, placeholder=<span class="hljs-string">'Password'</span>, required)</span>
                            <span class="hljs-title">input</span><span class="hljs-params">(<span class="hljs-keyword">type</span>=<span class="hljs-string">'email'</span>, name=<span class="hljs-string">'email'</span>, <span class="hljs-keyword">class</span>=<span class="hljs-string">'form-control'</span>, placeholder=<span class="hljs-string">'Email'</span>,required)</span>
                            <span class="hljs-title">input</span><span class="hljs-params">(<span class="hljs-keyword">type</span>=<span class="hljs-string">'text'</span>, name=<span class="hljs-string">'firstName'</span>, <span class="hljs-keyword">class</span>=<span class="hljs-string">'form-control'</span>, placeholder=<span class="hljs-string">'First Name'</span>,required)</span>
                            <span class="hljs-title">input</span><span class="hljs-params">(<span class="hljs-keyword">type</span>=<span class="hljs-string">'text'</span>, name=<span class="hljs-string">'lastName'</span>, <span class="hljs-keyword">class</span>=<span class="hljs-string">'form-control'</span>, placeholder=<span class="hljs-string">'Last Name'</span>,required)</span>
                            <span class="hljs-title">button</span><span class="hljs-params">(<span class="hljs-keyword">class</span>=<span class="hljs-string">'btn btn-lg btn-primary btn-block'</span>, <span class="hljs-keyword">type</span>=<span class="hljs-string">'submit'</span>)</span> <span class="hljs-title">Register</span>
                            <span class="hljs-title">span</span>.<span class="hljs-title">clearfix</span>
                    #<span class="hljs-title">message</span>
                        <span class="hljs-title">if</span> <span class="hljs-title">message</span>
                            <span class="hljs-title">h1</span>.<span class="hljs-title">text</span>-<span class="hljs-title">center</span>.<span class="hljs-title">error</span>-<span class="hljs-title">message</span> #<span class="hljs-comment">{message}</span></span>
</code></pre><p>In <strong>views/home.jade</strong></p>
<pre><code>extends layout
block content
    <span class="hljs-operator">div</span>.container
        <span class="hljs-operator">div</span>.row
            <span class="hljs-operator">div</span>.col-sm-<span class="hljs-number">6.</span>col-md-<span class="hljs-number">4.</span>col-md-<span class="hljs-built_in">offset</span>-<span class="hljs-number">4</span>
                <span class="hljs-comment">#user</span>
                    h1.<span class="hljs-keyword">text</span>-center.login-title Welcome <span class="hljs-comment">#{user.firstName}. Check your details below:</span>
                    <span class="hljs-operator">div</span>.signup-wall
                        ul.user-details
                            li Username <span class="hljs-comment">---&gt; #{user.username}</span>
                            li Email    <span class="hljs-comment">---&gt; #{user.email}</span>
                            li First Name <span class="hljs-comment">---&gt; #{user.firstName}</span>
                            li Last Name <span class="hljs-comment">---&gt; #{user.lastName}</span>
                    <span class="hljs-operator">a</span>(href=<span class="hljs-string">'/signout'</span>, class=<span class="hljs-string">'text-center new-account'</span>) Sign Out
</code></pre><p>Be careful about the whitespace in these files.</p>
<h2 id="step-three">Step Three</h2>
<p>Database Mongoose</p>
<p>In <strong>app.js</strong>, about line 8.</p>
<pre><code><span class="hljs-keyword">var</span> dbConfig = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./db'</span>);
<span class="hljs-keyword">var</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);
<span class="hljs-comment">// Connect to DB</span>
mongoose.connect(dbConfig.url);
</code></pre><p>On about line 13, comment out the existing routes call:</p>
<pre><code>// <span class="hljs-keyword">var</span> routes = require(<span class="hljs-string">'./routes/index'</span>);
</code></pre><p>In app.js around line 28:</p>
<pre><code><span class="hljs-comment">// Configuring Passport</span>
<span class="hljs-keyword">var</span> passport = <span class="hljs-keyword">require</span>(<span class="hljs-string">'passport'</span>);
<span class="hljs-keyword">var</span> expressSession = <span class="hljs-keyword">require</span>(<span class="hljs-string">'express-session'</span>);
app.<span class="hljs-keyword">use</span>(expressSession({
    secret: <span class="hljs-string">'mySecretKey'</span>,
    resave: <span class="hljs-keyword">true</span>,
    saveUninitialized: <span class="hljs-keyword">true</span>
}));
app.<span class="hljs-keyword">use</span>(passport.initialize());
app.<span class="hljs-keyword">use</span>(passport.session());

<span class="hljs-comment">// Initialize Passport</span>
<span class="hljs-keyword">var</span> initPassport = <span class="hljs-keyword">require</span>(<span class="hljs-string">'./passport/init'</span>);
initPassport(passport);

<span class="hljs-keyword">var</span> routes = <span class="hljs-keyword">require</span>(<span class="hljs-string">'./routes/index'</span>)(passport);
</code></pre><h2 id="step-four">Step Four</h2>
<p>Backend</p>
<p>Passport provides authentication. If the user can be authenticated, then they will be allowed to do something, otherwise will they will be redirected to another screen:</p>
<ul>
<li>Success: You get to do it</li>
<li>Failure: Access denied!</li>
</ul>
<p>Here is the classic <strong>authenticate</strong> middleware in action:</p>
<pre><code><span class="hljs-tag">router</span><span class="hljs-class">.post</span>(<span class="hljs-string">'/login'</span>, passport.<span class="hljs-function">authenticate</span>(<span class="hljs-string">'login'</span>, {
    <span class="hljs-attribute">successRedirect</span>: <span class="hljs-string">'/home'</span>,
    <span class="hljs-attribute">failureRedirect</span>: <span class="hljs-string">'/'</span>
  }));
</code></pre><p>In <strong>routes/index.js</strong></p>
<pre><code><span class="hljs-keyword">var</span> express = require(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">var</span> router = express.Router();

<span class="hljs-keyword">var</span> isAuthenticated = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res, next)</span> </span>{
    <span class="hljs-comment">// if user is authenticated in the session, call the next() to call the next request handler</span>
    <span class="hljs-comment">// Passport adds this method to request object. A middleware is allowed to add properties to</span>
    <span class="hljs-comment">// request and response objects</span>
    <span class="hljs-keyword">if</span> (req.isAuthenticated())
        <span class="hljs-keyword">return</span> next();
    <span class="hljs-comment">// if the user is not authenticated then redirect him to the login page</span>
    res.redirect(<span class="hljs-string">'/'</span>);
};

module.exports = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(passport)</span> </span>{

    router.<span class="hljs-keyword">get</span>(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res)</span> </span>{
        res.render(<span class="hljs-string">'index'</span>, {title: <span class="hljs-string">"sign in"</span>});
    });

    router.post(<span class="hljs-string">'/login'</span>, passport.authenticate(<span class="hljs-string">'login'</span>, {
        successRedirect: <span class="hljs-string">'/home'</span>,
        failureRedirect: <span class="hljs-string">'/'</span>
    }));

    router.<span class="hljs-keyword">get</span>(<span class="hljs-string">'/signup'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res)</span> </span>{
        res.render(<span class="hljs-string">'register'</span>, {});
    });

    <span class="hljs-comment">/* Handle Registration POST */</span>
    router.post(<span class="hljs-string">'/signup'</span>, passport.authenticate(<span class="hljs-string">'signup'</span>, {
        successRedirect: <span class="hljs-string">'/home'</span>,
        failureRedirect: <span class="hljs-string">'/signup'</span>
    }));

    <span class="hljs-comment">/* GET Home Page */</span>
    router.<span class="hljs-keyword">get</span>(<span class="hljs-string">'/home'</span>, isAuthenticated, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res)</span> </span>{
        res.render(<span class="hljs-string">'home'</span>, {user: req.user});
    });

    router.<span class="hljs-keyword">get</span>(<span class="hljs-string">'/signout'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res)</span> </span>{
        req.logout();
        res.redirect(<span class="hljs-string">'/'</span>);
    });

    <span class="hljs-keyword">return</span> router;
};
</code></pre><h2 id="step-five">Step Five</h2>
<p>Passport</p>
<p>In <strong>/passport/init.js</strong></p>
<pre><code><span class="hljs-keyword">var</span> login = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./login'</span>);
<span class="hljs-keyword">var</span> signup = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./signup'</span>);
<span class="hljs-keyword">var</span> User = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../models/user'</span>);

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">passport</span>) </span>{

    <span class="hljs-comment">// Passport needs to be able to serialize and deserialize</span>
    <span class="hljs-comment">// users to support persistent login sessions</span>
    passport.serializeUser(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">user, done</span>) </span>{
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'serializing user: '</span>);
        <span class="hljs-built_in">console</span>.log(user);
        done(<span class="hljs-literal">null</span>, user._id);
    });

    passport.deserializeUser(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id, done</span>) </span>{
        User.findById(id, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, user</span>) </span>{
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'deserializing user:'</span>, user);
            done(err, user);
        });
    });

    <span class="hljs-comment">// Setting up Passport Strategies for Login and SignUp/Registration</span>
    login(passport);
    signup(passport);

};
</code></pre><p>In <strong>/passport/login.js</strong></p>
<pre><code><span class="hljs-comment">/**
 * Created by charlie on 6/8/2015.
 */</span>

<span class="hljs-keyword">var</span> LocalStrategy   = <span class="hljs-built_in">require</span>(<span class="hljs-string">'passport-local'</span>).Strategy;
<span class="hljs-keyword">var</span> User = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../models/user'</span>);
<span class="hljs-keyword">var</span> bCrypt = <span class="hljs-built_in">require</span>(<span class="hljs-string">'bcrypt-nodejs'</span>);

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">passport</span>) </span>{

    passport.use(<span class="hljs-string">'login'</span>, <span class="hljs-keyword">new</span> LocalStrategy({
                passReqToCallback : <span class="hljs-literal">true</span>
            },
            <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, username, password, done</span>) </span>{
                <span class="hljs-comment">// check in mongo if a user with username exists or not</span>
                User.findOne({ <span class="hljs-string">'username'</span> :  username },
                    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, user</span>) </span>{
                        <span class="hljs-comment">// In case of any error, return using the done method</span>
                        <span class="hljs-keyword">if</span> (err)
                            <span class="hljs-keyword">return</span> done(err);
                        <span class="hljs-comment">// Username does not exist, log the error and redirect back</span>
                        <span class="hljs-keyword">if</span> (!user){
                            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'User Not Found with username '</span>+username);
                            <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>);
                        }
                        <span class="hljs-comment">// User exists but wrong password, log the error</span>
                        <span class="hljs-keyword">if</span> (!isValidPassword(user, password)){
                            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Invalid Password'</span>);
                            <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>); <span class="hljs-comment">// redirect back to login page</span>
                        }
                        <span class="hljs-comment">// User and password both match, return user from done method</span>
                        <span class="hljs-comment">// which will be treated like success</span>
                        <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, user);
                    }
                );

            })
    );


    <span class="hljs-keyword">var</span> isValidPassword = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">user, password</span>)</span>{
        <span class="hljs-keyword">return</span> bCrypt.compareSync(password, user.password);
    }

};
</code></pre><p>In <strong>/passport/signup.js</strong></p>
<pre><code><span class="hljs-keyword">var</span> LocalStrategy   = <span class="hljs-built_in">require</span>(<span class="hljs-string">'passport-local'</span>).Strategy;
<span class="hljs-keyword">var</span> User = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../models/user'</span>);
<span class="hljs-keyword">var</span> bCrypt = <span class="hljs-built_in">require</span>(<span class="hljs-string">'bcrypt-nodejs'</span>);

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">passport</span>)</span>{

    passport.use(<span class="hljs-string">'signup'</span>, <span class="hljs-keyword">new</span> LocalStrategy({
            passReqToCallback : <span class="hljs-literal">true</span> <span class="hljs-comment">// allows us to pass back the entire request to the callback</span>
        },
        <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, username, password, done</span>) </span>{

            findOrCreateUser = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
                <span class="hljs-comment">// find a user in Mongo with provided username</span>
                User.findOne({ <span class="hljs-string">'username'</span> :  username }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, user</span>) </span>{
                    <span class="hljs-comment">// In case of any error, return using the done method</span>
                    <span class="hljs-keyword">if</span> (err){
                        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Error in SignUp: '</span>+err);
                        <span class="hljs-keyword">return</span> done(err);
                    }
                    <span class="hljs-comment">// already exists</span>
                    <span class="hljs-keyword">if</span> (user) {
                        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'User already exists with username: '</span>+username);
                        <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>, req.flash(<span class="hljs-string">'message'</span>,<span class="hljs-string">'User Already Exists'</span>));
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-comment">// if there is no user with that email</span>
                        <span class="hljs-comment">// create the user</span>
                        <span class="hljs-keyword">var</span> newUser = <span class="hljs-keyword">new</span> User();

                        <span class="hljs-comment">// set the user's local credentials</span>
                        newUser.username = username;
                        newUser.password = createHash(password);
                        newUser.email = req.param(<span class="hljs-string">'email'</span>);
                        newUser.firstName = req.param(<span class="hljs-string">'firstName'</span>);
                        newUser.lastName = req.param(<span class="hljs-string">'lastName'</span>);

                        <span class="hljs-comment">// save the user</span>
                        newUser.save(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
                            <span class="hljs-keyword">if</span> (err){
                                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Error in Saving user: '</span>+err);  
                                <span class="hljs-keyword">throw</span> err;  
                            }
                            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'User Registration succesful'</span>);    
                            <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, newUser);
                        });
                    }
                });
            };
            <span class="hljs-comment">// Delay the execution of findOrCreateUser and execute the method</span>
            <span class="hljs-comment">// in the next tick of the event loop</span>
            process.nextTick(findOrCreateUser);
        })
    );

    <span class="hljs-comment">// Generates hash using bCrypt</span>
    <span class="hljs-keyword">var</span> createHash = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">password</span>)</span>{
        <span class="hljs-keyword">return</span> bCrypt.hashSync(password, bCrypt.genSaltSync(<span class="hljs-number">10</span>), <span class="hljs-literal">null</span>);
    }

};
</code></pre><h2 id="step-six">Step Six</h2>
<p>Add css. Append this to <strong>public/css/style.css</strong>:</p>
<pre><code><span class="hljs-class">.form-signin</span><span class="hljs-rules">{
    <span class="hljs-rule"><span class="hljs-attribute">max-width</span>:<span class="hljs-value"> <span class="hljs-number">330px</span></span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">padding</span>:<span class="hljs-value"> <span class="hljs-number">15px</span></span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">margin</span>:<span class="hljs-value"> <span class="hljs-number">0</span> auto</span></span>;
}</span>
<span class="hljs-class">.form-signin</span> <span class="hljs-class">.form-signin-heading</span>, <span class="hljs-class">.form-signin</span> <span class="hljs-class">.checkbox</span><span class="hljs-rules">{
    <span class="hljs-rule"><span class="hljs-attribute">margin-bottom</span>:<span class="hljs-value"> <span class="hljs-number">10px</span></span></span>;
}</span>
<span class="hljs-class">.form-signin</span> <span class="hljs-class">.checkbox</span><span class="hljs-rules">{
    <span class="hljs-rule"><span class="hljs-attribute">font-weight</span>:<span class="hljs-value"> normal</span></span>;
}</span>
<span class="hljs-class">.form-signin</span> <span class="hljs-class">.form-control</span><span class="hljs-rules">{
    <span class="hljs-rule"><span class="hljs-attribute">position</span>:<span class="hljs-value"> relative</span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">font-size</span>:<span class="hljs-value"> <span class="hljs-number">16px</span></span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">height</span>:<span class="hljs-value"> auto</span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">padding</span>:<span class="hljs-value"> <span class="hljs-number">10px</span></span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">-webkit-box-sizing</span>:<span class="hljs-value"> border-box</span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">-moz-box-sizing</span>:<span class="hljs-value"> border-box</span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">box-sizing</span>:<span class="hljs-value"> border-box</span></span>;
}</span>
<span class="hljs-class">.form-signin</span> <span class="hljs-class">.form-control</span><span class="hljs-pseudo">:focus</span><span class="hljs-rules">{
    <span class="hljs-rule"><span class="hljs-attribute">z-index</span>:<span class="hljs-value"> <span class="hljs-number">2</span></span></span>;
}</span>
<span class="hljs-class">.form-signin</span> <span class="hljs-tag">input</span><span class="hljs-attr_selector">[type="text"]</span><span class="hljs-rules">{
    <span class="hljs-rule"><span class="hljs-attribute">margin-bottom</span>:<span class="hljs-value"> -<span class="hljs-number">1px</span></span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">border-bottom-left-radius</span>:<span class="hljs-value"> <span class="hljs-number">0</span></span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">border-bottom-right-radius</span>:<span class="hljs-value"> <span class="hljs-number">0</span></span></span>;
}</span>
<span class="hljs-class">.form-signin</span> <span class="hljs-tag">input</span><span class="hljs-attr_selector">[type="password"]</span><span class="hljs-rules">{
    <span class="hljs-rule"><span class="hljs-attribute">margin-bottom</span>:<span class="hljs-value"> <span class="hljs-number">10px</span></span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">border-top-left-radius</span>:<span class="hljs-value"> <span class="hljs-number">0</span></span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">border-top-right-radius</span>:<span class="hljs-value"> <span class="hljs-number">0</span></span></span>;
}</span>
<span class="hljs-class">.form-signin</span> <span class="hljs-tag">input</span><span class="hljs-attr_selector">[type="password"]</span><span class="hljs-class">.nomargin</span><span class="hljs-rules">{
    <span class="hljs-rule"><span class="hljs-attribute">margin-bottom</span>:<span class="hljs-value"> <span class="hljs-number">0px</span></span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">border-top-left-radius</span>:<span class="hljs-value"> <span class="hljs-number">0</span></span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">border-top-right-radius</span>:<span class="hljs-value"> <span class="hljs-number">0</span></span></span>;
}</span>
<span class="hljs-class">.account-wall</span><span class="hljs-rules">{
    <span class="hljs-rule"><span class="hljs-attribute">margin-top</span>:<span class="hljs-value"> <span class="hljs-number">20px</span></span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">padding</span>:<span class="hljs-value"> <span class="hljs-number">40px</span> <span class="hljs-number">0px</span> <span class="hljs-number">20px</span> <span class="hljs-number">0px</span></span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">background-color</span>:<span class="hljs-value"> <span class="hljs-hexcolor">#f7f7f7</span></span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">-moz-box-shadow</span>:<span class="hljs-value"> <span class="hljs-number">0px</span> <span class="hljs-number">2px</span> <span class="hljs-number">2px</span> <span class="hljs-function">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.3</span>)</span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">-webkit-box-shadow</span>:<span class="hljs-value"> <span class="hljs-number">0px</span> <span class="hljs-number">2px</span> <span class="hljs-number">2px</span> <span class="hljs-function">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.3</span>)</span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">box-shadow</span>:<span class="hljs-value"> <span class="hljs-number">0px</span> <span class="hljs-number">2px</span> <span class="hljs-number">2px</span> <span class="hljs-function">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.3</span>)</span></span>;
}</span>
<span class="hljs-class">.signup-wall</span><span class="hljs-rules">{
    <span class="hljs-rule"><span class="hljs-attribute">margin-top</span>:<span class="hljs-value"> <span class="hljs-number">20px</span></span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">padding</span>:<span class="hljs-value"> <span class="hljs-number">20px</span> <span class="hljs-number">0px</span> <span class="hljs-number">20px</span> <span class="hljs-number">0px</span></span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">background-color</span>:<span class="hljs-value"> <span class="hljs-hexcolor">#f7f7f7</span></span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">-moz-box-shadow</span>:<span class="hljs-value"> <span class="hljs-number">0px</span> <span class="hljs-number">2px</span> <span class="hljs-number">2px</span> <span class="hljs-function">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.3</span>)</span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">-webkit-box-shadow</span>:<span class="hljs-value"> <span class="hljs-number">0px</span> <span class="hljs-number">2px</span> <span class="hljs-number">2px</span> <span class="hljs-function">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.3</span>)</span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">box-shadow</span>:<span class="hljs-value"> <span class="hljs-number">0px</span> <span class="hljs-number">2px</span> <span class="hljs-number">2px</span> <span class="hljs-function">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.3</span>)</span></span>;    
}</span>
<span class="hljs-class">.login-title</span><span class="hljs-rules">{
    <span class="hljs-rule"><span class="hljs-attribute">color</span>:<span class="hljs-value"> <span class="hljs-hexcolor">#555</span></span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">font-size</span>:<span class="hljs-value"> <span class="hljs-number">18px</span></span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">font-weight</span>:<span class="hljs-value"> <span class="hljs-number">400</span></span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">display</span>:<span class="hljs-value"> block</span></span>;
}</span>
<span class="hljs-class">.profile-img</span><span class="hljs-rules">{
    <span class="hljs-rule"><span class="hljs-attribute">width</span>:<span class="hljs-value"> <span class="hljs-number">96px</span></span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">height</span>:<span class="hljs-value"> <span class="hljs-number">96px</span></span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">margin</span>:<span class="hljs-value"> <span class="hljs-number">0</span> auto <span class="hljs-number">10px</span></span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">display</span>:<span class="hljs-value"> block</span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">-moz-border-radius</span>:<span class="hljs-value"> <span class="hljs-number">50%</span></span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">-webkit-border-radius</span>:<span class="hljs-value"> <span class="hljs-number">50%</span></span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">border-radius</span>:<span class="hljs-value"> <span class="hljs-number">50%</span></span></span>;
}</span>
<span class="hljs-class">.new-account</span><span class="hljs-rules">{
    <span class="hljs-rule"><span class="hljs-attribute">display</span>:<span class="hljs-value"> block</span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">margin-top</span>:<span class="hljs-value"> <span class="hljs-number">10px</span></span></span>;
}</span>
<span class="hljs-tag">h1</span><span class="hljs-class">.error-message</span><span class="hljs-rules">{
    <span class="hljs-rule"><span class="hljs-attribute">color</span>:<span class="hljs-value"> red</span></span>;
}</span>
<span class="hljs-tag">ul</span><span class="hljs-class">.user-details</span><span class="hljs-rules">{
    <span class="hljs-rule"><span class="hljs-attribute">list-style</span>:<span class="hljs-value"> none</span></span>;
}</span>
</code></pre><h2 id="step-seven-view-data-on-mongolab">Step Seven View Data on MongoLab</h2>
<p>When viewing the data on MongoLab, select <strong>edit table view</strong> in the view of your <strong>users</strong> collection and paste in the following code:</p>
<pre><code>{
    "<span class="hljs-attribute">_id</span>": <span class="hljs-value"><span class="hljs-string">"id"</span></span>,
    "<span class="hljs-attribute">username</span>": <span class="hljs-value"><span class="hljs-string">"username"</span></span>,
    "<span class="hljs-attribute">email</span>": <span class="hljs-value"><span class="hljs-string">"email"</span></span>,
    "<span class="hljs-attribute">firstName</span>": <span class="hljs-value"><span class="hljs-string">"firstName"</span></span>,
    "<span class="hljs-attribute">lastName</span>": <span class="hljs-value"><span class="hljs-string">"lastName"</span></span>,
    "<span class="hljs-attribute">password</span>": <span class="hljs-value"><span class="hljs-string">"password"</span>
</span>}
</code></pre><p>When you are done, you are view of the data could look something like this:</p>
<p><img src="https://s3.amazonaws.com/bucket01.elvenware.com/images/SignIn04.png" alt="MongoLab"></p>
<h2 id="turn-it-in">Turn it in</h2>
<p>Submit four screen shots as PNG attachments. Each screen shot except the last should contain your first and last names. Model your screen shots after the four images found in this assignment.</p>
<p>Also check in your code in <strong>Week10-MongooseSignIn</strong> or some similar name beginning with <strong>Week10</strong>. If there might be any question at all as to where I would find your code, please include the folder name when you submit the assignment.</p>
</div></body></html>