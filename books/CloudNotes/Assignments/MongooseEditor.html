<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width initial-scale=1.0"><title>MongooseEditor</title><link rel="shortcut icon" href="/charlie/images/favicon.png"><!-- Latest compiled and minified CSS--><link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap.min.css"><!-- Optional theme--><link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap-theme.min.css"><!-- link(href='/libs/css/BootstrapIndex.css', rel='stylesheet', type='text/css')--><link href="/css/style.css" rel="stylesheet" type="text/css"><link href="/css/highlight/googlecode.css" rel="stylesheet" type="text/css"><script src="/components/jquery/dist/jquery.js"></script><script src="/components/angular/angular.js"></script><script src="/components/angular-route/angular-route.js"></script><script src="/components/bootstrap/dist/js/bootstrap.min.js"></script><!-- script(src='/libs/scripts/elvenware.js', type='text/javascript')--><!-- script(src="/libs/scripts/Control.js")--><!-- script(src='http://localhost:35729/livereload.js')--></head><body><div class="navbar navbar-inverse"><div class="container"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target=".navbar-collapse" class="navbar-toggle"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">Elvenware</a></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li class="active"><a href="/index.html">Home</a></li><li><a href="/about">About</a></li><li class="dropdown"><a href="#/" data-toggle="dropdown" class="dropdown-toggle">Dropdown<b class="caret"></b></a><ul class="dropdown-menu"><li class="dropdown-header">Core Code</li><li><a href="/development/index.html">Strongly Typed</a></li><li><a href="/development/web/index.html">Web & Scripts</a></li><li><a href="/development/cloud/index.shtml">Cloud</a></li><li class="divider"></li><li class="dropdown-header">OS and Tools</li><li><a href="/os/index.html">OS</a></li><li><a href="/development/database/index.html">Database</a></li><li><a href="/books/index.html">My Writing</a></li><li class="divider"></li><li class="dropdown-header">Art</li><li><a href="/charlie/Art/index.html">Poems & Photos</a></li><li><a href="/books/reading/index.html">Book Reviews</a></li><li><a href="/spirit/index.html">Spiritual</a></li><li class="divider"></li><li class="dropdown-header">Links</li><li><a href="/charlie/links.html">My Links</a></li><li><a href="http://www.github.com/charliecalvert">GitHub</a></li><li><a href="http://sourceforge.net/projects/elvenware/">Sourceforge</a></li></ul></li></ul></div><!-- /.nav-collapse--></div></div><div class="container"><figure><img alt="Elvenware" src="/charlie/images/elvenwarelogo.png"/></figure><h1>MongooseEditor</h1><h3>Table of Contents</h3><ul><!--TOC_Start--><li><a href="#description">Description</a></li>
<li><a href="#mongoose-updates">Mongoose Updates</a></li>
<li><a href="#update-schema">Update Schema</a></li>
<li><a href="#remove-numeric-input">Remove Numeric Input</a></li>
<li><a href="#clickable-items">Clickable Items</a></li>
<li><a href="#mongofactory">MongoFactory</a></li>
<li><a href="#the-menu">The Menu</a></li>
<li><a href="#program-structure">Program Structure</a></li>
<li><a href="#directives">Directives</a></li>
<li><a href="#finding-data">Finding Data</a></li>
<li><a href="#posting-data">Posting Data</a></li>
<li><a href="#edit-main-fields">Edit Main Fields</a></li>
<li><a href="#subjects">Subjects</a></li><!--TOC_End--></ul><h2 id="description">Description</h2>
<p>This is the followup to the <a href="http://www.ccalvert.net/books/CloudNotes/Assignments/MongooseBasics.html">MongooseBasics assignment</a>.</p>
<p>The main goal of this assignment will be to create multiple pages in our application:</p>
<ul>
<li>Main Page: View the data</li>
<li>Edit: Edit scientist name and main subject</li>
<li>Subjects: Edit a list of subjects associated with a scientist</li>
<li>Comments: Comment on a scientist</li>
<li>About: Standard about page</li>
</ul>
<p>We are breaking the app up into multiple pages for several reasons:</p>
<ul>
<li>It creates a number of small pages that will fit on a mobile device</li>
<li>It helps the user understand each discreet task by isolating it on a simple page</li>
<li>It teaches you how to create and maintain a multi-page angular application</li>
</ul>
<p>References:</p>
<ul>
<li>The Mongoose Slides: <a href="http://bit.ly/elf-mongoose">http://bit.ly/elf-mongoose</a></li>
<li><a href="http://www.ccalvert.net/books/CloudNotes/Prog219/Prog219-Week09-2015.html">Week09 Overview</a></li>
<li><a href="http://www.ccalvert.net/books/CloudNotes/Prog219/Prog219-Resources.html">Prog219 Resources</a></li>
</ul>
<h2 id="mongoose-updates">Mongoose Updates</h2>
<p>There are several updates to the code we wrote on Monday.</p>
<h3 id="update-schema">Update Schema</h3>
<p>In <strong>modules/scientists</strong>, the <strong>subjects</strong> array should look like this: </p>
<pre><code>subjects: [<span class="hljs-symbol">String</span>].
</code></pre><p>Here is the entire schema so you can see the change in context:</p>
<pre><code><span class="hljs-built_in">var</span> scientistsSchema = mongoose.Schema({
    <span class="hljs-string">"firstName"</span>: <span class="hljs-built_in">String</span>,
    <span class="hljs-string">"lastName"</span>: <span class="hljs-built_in">String</span>,
    <span class="hljs-string">"subject"</span>: <span class="hljs-built_in">String</span>,
    <span class="hljs-string">"subjects"</span>: <span class="hljs-meta">[</span><span class="hljs-built_in">String</span><span class="hljs-meta">]</span>,
    comments: <span class="hljs-meta">[</span>{ body: <span class="hljs-built_in">String</span>, <span class="hljs-built_in">date</span>: <span class="hljs-built_in">Date</span> }<span class="hljs-meta">]</span>
});
</code></pre><p>You should be able to make this change without modifying the rest of your code.</p>
<h3 id="remove-numeric-input">Remove Numeric Input</h3>
<p>Remove the numeric input from <strong>index.jade</strong> and from <strong>control.js</strong>. This means we no longer need:</p>
<ul>
<li><strong>currentItem</strong> in either <strong>control.js</strong> or in <strong>mongo-factory</strong>.</li>
<li>The <strong>indexChanged</strong> method in <strong>control.js</strong>.</li>
<li>The numeric input in <strong>layout.jade</strong></li>
</ul>
<h2 id="clickable-items">Clickable Items</h2>
<p>With the numeric input gone, we need another way to select items. We will do that by making each item in our list a hyperlink:</p>
<pre><code>    ul
        li(data-ng-repeat=<span class="hljs-string">'scientist in mongoController.allData'</span>)
            &lt;a ng-click=<span class="hljs-string">"mongoController.selectScientist(scientist)"</span>&gt; <span class="hljs-template-variable">{{scientist.id}}</span> <span class="hljs-template-variable">{{scientist.name}}</span> &lt;<span class="hljs-regexp">/a&gt;</span>
</code></pre><p>The selectScientist method looks like this:</p>
<pre><code>        mongoController.selectScientist = function(<span class="hljs-keyword">scientist) </span>{
            mongoFactory.getScientistById(<span class="hljs-keyword">scientist.id, </span>mongoController)<span class="hljs-comment">;</span>
        }<span class="hljs-comment">;</span>
</code></pre><p>We are also going to change the way that we load data into the main screen. Begin by deleting the old
code from <strong>control.js</strong>:</p>
<pre><code>    $http.get(<span class="hljs-string">'/all-data'</span>).success(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
        mongoController.allData = data;
        mongoController.scientistsLength = data.allData.<span class="hljs-built_in">length</span>;
    }).<span class="hljs-built_in">error</span>(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
        console.<span class="hljs-built_in">log</span>(err);
    });
</code></pre><p>In its place, at the bottom of the file, ask the <strong>mongoFactory</strong> to retrieve the data:</p>
<pre><code>    <span class="hljs-selector-tag">mongoFactory</span><span class="hljs-selector-class">.getScientists</span>(<span class="hljs-selector-tag">mongoController</span>);
</code></pre><p>If there are save and insert methods left over from Monday, you can delete them. We are going to do
those tasks elsewhere. </p>
<p>The code we have added won&#39;t work quite yet. We still need to make some changes to MongoFactory, as
shown in the next section.</p>
<h2 id="mongofactory">MongoFactory</h2>
<p>Right now the structure of our <strong>mongoFactory</strong> looks like this:</p>
<pre><code>    var app = angular.module(<span class="hljs-string">'elvenApp'</span>);

    app.factory(<span class="hljs-string">'mongoFactory'</span>, <span class="hljs-keyword">function</span>($http) {

        return {
            // code omitted here
        };        

    });
</code></pre><p>Let&#39;s make a slight change to that code so that we can reference the factory itself from within the factory:</p>
<pre><code>    <span class="hljs-keyword">var</span> app = angular.module(<span class="hljs-string">'elvenApp'</span>);

    app.factory(<span class="hljs-string">'mongoFactory'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">($http)</span> </span>{

        <span class="hljs-keyword">var</span> mongoFactory =  {
            <span class="hljs-comment">// code omitted here</span>
            <span class="hljs-comment">// With this new structure, we can reference the mongoFactory in here.</span>
        };        

        <span class="hljs-keyword">return</span> mongoFactory;
    });
</code></pre><p>We don&#39;t have a <strong>getScientistById</strong> method, so let&#39;s make some changes to <strong>mongo-factory.js</strong> that make it possible. We are going to add two properties:</p>
<ul>
<li><strong>currentId</strong>: This is the MongoDb <strong>id</strong> of the currently selected scientist. It is long and looks a bit like GUID or UUID.</li>
<li><strong>allData</strong>: When we retrieve the list of scientists, we can store it in this property</li>
</ul>
<p>We will have to make some changes to <strong>mongoFactory.getScientists</strong> to support these new properties. Notice that we initialize both properties after retrieving the list of scientists from the server:</p>
<pre><code><span class="hljs-attribute">currentId</span>: null,

<span class="http"><span class="hljs-attribute">allData</span>: null,

<span class="fortran">getScientists: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(controller)</span></span> {
    $http.get(<span class="hljs-string">'/all-data'</span>).success(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span></span> {
        controller.scientistsLength = <span class="hljs-keyword">data</span>.allData.length;
        mongoFactory.allData = <span class="hljs-keyword">data</span>.allData;
        mongoFactory.currentId = <span class="hljs-keyword">data</span>.allData[<span class="hljs-number">0</span>]._id;
        allDataNames = <span class="hljs-keyword">data</span>.allData.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(scientist)</span></span> {
            <span class="hljs-keyword">return</span> {id: scientist._id, <span class="hljs-keyword">name</span>: scientist.firstName + <span class="hljs-string">' '</span> + scientist.lastName};
        });
        controller.allData = allDataNames;
        mongoFactory.getScientistById(mongoFactory.currentId, controller);
    }).error(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span> {
        console.<span class="hljs-built_in">log</span>(<span class="hljs-string">"error"</span>);
    });
},</span></span>
</code></pre><p>If you look at the mongoFactory.getScientists method, you can see that it frequently references itself:</p>
<pre><code>    mongoFactory.allData = <span class="hljs-class"><span class="hljs-keyword">data</span>.allData</span>
</code></pre><p>Being able to write that kind of code was why we made the change to the structure of the factory. Our goal is to avoid using <strong>this</strong> whenever possible. In particular, we don&#39;t want to accidentally reference this thinking that it points to <strong>mongoFactory</strong> when it actually points to the global object. </p>
<p>Now that we can track the list of scientists and a currently selected scientist, it becomes easy to retrieve a scientist by MongoDb <strong>id</strong>:</p>
<pre><code>getScientistById: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(id, controller)</span> </span>{
    mongoFactory.currentId = id;
    <span class="hljs-keyword">var</span> items = mongoFactory.allData.filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(scientist)</span> </span>{
        <span class="hljs-keyword">return</span> scientist._id === id;
    });
    <span class="hljs-keyword">return</span> controller.data = items[<span class="hljs-number">0</span>];
}
</code></pre><p>This method uses the javascript <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/filter"><strong>filter</strong></a> method. The <strong>filter</strong> method is an of javascript&#39;s support for <a href="http://eloquentjavascript.net/05_higher_order.html">functional programming</a>.</p>
<h2 id="the-menu">The Menu</h2>
<p>We need a menu in <strong>index.jade</strong> so the user can access each page.</p>
<pre><code>extends layout
block content
    .container
        .header
            nav.navbar-default.navbar-fixed-top
                ul.nav.nav-pills
                    <span class="hljs-keyword">li</span>(ng-<span class="hljs-keyword">class</span>=<span class="hljs-string">"{ active: isActive('/')}"</span>)
                        a(ng-href='#/') Home
                    <span class="hljs-keyword">li</span>(ng-<span class="hljs-keyword">class</span>=<span class="hljs-string">"{ active: isActive('/edit')}"</span>)
                        a(ng-href='#/<span class="hljs-keyword">edit</span>') <span class="hljs-keyword">Edit</span>
                    <span class="hljs-keyword">li</span>(ng-<span class="hljs-keyword">class</span>=<span class="hljs-string">"{ active: isActive('/subjects')}"</span>)
                        a(ng-href='#/subjects') Subjects
                    <span class="hljs-keyword">li</span>(ng-<span class="hljs-keyword">class</span>=<span class="hljs-string">"{ active: isActive('/comments')}"</span>)
                        a(ng-href='#/comments') Comments
                    <span class="hljs-keyword">li</span>(ng-<span class="hljs-keyword">class</span>=<span class="hljs-string">"{ active: isActive('/about')}"</span>)
                        a(ng-href='#/<span class="hljs-keyword">about</span>') <span class="hljs-keyword">About</span>
        div.jumbotron
            h1= title
            p Welcome to #{title}

        #monogoData(data-ng-<span class="hljs-keyword">view</span>=<span class="hljs-string">""</span>)
</code></pre><p>We will need to modify this menu next week. When run on a phone, for instance, we need it to morph into a hamburger menu. But for now, let&#39;s keep it as simple as possible.</p>
<h2 id="program-structure">Program Structure</h2>
<p>We need jade and javascript files to support each of the menu items:</p>
<table>
<thead>
<tr>
<th style="text-align:right">Menu</th>
<th style="text-align:right">Jade</th>
<th style="text-align:right">JavaScript</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">Home</td>
<td style="text-align:right">main.jade</td>
<td style="text-align:right">control.js</td>
</tr>
<tr>
<td style="text-align:right">Edit</td>
<td style="text-align:right">edit.jade</td>
<td style="text-align:right">edit.js</td>
</tr>
<tr>
<td style="text-align:right">Subjects</td>
<td style="text-align:right">subjects.jade</td>
<td style="text-align:right">subjects.js</td>
</tr>
<tr>
<td style="text-align:right">Comments</td>
<td style="text-align:right">comments.jade</td>
<td style="text-align:right">comments.js</td>
</tr>
<tr>
<td style="text-align:right">About</td>
<td style="text-align:right">about.jade</td>
<td style="text-align:right">about.js</td>
</tr>
</tbody>
</table>
<p>Of course we need to make corresponding changes in <strong>layout.jade</strong>:</p>
<pre><code>doctype html

html
    head
        title= title
        link(<span class="hljs-name">rel=</span>'stylesheet', href='/stylesheets/style.css')
        link(<span class="hljs-name">rel=</span>'stylesheet', href='/components/bootstrap/dist/css/bootstrap.css')
        script(<span class="hljs-name">src=</span><span class="hljs-string">"components/jquery/dist/jquery.js"</span>)
        script(<span class="hljs-name">src=</span><span class="hljs-string">"components/bootstrap/dist/js/bootstrap.js"</span>)
        script(<span class="hljs-name">src=</span><span class="hljs-string">"components/angular/angular.js"</span>)
        script(<span class="hljs-name">src=</span><span class="hljs-string">"components/angular-route/angular-route.js"</span>)
        script(<span class="hljs-name">src=</span><span class="hljs-string">"javascripts/app.js"</span>)
        script(<span class="hljs-name">src=</span><span class="hljs-string">"javascripts/control.js"</span>)
        script(<span class="hljs-name">src=</span><span class="hljs-string">"javascripts/subjects.js"</span>)
        script(<span class="hljs-name">src=</span><span class="hljs-string">"javascripts/comments.js"</span>)
        script(<span class="hljs-name">src=</span><span class="hljs-string">"javascripts/mongo-factory.js"</span>)
        script(<span class="hljs-name">src=</span><span class="hljs-string">"javascripts/about.js"</span>)
        script(<span class="hljs-name">src=</span><span class="hljs-string">"javascripts/edit.js"</span>)
        script(<span class="hljs-name">src=</span><span class="hljs-string">"javascripts/science-input.js"</span>)
    body(<span class="hljs-name">data-ng-app=</span><span class="hljs-string">"elvenApp"</span>)
        block content
</code></pre><p>You can sketch out the jade files by putting code like this in each of them:</p>
<pre><code><span class="hljs-selector-tag">h1</span>: About
</code></pre><p>And in the javascript files, you can put code like this:</p>
<pre><code>(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">var</span> app = angular.module(<span class="hljs-string">'elvenApp'</span>);

    app.controller(<span class="hljs-string">'CommentsController'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">($http, mongoFactory)</span> </span>{
        <span class="hljs-keyword">var</span> commentsController = <span class="hljs-keyword">this</span>;

        commentsController.hint = <span class="hljs-string">"Edit Document"</span>;
    });

})();
</code></pre><p>It should be obvious the small changes that need to be made to this sample code in order to make it unique to a particular file. For instance, in <strong>subjects.jade</strong> one would write: <strong>h1: Subjects</strong>. You can use the <strong>app.js</strong> file shown below to help you fill in the details, if they are not already obvious to you.</p>
<p>The <strong>main.jade</strong> file is a special case, as it will now contain the working code that was in <strong>index.jade</strong>:</p>
<pre><code>hr
ul
    li(data-ng-repeat=<span class="hljs-string">'scientist in mongoController.allData'</span>)
        &lt;a ng-click=<span class="hljs-string">"mongoController.selectScientist(scientist)"</span>&gt; <span class="hljs-template-variable">{{scientist.id}}</span> <span class="hljs-template-variable">{{scientist.name}}</span> &lt;<span class="hljs-regexp">/a&gt;


h2 Main
div(science-show="")
h2 Subjects
p {{mongoController.data.subjects}}
h2 Comments
p {{mongoController.data.comments}}</span>
</code></pre><p>We also need to create a file where we can specifyg our client side routes. The file, will be called <strong>app.js</strong> and it belongs in the <strong>public/javascripts</strong> folder. It structure should be second nature to you by this time:</p>
<pre><code>var myModule = angular.module(<span class="hljs-string">"elvenApp"</span>, [ <span class="hljs-string">'ngRoute'</span> ]);

myModule.config(<span class="hljs-keyword">function</span>($routeProvider, $locationProvider) {
    $routeProvider.when(<span class="hljs-string">"/"</span>, {
        templateUrl : <span class="hljs-string">"main"</span>,
        controller : <span class="hljs-string">"MongoController"</span>,
        controllerAs: <span class="hljs-string">"mongoController"</span>
    }).when(<span class="hljs-string">'/edit'</span>, {
        templateUrl : <span class="hljs-string">"edit"</span>,
        controller : <span class="hljs-string">"EditController"</span>,
        controllerAs: <span class="hljs-string">'editController'</span>
    }).when(<span class="hljs-string">'/subjects'</span>, {
        templateUrl : <span class="hljs-string">"subjects"</span>,
        controller : <span class="hljs-string">"SubjectsController"</span>,
        controllerAs: <span class="hljs-string">'subjectsController'</span>
    }).when(<span class="hljs-string">'/comments'</span>, {
        templateUrl : <span class="hljs-string">"comments"</span>,
        controller : <span class="hljs-string">"CommentsController"</span>,
        controllerAs: <span class="hljs-string">'commentsController'</span>
    }).when(<span class="hljs-string">'/about'</span>, {
        templateUrl : <span class="hljs-string">"about"</span>,
        controller : <span class="hljs-string">"AboutController"</span>,
        controllerAs: <span class="hljs-string">'aboutController'</span>
    }).otherwise({
        redirectTo : <span class="hljs-string">'/'</span>
    });
});
</code></pre><p>Now that we are initiliazing our <strong>elvenApp</strong> module in <strong>app.js</strong>, don&#39;t forget to remove the dependencies to the module declaration in <strong>control.js</strong>:</p>
<ul>
<li>Wrong code in <strong>control.js</strong>: var app = angular.module(&#39;elvenApp&#39;, []);</li>
<li>Right code in <strong>control.js</strong>: var app = angular.module(&#39;elvenApp&#39;);</li>
</ul>
<h2 id="directives">Directives</h2>
<p>There are two directives we will use now, or later. Put them both in a file called <strong>public/javascripts/science-input.js</strong>:</p>
<pre><code>(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>

    var app = angular.module(<span class="hljs-string">'elvenApp'</span>);

    app.directive(<span class="hljs-string">'scienceShow'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>

        <span class="hljs-keyword">return</span> {
            controller: <span class="hljs-string">'MongoController'</span>,
            controllerAs: <span class="hljs-string">'mongoController'</span>,
            template:
            <span class="hljs-string">'First: {{mongoController.data.firstName}} '</span> +
            <span class="hljs-string">'&lt;br&gt;Last: {{mongoController.data.lastName}}'</span> +
            <span class="hljs-string">'&lt;br&gt;Topic: {{mongoController.data.subject}}'</span>
        };
    });

    app.directive(<span class="hljs-string">'scienceInput'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>

        <span class="hljs-keyword">return</span> {
            controller: <span class="hljs-string">'MongoController'</span>,
            controllerAs: <span class="hljs-string">'mongoController'</span>,
            template: <span class="hljs-string">"&lt;hr/&gt;"</span> +
            <span class="hljs-string">"&lt;label class='</span>col-sm<span class="hljs-number">-2</span> control-label'&gt;First Name&lt;/label&gt;<span class="hljs-string">" +
            "</span>&lt;div class=<span class="hljs-string">'col-sm-4'</span>&gt;<span class="hljs-string">" +
                "</span>&lt;input <span class="hljs-built_in">type</span>=<span class="hljs-string">'text'</span> class=<span class="hljs-string">'form-control'</span> ng-model=<span class="hljs-string">'mongoController.data.firstName'</span>&gt;<span class="hljs-string">" +
            "</span>&lt;/div&gt;<span class="hljs-string">" +
            "</span>&lt;label class=<span class="hljs-string">'col-sm-2 control-label'</span>&gt;Last Name&lt;/label&gt;<span class="hljs-string">" +
            "</span>&lt;div class=<span class="hljs-string">'col-sm-4'</span>&gt;<span class="hljs-string">" +
                "</span>&lt;input <span class="hljs-built_in">type</span>=<span class="hljs-string">'text'</span> class=<span class="hljs-string">'form-control'</span> ng-model=<span class="hljs-string">'mongoController.data.lastName'</span>&gt;<span class="hljs-string">" +
            "</span>&lt;/div&gt;<span class="hljs-string">" +
            "</span>&lt;label class=<span class="hljs-string">'col-sm-2 control-label'</span>&gt;Subject&lt;/label&gt;<span class="hljs-string">" +
            "</span>&lt;div class=<span class="hljs-string">'col-sm-4'</span>&gt;<span class="hljs-string">" +
                "</span>&lt;input <span class="hljs-built_in">type</span>=<span class="hljs-string">'text'</span> class=<span class="hljs-string">'form-control'</span> ng-model=<span class="hljs-string">'mongoController.data.subject'</span>&gt;<span class="hljs-string">" +
            "</span>&lt;/div&gt;<span class="hljs-string">"
        };
    });

})();</span>
</code></pre><p>As you can see, the <strong>scienceShow</strong> directive is just another version of <strong>elfMarie</strong>, so you can remove that directive from <strong>control.js</strong>.</p>
<h2 id="finding-data">Finding Data</h2>
<p>I&#39;ve rewritten the connect method to make it easier to see the user name, password and database. Remember
that we want to create a REST URL that looks like this:</p>
<pre><code>mongoose.connect('mongodb://csc:Re<span class="hljs-keyword">*</span>lD<span class="hljs-keyword">*</span>t<span class="hljs-keyword">*</span>22<span class="hljs-comment">#@ds049848.mongolab.com:49848/elvenlab01');</span>
</code></pre><p>Here is the new method, where the parts that specify the user name, password and database
are perhaps easier for you to see. Remember that the user name and password are separated
by a colon:    </p>
<pre><code><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doConnection</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> baseUrl = <span class="hljs-string">'mongodb://'</span>;
  <span class="hljs-keyword">var</span> userName = <span class="hljs-string">'csc'</span>;
  <span class="hljs-keyword">var</span> password = <span class="hljs-string">'Re*lD*t*22#'</span>;
  <span class="hljs-keyword">var</span> siteAndPort = <span class="hljs-string">'ds049848.mongolab.com:49848'</span>;
  <span class="hljs-keyword">var</span> databaseName = <span class="hljs-string">'elvenlab01'</span>;
  <span class="hljs-keyword">var</span> url = baseUrl + userName + <span class="hljs-string">':'</span> + password + <span class="hljs-string">'@'</span> + siteAndPort + <span class="hljs-string">'/'</span> + databaseName;
  <span class="hljs-built_in">console</span>.log(url);
  mongoose.connect(url);

  <span class="hljs-keyword">var</span> db = mongoose.connection;
  db.on(<span class="hljs-string">'error'</span>, <span class="hljs-built_in">console</span>.error.bind(<span class="hljs-built_in">console</span>, <span class="hljs-string">'connection error:'</span>));
  db.once(<span class="hljs-string">'open'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
    connected = <span class="hljs-literal">true</span>;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Opened connection to mongo'</span>);
  });
}
</code></pre><p>We have changed the way several methods in <strong>routes/index.js</strong> work:</p>
<pre><code>router.<span class="hljs-keyword">get</span>('/data/:<span class="hljs-built_in">id</span>', function(request, response) {
    console.<span class="hljs-built_in">log</span>('Request <span class="hljs-built_in">id</span>: ' + request.params.<span class="hljs-built_in">id</span>);
    console.<span class="hljs-built_in">log</span>('type <span class="hljs-keyword">of</span> request:' + typeof request.params.<span class="hljs-built_in">id</span>);
    var idInvalid = (request.params.<span class="hljs-built_in">id</span> === 'undefined');
    console.<span class="hljs-built_in">log</span>('IdInvalid: ' + idInvalid);
    <span class="hljs-keyword">if</span> (!idInvalid) {
        response.send({
            <span class="hljs-literal">result</span>: 'Success',
            numberOfDocuments: allData.<span class="hljs-built_in">length</span>,
            <span class="hljs-built_in">id</span>: allData[request.params.<span class="hljs-built_in">id</span>]._id,
            firstName: allData[request.params.<span class="hljs-built_in">id</span>].firstName,
            lastName: allData[request.params.<span class="hljs-built_in">id</span>].lastName,
            subject: allData[request.params.<span class="hljs-built_in">id</span>].subject,
            subjects: allData[request.params.<span class="hljs-built_in">id</span>].subjects,
            comments: allData[request.params.<span class="hljs-built_in">id</span>].comments
        });
    } <span class="hljs-keyword">else</span> {
        response.send({<span class="hljs-literal">result</span>: 'Invalid <span class="hljs-built_in">id</span>'});
    }
});

router.<span class="hljs-keyword">get</span>('/find-<span class="hljs-keyword">by</span>-<span class="hljs-built_in">id</span>/:<span class="hljs-built_in">id</span>', function(request, response) {
    console.<span class="hljs-built_in">log</span>('Request <span class="hljs-built_in">id</span>: ' + request.params.<span class="hljs-built_in">id</span>);
    console.<span class="hljs-built_in">log</span>('type <span class="hljs-keyword">of</span> request:' + typeof request.params.<span class="hljs-built_in">id</span>);
    var idInvalid = (request.params.<span class="hljs-built_in">id</span> === 'undefined');
    console.<span class="hljs-built_in">log</span>('IdInvalid: ' + idInvalid);
    <span class="hljs-keyword">if</span> (!idInvalid) {
        var query = scientists.<span class="hljs-keyword">where</span>({_id: request.params.<span class="hljs-built_in">id</span>});
        query.findOne(function(err, scientist) {
            <span class="hljs-keyword">if</span> (err) {
                response.send(err);
            }
            <span class="hljs-keyword">if</span> (scientist) {
                response.send(scientist);
            }
        });
    } <span class="hljs-keyword">else</span> {
        response.send({<span class="hljs-literal">result</span>: 'Invalid <span class="hljs-built_in">id</span>'});
    }
});
</code></pre><h2 id="posting-data">Posting Data</h2>
<p>We want to update the database, we have to post data from the client to the server and from the server to the database. Information about the transaction is that routed back to the client.</p>
<p>On the client side, we use <strong>$http.post</strong> to send data to the server. These calls take two parameters:</p>
<ul>
<li>The route we want to call on the server. For instance: <strong>&#39;/data&#39;</strong>.</li>
<li>The new data that we want to send to the database. This is the update itself.</li>
</ul>
<p>First, let&#39;s create a helper function that can handle our success and error messages:</p>
<pre><code>    report: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data, status, headers, config)</span></span> {
        console.<span class="hljs-built_in">log</span>(<span class="hljs-keyword">data</span>);
        console.<span class="hljs-built_in">log</span>(<span class="hljs-keyword">status</span>);
        console.<span class="hljs-built_in">log</span>(headers);
        console.<span class="hljs-built_in">log</span>(config);
    },
</code></pre><p>Now lets compose the <strong>$http</strong> requests that will send data to the server. There are three of them:</p>
<ul>
<li>Update the <strong>firstName</strong>, <strong>lastName</strong> and main <strong>subject</strong>.</li>
<li>Update the detailed list of <strong>subjects</strong>.</li>
<li>Update the the list of <strong>comments</strong>.</li>
</ul>
<p>Here is what the code in <strong>mongoFactory</strong> looks like. Remember that each method is  requests to update the database. It will be sent to the server using REST calls.</p>
<p>When pasting in the code shown here, replace your existing <strong>postDocument</strong> function
and then add two new methods for <strong>subjects</strong> and <strong>comments</strong>:</p>
<pre><code>            postDocument: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(route, controller)</span></span> {
                var scientist = {
                    id: controller.<span class="hljs-keyword">data</span>._id,
                    firstName: controller.<span class="hljs-keyword">data</span>.firstName,
                    lastName: controller.<span class="hljs-keyword">data</span>.lastName,
                    subject: controller.<span class="hljs-keyword">data</span>.subject
                };
                $http.post(route, scientist)
                .success(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data, status, headers, config)</span></span> {
                    mongoFactory.report(<span class="hljs-keyword">data</span>, <span class="hljs-keyword">status</span>, headers, config);
                }).error(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data, status, headers, config)</span></span> {
                    mongoFactory.report(<span class="hljs-keyword">data</span>, <span class="hljs-keyword">status</span>, headers, config);
                });
            },

            postSubjects: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(initId, subjects)</span></span> {
                var subjectsUpdate = {
                    id: initId,
                    subjects: subjects
                };
                $http.post(<span class="hljs-string">'/updateSubjects'</span>, subjectsUpdate)
                .success(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data, status, headers, config)</span></span> {
                    mongoFactory.report(<span class="hljs-keyword">data</span>, <span class="hljs-keyword">status</span>, headers, config);
                }).error(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data, status, headers, config)</span></span> {
                    mongoFactory.report(<span class="hljs-keyword">data</span>, <span class="hljs-keyword">status</span>, headers, config);
                });
            },

            postComments: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(initId, comments)</span></span> {
                var subjectsUpdate = {
                    id: initId,
                    comments: comments
                };
                $http.post(<span class="hljs-string">'/updateComments'</span>, subjectsUpdate)
                .success(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data, status, headers, config)</span></span> {
                    mongoFactory.report(<span class="hljs-keyword">data</span>, <span class="hljs-keyword">status</span>, headers, config);
                }).error(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data, status, headers, config)</span></span> {
                    mongoFactory.report(<span class="hljs-keyword">data</span>, <span class="hljs-keyword">status</span>, headers, config);
                });
            },
</code></pre><p>In <strong>routes/index.js</strong> we respond to the requests that originate in <strong>mongoFactory</strong>. We need to replace our existing <strong>/insert</strong> route and create two new routes for <strong>subjects</strong> and <strong>comments</strong>:</p>
<pre><code>router.post(<span class="hljs-string">'/insert'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Save called. Body is next: '</span>);
    <span class="hljs-comment">//var newData = getNewData(request.body);</span>
    <span class="hljs-keyword">var</span> newData = {
        firstName: request.body.firstName,
        lastName: request.body.lastName,
        subject:  request.body.subject,
        comments: [],
        subjects: []
    };
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"New Data"</span>, newData);

    <span class="hljs-keyword">if</span> (!connected) {
        doConnection();
    }

    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"about to call update"</span>);
    <span class="hljs-keyword">var</span> f = <span class="hljs-keyword">new</span> scientists(newData);
    f.save(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e, a</span>) </span>{
        response.send({result: e + a});
    });
});

router.post(<span class="hljs-string">'/updateSubjects'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'updateSubjects called. Body is next: '</span>);
    <span class="hljs-built_in">console</span>.log(request.body);
    scientists.update({ _id: request.body.id }, {
            $set: {
                subjects: request.body.subjects
            }
        }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, numUpdated</span>) </span>{
            <span class="hljs-built_in">console</span>.log(err, {numUpdated: numUpdated});
            <span class="hljs-keyword">if</span> (err) {
                <span class="hljs-built_in">console</span>.log(err);
            }
            response.send({result: <span class="hljs-string">'Success'</span>, data: numUpdated});
        }
    );
});

router.post(<span class="hljs-string">'/updateComments'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'updateComments called. Body is next: '</span>);
    <span class="hljs-built_in">console</span>.log(request.body);
    scientists.update({ _id: request.body.id }, {
            $set: {
                comments: request.body.comments
            }
        }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, numUpdated</span>) </span>{
            <span class="hljs-built_in">console</span>.log(err, {numUpdated: numUpdated});
            <span class="hljs-keyword">if</span> (err) {
                <span class="hljs-built_in">console</span>.log(err);
            }
            response.send({result: <span class="hljs-string">'Success'</span>, data: numUpdated});
        }
    );
});
</code></pre><p>You should already have it in there, but if not, be sure you have include a <strong>save</strong> route:</p>
<pre><code class="lang-javascript">router.post(<span class="hljs-string">'/save'</span>, function(request, response) {
  console.log(<span class="hljs-string">'Save called. Body is next: '</span>)

  var newData = getNewData(request.body)<span class="hljs-comment">;</span>

  <span class="hljs-keyword">if</span> (!connected) {
    doConnection()<span class="hljs-comment">;</span>
  }

  console.log(<span class="hljs-string">"about to call update"</span>)<span class="hljs-comment">;</span>
  scientists.update({ _id: request.body.id }, { $set: newData},
      function(<span class="hljs-keyword">err</span>, data) {
        console.log(<span class="hljs-keyword">err</span>, data)<span class="hljs-comment">;</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">err</span>) {
          console.log(<span class="hljs-keyword">err</span>)<span class="hljs-comment">;</span>
        }
        response.send({result: <span class="hljs-string">'Success'</span>, data: data})<span class="hljs-comment">;</span>
      }
  )<span class="hljs-comment">;</span>

})<span class="hljs-comment">;</span>
</code></pre>
<h2 id="edit-main-fields">Edit Main Fields</h2>
<p>Now that we have things set up, the first step will be to enable editing of the <strong>firstName</strong> 
and <strong>lastName</strong>. This will take place in <strong>edit.js</strong>. We begin by modifying <strong>edit.jade</strong>:</p>
<pre><code>h1 <span class="hljs-keyword">Edit</span>

p hint: {{editController.hint}}

hr
button(data-ng-click=<span class="hljs-string">"editController.saveCurrentDocument()"</span>) <span class="hljs-keyword">Save</span> Current Document
<span class="hljs-keyword">br</span>
<span class="hljs-keyword">br</span>
button(data-ng-click=<span class="hljs-string">"editController.insertDocument()"</span>) Insert New Document


div(ng-<span class="hljs-keyword">form</span>=<span class="hljs-string">"myform"</span>)
   hr
   <span class="hljs-keyword">label</span>(<span class="hljs-keyword">class</span>='col-sm-2, control-<span class="hljs-keyword">label</span>') First Name
   <span class="hljs-keyword">input</span>.<span class="hljs-keyword">form</span>-control(<span class="hljs-keyword">type</span>='text', ng-model='editController.data.firstName')
   <span class="hljs-keyword">br</span>
   <span class="hljs-keyword">label</span>(<span class="hljs-keyword">class</span>='col-sm-2, control-<span class="hljs-keyword">label</span>') Last Name
   <span class="hljs-keyword">input</span>.<span class="hljs-keyword">form</span>-control(<span class="hljs-keyword">type</span>='text', ng-model='editController.data.lastName')
   <span class="hljs-keyword">br</span>
   <span class="hljs-keyword">label</span>(<span class="hljs-keyword">class</span>='col-sm-2, control-<span class="hljs-keyword">label</span>') Subject
   <span class="hljs-keyword">input</span>.<span class="hljs-keyword">form</span>-control(<span class="hljs-keyword">type</span>='text', ng-model='editController.data.subject')
</code></pre><p>Then, in <strong>edit.js</strong>, our first task is to get hold of the individual
scientist that we want to edit:</p>
<pre><code>        <span class="hljs-selector-tag">mongoFactory</span><span class="hljs-selector-class">.getScientistById</span>(<span class="hljs-selector-tag">mongoFactory</span><span class="hljs-selector-class">.currentId</span>, <span class="hljs-selector-tag">editController</span>);
</code></pre><p>Now we are able to display the scientist data. The final step is to save and insert
documents:</p>
<pre><code>        editController.saveCurrentDocument = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
            mongoFactory.postDocument(<span class="hljs-string">"/save"</span>, editController);
        };

        editController.insertDocument = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
            mongoFactory.postDocument(<span class="hljs-string">"/insert"</span>, editController);
        };
</code></pre><h2 id="subjects">Subjects</h2>
<p>Now we want to be able to create a detailed list of subjects associated with a particular scientist. Let&#39;s start by adding 
in the jade code in <strong>views/subjects.jade</strong>:</p>
<pre><code>h1 Subjects

label(class=<span class="hljs-string">'col-sm-2, control-label'</span>) New Subject
<span class="hljs-keyword">input</span>.form-control(type=<span class="hljs-string">'text'</span>, ng-model=<span class="hljs-string">'subjectsController.newSubject'</span>)


<span class="hljs-keyword">button</span>(ng-click=<span class="hljs-string">"subjectsController.addItem()"</span>) Add Item
<span class="hljs-keyword">button</span>(ng-click=<span class="hljs-string">"subjectsController.saveItems()"</span>) Save Items
<span class="hljs-keyword">button</span>(ng-click=<span class="hljs-string">"subjectsController.deleteSelected()"</span>) <span class="hljs-keyword">Delete</span> Selected

ul
   li(ng-<span class="hljs-keyword">repeat</span>=<span class="hljs-string">'subject in subjectsController.data.subjects'</span>)
      span {{subject}}
</code></pre><p>Here is the code for inserting and updating the detailed list of subjects. It belongs, of course, in <strong>public/javascripts/subjects.js</strong>:</p>
<pre><code>(<span class="hljs-name">function</span>() {

    var app = angular.module(<span class="hljs-name">'elvenApp'</span>)<span class="hljs-comment">;</span>

    app.controller(<span class="hljs-name">'SubjectsController'</span>, function($http, mongoFactory) {
        var subjectsController = this;

        subjectsController.hint = <span class="hljs-string">"Edit Document"</span><span class="hljs-comment">;</span>

        subjectsController.addItem = function() {
            subjectsController.data.subjects.push(<span class="hljs-name">subjectsController.newSubject</span>)<span class="hljs-comment">;</span>
        }<span class="hljs-comment">;</span>

        subjectsController.saveItems = function() {
            mongoFactory.postSubjects(<span class="hljs-name">subjectsController.data._id</span>,
                subjectsController.data.subjects)<span class="hljs-comment">;</span>
        }<span class="hljs-comment">;</span>

        subjectsController.deleteSelected = function() {

        }<span class="hljs-comment">;</span>

        function getScientist() {
            mongoFactory.getScientistById(<span class="hljs-name">mongoFactory.currentId</span>, subjectsController)<span class="hljs-comment">;</span>
        }

        getScientist()<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>

})()<span class="hljs-comment">;</span>
</code></pre><p>The code starts in <strong>getScientist</strong> by retrieving the current record from the <strong>mongoFactory</strong>:</p>
<pre><code>    <span class="hljs-selector-tag">mongoFactory</span><span class="hljs-selector-class">.getScientistById</span>(<span class="hljs-selector-tag">mongoFactory</span><span class="hljs-selector-class">.currentId</span>, <span class="hljs-selector-tag">subjectsController</span>);
</code></pre><p>This code works because the factory is always tracking the currently selected record back on the main page.</p>
</div></body></html>