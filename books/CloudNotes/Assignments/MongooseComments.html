<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width initial-scale=1.0"><title>MongooseComments</title><link href="/css/first-style.css" rel="stylesheet"><link rel="shortcut icon" href="/images/favicon.png"><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet"><link href="/css/highlight/googlecode.css" rel="stylesheet" type="text/css"><link href="/css/style.css" rel="stylesheet"><script src="https://code.jquery.com/jquery-1.12.0.min.js"></script><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- Latest compiled and minified CSS --><script src="/js/elven-help.js"></script></head><body><nav class="navbar navbar-inverse"><div class="container"><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/">Elvenware</a></div><div class="navbar-collapse collapse" id="navbar"><ul class="nav navbar-nav"><li class="trigger-collapse" ng-class="{ active: isActive('/')}"><a href="/">Home</a></li><li><a href="/about.html">About</a></li></ul></div></div></nav><div class="container"><figure><img class="elf-normal" alt="Elvenware" src="/images/elvenwarelogo.png"/></figure><h1>MongooseComments</h1><p>Welcome to MongooseComments</p><ul><!--TOC_Start--><li><a href="#description">Description</a></li>
<li><a href="#step-one">Step One</a></li>
<li><a href="#step-two">Step Two</a></li>
<li><a href="#step-three">Step Three</a></li>
<li><a href="#step-four">Step Four</a></li>
<li><a href="#step-five">Step Five</a></li>
<li><a href="#step-six">Step Six</a></li>
<li><a href="#step-seven">Step Seven</a></li>
<li><a href="#step-eight">Step Eight</a></li>
<li><a href="#turn-it-in">Turn it in</a></li>
<li><a href="#hints">Hints</a></li>
<li><a href="#references">References</a></li><!--TOC_End--></ul></div><div class="container"><a class="anchor" id="description"></a>
<h2>Description</h2>
<p>Learn how to refactor <strong>MongooseSubDocs</strong> in to a program with easily reusable components. In particular, learn how to break out the code for handling comments into two separate modules called:</p>
<ul>
<li><strong>routes/comments.js</strong></li>
<li><strong>public/javascripts/comment-factory.js</strong></li>
</ul>
<p>You will also create a new file for handling connections to a MongoDb database. That file is called:</p>
<p>-- <strong>routes/connect.js</strong> </p>
<p>Some changes will also be made to the <strong>routes/index.js</strong> file in <strong>MongooseSubDocs</strong></p>
<p><strong>NOTE</strong>: <em>If you have already completed this assignment as part of <strong>MongooseRoutes</strong>, then you can simply point me toward that assignment when you turn in this assignment. I have created this assignment so as to make it as easy as possible for you to add a comments to your Final project. It steps you through the process of creating the files that will handle comments in your Final project.</em></p>
<a class="anchor" id="step-one"></a>
<h2>Step One</h2>
<p>Copy MongooseSubDocs into <strong>Week11-MongooseComments</strong>:</p>
<pre>robocopy Week10-MongooseSubdocs Week11-MongooseComments /mir
</pre>
<p>Open <strong>Week11-MongooseComments</strong> in WebStorm and change the name from MongooseSubDocs to MongooseComments.</p>
<a class="anchor" id="step-two"></a>
<h2>Step Two</h2>
<p>Create a connection to the MongoDb database.</p>
<p>Below you will reusable code that can be used when we need to connect to our database. This is needed because our new application is going to have two pieces of middleware both of which need to connect to the Mongoose database:</p>
<ul>
<li><strong>routes/index.js</strong>  will be able to retrieve all the data from the database. In our final, this file might be also used for other tasks such as inserting and deleting scientists and updating the subjects. In short, it handles everything except the comments.</li>
<li><strong>routes/comments.js</strong> will only handle comments. The point is that the CRUD operations for comments are complex enough that they belongs in their own module. We are following the rule that says each object should do one thing and have only one reason for change. The <strong>comments.js</strong> module follows that rule reasonable well, in that it only will change if our technique for handling <strong>comments</strong> changes.</li>
</ul>
<p><strong>NOTE</strong>: <em>It is arguable that we could break more code out of <strong>index.js</strong> and into its own middleware file. I would, in fact, do that, but we have simply run out of time this quarter.</em></p>
<p>See the <a href="http://www.elvenware.com/charlie/development/database/NoSql/MongoDb.html#how-to-connect">details of how to connect</a> on Elvenware:</p>
<a class="anchor" id="step-three"></a>
<h2>Step Three</h2>
<p>Create <strong>routes/comments.js</strong>. </p>
<ul>
<li>Right click on the <strong>routes</strong> folder and create a new file called <strong>comments.js</strong>.</li>
</ul>
<p>At the top of <strong>routes/comments.js</strong> paste in this code:</p>
<pre>var express = require('express');
var router = express.Router();
var connect = require('./connect');
var scientists = require('../models/scientists');
</pre>
<p>First we load express and the router, just as we do at the top of all the <strong>middleware</strong> files in the <strong>routes</strong> folder. Then we link in our new connection code and our existing <strong>scientists</strong> model.</p>
<ul>
<li>Cut the entirety of the following methods from <strong>index.js</strong> and paste them into <strong>comments.js</strong><ul>
<li><strong>router.post(&#39;/newComment&#39;, etc...</strong></li>
<li><strong>function remove(arr, item) {  etc...</strong></li>
<li><strong>router.post(&#39;/deleteComment&#39;, function(request, response) { etc...</strong></li>
<li><strong>router.post(&#39;/updateComments&#39;, function(request, response) { etc...</strong></li>
</ul>
</li>
<li>Also copy this line to the very end of <strong>comments.js</strong>:<ul>
<li><strong>module.exports = router;</strong></li>
</ul>
</li>
</ul>
<p>The final step is to modify the way we handle connecting to the database. Take a close look at the beginning of <strong>connect.js</strong> above. Notice that we have declared a <strong>boolean</strong> property of the <strong>connect</strong> object that records whether or not we are already connected.</p>
<p>Inside <strong>routes/comments.js</strong> we use that <strong>connected</strong> property, and the <strong>doConnection</strong> method itself, like this:</p>
<pre>if (!connect.connected) {
    connect.doConnection();
}
</pre>
<p>You should work your way through comments.js and make sure all the calls that check for the connection to the database now look like the code shown above. In other words, you want to transform code like the following into the code shown above:</p>
<pre>if (!connected) {
    doConnection();
}
</pre>
<p>Your should have to make three such substitutions, one at the top of each methods in <strong>comments.js</strong>.</p>
<pre>var express = require('express');
var router = express.Router();
var connect = require('./connect');
var scientists = require('../models/scientists');

router.post('/newComment', function(request, response) {
    if (!connect.connected) {
        connect.doConnection();
    }

    console.log('newComments called. Body is next: ');
    console.log(request.body);
    var scientist = request.body.scientist;
    var comment = request.body.comment;
    console.log(comment);

    // Code omitted here
});

function remove(arr, item) {
    for(var i = arr.length; i--;) {
        if(arr[i]._id == item._id) {
            arr.splice(i, 1);
        }
    }
}

router.post('/deleteComment', function(request, response) {
    if (!connect.connected) {
        connect.doConnection();
    }

    // Code omitted here
});

router.post('/updateComments', function(request, response) {
    if (!connect.connected) {
        connect.doConnection();
    }

    // Code omitted here
});

module.exports = router;
</pre>
<p>Your copy of <strong>models/scientists.js</strong> may already look like this, but just to avoid confusion, the version of that file I&#39;m using in this project looks like this:</p>
<pre>/**
 * Created by charlie on 6/6/2015.
 */

var mongoose = require('mongoose');

var commentSchema = mongoose.Schema({
    commentText: String,
    date: { type: Date, default: Date.now }
});

var scientistsSchema = mongoose.Schema({
    "firstName": String,
    "lastName": String,
    "subject": String,
    "subjects": [String],
    comments: [commentSchema]
});

module.exports = mongoose.model('scientist', scientistsSchema);
</pre>
<p>Notice the <strong>exports</strong> statement as it may vary slightly from the version on your system. It is important to get it right as other code in this document depends on it.</p>
<a class="anchor" id="step-four"></a>
<h2>Step Four</h2>
<p>Link in your new <strong>routes/comments.js</strong> middleware. </p>
<p>We want this new <strong>comments</strong> module to be included in our program, so we have to tell <strong>express</strong> to call it whenever a request for an operation on our comments comes in. All our comment operations will have have the routes <strong>/coment</strong> prepended to them.</p>
<p>You can begin by loading the <strong>comments</strong> module. In the following code, the first two lines, and last line, are included only for context. It is the third line that you want to add to the server side <strong>/app.js</strong> file:</p>
<pre>var routes = require('./routes/index');
var users = require('./routes/users');
var comments = require('./routes/comments');

var app = express();
</pre>
<p>Now tell express to include your <strong>comments</strong> middleware in the chain of code it calls when requests to handle comments are passed to the server from the client. Again, the first two lines are included here only for context, only to help you find the place in <strong>app.js</strong> to add our new line of code:</p>
<pre>app.use('/', routes);
app.use('/users', users);
app.use('/comments', comments);
</pre>
<a class="anchor" id="step-five"></a>
<h2>Step Five</h2>
<p>Modify <strong>index.js</strong> to work with our new connection model.</p>
<p>Here is the way the top of <strong>index.js</strong> should now look:</p>
<pre>var express = require('express');
var router = express.Router();
var connect = require('./connect');
var scientists = require('../models/scientists');
var fs = require('fs');
</pre>
<p>The key point is that we are now linking in the new <strong>routes/connect.js</strong> module.</p>
<p>Since the <strong>doConnection</strong> method is now in <strong>connect.js</strong>, you should delete <strong>doConnection</strong> from <strong>routes/index.js</strong>. You should also delete the variable called <strong>connected</strong>. You should also change all the calls to <strong>doConnection</strong> as described in an earlier step.</p>
<a class="anchor" id="step-six"></a>
<h2>Step Six</h2>
<p>Let&#39;s now switch over to the client side and create a <strong>javascripts/comments.js</strong> file that mirrors the <strong>routes/comments.js</strong> file on the server side. </p>
<p>Create a file called <strong>javascripts/comment-factory.js</strong>. Start it out with boilerplate code:</p>
<pre>
(function() {

    var app = angular.module('elvenApp');

    app.factory('commentFactory', function($http) {

            var commentFactory = {

                // Insert comment methods here

            };

            return commentFactory;    
        });
})();
</pre>
<p>Cut the following methods from <strong>mongo-factory.js</strong> and paste them into <strong>comment-factory</strong> in the designated location:</p>
<ul>
<li><strong>newComment</strong></li>
<li><strong>updateComment</strong></li>
<li><strong>deleteComment</strong></li>
</ul>
<p>Make sure that the factory in <strong>mongo-factory</strong> is called <strong>mongoFactory</strong> and the factory in <strong>comment-factory</strong> is called <strong>commentFactory</strong>. Double check to make sure you got it right.</p>
<p>Now change all the <strong>HTTP</strong> REST calls to make sure they are using the route to our new middleware. In particular, change calls that look like this:</p>
<pre>$http.post('/newComment'
</pre>
<p>Now they should use our new route to the middleware found in <strong>routes/comments.js</strong>:</p>
<pre>$http.post('/comments/newComment'
</pre>
<p>Recall that we set that middleware up in <strong>/app.js</strong> with this line of code:</p>
<pre>app.use('/comments', comments);
</pre>
<p>And we will need a <strong>/views/commentds.jade</strong> file to go with <strong>public/javascripts/comments.js</strong></p>
<pre>h1 Comments: {{commentsController.name}}
div.names
    ul
        li(ng-repeat='comment in commentsController.scientist.comments')
            a(ng-click="commentsController.selectComment(comment)") {{comment.commentText}}
    div.names(ng-form="newCommentForm")
        hr
        button.btn.btn-default(ng-click='commentsController.newComment()') New Comment
        br
        br
        label(class='col-sm-2, control-label') Text
        input.form-control(type='text', ng-model='commentsController.newCommentText')
    div.names(ng-form="myform")
        hr
        button.btn.btn-default(ng-click='commentsController.updateComment()') Update Comment
        button.btn.btn-default(ng-click='commentsController.deleteComment()') Delete Comment
        br
        br
        label(class='col-sm-2, control-label') Text
        input.form-control(type='text', ng-model='commentsController.comment.commentText')
        br
        label(class='col-sm-2, control-label') Date
        input.form-control(type='text', ng-model='commentsController.comment.date')
        br
        label(class='col-sm-2, control-label') Id
        input.form-control(type='text', ng-model='commentsController.comment._id')
</pre>
<p>You should probably add support for an about page as well.</p>
<a class="anchor" id="step-seven"></a>
<h2>Step Seven</h2>
<p>Include a menu in <strong>index.jade</strong></p>
<pre>extends layout
block content
    nav.navbar-default.navbar-fixed-top
        .container-fluid
            .navbar-header
                button(type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#myTarget")
                    span.sr-only Toggle navigation
                    span.icon-bar
                    span.icon-bar
                    span.icon-bar
                a.navbar-brand(href="#/") Final
            #myTarget.collapse.navbar-collapse
                ul.nav.navbar-nav
                    li(ng-class="{ active: isActive('/')}")
                        a(ng-href='#/') Home
                    li(ng-class="{ active: isActive('/comments')}")
                        a(ng-href='#/comments') Comments
                    li(ng-class="{ active: isActive('/about')}")
                        a(ng-href='#/about') About
    h1= title
    p Welcome to #{title}
    div(data-ng-view="")
</pre>
<p>And add in support for routes:</p>
<pre>bower install angular-route --save
</pre>
<p>Make sure that <strong>bower.json</strong> is using a single version of angular throughout.</p>
<p>Then provide support for your routes on the client:</p>
<pre>var myModule = angular.module("elvenApp", [ 'ngRoute' ]);

myModule.config(function($routeProvider, $httpProvider, $locationProvider) {

    $routeProvider.when("/", {
        templateUrl : "main",
        controller : "MainController",
        controllerAs: "mainController"
    }).when('/comments', {
        templateUrl : "comments",
        controller : "CommentsController",
        controllerAs: 'commentsController',
        resolve: {
            loggedin: checkLoggedin
        }
    }).when('/about', {
        templateUrl : "about",
        controller : "AboutController",
        controllerAs: 'aboutController'
    }).otherwise({
        redirectTo : '/'
    });
});
</pre>
<a class="anchor" id="step-eight"></a>
<h2>Step Eight</h2>
<p>Some finishing touches.</p>
<p>In layout.jade, link in comments:</p>
<pre>script(src="javascripts/comment-factory.js")
script(src="javascripts/mongo-factory.js")
</pre>
<p>At the top of <strong>control.js</strong>, link in both <strong>mongoFactory</strong> and <strong>commentFactory</strong>:</p>
<pre>app.controller('MainController', function(mongoFactory, commentFactory) {
</pre>
<p>Go through each method in <strong>control.js</strong> and make sure it is calling into the proper factory. Some call into <strong>commentFactory</strong> and others into <strong>mongoFactory</strong>.</p>
<p>Congrats. You now have everything set up correctly. In addition, it should be relatively trivial for you to move this code into your <strong>Final</strong> project.</p>
<a class="anchor" id="turn-it-in"></a>
<h2>Turn it in</h2>
<p>Put his project in a folder of your repository called <strong>Week11-MongooseComments</strong>. If you already completed this project  as part of the <strong>MongooseRoutes</strong> assignment, then simply point me to the folder that contains your version of the assignment. For instance, when you submit this assignment, add a comment saying that this project can be found in the <strong>XXX</strong> folder.</p>
<a class="anchor" id="hints"></a>
<h2>Hints</h2>
<p>Please see this information:</p>
<ul>
<li>Sending a <a href="http://elvenware.com/charlie/development/web/JavaScript/Angular.html#http">new comment</a> from the browser to the server to a database. </li>
</ul>
<a class="anchor" id="references"></a>
<h3>References</h3>
<p>As of version 3 of Mongoose, there are two ways to declare sub-documents. Method 1 and method 2 are functionally equivalent.</p>
<p>Method 1:</p>
<pre>var commentSchema = new Schema({ commentText: 'string' });

var scientistSchema = new Schema({
  comments: [commentSchema]
})
</pre>
<p>Method 2:</p>
<pre>var scientistSchema = new Schema({
  comments: [{ commentText: 'string' }]
})
</pre>
<p>The reference is here:</p>
<ul>
<li><a href="http://mongoosejs.com/docs/subdocs.html#altsyntax">http://mongoosejs.com/docs/subdocs.html#altsyntax</a></li>
</ul>
<p>There are sometimes also called embedded documents:</p>
<ul>
<li><a href="http://mongoosejs.com/docs/subdocs.html">http://mongoosejs.com/docs/subdocs.html</a></li>
</ul>
<p>The docs state: &quot;Sub-documents enjoy all the same features as normal documents. The only difference is that they are not saved individually, they are saved whenever their top-level parent document is saved.&quot;</p>
</div></body></html>