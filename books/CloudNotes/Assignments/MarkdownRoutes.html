<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width initial-scale=1.0"><title>MarkdownRoutes</title><link href="/css/first-style.css" rel="stylesheet"><link rel="shortcut icon" href="/images/favicon.png"><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet"><link href="/css/highlight/googlecode.css" rel="stylesheet" type="text/css"><link href="/css/style.css" rel="stylesheet"><script src="https://code.jquery.com/jquery-1.12.0.min.js"></script><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- Latest compiled and minified CSS --><script src="/js/elven-help.js"></script></head><body><nav class="navbar navbar-inverse"><div class="container"><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/">Elvenware</a></div><div class="navbar-collapse collapse" id="navbar"><ul class="nav navbar-nav"><li class="trigger-collapse" ng-class="{ active: isActive('/')}"><a href="/">Home</a></li><li><a href="/about.html">About</a></li></ul></div></div></nav><div class="container"><figure><img class="elf-normal" alt="Elvenware" src="/images/elvenwarelogo.png"/></figure><h1>MarkdownRoutes</h1><p>Welcome to MarkdownRoutes</p><ul><!--TOC_Start--><li><a href="#week-10-routes-and-markdown">Week 10 Routes and Markdown</a></li>
<li><a href="#step-06-refactor">Step 06: Refactor</a></li><!--TOC_End--></ul></div><div class="container"><a class="anchor" id="week-10-routes-and-markdown"></a>
<h1>Week 10 Routes and Markdown</h1>
<p>The goal here is to:</p>
<ul>
<li>Integrate Markdown into our Main BridgeReader application</li>
<li>Learn about routes and the session object</li>
</ul>
<p>##Step01: Set up Routes and Views</p>
<p>Basic steps to set up routing with <strong>markShow</strong>.</p>
<p>Create <strong>/views/Markdown.jade</strong>. When doing this, be sure, one way or another, that you load <strong>public/stylesheets/markdown.css</strong>. That may involve editing <strong>layout.jade</strong> or creating a <strong>layoutMarkdown.jade</strong>:</p>
<pre><code>extends layout

block <span class="hljs-attribute">content</span>
  h1= title
  <span class="hljs-selector-tag">p</span> Welcome to #{title}

  button<span class="hljs-selector-id">#editLoad</span> Edit Load
  p<span class="hljs-selector-id">#sessionNumber</span>

  div<span class="hljs-selector-id">#markdown</span><span class="hljs-selector-class">.clearfix</span>
    <span class="hljs-selector-tag">div</span><span class="hljs-selector-class">.wmd-panel</span>
      div<span class="hljs-selector-id">#wmd-button-bar-elf</span>
      <span class="hljs-selector-tag">textarea</span>.wmd-input<span class="hljs-selector-id">#wmd-input-elf</span>

    div<span class="hljs-selector-id">#wmd-preview-elf</span><span class="hljs-selector-class">.wmd-panel</span><span class="hljs-selector-class">.wmd-preview</span>
</code></pre><p>Create <strong>/routes/Markdown.js</strong>:</p>
<pre><code><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">var</span> router = express.Router();

<span class="hljs-comment">/* GET home page. */</span>
router.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
  res.render(<span class="hljs-string">'Markdown'</span>, { <span class="hljs-attr">title</span>: <span class="hljs-string">'Markdown'</span> });
});

<span class="hljs-built_in">module</span>.exports = router;
</code></pre><p>##Step02: Set up the Pick Routes and Session</p>
<p>In our app, the user first loads <strong>FileList.json</strong>. In that JSON file are set of files. Some of them have JSON endings and are of type JSON. We already know how to handle them. But what do we do if the user wants to view a <strong>markdown</strong> file?</p>
<p>As you know, there is a problem with viewing markdown files that we don&#39;t have with viewing JSON files. If we want to view JSON files, we do it in plcae. But if we want to edit <strong>markdown</strong> files, then at this time we load a new page. </p>
<p>When the user selects a <strong>markdown</strong> file, we have to load a new page, which means that we will lose our data when we load the new page. The data lost includes the user&#39;s file choice. As a result, we have to save that file choice somewhere before loading the new page. Our solution for now is to save it on the server. We want to send the user&#39;s selected file to the server and have the server hold on to it. </p>
<p>Since multiple people can be signed on to the app at once, on the server side we need to be sure that we save <strong>User01&#39;s</strong> choice in an appropriate place, and not confuse it with the choice made by <strong>User02</strong>. To do this, we use the Express <strong>Session</strong> object.</p>
<p>Here is the first step in adding  in support for sesisons:</p>
<pre><code>npm <span class="hljs-keyword">install</span> express-<span class="hljs-keyword">session</span> <span class="hljs-comment">--save</span>
</code></pre><p>In <strong>app.js</strong> we load the session object:</p>
<pre><code><span class="hljs-keyword">var</span> session = <span class="hljs-keyword">require</span>(<span class="hljs-string">'express-session'</span>);       <span class="hljs-comment">// Place just after body parser</span>
app.<span class="hljs-keyword">use</span>(session({secret: <span class="hljs-string">'stealthy'</span>}));         <span class="hljs-comment">// Place just before use routes</span>
<span class="hljs-keyword">var</span> markdown = <span class="hljs-keyword">require</span>(<span class="hljs-string">"./routes/Markdown"</span>);    <span class="hljs-comment">// Place just before app=express()</span>
app.<span class="hljs-keyword">use</span>(<span class="hljs-string">'/Markdown'</span>, markdown);                 <span class="hljs-comment">// Place just before error handlers</span>
</code></pre><p>In <strong>/routes/index.js</strong> we set up the actual code that will handle the saving and retrieving of the user&#39;s file selection. In this case we are calling the selection his &quot;pick&quot;, since he *picked&quot; a particular markdown file to view. Here is the relevant code:</p>
<pre><code><span class="hljs-comment">// Code omitted here</span>
<span class="hljs-keyword">var</span> internalSessionNumber = <span class="hljs-number">0</span>;  <span class="hljs-comment">// Place near top of file</span>

<span class="hljs-comment">/* GET home page. */</span>
router.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
    response.render(<span class="hljs-string">'index'</span>, { <span class="hljs-attr">title</span> : <span class="hljs-string">'Week08BridgePattern'</span> });
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> request.session.sessionNumber === <span class="hljs-string">'undefined'</span>) {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Session undefined, setting number"</span>);
        request.session.sessionNumber = internalSessionNumber++;
    }
});

router.get(<span class="hljs-string">'/setPick'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"SetPick Query: "</span> + request.query.pick );    
    request.session.pick = request.query.pick;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"SetPick Session: "</span> + <span class="hljs-built_in">JSON</span>.stringify(request.session));
    response.send({<span class="hljs-string">"result"</span>: <span class="hljs-string">"success"</span>, <span class="hljs-string">"sessionNumber"</span>: request.session.sessionNumber});
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Sent message"</span>);
});

router.get(<span class="hljs-string">'/getPick'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"GetPick: "</span> + request.session.sessionNumber);    
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"GetPick Session: "</span> + <span class="hljs-built_in">JSON</span>.stringify(request.session));
    response.send({<span class="hljs-string">"userPick"</span>: request.session.pick, <span class="hljs-string">"sessionNumber"</span>: request.session.sessionNumber})
});
</code></pre><p>Notice that we keep an internal session number. Each user who signs on will get a session number. If you, for instance, open both FireFox and Chromium, then the first browser to access the app will be user01, and the second browser to access to the app will be user02. You can open as many tabs as you want in either browser, and they will all be attached to the same user. It is only when you move to another browser, or another machine, that Express will create a new user.</p>
<p>Note also that our getPick route simply mirrors back the file name sent by the user:</p>
<pre><code><span class="hljs-string">"userPick"</span>: request<span class="hljs-selector-class">.session</span><span class="hljs-selector-class">.pick</span>,
</code></pre><p>Ultimately, We want to do more than this: we want to read the <strong>markdown</strong> file selected by the user and send it back as part of our response. But let&#39;s put that on the back burner for now. Once we have the route set up, then we can focus on actually getting it to do something useful.</p>
<p><strong>NOTE</strong>: <em>If you don&#39;t already have it, you&#39;ll need to add the /read route to routes/index.js</em>:</p>
<pre><code>router.get(<span class="hljs-string">'/read'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'root read called: '</span> + <span class="hljs-built_in">JSON</span>.stringify(request.query));
    <span class="hljs-keyword">var</span> fileName = request.query.fileName;
    fs.readFile(fileName, <span class="hljs-string">'utf8'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, data</span>) </span>{
        <span class="hljs-keyword">if</span> (error) {
            response.send({ <span class="hljs-string">"Could_Not_Find_File"</span>: error, <span class="hljs-attr">fileName</span>: fileName});
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">var</span> jsonObject = <span class="hljs-built_in">JSON</span>.parse(data);
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Sending result"</span>);
            response.send(jsonObject);
        } <span class="hljs-keyword">catch</span>(e) {            
            response.send({ <span class="hljs-string">"error"</span>: <span class="hljs-string">"Could not parse"</span>, <span class="hljs-string">"Could_Not_Parse_JSON"</span>: <span class="hljs-string">"error"</span>});
        };        
    });
});
</code></pre><p>I&#39;ll leave it up to you to setup <strong>require.config</strong> and to copy in:</p>
<ul>
<li>MarkShow</li>
<li>PagedownSetup</li>
<li>Markdown/Converter</li>
<li>Markdown/Editor</li>
</ul>
<p>##Step03: Call getPick and setPick</p>
<p>Now that we have the server set up, the next step is to call <strong>getPick</strong> and <strong>setPick</strong> from the client. To get started, we can create a temporary solution by simply adding a button to our main page that will call a function in <strong>Control.js</strong> that looks like this:</p>
<pre><code><span class="hljs-keyword">var</span> showMarkdown = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    $.getJSON(<span class="hljs-string">'/setPick'</span>, {<span class="hljs-attr">pick</span>: <span class="hljs-string">"public/Test.md"</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">result</span>)</span>{
        <span class="hljs-keyword">if</span> (result.result !== <span class="hljs-string">"success"</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-string">"Error"</span>;
        }
        <span class="hljs-built_in">window</span>.location.href = <span class="hljs-string">'/Markdown'</span>;
    }).error = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">f, a, b</span>) </span>{
        alert(f);
    };
};
</code></pre><p>This function first calls the <strong>setPick</strong> route and then launches the <strong>Markdown</strong> window or tab. The function shown here provides another temporary solution by hard-coding in a file name and passing to to our server side <strong>setPick</strong> route:</p>
<pre><code>{<span class="hljs-attribute">pick</span>: <span class="hljs-string">"public/Test.md"</span>}
</code></pre><p>Later on will figure out how to get the user&#39;s file pick and to pass it into to this function.</p>
<p>###Get Pick in Main</p>
<p>You have seen this code before, but it is important not to foget it. Here is the code in <strong>Main.js</strong> that detects that the user has asked for the <strong>Markdown</strong> file. Note that we make a call to <strong>getPick</strong>. This is the code that retreive&#39;s the user choice from the server:</p>
<pre><code><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">endsWith</span>(<span class="hljs-params">value, suffix</span>) </span>{
    <span class="hljs-keyword">return</span> value.indexOf(suffix, <span class="hljs-keyword">this</span>.length - suffix.length) !== <span class="hljs-number">-1</span>;
}

<span class="hljs-built_in">require</span>([ <span class="hljs-string">'jquery'</span>, <span class="hljs-string">"Control"</span>, <span class="hljs-string">"MarkShow"</span>, <span class="hljs-string">"PubSub"</span> ],
<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">jq, Control, MarkShow, PubSub</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Main called"</span>);

    $(<span class="hljs-built_in">document</span>).ready(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (endsWith(<span class="hljs-built_in">document</span>.URL, <span class="hljs-string">"Markdown"</span>)) {
            <span class="hljs-keyword">var</span> markShow = <span class="hljs-keyword">new</span> MarkShow();
            markShow.getPick();
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">var</span> control = <span class="hljs-keyword">new</span> Control();
        };
    });
});
</code></pre><p>And we also need to be sure we are loading the proper CSS for handling Markdown. This means copying in <strong>markdown.css</strong> from one of our other projects, and somehow adding this line to the HEAD tag in our HTML:</p>
<pre><code>link(<span class="hljs-attribute">rel</span>=<span class="hljs-string">'stylesheet'</span>, <span class="hljs-attribute">href</span>=<span class="hljs-string">'/stylesheets/markdown.css'</span>)
</code></pre><p>To add the tag, we can:</p>
<ul>
<li>create a <strong>LayoutMarkdown.jade</strong> to include in <strong>Markdown.jade</strong></li>
<li>Modify <strong>Markdown.jade</strong> directly,</li>
<li>Or just add it to <strong>layout.jade</strong></li>
</ul>
<p>We also need to copy in <strong>wmd_buttons.png</strong> from one of our earlier projects.</p>
<p>##Step04: Loading a file</p>
<p>Our current implementation of <strong>getPick</strong> simply mirrors back the user&#39;s selected file:</p>
<pre><code>request<span class="hljs-selector-class">.session</span><span class="hljs-selector-class">.pick</span>
</code></pre><p>Let&#39;s rewrite <strong>getPick</strong> so that we can handle a request for a file name, load that file, and send the file&#39;s content back to the client:</p>
<pre><code>router.get(<span class="hljs-string">'/getPick'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"GetPick: "</span> + request.session.sessionNumber);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"GetPick Session: "</span> + <span class="hljs-built_in">JSON</span>.stringify(request.session));
    fs.readFile(request.session.pick, <span class="hljs-string">'utf8'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, markdown</span>) </span>{
        <span class="hljs-keyword">if</span> (error) {
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Sending Error"</span> + error);
            response.send({
                <span class="hljs-string">"Could_Not_Find_File"</span> : error,
                <span class="hljs-attr">fileName</span> : fileName
            });
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Successfully load file, sending response."</span>);
        response.send({
            <span class="hljs-string">"userPick"</span> : request.session.pick,
            <span class="hljs-string">"content"</span> : markdown,
            <span class="hljs-string">"sessionNumber"</span> : request.session.sessionNumber
        })
    });
});
</code></pre><p>The <strong>readFile</strong> call above is divided into two parts:</p>
<ul>
<li>Respond to any possible errors retreiving the file. For instance, respond appropriately if the requested file could not be found. </li>
<li>The second part assumes we succcessful loaded the file from disk. The response is then sent back in a field of our object called <strong>content</strong>.</li>
</ul>
<p>The approach we take here means that no exceptions are thrown even if there is a failure. For instance, in the past we have written code like this:</p>
<pre><code><span class="hljs-keyword">if</span> (<span class="hljs-keyword">error</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">error</span>;
}
</code></pre><p>This is good code, and very helpful during development. But as our application becomes more refined, we want to suppress the error, and instead send back content meaningful to end users. This means you won&#39;t see the exception at the command line, and also that you need to appropriately handle this code on the client side. I do not, in this example, show code for handling the error on the client. You will need to write that yourself. There are other ways to solve this problem, but this is a reasonable approach.</p>
<p>As a reminder, here is the code got <strong>getPick</strong> in <strong>MarkShow</strong>. If you have not already done so, change <strong>PagedownSetup</strong> from this:</p>
<pre><code><span class="hljs-keyword">var</span> editor = <span class="hljs-keyword">new</span> <span class="hljs-type">Markdown</span>.Editor(converter, <span class="hljs-string">"-elf"</span>, options);
editor.run();
<span class="hljs-keyword">return</span> editor.getConverter();
</code></pre><p>To this:</p>
<pre><code><span class="hljs-keyword">var</span> editor = <span class="hljs-keyword">new</span> <span class="hljs-type">Markdown</span>.Editor(converter, <span class="hljs-string">"-elf"</span>, options);
editor.run();
<span class="hljs-keyword">return</span> editor;
</code></pre><pre><code><span class="hljs-comment">// Declaration with object scope. Put at top of MarkShow object.</span>
<span class="hljs-keyword">var</span> inputText; 

<span class="hljs-comment">// In the Constructor:</span>
editor = pagedownSetup.setupConverter(Markdown);
converter = editor.getConverter();
inputText = $(<span class="hljs-string">"#wmd-input-elf"</span>);
inputText.html(<span class="hljs-string">"This is the starter text with tweaked editor.\n\n- A\n- B\n"</span>);

<span class="hljs-comment">// Near the bottom of the file add this method:</span>
MarkShow.prototype.getPick = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
    $.getJSON(<span class="hljs-string">'/getPick'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">result</span>) </span>{
        $(<span class="hljs-string">"#sessionNumber"</span>).html(<span class="hljs-string">"Session: "</span> + result.sessionNumber);
        <span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">JSON</span>.stringify(result));
        inputText.html(result.content);
        editor.refreshPreview();
    });
}
</code></pre><p>##Step05: Get the Picked File</p>
<p>Let&#39;s take a second to do some house keeping. Let&#39;s start by getting the markdown code out of the main folder:</p>
<pre><code>git mv MarkShow<span class="hljs-selector-class">.js</span> Markdown/.
git mv PagedownSetup<span class="hljs-selector-class">.js</span> Markdown/.
</code></pre><p>Don&#39;t forget to make the appropriate changes to <strong>require.config</strong> in <strong>Main.js</strong>.   </p>
<p>Now to get down to business. When the user clicks on an individual line from our <strong>FileList.json</strong>, how do we detect if that line contains a request to load a JSON file or a markdown file? One approach is to see the extension of the file the user loads. To do that, We need a <strong>getExtension</strong> method:</p>
<pre><code>function getExtension(fileName) {
    fileName = fileName.trim();
    <span class="hljs-built_in">var</span> <span class="hljs-built_in">array</span> = fileName.<span class="hljs-built_in">split</span>(<span class="hljs-string">"."</span>);    
    <span class="hljs-keyword">if</span>( <span class="hljs-built_in">array</span>.<span class="hljs-built_in">length</span> === <span class="hljs-number">1</span> || ( <span class="hljs-built_in">array</span>[<span class="hljs-number">0</span>] === <span class="hljs-string">""</span> &amp;&amp; <span class="hljs-built_in">array</span>.<span class="hljs-built_in">length</span> === <span class="hljs-number">2</span> ) ) {
        <span class="hljs-built_in">return</span> <span class="hljs-string">""</span>;
    }
    <span class="hljs-built_in">return</span> <span class="hljs-built_in">array</span>.<span class="hljs-built_in">pop</span>().toLowerCase();
}
</code></pre><p>If you pass in a file name such as <strong>/foo/bar/sble.md</strong>, then this function returns <strong>md</strong>. Let&#39;s move this method into our <strong>Utilities</strong> file.  We will also want to add a few more methods in our Utilities file that make it possible to sort out what to do with the file extension once we have it. Here are the three methods we can add to the file to do the job (actually its two new methods and an updated copy of <strong>setFileName</strong>:</p>
<pre><code>
    getExtension : function(fileName) {
        fileName = fileName.trim();
        var array = fileName.split(<span class="hljs-string">"."</span>);
        <span class="hljs-keyword">if</span> (array.length === <span class="hljs-number">1</span>
                || (array[<span class="hljs-number">0</span>] === <span class="hljs-string">""</span> &amp;&amp; array.length === <span class="hljs-number">2</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
        }
        <span class="hljs-keyword">return</span> array.<span class="hljs-keyword">pop</span>().toLowerCase();
    },

    getObjectType : function(<span class="hljs-keyword">options</span>) {
        <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">options</span>.currentExtension) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'json'</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">options</span>.readers[<span class="hljs-number">0</span>];
            <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">case</span> <span class="hljs-string">'md'</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">options</span>.readers[<span class="hljs-number">1</span>];
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">default</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">options</span>.readers[<span class="hljs-number">0</span>];
        }
    },

    setFileName : function(<span class="hljs-keyword">options</span>, event) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">options</span>.useDefaultFile) {
            <span class="hljs-keyword">options</span>.fileName = <span class="hljs-keyword">options</span>.defaultFileName;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">options</span>.fileName = event.target.attributes.data.value;
        }
        <span class="hljs-keyword">options</span>.currentExtension = <span class="hljs-keyword">this</span>.getExtension(<span class="hljs-keyword">options</span>.fileName);
        <span class="hljs-keyword">options</span>.objectType = <span class="hljs-keyword">this</span>.getObjectType(<span class="hljs-keyword">options</span>);
        <span class="hljs-keyword">return</span> !<span class="hljs-keyword">options</span>.useDefaultFile;
    }
</code></pre><p>With this code we are able to detect that we selected a markdown object, and set up <strong>Control</strong> to automatically ask the <strong>ReaderFactory</strong> to load a markdown file rather than JSON file. We did not have to make any changes to <strong>Control</strong> in order to do this. We did, however, make control ugly earlier in this process, by putting our call to <strong>getJSON</strong> in it. We no longer need that call, or that button that linked to it. Instead, we can add the $.getJson call to our Factory statement for creating the <strong>Markdown</strong> page:</p>
<pre><code>$.getJSON(<span class="hljs-string">'/setPick'</span>, {<span class="hljs-attr">pick</span>: <span class="hljs-string">"public/Test.md"</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">result</span>)</span>{
    <span class="hljs-keyword">if</span> (result.result !== <span class="hljs-string">"success"</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-string">"Error"</span>;
    }
    <span class="hljs-built_in">window</span>.location.href = <span class="hljs-string">'/Markdown'</span>;
}).error = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">f, a, b</span>) </span>{
    alert(f);
};
</code></pre><p>It looks like this:</p>
<pre><code><span class="hljs-comment">/**
 * @author Charlie Calvert
 * @file: ReaderFactory.js
 */</span>

define([ <span class="hljs-string">'DefaultReader'</span>, <span class="hljs-string">'JsonReader'</span>, <span class="hljs-string">"MarkdownReader"</span> ], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">
        DefaultReader, JsonReader, MarkdownReader</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;

    <span class="hljs-keyword">var</span> ReaderFactory = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ReaderFactory</span>(<span class="hljs-params"></span>) </span>{
        }

        ReaderFactory.prototype.product = {};

        <span class="hljs-keyword">var</span> showMarkdown = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        };

        ReaderFactory.prototype.create = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">options</span>) </span>{

            <span class="hljs-keyword">switch</span> (options.objectType) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">"JsonReader"</span>:
                <span class="hljs-keyword">this</span>.product = <span class="hljs-keyword">new</span> JsonReader();
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">"MarkdownReader"</span>:
                $.getJSON(<span class="hljs-string">'/setPick'</span>, {<span class="hljs-attr">pick</span>: <span class="hljs-string">"public/Test.md"</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">result</span>)</span>{
                    <span class="hljs-keyword">if</span> (result.result !== <span class="hljs-string">"success"</span>) {
                        <span class="hljs-keyword">throw</span> <span class="hljs-string">"Error"</span>;
                    }
                    <span class="hljs-built_in">window</span>.location.href = <span class="hljs-string">'/Markdown'</span>;
                }).error = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">f, a, b</span>) </span>{
                    alert(f);
                };        
                <span class="hljs-comment">//this.product = new MarkdownReader();</span>
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">"DefaultReader"</span>:
                <span class="hljs-keyword">this</span>.product = <span class="hljs-keyword">new</span> DefaultReader();
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">this</span>.product = {};
            }

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.product;

        };

        <span class="hljs-keyword">return</span> ReaderFactory;

    }());

    <span class="hljs-keyword">return</span> ReaderFactory;
});
</code></pre><p>This works, and we don&#39;t have to change <strong>Control</strong> at all! It has now been restored to its original state, and looks exactly as it did before we started the integration of the <strong>markdown</strong> project. Our solution is not perfect, but it achieves one of our major goals: We are able to get the functionality we want while keeping our architecture intact. Nothing has changed in <strong>Control.js</strong>, or in the flow of execution in our program. Keeping the core flow of the program unchanged, and easy to understand, is our primary goal, so this solution makes us happy!</p>
<p>I&#39;m not, however, entirely pleased with having the getJSON call inside of the Factory. Is there some other place where it might belong? Well, if we look at the call to <strong>\$.getJSON</strong> we see that it takes a file name. That rings a bell! What about moving it into the <strong>readFile</strong> method of our <strong>MarkdownReader</strong>?</p>
<pre><code><span class="hljs-comment">/**
 * MarkdownReader.js
 */</span>

define(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">require</span>) </span>{<span class="hljs-string">'use strict'</span>;

    <span class="hljs-keyword">var</span> MarkdownReader = ( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">MarkdownReader</span>(<span class="hljs-params"></span>) </span>{

            }

            MarkdownReader.prototype.readFile = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fileName, customCallback</span>) </span>{
                $.getJSON(<span class="hljs-string">'/setPick'</span>, {<span class="hljs-attr">pick</span>: fileName}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">result</span>)</span>{
                    <span class="hljs-keyword">if</span> (result.result !== <span class="hljs-string">"success"</span>) {
                        <span class="hljs-keyword">throw</span> <span class="hljs-string">"Error"</span>;
                    }
                    <span class="hljs-built_in">window</span>.location.href = <span class="hljs-string">'/Markdown'</span>;
                }).error = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">f, a, b</span>) </span>{
                    alert(f);
                };        
            };

            MarkdownReader.prototype.display = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{                
                <span class="hljs-keyword">var</span> text = <span class="hljs-built_in">JSON</span>.stringify(data, <span class="hljs-literal">null</span>, <span class="hljs-number">4</span>);
                $(<span class="hljs-string">"#display"</span>).text(text);
            };

            <span class="hljs-keyword">return</span> MarkdownReader;
        }());

    <span class="hljs-keyword">return</span> MarkdownReader;
});
</code></pre><p>Oh my gosh! That just worked. We only had to make one change. We started with this:</p>
<pre><code>$.getJSON(<span class="hljs-string">'/setPick'</span>, {<span class="hljs-attr">pick</span>: <span class="hljs-string">"public/Test.md"</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">result</span>)</span>{
</code></pre><p>We deleted the hardcoded file name, and used the <strong>fileName</strong> passed into <strong>readFile</strong>. </p>
<pre><code>$.getJSON(<span class="hljs-string">'/setPick'</span>, {<span class="hljs-attr">pick</span>: fileName}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">result</span>)</span>{
</code></pre><p>This is obviously much more flexible, and in fact solves three problems at once: </p>
<ul>
<li>It allows us to pass in a custom file name</li>
<li>It allows us us to keep the exact same code and architecture in <strong>Control.js</strong>. The point being that <strong>Control</strong> was already passing in the file name to <strong>readFile</strong>. </li>
<li>It cleans up <strong>ReaderFactory</strong>, like this:</li>
</ul>
<pre><code><span class="hljs-comment">/**
 * @file: ReaderFactory.js
 * @author Charlie Calvert
 */</span>

define([ <span class="hljs-string">'DefaultReader'</span>, <span class="hljs-string">'JsonReader'</span>, <span class="hljs-string">"MarkdownReader"</span> ], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">
        DefaultReader, JsonReader, MarkdownReader</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;

    <span class="hljs-keyword">var</span> ReaderFactory = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ReaderFactory</span>(<span class="hljs-params"></span>) </span>{
        }

        ReaderFactory.prototype.product = {};

        <span class="hljs-keyword">var</span> showMarkdown = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        };

        ReaderFactory.prototype.create = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">options</span>) </span>{

            <span class="hljs-keyword">switch</span> (options.objectType) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">"JsonReader"</span>:
                <span class="hljs-keyword">this</span>.product = <span class="hljs-keyword">new</span> JsonReader();
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">"MarkdownReader"</span>:
                <span class="hljs-keyword">this</span>.product = <span class="hljs-keyword">new</span> MarkdownReader();
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">"DefaultReader"</span>:
                <span class="hljs-keyword">this</span>.product = <span class="hljs-keyword">new</span> DefaultReader();
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">this</span>.product = {};
            }

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.product;

        };

        <span class="hljs-keyword">return</span> ReaderFactory;

    }());

    <span class="hljs-keyword">return</span> ReaderFactory;
});
</code></pre><p>I don&#39;t want to sound like a broken record, but it is impossible to emphasize too much how important it is to find the right architecture, and to create simple, clean objects like our revised <strong>ReaderFactory.js</strong>. It was painful to stick the call <strong>\$.getJSON</strong> in there, because it made the code messy and hard to read. Now we have restored the object to a clean state, and it will be much easier to maintain.</p>
<p><strong>TIP</strong>: <em>Often, the mark of a good programmer is simply the ability to see how to simplify code so it is easy to understand. The great irony is that the less skill we have as a programmer, the more need we have to work with well architected code, and the harder it is for us to find the a good architecture. Patterns are designed to help use find that right architecture. We just keep searching and searching through our patterns until at once: Click: everything fits into place. Of course, it takes time and patience to do things right. Good programmers succeed because they are willing to slow down and find the right design.</em></p>
<a class="anchor" id="step-06-refactor"></a>
<h2>Step 06: Refactor</h2>
<p>At this stage, things are starting to work. The user can click on a markdown file from <strong>FileList.json</strong> and we can respond by loading the file in our markdown editor. As always, when things start to work, the next step is to <strong>refactor</strong>.</p>
<p><strong>TIP</strong>: <em>Just because you code is working that does not mean you are done. In general, it is rarely even half way to being done. You must refactor your code and make it elegant and easy to use. If you skip this step, you are toast. Developers sometimes say that they don&#39;t want to take the time to refactor or write unit tests when they are &quot;in the flow&quot;. I understand. But afterwards, once you get things working, then double back and make it right! Frankly, I find the act of discovering the right architecture, or refactoring my code, one of the most interesting and exciting parts of writing code.</em> </p>
<p>You recall that we had <strong>setFileName</strong> in the <strong>Utilities</strong> object. As code was added to make it powerful enough to handle extension detection, it grew in size, and finally had three methods involved. It was clear that that these three methods belonged together, so I made them a sub-object of Utilities:</p>
<pre><code>define(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">require</span>) </span>{

    <span class="hljs-keyword">var</span> utilities = {

        <span class="hljs-attr">errorHandler</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fx, status, error</span>) </span>{
            $(<span class="hljs-string">'#debug01'</span>).html(fx.responseText);
            $(<span class="hljs-string">'#debug02'</span>).html(<span class="hljs-string">'error'</span> + error);
        },

        <span class="hljs-attr">isTruthy</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
            <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">false</span>) {
                <span class="hljs-keyword">return</span> value;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'undefined'</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
        },

        <span class="hljs-attr">isFalsy</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.isTruthy(value) ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>;
        },

        <span class="hljs-attr">displayOptions</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">options</span>) </span>{
            $(<span class="hljs-string">'#debug01'</span>).html(<span class="hljs-string">"Type: "</span> + options.objectType)
            $(<span class="hljs-string">'#debug02'</span>).html(<span class="hljs-string">"File: "</span> + options.fileName);
        },

        <span class="hljs-attr">setClick</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">func</span>) </span>{
            $(<span class="hljs-string">"#displayList"</span>).off(<span class="hljs-string">'click'</span>);
            $(<span class="hljs-string">"#displayList"</span>).click(func);
        },

        <span class="hljs-attr">fileTypeSorter</span> : {
            <span class="hljs-attr">getExtension</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fileName</span>) </span>{
                fileName = fileName.trim();
                <span class="hljs-keyword">var</span> array = fileName.split(<span class="hljs-string">"."</span>);
                <span class="hljs-keyword">if</span> (array.length === <span class="hljs-number">1</span>
                        || (array[<span class="hljs-number">0</span>] === <span class="hljs-string">""</span> &amp;&amp; array.length === <span class="hljs-number">2</span>)) {
                    <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
                }
                <span class="hljs-keyword">return</span> array.pop().toLowerCase();
            },

            <span class="hljs-attr">getObjectType</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">options</span>) </span>{
                <span class="hljs-keyword">switch</span> (options.currentExtension) {
                <span class="hljs-keyword">case</span> <span class="hljs-string">'json'</span>:
                    <span class="hljs-keyword">return</span> options.readers[<span class="hljs-number">0</span>];
                    <span class="hljs-keyword">break</span>
                <span class="hljs-keyword">case</span> <span class="hljs-string">'md'</span>:
                    <span class="hljs-keyword">return</span> options.readers[<span class="hljs-number">1</span>];
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">default</span>:
                    <span class="hljs-keyword">return</span> options.readers[<span class="hljs-number">0</span>];
                }
            },

            <span class="hljs-attr">setFileName</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">options, event</span>) </span>{
                <span class="hljs-keyword">if</span> (options.useDefaultFile) {
                    options.fileName = options.defaultFileName;
                } <span class="hljs-keyword">else</span> {
                    options.fileName = event.target.attributes.data.value;
                }
                options.currentExtension = <span class="hljs-keyword">this</span>.getExtension(options.fileName);
                options.objectType = <span class="hljs-keyword">this</span>.getObjectType(options);
                <span class="hljs-keyword">return</span> !options.useDefaultFile;
            }
        }
    }

    <span class="hljs-keyword">return</span> utilities;

});
</code></pre><p>I created the <strong>fileTypeSorter</strong> inside of <strong>Utilities</strong> simply because it was convenient. I didn&#39;t want to take time to create a new object when I still couldn&#39;t see the exact shape of what I was creating, and while my attention was focused elsewhere. But once the code settled down, it was time to refactor, and the first step was to move <strong>fileTypeSorter</strong> into its own module:</p>
<pre><code><span class="hljs-comment">/**
 * FileTypeSorter
 */</span>

define(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">var</span> FileTypeSorter = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">FileTypeSorter</span><span class="hljs-params">()</span> </span>{

        }

        <span class="hljs-keyword">var</span> getExtension = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(fileName)</span> </span>{
            fileName = fileName.trim();
            <span class="hljs-keyword">var</span> <span class="hljs-keyword">array</span> = fileName.split(<span class="hljs-string">"."</span>);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">array</span>.length === <span class="hljs-number">1</span> || (<span class="hljs-keyword">array</span>[<span class="hljs-number">0</span>] === <span class="hljs-string">""</span> &amp;&amp; <span class="hljs-keyword">array</span>.length === <span class="hljs-number">2</span>)) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
            }
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">array</span>.pop().toLowerCase();
        };

        <span class="hljs-keyword">var</span> getObjectType = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
            <span class="hljs-keyword">switch</span> (options.currentExtension) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">'json'</span>:
                <span class="hljs-keyword">return</span> options.readers[<span class="hljs-number">0</span>];
                <span class="hljs-keyword">break</span>
            <span class="hljs-keyword">case</span> <span class="hljs-string">'md'</span>:
                <span class="hljs-keyword">return</span> options.readers[<span class="hljs-number">1</span>];
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">return</span> options.readers[<span class="hljs-number">0</span>];
            }
        };

        FileTypeSorter.prototype.setFileName = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options, event)</span> </span>{
            <span class="hljs-keyword">if</span> (options.useDefaultFile) {
                options.fileName = options.defaultFileName;
            } <span class="hljs-keyword">else</span> {
                options.fileName = event.target.attributes.data.value;
            }
            options.currentExtension = getExtension(options.fileName);
            options.objectType = getObjectType(options);
            <span class="hljs-keyword">return</span> !options.useDefaultFile;
        };

        <span class="hljs-keyword">return</span> FileTypeSorter;
    }());

    <span class="hljs-keyword">return</span> FileTypeSorter;
});
</code></pre><p>As you can see, the object has been made ready for require, and wrapped in the modular pattern. Unfortunately, this does force us to make changes to <strong>Control.js</strong>:</p>
<pre><code><span class="hljs-comment">/**
 * @file: Control.js
 */</span>

define([ <span class="hljs-string">"ReaderFactory"</span>, <span class="hljs-string">"BridgeFactory"</span>, <span class="hljs-string">"FileTypeSorter"</span>, <span class="hljs-string">"Utilities"</span>, <span class="hljs-string">"TinyPubSub"</span> ], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">
        ReaderFactory, BridgeFactory, FileTypeSorter, utilities, tps</span>) </span>{

    <span class="hljs-keyword">var</span> Control = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">var</span> fancyReader = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">var</span> factory = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">var</span> fileTypeSorter = <span class="hljs-literal">null</span>;

        <span class="hljs-keyword">var</span> options = {
            <span class="hljs-attr">defaultFileName</span> : <span class="hljs-string">"public/FileList.json"</span>,
            <span class="hljs-attr">useDefaultFile</span> : <span class="hljs-literal">true</span>,
        };
        options.readers = [ <span class="hljs-string">"JsonReader"</span>, <span class="hljs-string">"MarkdownReader"</span> ];
        options.objectType = options.readers[<span class="hljs-number">0</span>];
        options.fileName = options.defaultFileName;

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Control</span>(<span class="hljs-params"></span>) </span>{
            factory = <span class="hljs-keyword">new</span> ReaderFactory();
            fancyReader = <span class="hljs-keyword">new</span> BridgeFactory().create({ <span class="hljs-attr">objectType</span> : <span class="hljs-string">"FancyReaderBridge"</span> });
            fileTypeSorter = <span class="hljs-keyword">new</span> FileTypeSorter();
            $.subscribe(<span class="hljs-string">'pageRefresh'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ $(<span class="hljs-string">"li"</span>).click(run); });            
            run();
        }

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">runReader</span>(<span class="hljs-params">options</span>) </span>{
            utilities.displayOptions(options);
            <span class="hljs-keyword">var</span> reader = factory.create(options);
            fancyReader.setReader(reader);
            fancyReader.readFile(options.fileName);
        }

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params">event</span>) </span>{
            options.useDefaultFile = fileTypeSorter.setFileName(options, event);
            runReader(options);
        }

        <span class="hljs-keyword">return</span> Control;

    }())

    <span class="hljs-keyword">return</span> Control;
})
</code></pre><p>The change is the declaration and initialization of FileTypeSorter:</p>
<pre><code><span class="hljs-attribute">var fileTypeSorter</span> = null;
<span class="hljs-attribute">fileTypeSorter</span> = new FileTypeSorter();
</code></pre><p>It pains me to do this. Perhaps we could have left <strong>FileTypeSorter</strong> a plain old JavaScript object, like the one in <strong>Utilities</strong>, but I felt like it was best to apply the <strong>modular</strong> pattern, and that meant we had to go through object initialization, as shown above. It is, however, a close call, and perhaps it is not work the candle.</p>
<p>At this stage we might also note that the <strong>javascripts</strong> directory is becoming a bit crowded:</p>
<pre><code>stat --<span class="hljs-built_in">printf</span>=<span class="hljs-string">"%n:\t\t %F\n"</span> *
Bridge<span class="hljs-variable">s:</span>            directory

Display:            directory
Factorie<span class="hljs-variable">s:</span>            directory
Markdown:            directory
Reader<span class="hljs-variable">s:</span>            directory
Control.<span class="hljs-keyword">j</span><span class="hljs-variable">s:</span>            regular <span class="hljs-keyword">file</span>
FileTypeSorter.<span class="hljs-keyword">j</span><span class="hljs-variable">s:</span>    regular <span class="hljs-keyword">file</span>
jquery-<span class="hljs-number">2.1</span>.<span class="hljs-number">1</span>.<span class="hljs-keyword">j</span><span class="hljs-variable">s:</span>    regular <span class="hljs-keyword">file</span>
Main.<span class="hljs-keyword">j</span><span class="hljs-variable">s:</span>            regular <span class="hljs-keyword">file</span>
require.<span class="hljs-keyword">j</span><span class="hljs-variable">s:</span>            regular <span class="hljs-keyword">file</span>
TinyPubSub.<span class="hljs-keyword">j</span><span class="hljs-variable">s:</span>      regular <span class="hljs-keyword">file</span>
Utilities.<span class="hljs-keyword">j</span><span class="hljs-variable">s:</span>        regular <span class="hljs-keyword">file</span>
</code></pre><p>Let&#39;s focus just on the JavaScript files:</p>
<pre><code>Control<span class="hljs-selector-class">.js</span>
FileTypeSorter<span class="hljs-selector-class">.js</span>
jquery-<span class="hljs-number">2.1</span>.<span class="hljs-number">1</span><span class="hljs-selector-class">.js</span>
Main<span class="hljs-selector-class">.js</span>
require<span class="hljs-selector-class">.js</span>
TinyPubSub<span class="hljs-selector-class">.js</span>
Utilities.js
</code></pre><p>It seems to me that several of these files are not part of the core of our application, and deserve to be pushed to another folder. Let&#39;s move <strong>FileTypeSorter</strong>, <strong>TinyPubSub</strong> and <strong>Utiilties</strong> into a <strong>Utility</strong> folder:</p>
<pre><code>Bridges:         <span class="hljs-built_in">directory</span>
Display:         <span class="hljs-built_in">directory</span>
Factories:         <span class="hljs-built_in">directory</span>
Markdown:         <span class="hljs-built_in">directory</span>
Readers:         <span class="hljs-built_in">directory</span>
Utility:         <span class="hljs-built_in">directory</span>
Control.js:         regular <span class="hljs-built_in">file</span>
Main.js:         regular <span class="hljs-built_in">file</span>
jquery<span class="hljs-number">-2.1</span><span class="hljs-number">.1</span>.js: regular <span class="hljs-built_in">file</span>
<span class="hljs-built_in">require</span>.js:         regular <span class="hljs-built_in">file</span>
</code></pre><p>Now things are neater, and easier to understand. The core files, Main and Control, are easily visible in the root. Everyone will immmediately know how to get started working on this project.</p>
<p><strong>TIP</strong>: <em>If you want to make your code easy to maintain and easy to understand, you simply have to take for these kinds of refactorings. The point, of course, is that this kind of refactoring only takes a few minutes out of your current day, but can save you hours in the long run. Our code has to be well factored if we hope to deal with the complexity inherent in any large application.</em></p>
<p><strong>NOTE</strong>: <em>Sometiems other libraries that are obviously very well written do not seem as carefully factored as our code. Please note that the developers who create these libraries are brilliant and don&#39;t need the support that we need. But sometimes, these developers actually do write code the same way we do, then create one large file from their many files just before shipping. That way users of their library need only download a single file, rather than many small files. At the same time, they may strip out unnecessary syntax that makes their code safer while testing, but that just takes up space in a shipping product. In general, if you work for a large corporation, they want you to produce code that works much more than they want you to find ways to shave milliseconds off the load time. Much of what we do in this class is aimed at helping you create working code. Believe me, you, your team and your manager will be much happier with working code that takes 1 second to execute than with broken code that executes in four fifths of a second.</em></p>
<p>##Step 07: Turn it in</p>
<p>Place your work in your repository in a folder called Week010MarkdownRoutes. Push it. Go to your remote AWS instance, then:</p>
<ul>
<li>cd to your folder</li>
<li>npm install</li>
<li>npm start</li>
</ul>
<p>Turn in a URL pointing at your running code: http://<ELASTIC-IP>:30025</p>
</div></body></html>