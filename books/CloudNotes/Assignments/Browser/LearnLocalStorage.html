<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width initial-scale=1.0"><title>LearnLocalStorage</title><link href="/css/first-style.css" rel="stylesheet"><link rel="shortcut icon" href="/images/favicon.png"><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet"><link href="/css/highlight/googlecode.css" rel="stylesheet" type="text/css"><link href="/css/style.css" rel="stylesheet"><script src="https://code.jquery.com/jquery-1.12.0.min.js"></script><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- Latest compiled and minified CSS --><script src="/js/elven-help.js"></script></head><body><nav class="navbar navbar-inverse"><div class="container"><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/">Elvenware</a></div><div class="navbar-collapse collapse" id="navbar"><ul class="nav navbar-nav"><li class="trigger-collapse" ng-class="{ active: isActive('/')}"><a href="/">Home</a></li><li><a href="/about.html">About</a></li></ul></div></div></nav><div class="container"><figure><img class="elf-normal" alt="Elvenware" src="/images/elvenwarelogo.png"/></figure><h1>LearnLocalStorage</h1><p>Welcome to LearnLocalStorage</p><ul><!--TOC_Start--><li><a href="#learn-local-storage">Learn Local Storage</a></li>
<li><a href="#elf-logger">Elf Logger</a></li>
<li><a href="#simple-object">Elf Local Storage</a></li>
<li><a href="#create-json">Create JSON File</a></li>
<li><a href="#load-json">Load JSON</a></li>
<li><a href="#load-after-mounting">Load After Mounting</a></li>
<li><a href="#double-check">Double Check</a></li>
<li><a href="#links">Links</a></li><!--TOC_End--></ul></div><div class="container"><a class="anchor" id="learn-local-storage"></a>
<h1>Learn Local Storage</h1>
<p>Learn about local storage in the browser.</p>
<ul>
<li>Insert 100 records with format elfXXXX</li>
<li>Insert <strong>elven-count</strong></li>
<li>Insert <strong>elven-store</strong></li>
<li>Load Data from Local Storage once Component is mounted</li>
</ul>
<a class="anchor" id="elf-logger"></a>
<h2>Elf Logger</h2>
<p>We need to be able to turn logging on and off as needed. One way to do it is to set it by module. If we set a particular environment variable to the name of a module, then the debug statements for that module will be visible.</p>
<p>The docs for <strong>ElfLogger</strong> are here: <a href="http://bit.ly/elven-utils">http://bit.ly/elven-utils</a></p>
<p>The source for <strong>ElfLogger</strong> is available as a gist: <a href="http://bit.ly/elf-logger">http://bit.ly/elf-logger</a></p>
<p>The source for <strong>ElfDebugEnzyme</strong> as a gist: <a href="http://bit.ly/elf-debug-enzyme">http://bit.ly/elf-debug-enzyme</a></p>
<a class="anchor" id="simple-object"></a>
<h2>Elf Local Storage</h2>
<p>Save this as <strong>assets/elf-local-storage</strong>:</p>
<pre>const ELF_TAG = 'elf';

const padNumber = function(numberToPad, width, padValue) {
    padValue = padValue || '0';
    numberToPad += '';
    if (numberToPad.length >= width) {
        return numberToPad;
    } else {
        return new Array(width - numberToPad.length + 1).join(padValue) + numberToPad;
    }
};

function saveByIndex(item, index) {
    if (typeof item === 'object') {
        item = JSON.stringify(item, null, 4);
    }
    const key = ELF_TAG + padNumber(index, 4, 0);
    localStorage.setItem(key, item);
}

function getByIndex(index) {
    const key = ELF_TAG + padNumber(index, 4, 0);
    return JSON.parse(localStorage.getItem(key));
}

function removeElfKeys() {
    for (var key in localStorage) {
        if (key.startsWith(ELF_TAG)) {
            localStorage.removeItem(key);
        }
    }
}

function clearLocalStorage() {
    localStorage.clear();
}

export {saveByIndex, getByIndex, removeElfKeys, clearLocalStorage};
</pre>
<p>Use it like this:</p>
<pre>import { getByIndex } from '../assets/elf-local-storage';
</pre>
<p>Since the above could get out of data. I will try to maintain it here:</p>
<ul>
<li><a href="https://gist.github.com/charliecalvert/d8404b826ee22702c501368335624622">Elf Local Storage</a></li>
</ul>
<a class="anchor" id="create-json"></a>
<h2>Create JSON File</h2>
<p>We want to create a valid JSON file containing an array of address objects that we can use in our program. One approach would to copy your array of addresses from <strong>address-list.js</strong> to <strong>public/address-list.json</strong>. The code you put in the their should pass <a href="https://jsonlint.com/">json-lint</a>.</p>
<p>A better way to handle this problem would to modify your <a href="http://www.ccalvert.net/books/CloudNotes/Assignments/React/ReactGetAddress.html">getAddress.js</a> code slightly so that it produces valid JSON. You need to modify the code inside your <strong>for loop</strong>.</p>
<ul>
<li>Begin by outputting not just a curly brace, but an open square brance and then an open curley brace.</li>
<li>Ensure you have double quotes around the property names, as this is part of the JSON spec.</li>
<li>At the end of the file, insert a close curly brace and a close square bracket.</li>
</ul>
<p>Some sample code to put in your version of <strong>get-address</strong> is shown here:</p>
<pre>// console.log('{');  <=== COMMENT IT OUT AND REPLACE IT WITH THESE TWO LINES
const open = (i === 0) ? '[\n\t{' : '\t{';
console.log(open);

// PUT DOUBLE QUOTES AROUND YOUR PROPERTY NAMES
writeIt('"firstName":', json.objects[i].person.firstname);

// AND SO ON

// console.log('},'); <=== COMMENT IT OUT AND REPLACE IT WITH THESE TWO LINES
const close = i < jsonLength - 1 ? '\t},' : '\t}\n]';
console.log(close);
</pre>
<p>The open lines start the array and the closing lines close the array. Note that <strong>firstName</strong> is written to be surrounded in double quotes, which satisfies the JSON spec. See the three samples below to better understand the use of double quotes for the property name (key) in a JSON file:</p>
<pre>// Valid JSON
{
  "foo": "bar"
}

// Invalid JSON because there are no quotes around key
{
  foo: "bar"
}

// Invalid JSON because of single quotes around key and value
{
  'foo': 'bar'
}
</pre>
<a class="anchor" id="load-json"></a>
<h2>Load JSON</h2>
<p>We can use a method called <strong>fetch</strong> to retrieve data from the server. In particular, we want to load our addresses in JSON format.</p>
<p><strong>NOTE</strong>: <em>Why are we doing this? What&#39;s wrong with the method we have been using to load the addresses? There is nothing serious wrong with it, but we want to take a half-step toward the time when we load our addresses from a server side databases. The code we will use to load the addresses from a JSON file stored on the server is similar to the code we will use to load JSON from a database. Also, we currently always have the addresses in memory from the moment we launch. We want to have the option of loading the addresses from the server or reading them from local storage. Again, this will only really make sense once we have the option of loading the data from a database.</em></p>
<p>Someday <strong>fetch</strong> will be probably be part of standard JavaScript. For now, we use an NPM package:</p>
<pre>npm install --save whatwg-fetch
</pre>
<p>Then at the top of <strong>Address.js</strong>:</p>
<pre>import 'whatwg-fetch';
</pre>
<p>Now we are ready to load our JavaScript with fetch and promises:</p>
<pre>fetch('./addresses.json').then(function(data) {
   const addresses = data.json();
   console.log(addresses);
   return addresses;
}).then(function (data) {
   console.log(JSON.stringify(data, null, 4));
   that.addresses = data;
   that.setLocalStorage();
}).catch(function (err) {
   logger.log(err);
})
</pre>
<p>For example:</p>
<pre>/**
 * Created by Charlie Calvert on 5/10/17.
 *
 * Use it like this:
 *
 *   import DataLoader from '../assets/DataLoader';
 *   const dataLoader = new DataLoader();
 */

import Logger from './ElfLogger';
const logger = new Logger('data-loader', 'yellow', 'green', '18px');
import { saveByIndex } from '../assets/elf-local-storage';

export default class DataLoader {

    constructor() {
        this.STORE_SET = ['elven-store', 'set', 'elven-count'];
        this.loadAddresses = this.loadAddresses.bind(this);
    }

    dataLoaded() {
        const elfStore = localStorage.getItem(this.STORE_SET[0]);
        return (elfStore === this.STORE_SET[1]);
    }

    setLocalStorage(addresses) {
        logger.log('SET LOCAL', addresses);
        localStorage.setItem(this.STORE_SET[0], this.STORE_SET[1]);
        localStorage.setItem(this.STORE_SET[2], addresses.length);
        addresses.forEach(function(address, index) {
            saveByIndex(address, index);
        });
        return addresses;
    }

    loadAddresses(callback) {
        const that = this;
        if (this.dataLoaded()) {
            logger.log('Using data from localstore');
            callback(localStorage.getItem(this.STORE_SET[2]));
        } else {
            logger.log('Loading data');
            fetch('./address-list.json').then(function(data) {
                //const addresses = data.json();
                //console.log(addresses);
                return data.json(); //addresses;
            }).then(function(data) {
                logger.log(JSON.stringify(data, null, 4));
                //console.log(that);
                that.setLocalStorage(data);
                callback(data.length);
            }).catch(function (err) {
                logger.log(err);
            });
        }
    }

}
</pre>
<p>Since the above code could get out of data, I will try to maintain it here:</p>
<ul>
<li><a href="https://gist.github.com/charliecalvert/d9fc57f29e16de8970b88a3c89b9b410">DataLoader</a></li>
</ul>
<a class="anchor" id="load-after-mounting"></a>
<h2>Load After Mounting</h2>
<p>We can&#39;t really load properly in the constructor because we have a callback and need to setState after we are done. So do it in <strong>componentDidMount</strong>:</p>
<pre>componentDidMount() {
    logger.log('DID MOUNT');
    const that = this;
    dataLoader.loadAddresses(function(addressCount) {
        if (!addressCount) {
            throw new Error('Cannot get address count in address.js');
        }
        that.addressCount = addressCount;
        logger.log('LOADED ADDRESS');
        const address = getByIndex(that.addressIndex);
        that.setState({
            address: address
        });
    });
}
</pre>
<a class="anchor" id="double-check"></a>
<h2>Double Check</h2>
<p>Do this to ensure your code is working:</p>
<ul>
<li>Load the Chrome Dev Tools</li>
<li>Go to the <strong>Application</strong> page in the Dev Tools</li>
<li>Select <strong>Clear Storage</strong></li>
<li>Select only <strong>Local and session storage</strong></li>
<li>Press <strong>Clear selected</strong></li>
<li>Look at <strong>Local Storage | <a href="http://localhost:3000">http://localhost:3000</a></strong></li>
</ul>
<p>Then make sure that <strong>localStorage</strong> gets properly initialized after you refresh your home page. In other words, you should see <strong>localStorage</strong> filled up with at least 100 addresses when you refresh your home page.</p>
<a class="anchor" id="links"></a>
<h2>Links</h2>
<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API">IndexedDb API</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API">WebStorage (localStorage) API</a></li>
<li><a href="https://localforage.github.io/localForage/">LocalForage is like LocalStorage but saves to IndexedDB</a></li>
<li><a href="https://github.com/localForage/localForage">LocalForage on GitHub shows it is popular</a></li>
<li><a href="https://pouchdb.com/">PouchDB is another IndexedDB front end, like CouchDb</a></li>
<li><a href="https://gonehybrid.com/how-to-use-pouchdb-sqlite-for-local-storage-in-your-ionic-app/">PouchDb + SqlLite</a></li>
<li><a href="http://dexie.org/">Dexie is nother front end for IndexedDB</a></li>
<li><a href="https://github.com/dfahlander/Dexie.js">Dexie on GidHub shows modest popularity</a></li>
<li><a href="https://github.com/erikolson186/zangodb">ZangoDb is not very popular</a></li>
</ul>
</div></body></html>