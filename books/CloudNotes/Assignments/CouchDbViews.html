<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width initial-scale=1.0"><title>CouchDbViews</title><link href="/css/first-style.css" rel="stylesheet"><link rel="shortcut icon" href="/images/favicon.png"><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet"><link href="/css/highlight/googlecode.css" rel="stylesheet" type="text/css"><link href="/css/style.css" rel="stylesheet"><script src="https://code.jquery.com/jquery-1.12.0.min.js"></script><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- Latest compiled and minified CSS --><script src="/js/elven-help.js"></script></head><body><nav class="navbar navbar-inverse"><div class="container"><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/">Elvenware</a></div><div class="navbar-collapse collapse" id="navbar"><ul class="nav navbar-nav"><li class="trigger-collapse" ng-class="{ active: isActive('/')}"><a href="/">Home</a></li><li><a href="/about.html">About</a></li></ul></div></div></nav><div class="container"><figure><img class="elf-normal" alt="Elvenware" src="/images/elvenwarelogo.png"/></figure><h1>CouchDbViews</h1><p>Welcome to CouchDbViews</p><ul><!--TOC_Start--><li><a href="#overview">Overview</a></li>
<li><a href="#get-started">Get Started</a></li>
<li><a href="#packages-and-globals">Packages and Globals</a></li>
<li><a href="#crud-like">Almost CRUD: Create, Read, Delete</a></li>
<li><a href="#creating-views">Creating Views</a></li>
<li><a href="#create-bash-menu">Create Bash Menu</a></li>
<li><a href="#turn-it-in">Turn it in</a></li><!--TOC_End--></ul></div><div class="container"><a class="anchor" id="overview"></a>
<h2>Overview</h2>
<ul>
<li><a href="http://www.ccalvert.net/database/CouchDb.html">CouchDb Elvenware</a></li>
<li><a href="http://couchdb.apache.org/">CouchDb</a></li>
</ul>
<a class="anchor" id="get-started"></a>
<h2>Get Started</h2>
<p>Create a folder in your repository called <strong>Week03-CouchDbViews</strong>. Use your common sense about the number of the current week if the number you see does not make sense.</p>
<p>In that folder, create a <strong>package.json</strong> that looks like this:</p>
<pre>{
  "name": "CouchDbViews",
  "description": "Learn about CouchDb Views",
  "version": "0.0.2",
  "private": true,
  "scripts": {
    "start": "node server.js"
  },
  "dependencies": {
    "inquirer": "^1.2.1",
    "nano": "^6.1.2",
    "request-debug": "^0.2.0"
  }
}
</pre>
<p>Run <strong>npm install</strong>.</p>
<p>Then create a file called <strong>server.js</strong> and put the code shown in the rest of this document into it. I believe I am presenting the code sequentially, so you can just start at the top and paste in each section one at a time.</p>
<a class="anchor" id="packages-and-globals"></a>
<h2>Packages and Globals</h2>
<p>Load packages and declare some constants or variables used in the rest of the program.</p>
<pre>var nano = require('nano')('http://192.168.2.23:5984');
var inquirer = require("inquirer");

var dbName = 'bc_data';
var RASPBERRY_PI = "raspberry pi";
var ARDUINO = "arduino";
var BEAGLEBONE = "beaglebone";
</pre>
<p>Right now these are becoming global variables, but in a later session we will reduce their scope.</p>
<p>As you can see, our database involves some of the small, cheap motherboards that you can buy for less than $100.</p>
<a class="anchor" id="crud-like"></a>
<h2>Almost CRUD: Create, Read, Delete</h2>
<p>Here are functions for creating the database, and then creating, inserting and deleting documents. We don&#39;t yet have the ability to update an existing record, but we can delete a document and replace it with a new one, which can be similar in effect. For now, we will only be deleting the design document, which is described below.</p>
<pre>var readIt = function(docName) {
    'use strict';
    var db = nano.db.use(dbName);
    db.get(docName, {
        revs_info: true
    }, function(err, body) {
        if (err) {
            throw err;
        }
        console.log(body);
    });
};

function insert(data) {
    'use strict';
    var callback = function(err, body) {
        if (err) {
            throw err;
        }
        console.log(body);
        readIt();
    };
    nano.db.create(dbName);
    var prog = nano.db.use(dbName);

    for (var i = 0; i < data.length; i++) {
        prog.insert(data[i], callback);
    }
}

function deleteDoc(docUniqueId) {
    'use strict';
    var db = nano.db.use(dbName);
    db.get(docUniqueId, function(err, body) {
        if (err) {
            throw err;
        }
        var latestRev = body._rev;
        db.destroy(docUniqueId, latestRev, function(err, body, header) {
            if (err) {
                throw err;
            }
            console.log('Successfully deleted doc', docUniqueId);
        });
    });
}

function coreDataInsert() {
    var data = [{
            "_id": RASPBERRY_PI,
            "item": RASPBERRY_PI,
            "urls": {
                "Amazon": "https://www.amazon.com/Raspberry-Pi-RASP-PI-3-Model-Motherboard/dp/B01CD5VC92/",                
                "Home": "https://www.raspberrypi.org/",
                "Wiki:": "https://en.wikipedia.org/wiki/Raspberry_Pi"
            }
        },

        {
            "_id": ARDUINO,
            "item": ARDUINO,
            "urls": {
                "Amazon": "https://www.amazon.com/Arduino-Uno-R3-Microcontroller-A000066/dp/B008GRTSV6/",
                "Home": "https://www.arduino.cc/",
                "Wiki:": "https://en.wikipedia.org/wiki/Arduino"
            }
        }, {
            "_id": BEAGLEBONE,
            "item": BEAGLEBONE,
            "urls": {
                "Amazon": "https://www.amazon.com/Beagleboard-BBONE-BLACK-4G-BeagleBone-Rev-C/dp/B00K7EEX2U/",
                "Home": "http://beagleboard.org/bone",                
                "Wiki:": "https://en.wikipedia.org/wiki/BeagleBoard#BeagleBone"
            }
        }
    ];
    insert(data);
}
</pre>
<a class="anchor" id="creating-views"></a>
<h2>Creating Views</h2>
<p>First we define two views:</p>
<ul>
<li>simpleView: Show the Doc ID and REV</li>
<li>designUrls: Show the urls of various items</li>
</ul>
<p>Each of these views become a map. That is, they are called once for each document in the database. They then transform the document into a new format, and use <strong>emit</strong> to display to the result.</p>
<p><strong>maps</strong> are a key concept in modern programming. They are often presented as part of a two step process:</p>
<ul>
<li>map: Transforms the objects in an array of in a list of some sort. In our case, it means transforming the documents in the database.<ul>
<li>Note that you can filter out some documents at the same time</li>
</ul>
</li>
<li>reduce: Iterate over the maps, and return a single value or summation of that data</li>
</ul>
<p>CouchDb makes use of Map/Reduce, but for now we are focused only on map.</p>
<p>Testing views can be tricky. One technique that can help is to:</p>
<ul>
<li>Open up futon</li>
<li>Selected your database</li>
<li>Set the view (in the top right) to <strong>Temporary view</strong></li>
<li>Paste in the anonymous function from your view.</li>
</ul>
<p>Here is the simpleView:</p>
<pre> var simpleView = function(doc) {
     emit(doc._id, doc._rev)
 };
</pre>
<p>Here is the anonymous function from your view:</p>
<pre>function(doc) {
  emit(doc._id, doc._rev)
}
</pre>
<p>Once you have one or more working views, place them inside a design document. The method called <strong>createDesignDocument</strong> demonstrates how to create a design document.</p>
<p>Here is the whole section of the code that involves creating views and design document. Paste it into your program.</p>
<pre>
/*******************************
 * Views
 *******************************/

 var simpleView = function(doc) {
     emit(doc._id, doc._rev)
 };

 var designUrls = function(doc) {
     var url, key;
     if (doc.item && doc.urls) {
         for (var urlName in doc.urls) {
             url = doc.urls[urlName];
             key = [doc.item, url];
             emit(key, url);
         }
     }
 }

 function createDesignDocument() {
     var data = [{
         "_id": "_design/example",
         "views": {
             "simple": {
                 "map": simpleView
             },
             "urls": {
                 "map": designUrls
             }
         },
     }];
     insert(data);
 }

function showView(designDoc, view) {
    var nanoDb = nano.db.use(dbName);
    nanoDb.view(designDoc, view, function(err, body) {
        if (!err) {                        
            for (var i = 0; i < body.rows.length; i++) {
                console.log(body.rows[i].key);
            }
        } else {
            console.log("Error", err);            
        }
    });
}
</pre>
<a class="anchor" id="create-bash-menu"></a>
<h2>Create Bash Menu</h2>
<p>Now that we have our CRUD-like operations, and the ability to create views, we just need a way to call these various methods. For now we will just set up a simple bash menu using the <strong>inquirer</strong> package.</p>
<p>To make this work, you may need to install the NPM package (library) called <strong>inquirer</strong>:</p>
<p>  npm install inquirer --save</p>
<p><strong>note</strong>: <em>We already placed the code to install <strong>inquirer</strong> in our <strong>package.json</strong>. Nevertheless, I&#39;m leaving in this reminder of how to install it and add it to your <strong>package.json</strong> file as it may be a helpful reminder for some readers.</em></p>
<p><strong>note</strong>: <em>Inquirer and nodemon don&#39;t get along. Please use node instead of nodemon to start your program: <strong>node server.js</strong>. You may need to edit <strong>package.json</strong> to ensure you don&#39;t have <strong>nodemon</strong> in the start option.</em></p>
<p>Here is the menu itself:</p>
<pre>
/***************************
 * Prompts
 ***************************/

function list() {
    "use strict";

    // Prompts
    var DESIGN = 0;
    var INSERT = 1;
    var DELETE = 2;
    var READ = 3;
    var VIEW = 4;
    var prompts = ['Design', 'Insert', "Delete", "Read", "View"];

    var options = [{
        type: "list",
        name: "theme",
        message: "What do you want to do?",
        choices: [
            prompts[DESIGN],
            prompts[INSERT],
            new inquirer.Separator(),
            prompts[VIEW],
            prompts[READ],
            prompts[DELETE]
        ]
    }];

    inquirer.prompt(options).then(function(answer) {
        console.log("Response:", answer);
        switch (answer.theme) {
            case prompts[READ]:
                console.log(prompts[READ]);
                readIt(RASPBERRY_PI);
                break;

            case prompts[DESIGN]:
                console.log(prompts[DESIGN]);
                createDesignDocument();
                break;

            case prompts[DELETE]:
                console.log(prompts[DELETE]);
                deleteDoc("_design/example");
                break;

            case prompts[INSERT]:
                console.log(prompts[INSERT]);
                coreDataInsert();
                break;

            case prompts[VIEW]:
                console.log(prompts[VIEW]);
                //showView("example", "prices");
                showView("example", "simple");
                break;

            default:
                console.log("No match");

        }
    });

}

list();
</pre>
<p>To better understand inquirer, see the docs and examples for this project in GitHub.</p>
<ul>
<li><a href="https://github.com/SBoudrias/Inquirer.js/">https://github.com/SBoudrias/Inquirer.js/</a></li>
<li><a href="https://github.com/SBoudrias/Inquirer.js/tree/master/examples">https://github.com/SBoudrias/Inquirer.js/tree/master/examples</a></li>
</ul>
<a class="anchor" id="turn-it-in"></a>
<h2>Turn it in</h2>
<p>Save your work and push it to the cloud. Attach a screenshot of the result from calling views function.</p>
</div></body></html>