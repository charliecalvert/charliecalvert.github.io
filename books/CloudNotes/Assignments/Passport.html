<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width initial-scale=1.0"><title>Passport</title><link rel="shortcut icon" href="/charlie/images/favicon.png"><!-- Latest compiled and minified CSS--><link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap.min.css"><!-- Optional theme--><link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap-theme.min.css"><!-- link(href='/libs/css/BootstrapIndex.css', rel='stylesheet', type='text/css')--><link href="/css/style.css" rel="stylesheet" type="text/css"><link href="/css/highlight/googlecode.css" rel="stylesheet" type="text/css"><script src="/components/jquery/dist/jquery.js"></script><script src="/components/angular/angular.js"></script><script src="/components/angular-route/angular-route.js"></script><script src="/components/bootstrap/dist/js/bootstrap.min.js"></script><!-- script(src='/libs/scripts/elvenware.js', type='text/javascript')--><script src="/libs/scripts/Control.js"></script><!-- script(src='http://localhost:35729/livereload.js')--></head><body><div class="navbar navbar-inverse"><div class="container"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target=".navbar-collapse" class="navbar-toggle"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">Elvenware</a></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li class="active"><a href="/index.html">Home</a></li><li><a href="/charlie/About.html">About</a></li><li class="dropdown"><a href="#/" data-toggle="dropdown" class="dropdown-toggle">Dropdown<b class="caret"></b></a><ul class="dropdown-menu"><li class="dropdown-header">Core Code</li><li><a href="/charlie/development/index.html">Strongly Typed</a></li><li><a href="/charlie/development/web/index.html">Web & Scripts</a></li><li><a href="/charlie/development/cloud/index.shtml">Cloud</a></li><li class="divider"></li><li class="dropdown-header">OS and Tools</li><li><a href="/os/index.html">OS</a></li><li><a href="/charlie/development/database/index.html">Database</a></li><li><a href="/books/index.html">My Writing</a></li><li class="divider"></li><li class="dropdown-header">Art</li><li><a href="/charlie/Art/index.html">Poems & Photos</a></li><li><a href="/books/reading/index.html">Book Reviews</a></li><li><a href="/spirit/index.html">Spiritual</a></li><li class="divider"></li><li class="dropdown-header">Links</li><li><a href="/charlie/links.html">My Links</a></li><li><a href="http://www.github.com/charliecalvert">GitHub</a></li><li><a href="http://sourceforge.net/projects/elvenware/">Sourceforge</a></li></ul></li></ul></div><!-- /.nav-collapse--></div></div><div class="container"><figure><img alt="Elvenware" src="/charlie/images/elvenwarelogo.png"/></figure><h1>Passport</h1><h3>Table of Contents</h3><ul><!--TOC_Start--><!--TOC_End--></ul><p>#Passport</p>
<p>This software allows you to &quot;sign in with Google&quot;. The goal of the
assignment is to allow you to add a <strong>Log On</strong> page to your web
application. You can then sign on to your site with your Google
account. It will be possible to decide whether a user can perform
a particular action depending on whether or not she is signed on.</p>
<p>By having Google manage the sign on process you free yourself of:</p>
<ul>
<li>Having to authenticate users. Google has already done it for you.</li>
<li>Having to write code that authenticates users in a secure manner.
This is a very error prone process. When the user signs on, Google
will pass their email address to you. Normally we would store that
address, and the user&#39;s ID, in a database. We would store it in MongoDb,
but typically developers use a small fast database called redis for
this purpose. There is a discussion of redis on Elvenware. In this
class, however, we will skip the process of storing the user&#39;s name
in a database due to time constraints.</li>
</ul>
<p>##Install Passport</p>
<p>To get started, first create a new project and then download the
Passport package:</p>
<pre><code>express Passport
cd Passport
npm <span class="hljs-keyword">install</span> passport passport-google <span class="hljs-comment">--save</span>
npm <span class="hljs-keyword">install</span> express-<span class="hljs-keyword">session</span> <span class="hljs-comment">--save</span>
</code></pre><p>Passport is the tool we will use to allow the user to log on with
Google.</p>
<p>Once you have passport installed, open up <strong>app.js</strong> and add the following
lines near the top:</p>
<pre><code><span class="hljs-keyword">var</span> session = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express-session'</span>);
<span class="hljs-keyword">var</span> passport = <span class="hljs-built_in">require</span>(<span class="hljs-string">'passport'</span>);
</code></pre><p>And in the use section (around line 26 or wherever, after cookie parser and static public):</p>
<pre><code class="lang-javascript"><span class="hljs-selector-tag">app</span><span class="hljs-selector-class">.use</span>(<span class="hljs-selector-tag">session</span>({
    <span class="hljs-attribute">secret</span>: <span class="hljs-string">'keyboard cat'</span>,
    resave: true,
    saveUninitialized: true
}));
<span class="hljs-selector-tag">app</span><span class="hljs-selector-class">.use</span>(<span class="hljs-selector-tag">passport</span><span class="hljs-selector-class">.initialize</span>());
<span class="hljs-selector-tag">app</span><span class="hljs-selector-class">.use</span>(<span class="hljs-selector-tag">passport</span><span class="hljs-selector-class">.session</span>());
</code></pre>
<p>##Passport Code</p>
<p>There is quite a bit of set up code needed to get Passport up and running.
I finally decided to put all this code in <strong>index.js</strong>. From an architectual
point of view, that is probably not a very good decision. It is, however,
much easier for you to simply paste the code into <strong>index.js</strong> than to
worry about a more optimal solution.</p>
<p>So, in the intest of expediency, set index.js to look like this:</p>
<pre><code><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">var</span> router = express.Router();
<span class="hljs-keyword">var</span> passport = <span class="hljs-built_in">require</span>(<span class="hljs-string">'passport'</span>);
<span class="hljs-keyword">var</span> GoogleStrategy = <span class="hljs-built_in">require</span>(<span class="hljs-string">'passport-google'</span>).Strategy;

<span class="hljs-comment">/* GET home page. */</span>
router.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Index called'</span>);
    response.render(<span class="hljs-string">'index'</span>, {
        title: <span class="hljs-string">'Passport Google'</span>
    });
});

router.get(<span class="hljs-string">'/info'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Info called'</span>);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Auth: '</span> + request.isAuthenticated(<span class="hljs-string">'google'</span>));
    response.send({
        result: <span class="hljs-string">'Success'</span>,
        authenticated: request.isAuthenticated()
    });
});

passport.serializeUser(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">user, done</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;
    done(<span class="hljs-literal">null</span>, user);
});

passport.deserializeUser(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">obj, done</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;
    done(<span class="hljs-literal">null</span>, obj);
});

passport.use(<span class="hljs-keyword">new</span> GoogleStrategy({
        returnURL: <span class="hljs-string">'http://localhost:30025/auth/google/return'</span>,
        realm: <span class="hljs-string">'http://localhost:30025/'</span>
    },
    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">identifier, profile, done</span>) </span>{
<span class="hljs-meta">        'use strict'</span>;
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Google Strategy'</span>);
        process.nextTick(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            profile.identifier = identifier;
            <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, profile);
        });
    }
));

router.get(<span class="hljs-string">'/auth/google'</span>, passport.authenticate(<span class="hljs-string">'google'</span>, {
    failureRedirect: <span class="hljs-string">'/login'</span>
}), <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;
    response.redirect(<span class="hljs-string">'/'</span>);
});

router.get(<span class="hljs-string">'/auth/google/return'</span>, passport.authenticate(<span class="hljs-string">'google'</span>, {
    failureRedirect: <span class="hljs-string">'/login'</span>
}), <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;
    response.redirect(<span class="hljs-string">'/'</span>);
});

router.get(<span class="hljs-string">'/auth/logout'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Logout called'</span>);
    request.logout();
    response.redirect(<span class="hljs-string">'/'</span>);
});

<span class="hljs-built_in">module</span>.exports = router;
</code></pre><p>Since we are working on a blank new project, you can just replace the
entirety of <strong>index.js</strong> with the code shown above. When working on
the final, however, you will have to do a bit of cutting and pasting.</p>
<p>For process.nextTick, <a href="http://nodejs.org/api/process.html#process_process_nexttick_callback">see the docs</a>. Instead of making the call immediately, it is more like a callback. We wait until the next time that node is not busy, then make the call. Node runs on an event loop, and in effect this is saying the next time the loop comes around.</p>
<p>##Login and Logout</p>
<p>Let&#39;s take a look at these lines in index.js:</p>
<pre><code>app.<span class="hljs-keyword">get</span>(<span class="hljs-string">'/auth/google'</span>, passport.authenticate(<span class="hljs-string">'google'</span>, {
    failureRedirect : <span class="hljs-string">'/login'</span>
}), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(request, response)</span> </span>{
    response.redirect(<span class="hljs-string">'/'</span>);
});

app.<span class="hljs-keyword">get</span>(<span class="hljs-string">'/auth/google/return'</span>, passport.authenticate(<span class="hljs-string">'google'</span>, {
    failureRedirect : <span class="hljs-string">'/login'</span>
}), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(request, response)</span> </span>{
    response.redirect(<span class="hljs-string">'/'</span>);
});
</code></pre><p>These are lines that get called when the user is being authenticated. You
might want to add some console.log lines to this code if you want to
better understand how the process works.</p>
<p>##Run</p>
<p>We are now ready to begin testing our code. This is not the final
solution for logging on, of course, but it lets you check that everything
is set up correctly before you come up with a more user friendly solution.</p>
<p>To log on, go to this URL:</p>
<blockquote>
<p><a href="http://localhost:30025/auth/google">http://localhost:30025/auth/google</a></p>
</blockquote>
<p>Or better, set up the page to handle all this with clicks. So layout.jade:</p>
<pre><code>doctype <span class="hljs-selector-tag">html</span>
<span class="hljs-selector-tag">html</span>
  head
    title= title
    link(rel=<span class="hljs-string">'stylesheet'</span>, href=<span class="hljs-string">'/stylesheets/style.css'</span>)
    script(src=<span class="hljs-string">"//code.jquery.com/jquery-1.11.0.min.js"</span>)
    script(src=<span class="hljs-string">"javascripts/Control.js"</span>)
  <span class="hljs-selector-tag">body</span>
    block <span class="hljs-attribute">content</span>
</code></pre><p>And then index.jade:</p>
<pre><code>extends layout

block content
  h1= title
  p Welcome <span class="hljs-built_in">to</span> <span class="hljs-comment">#{title}</span>

  <span class="hljs-keyword">div</span>
    <span class="hljs-keyword">a</span>(href=<span class="hljs-string">'/auth/google'</span>) Log In
  <span class="hljs-keyword">div</span>
    <span class="hljs-keyword">a</span>(href=<span class="hljs-string">'/auth/logout'</span>) Log out
  <span class="hljs-keyword">div</span>
    <span class="hljs-keyword">a</span>(href=<span class="hljs-string">'/account'</span>) Account
  <span class="hljs-keyword">div</span>
    <span class="hljs-keyword">a</span>(href=<span class="hljs-string">'/login'</span>) Login

  button<span class="hljs-comment">#info Information</span>

  <span class="hljs-keyword">div</span>
    p<span class="hljs-comment">#report</span>
  <span class="hljs-keyword">div</span>
    p<span class="hljs-comment">#debug</span>
</code></pre><p>#Is the User Logged On?</p>
<p>It is often helpful for the client to know whether or not the user
is signed on. Let&#39;s add a simple Ajax call to Control.js. The call can
return information about the status of the user.</p>
<p>#Control</p>
<pre><code><span class="hljs-comment">/**
 * Control.js
 */</span>

<span class="hljs-keyword">var</span> Control = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Control</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Control constructor called"</span>);
        $(<span class="hljs-string">"#info"</span>).click(info);
    }

    <span class="hljs-keyword">var</span> info = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        $.ajax({
            url: <span class="hljs-string">'/info'</span>
        }).success(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">serverInfo</span>) </span>{
            $(<span class="hljs-string">"#report"</span>).html(<span class="hljs-built_in">JSON</span>.stringify(serverInfo));
        }).error(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
            $(<span class="hljs-string">"#debug"</span>).html(err);
        });
    };

    <span class="hljs-keyword">return</span> Control;

}());


$(<span class="hljs-built_in">document</span>).ready(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> control = <span class="hljs-keyword">new</span> Control();
});
</code></pre><p>##Account and Logon</p>
<p>Now we are back on the server side. Here is a simple module with one
method it in. We can use this code to check if the user is signed in.
Notice in particular the <strong>isAuthenticated</strong> method.</p>
<p>Create a file called &#39;routes/SignedIn.js:</p>
<pre><code><span class="hljs-comment">/**
 * SignedIn.js
 */</span>

function signedIn(request, response, <span class="hljs-keyword">next</span>) {
    <span class="hljs-keyword">if</span> (request.isAuthenticated()) {
        console.log(<span class="hljs-string">"authenticated and valid"</span>)<span class="hljs-comment">;</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">next</span>()<span class="hljs-comment">;</span>
    }
    console.log(<span class="hljs-string">"not authenticated."</span>)<span class="hljs-comment">;</span>
    response.redirect(<span class="hljs-string">'/login'</span>)<span class="hljs-comment">;</span>
}

exports.signedIn = signedIn<span class="hljs-comment">;</span>
</code></pre><p>And in Account.js:</p>
<pre><code><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">var</span> router = express.Router();
<span class="hljs-keyword">var</span> signedIn = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./SignedIn'</span>).signedIn;

<span class="hljs-comment">/* GET home page. */</span>
router.get(<span class="hljs-string">'/'</span>, signedIn, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Index called"</span>);
    response.render(<span class="hljs-string">'account'</span>, { title: <span class="hljs-string">'Passport Account'</span> });

    <span class="hljs-comment">// response.render('account', { user : request.user });</span>
});

<span class="hljs-built_in">module</span>.exports = router;
</code></pre><p>##Permissions</p>
<p>You want to track who has permissions to access your account information:</p>
<blockquote>
<p><a href="https://security.google.com/settings/security/permissions">https://security.google.com/settings/security/permissions</a></p>
</blockquote>
<p>##Turn It In</p>
<p>In your repository create a folder called Week11Passport. Place your work in that folder, if it is not there already. Submit your assignment.</p>
</div></body></html>