<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width initial-scale=1.0"><title>Passport</title><link rel="shortcut icon" href="/charlie/images/favicon.png"><!-- Latest compiled and minified CSS--><link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap.min.css"><!-- Optional theme--><link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap-theme.min.css"><!-- link(href='/libs/css/BootstrapIndex.css', rel='stylesheet', type='text/css')--><link href="/css/style.css" rel="stylesheet" type="text/css"><link href="/css/highlight/googlecode.css" rel="stylesheet" type="text/css"><script src="/components/jquery/dist/jquery.js"></script><script src="/components/angular/angular.js"></script><script src="/components/angular-route/angular-route.js"></script><script src="/components/bootstrap/dist/js/bootstrap.min.js"></script><!-- script(src='/libs/scripts/elvenware.js', type='text/javascript')--><script src="/libs/scripts/Control.js"></script><!-- script(src='http://localhost:35729/livereload.js')--></head><body><div class="navbar navbar-inverse"><div class="container"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target=".navbar-collapse" class="navbar-toggle"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">Elvenware</a></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li class="active"><a href="/index.html">Home</a></li><li><a href="/charlie/About.html">About</a></li><li class="dropdown"><a href="#/" data-toggle="dropdown" class="dropdown-toggle">Dropdown<b class="caret"></b></a><ul class="dropdown-menu"><li class="dropdown-header">Core Code</li><li><a href="/charlie/development/index.html">Strongly Typed</a></li><li><a href="/charlie/development/web/index.html">Web & Scripts</a></li><li><a href="/charlie/development/cloud/index.shtml">Cloud</a></li><li class="divider"></li><li class="dropdown-header">OS and Tools</li><li><a href="/os/index.html">OS</a></li><li><a href="/charlie/development/database/index.html">Database</a></li><li><a href="/books/index.html">My Writing</a></li><li class="divider"></li><li class="dropdown-header">Art</li><li><a href="/charlie/Art/index.html">Poems & Photos</a></li><li><a href="/books/reading/index.html">Book Reviews</a></li><li><a href="/spirit/index.html">Spiritual</a></li><li class="divider"></li><li class="dropdown-header">Links</li><li><a href="/charlie/links.html">My Links</a></li><li><a href="http://www.github.com/charliecalvert">GitHub</a></li><li><a href="http://sourceforge.net/projects/elvenware/">Sourceforge</a></li></ul></li></ul></div><!-- /.nav-collapse--></div></div><div class="container"><figure><img alt="Elvenware" src="/charlie/images/elvenwarelogo.png"/></figure><h1>Passport</h1><h3>Table of Contents</h3><ul><!--TOC_Start--><li><a href="#key-places">Key Places</a></li>
<li><a href="#install-passport">Install Passport</a></li>
<li><a href="#setup-google">Setup Google</a></li>
<li><a href="#setup-facebook">Setup Facebook</a></li>
<li><a href="#basics">Basics</a></li>
<li><a href="#google-specific-code">Google Specific Code</a></li>
<li><a href="#passport-specific-code">Passport Specific Code</a></li>
<li><a href="#run">Run</a></li>
<li><a href="#is-the-user-logged-on-">Is the User Logged On?</a></li>
<li><a href="#control">Control</a></li>
<li><a href="#account-and-logon">Account and Logon</a></li>
<li><a href="#permissions">Permissions</a></li>
<li><a href="#turn-it-in">Turn It In</a></li><!--TOC_End--></ul><p>#Passport</p>
<p><a href="http://passportjs.org/">Passport</a> is a tool that allows you to &quot;sign in with Google&quot;, &quot;sign in with Facebook&quot; or &quot;sign with Twitter&quot;. There are other options as well, including creating a basic sign in where the user enters their own user name and email. But Google, Facebook and Twitter are the options that most poeple want.</p>
<p>The goal of this assignment is to allow you to add a <strong>Log On</strong> with Goggle and Facebook page to your web application. It will allow users to sign on to your site with their Google or Facebook accounts. It will then be possible to decide whether a user can perform a particular action depending on whether or not she is signed on.</p>
<p>By having Google, Facebook or Twitter manage the sign on process you free yourself of:</p>
<ul>
<li>Having to authenticate users. Google has already done it for you.</li>
<li>Having to write code that authenticates users in a secure manner. This is a very error prone process.</li>
</ul>
<p>When the user signs on, Google will pass some of their profile information to you. We can request that they send more or less information if they want to access our site. But for this exercise, we want to see only their public profile information. That is, we want to see only the information that they have already decided to show publicly.</p>
<p>Normally we would store that information and the user&#39;s ID, in a database. We could store it in <em>MongoDb</em>, or <em>CouchDb</em>, but typically developers use a small fast database called <em>redis</em> for this purpose. There is a discussion of <em>redis</em> on Elvenware. In this exercise, however, we will skip the process of storing the user&#39;s name
in a database. We&#39;ll get to that later.</p>
<h2 id="key-places">Key Places</h2>
<ul>
<li><a href="http://passportjs.org/">Passport home page</a></li>
<li><a href="https://developers.facebook.com/">https://developers.facebook.com/</a></li>
<li><a href="https://developers.facebook.com/quickstarts/">https://developers.facebook.com/quickstarts/</a></li>
<li><a href="https://developers.facebook.com/products/">https://developers.facebook.com/products/</a></li>
<li><a href="https://www.facebook.com/groups/fbdevelopers/">Facebook Developer Community</a></li>
<li><a href="https://developers.facebook.com/docs/">Facebook Developer Documentation</a></li>
<li><a href="http://aleksandrov.ws/2013/09/12/restful-api-with-nodejs-plus-mongodb/#Step5">Multiple Strategies</a></li>
</ul>
<h2 id="install-passport">Install Passport</h2>
<p>To get started, first create a new express project called <strong>Week08-Passport</strong>. At this stage, the best option for creating the app is probably still <strong>CreateAllExpress</strong>. However my fork of the Express Generator is showing signs of improvement:</p>
<pre><code class="lang-bash">npm <span class="hljs-keyword">install</span> -<span class="hljs-keyword">g</span> elf-express-generator  
elf-express Week08-Passport
</code></pre>
<p>You need install elf-express-generator only once. However, if you want to check for updates:</p>
<pre><code class="lang-bash"><span class="hljs-built_in">npm</span> outdated -g
</code></pre>
<p>If it is outdated, then just reinstall.</p>
<p>Navigate to your project directory and then download the Passport package and other related materials:</p>
<pre><code class="lang-bash">cd Week08-Passport
npm <span class="hljs-keyword">install</span> passport <span class="hljs-comment">--save</span>
npm <span class="hljs-keyword">install</span> passport passport-facebook<span class="hljs-comment">--save</span>
npm <span class="hljs-keyword">install</span> passport-google-oauth20 <span class="hljs-comment">--save</span>
npm <span class="hljs-keyword">install</span> express-<span class="hljs-keyword">session</span> <span class="hljs-comment">--save</span>
npm <span class="hljs-keyword">install</span> <span class="hljs-keyword">connect</span>-ensure-login <span class="hljs-comment">--save</span>
</code></pre>
<p>Passport is the tool we will use to allow the user to log on with
Google.</p>
<h2 id="setup-google">Setup Google</h2>
<p>You are going to need a Google Developer&#39;s account. You won&#39;t need a new log in, as you can use your standard Google Account.</p>
<p>Start at <a href="https://developers.google.com/">https://developers.google.com/</a>. Click around. Get familiar with it. Note the <strong>Developer Console</strong> link near the bottom of the page on the right.</p>
<p>Now go to <a href="https://console.developers.google.com">https://console.developers.google.com</a>. We are going to be using the Google Plus API, which is visiable near the bottom of the <strong>Dashboard</strong>. This is a free service, but there are some limitations. In particular, go to the quotas page. Note that you can only have 20 million users sign in per day, and no more than 25 thousand every 100 seconds. If you actually hit these limits, you can take solace in the fact that your web traffic is large enough so that your grand children will probably never know economic want.</p>
<p>Choose <strong>Credintials</strong> and create an <strong>OAuth Client ID</strong>. Set the Authorized JavaScript origins to:</p>
<ul>
<li><a href="http://localhost:30025">http://localhost:30025</a></li>
</ul>
<p>Set the <strong>Authorized redirect URIs</strong> to:</p>
<ul>
<li><a href="http://localhost:30025/oauth2callback">http://localhost:30025/oauth2callback</a></li>
</ul>
<p>We are actually using this, so I don&#39;t understand why the above works, but it does:</p>
<ul>
<li><a href="http://localhost:30025/auth/google/callback">http://localhost:30025/auth/google/callback</a></li>
</ul>
<h2 id="setup-facebook">Setup Facebook</h2>
<p>Go to the Facebook developers site: <a href="https://developers.facebook.com/">https://developers.facebook.com/</a>. Note at the bottom the link to the Login API.</p>
<p>Visit the Facebook Login for Developers Page: <a href="https://developers.facebook.com/products/login/">https://developers.facebook.com/products/login/</a>. Check out the page you see from the Get Started button.</p>
<p>After getting oriented, look at the top right, and select the option to create a <strong>New App</strong>.</p>
<ul>
<li>Displan Name: Isit320-Lastname</li>
<li>Category: Education</li>
</ul>
<p>Click okay, fill in the capcha, and choose <strong>Facebook Login</strong> as Product and <strong>www</strong> as login.</p>
<ul>
<li>Site URL: <a href="http://localhost:30025">http://localhost:30025</a></li>
<li>Get your App ID and Secret</li>
<li>Client token on advanced page</li>
<li>The Valid OAuth redirect APIs: <a href="http://localhost:30025/facebook/login">http://localhost:30025/facebook/login</a></li>
</ul>
<p><img src="https://s3.amazonaws.com/bucket01.elvenware.com/images/passport-facebook-oauth.png" alt="OAuth Facebook"></p>
<h2 id="basics">Basics</h2>
<p>Once you have passport installed, open up <strong>app.js</strong> and add the following
lines near the top:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> session = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express-session'</span>);
<span class="hljs-keyword">var</span> passport = <span class="hljs-built_in">require</span>(<span class="hljs-string">'passport'</span>);
</code></pre>
<p>And in the use section (around line 26 or wherever, after cookie parser and static public):</p>
<pre><code class="lang-javascript"><span class="hljs-selector-tag">app</span><span class="hljs-selector-class">.use</span>(<span class="hljs-selector-tag">session</span>({
    <span class="hljs-attribute">secret</span>: <span class="hljs-string">'keyboard cat'</span>,
    resave: true,
    saveUninitialized: true
}));
<span class="hljs-selector-tag">app</span><span class="hljs-selector-class">.use</span>(<span class="hljs-selector-tag">passport</span><span class="hljs-selector-class">.initialize</span>());
<span class="hljs-selector-tag">app</span><span class="hljs-selector-class">.use</span>(<span class="hljs-selector-tag">passport</span><span class="hljs-selector-class">.session</span>());
</code></pre>
<p>While you are at it, set up your <strong>favicon</strong> and update the development error handler:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">if</span> (app.get(<span class="hljs-string">'env'</span>) === <span class="hljs-string">'development'</span>) {
    app.use(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, req, res, next</span>) </span>{
<span class="hljs-meta">        'use strict'</span>;
        res.status(err.status || <span class="hljs-number">500</span>);
        <span class="hljs-built_in">console</span>.log(err.message);  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">====</span> <span class="hljs-attr">ADD</span> <span class="hljs-attr">THIS</span> <span class="hljs-attr">LINE</span> =<span class="hljs-string">=&lt;</span>
        <span class="hljs-attr">res.render</span>('<span class="hljs-attr">error</span>', {
            <span class="hljs-attr">message:</span> <span class="hljs-attr">err.message</span>,
            <span class="hljs-attr">error:</span> <span class="hljs-attr">err</span>
        });
    });
}</span></span>
</code></pre>
<p>##Passport Code</p>
<p>There is quite a bit of set up code needed to get Passport up and running. I ended up putting the code shared by both the Google and Facebook strategies in <strong>index.js</strong>. I then create separate modules for the Google and Facebook specific code.</p>
<p>So, in the intest of expediency, set index.js to look like this:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">var</span> router = express.Router();
<span class="hljs-keyword">var</span> passport = <span class="hljs-built_in">require</span>(<span class="hljs-string">'passport'</span>);

<span class="hljs-comment">/* GET home page. */</span>
router.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response, next</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Index called'</span>);
    response.render(<span class="hljs-string">'index'</span>, {
        title: <span class="hljs-string">'Passport Google'</span>
    });
});

passport.serializeUser(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">user, done</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;
    done(<span class="hljs-literal">null</span>, user);
});

passport.deserializeUser(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">obj, done</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;
    done(<span class="hljs-literal">null</span>, obj);
});

router.get(<span class="hljs-string">'/login'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;
    res.render(<span class="hljs-string">'login'</span>, {
        user: req.user
    });
});

router.get(<span class="hljs-string">'/logout'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;
    request.logout();
    response.redirect(<span class="hljs-string">'/'</span>);
});

router.get(<span class="hljs-string">'/info'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Info called'</span>);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Auth: '</span> + request.isAuthenticated(<span class="hljs-string">'google'</span>));
    response.send({
        result: <span class="hljs-string">'Success'</span>,
        authenticated: request.isAuthenticated()
    });
});

<span class="hljs-built_in">module</span>.exports = router;
</code></pre>
<p>The <strong>serialize</strong> and <strong>deserialize</strong> methods simply preserve state between HTTP requests. We might have multiple sessions going on at the same time. These <strong>serialize</strong> methods helps us track which user is associated with which session. In particular, we store the user information or some subset of that information in the serialize method when the session is first created. Then each time the session for that user resumes, that is, each that user makes another request, the <strong>deserialize</strong> method is called and we get the user information restored to us. (At least this is my understanding of how it works.)</p>
<p>Note the Google Strategy code shown below returns the whole profile. Later, we can use the Profile info to look up a user entry in our database.</p>
<p>You probably want to spend some time examining the user information that you get in the serialize or Google Strategy method. It shows you what data was sent from Facebook/Google back to your location.</p>
<h2 id="google-specific-code">Google Specific Code</h2>
<p>Save the Google specific code in <strong>routes/google-auth.js</strong>:</p>
<pre><code class="lang-javascript"><span class="hljs-comment">/**
 * Created by charlie on 11/5/16.
 */</span>

<span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">var</span> router = express.Router();
<span class="hljs-keyword">var</span> passport = <span class="hljs-built_in">require</span>(<span class="hljs-string">'passport'</span>);
<span class="hljs-keyword">var</span> GoogleStrategy = <span class="hljs-built_in">require</span>(<span class="hljs-string">'passport-google-oauth20'</span>).Strategy;

<span class="hljs-comment">/**************************************
 *  Google
 **************************************/</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ensureAuthenticated</span>(<span class="hljs-params">req, res, next</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;
    <span class="hljs-keyword">if</span> (req.isAuthenticated()) {
        <span class="hljs-keyword">return</span> next();
    }
    res.redirect(<span class="hljs-string">'/login'</span>);
}

router.get(<span class="hljs-string">'/account'</span>, ensureAuthenticated, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;
    response.render(<span class="hljs-string">'account'</span>, {
        title: <span class="hljs-string">'Google Account'</span>,
        user: request.user
    });
});

passport.use(<span class="hljs-keyword">new</span> GoogleStrategy({
        clientID: <span class="hljs-string">'1026609216908-b0bbgmbq6dsgggokh8ck546794q4tiak.apps.googleusercontent.com'</span>,
        clientSecret: <span class="hljs-string">'86pZljGDr0s7CAZ3c8qvvwLQ'</span>,
        callbackURL: <span class="hljs-string">'http://localhost:30025/auth/google/callback'</span>,
        passReqToCallback: <span class="hljs-literal">true</span>
    },
    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, accessToken, refreshToken, profile, done</span>) </span>{
<span class="hljs-meta">        'use strict'</span>;
        <span class="hljs-comment">// asynchronous verification, for effect...</span>
        process.nextTick(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

            <span class="hljs-comment">// Return Google profile for now. We will add Database data here later.</span>
            <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, profile);
        });
    }
));

router.get(<span class="hljs-string">'/google'</span>,
    passport.authenticate(<span class="hljs-string">'google'</span>, {
        scope: [<span class="hljs-string">'profile'</span>]
    }));

<span class="hljs-comment">//router.get('/auth/google/callback',</span>
router.get(<span class="hljs-string">'/google/callback'</span>,
    passport.authenticate(<span class="hljs-string">'google'</span>, {
        failureRedirect: <span class="hljs-string">'/login'</span>
    }),
    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
<span class="hljs-meta">        'use strict'</span>;
        <span class="hljs-comment">// Successful authentication, redirect home.</span>
        res.redirect(<span class="hljs-string">'/'</span>);
    });

<span class="hljs-built_in">module</span>.exports = router;
</code></pre>
<p>In the Google Strategy, we need to set up a valid URL. Here some things to keep in mind:</p>
<ul>
<li>Don&#39;t use a private IP not accessible from the WAN.</li>
<li>Use the Google Console to set up local host</li>
</ul>
<p>For <strong>process.nextTick</strong>, <a href="http://nodejs.org/api/process.html#process_process_nexttick_callback">see the docs</a>. Instead of making the call immediately, it is more like a callback. We wait until the next time that node is not busy, then make the call. Node runs on an event loop, and in effect this is saying the next time the loop comes around.</p>
<h2 id="passport-specific-code">Passport Specific Code</h2>
<p>Save the Facebook specific code in <strong>routes/facebook.js</strong>:</p>
<pre><code class="lang-javascript">/<span class="hljs-keyword">*</span><span class="hljs-keyword">*</span>
 <span class="hljs-keyword">*</span> Created by charlie on 11/5/16.
 <span class="hljs-keyword">*</span>/

var express = require('express');
var router = express.Router();
var passport = require('passport');
var Strategy = require('passport-facebook').Strategy;

/<span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span>
 <span class="hljs-keyword">*</span>  Facebook
 <span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span><span class="hljs-keyword">*</span>/

router.get('/profile', require('connect-ensure-login').ensureLoggedIn(),
    function(req, res) {
        'use strict';
        console.log(req.user);
        res.render('profile-temp', {
            title: 'Facebook Profile',
            user: req.user
        });
    });

passport.use(new Strategy({
        clientID: process.env.CLIENT_ID,
        clientSecret: process.env.CLIENT_SECRET,
        callbackURL: 'http://localhost:30025/facebook/login/return'
    },
    function(accessToken, refreshToken, profile, done) {
        'use strict';
        // In this example, the user's Facebook profile is supplied as the user
        // record.  In a production-quality application, the Facebook profile should
        // be associated with a user record in the application's database, which
        // allows for account linking and authentication with other identity
        // providers.
        return done(null, profile);
    }));

router.get('/login',
    passport.authenticate('facebook'));

//router.get('/login/facebook/return',
router.get('/login/return',
    passport.authenticate('facebook', {
        failureRedirect: '/login'
    }),
    function(req, res) {
        'use strict';
        res.redirect('/');
    });

module.exports = router;
</code></pre>
<p>##Login and Logout</p>
<p>Let&#39;s take a look at these lines in <strong>google-auth.js</strong>:</p>
<pre><code class="lang-javascript">app.<span class="hljs-keyword">get</span>(<span class="hljs-string">'/auth/google'</span>, passport.authenticate(<span class="hljs-string">'google'</span>, {
    failureRedirect : <span class="hljs-string">'/login'</span>
}), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(request, response)</span> </span>{
    response.redirect(<span class="hljs-string">'/'</span>);
});

app.<span class="hljs-keyword">get</span>(<span class="hljs-string">'/auth/google/return'</span>, passport.authenticate(<span class="hljs-string">'google'</span>, {
    failureRedirect : <span class="hljs-string">'/login'</span>
}), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(request, response)</span> </span>{
    response.redirect(<span class="hljs-string">'/'</span>);
});
</code></pre>
<p>These are lines that get called when the user is being authenticated. You
might want to add some console.log lines to this code if you want to
better understand how the process works.</p>
<h2 id="run">Run</h2>
<p>We are now ready to begin testing our code. This is not the final
solution for logging on, of course, but it lets you check that everything
is set up correctly before you come up with a more user friendly solution.</p>
<p>To log on, go to this URL:</p>
<blockquote>
<p><a href="http://localhost:30025/auth/google">http://localhost:30025/auth/google</a></p>
</blockquote>
<p>Or better, set up the page to handle all this with clicks. So layout.jade:</p>
<pre><code>doctype <span class="hljs-selector-tag">html</span>
<span class="hljs-selector-tag">html</span>
  head
    title= title
    link(rel=<span class="hljs-string">'stylesheet'</span>, href=<span class="hljs-string">'/stylesheets/style.css'</span>)
    script(src=<span class="hljs-string">"//code.jquery.com/jquery-1.11.0.min.js"</span>)
    script(src=<span class="hljs-string">"javascripts/Control.js"</span>)
  <span class="hljs-selector-tag">body</span>
    block <span class="hljs-attribute">content</span>
</code></pre><p>And then index.jade:</p>
<pre><code>extends layout

block content
  h1= title
  p Welcome <span class="hljs-built_in">to</span> <span class="hljs-comment">#{title}</span>

  <span class="hljs-keyword">div</span>
    <span class="hljs-keyword">a</span>(href=<span class="hljs-string">'/facebook/login'</span>) Log In <span class="hljs-keyword">with</span> Facebook
  <span class="hljs-keyword">div</span>
    <span class="hljs-keyword">a</span>(href=<span class="hljs-string">"/facebook/profile"</span>) Facebook Profile

  <span class="hljs-keyword">div</span>
    <span class="hljs-keyword">a</span>(href=<span class="hljs-string">'/auth/google'</span>) Log In Google
  <span class="hljs-keyword">div</span>
    <span class="hljs-keyword">a</span>(href=<span class="hljs-string">'/auth/account'</span>) Google Account

  <span class="hljs-keyword">div</span>
    <span class="hljs-keyword">a</span>(href=<span class="hljs-string">'/logout'</span>) Logout

  button<span class="hljs-comment">#info Information</span>

  <span class="hljs-keyword">div</span>
    pre<span class="hljs-comment">#report</span>
  <span class="hljs-keyword">div</span>
    pre<span class="hljs-comment">#debug</span>
</code></pre><h2 id="is-the-user-logged-on-">Is the User Logged On?</h2>
<p>It is often helpful for the client to know whether or not the user
is signed on. Let&#39;s add a simple Ajax call to Control.js. The call can
return information about the status of the user.</p>
<h2 id="control">Control</h2>
<pre><code class="lang-javascript"><span class="hljs-comment">/**
 * Control.js
 */</span>

<span class="hljs-keyword">var</span> Control = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Control</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Control constructor called"</span>);
        $(<span class="hljs-string">"#info"</span>).click(info);
    }

    <span class="hljs-keyword">var</span> info = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        $.ajax({
            url: <span class="hljs-string">'/info'</span>
        }).success(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">serverInfo</span>) </span>{
            $(<span class="hljs-string">"#report"</span>).html(<span class="hljs-built_in">JSON</span>.stringify(serverInfo));
        }).error(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
            $(<span class="hljs-string">"#debug"</span>).html(err);
        });
    };

    <span class="hljs-keyword">return</span> Control;

}());

$(<span class="hljs-built_in">document</span>).ready(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> control = <span class="hljs-keyword">new</span> Control();
});
</code></pre>
<h2 id="account-and-logon">Account and Logon</h2>
<p>Now we are back on the server side. Here is a simple module with one
method it in. We can use this code to check if the user is signed in.
Notice in particular the <strong>isAuthenticated</strong> method.</p>
<p>Create a file called &#39;routes/SignedIn.js:</p>
<pre><code><span class="hljs-comment">/**
 * SignedIn.js
 */</span>

function signedIn(request, response, <span class="hljs-keyword">next</span>) {
    <span class="hljs-keyword">if</span> (request.isAuthenticated()) {
        console.log(<span class="hljs-string">"authenticated and valid"</span>)<span class="hljs-comment">;</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">next</span>()<span class="hljs-comment">;</span>
    }
    console.log(<span class="hljs-string">"not authenticated."</span>)<span class="hljs-comment">;</span>
    response.redirect(<span class="hljs-string">'/login'</span>)<span class="hljs-comment">;</span>
}

exports.signedIn = signedIn<span class="hljs-comment">;</span>
</code></pre><p>And in Account.js:</p>
<pre><code><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">var</span> router = express.Router();
<span class="hljs-keyword">var</span> signedIn = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./SignedIn'</span>).signedIn;

<span class="hljs-comment">/* GET home page. */</span>
router.get(<span class="hljs-string">'/'</span>, signedIn, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Index called"</span>);
    response.render(<span class="hljs-string">'account'</span>, { title: <span class="hljs-string">'Passport Account'</span> });

    <span class="hljs-comment">// response.render('account', { user : request.user });</span>
});

<span class="hljs-built_in">module</span>.exports = router;
</code></pre><h2 id="permissions">Permissions</h2>
<p>You want to track who has permissions to access your account information:</p>
<blockquote>
<p><a href="https://security.google.com/settings/security/permissions">https://security.google.com/settings/security/permissions</a></p>
</blockquote>
<h2 id="turn-it-in">Turn It In</h2>
<p>Place your work in the appropriate folder in your repository, if it is not there already. Submit your assignment.</p>
</div></body></html>