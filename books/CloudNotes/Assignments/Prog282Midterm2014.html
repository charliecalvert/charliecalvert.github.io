<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width initial-scale=1.0"><title>Prog282Midterm2014</title><link href="/css/first-style.css" rel="stylesheet"><link rel="shortcut icon" href="/images/favicon.png"><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet"><link href="/css/highlight/googlecode.css" rel="stylesheet" type="text/css"><link href="/css/style.css" rel="stylesheet"><script src="https://code.jquery.com/jquery-1.12.0.min.js"></script><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- Latest compiled and minified CSS --><script src="/js/elven-help.js"></script></head><body><nav class="navbar navbar-inverse"><div class="container"><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/">Elvenware</a></div><div class="navbar-collapse collapse" id="navbar"><ul class="nav navbar-nav"><li class="trigger-collapse" ng-class="{ active: isActive('/')}"><a href="/">Home</a></li><li><a href="/about.html">About</a></li></ul></div></div></nav><div class="container"><figure><img class="elf-normal" alt="Elvenware" src="/images/elvenwarelogo.png"/></figure><h1>Prog282Midterm2014</h1><p>Welcome to Prog282Midterm2014</p><ul><!--TOC_Start--><li><a href="#call-into-newpage">Call into NewPage</a></li>
<li><a href="#the-calculatepage">The CalculatePage</a></li>
<li><a href="#the-convert-page">The convert page</a></li><!--TOC_End--></ul></div><div class="container"><p>#Prog 282 Midterm Spring 2014</p>
<p>The goal of this assignment is to learn more about using Ajax to pass data between a client and server. We will also learn more about Express and Jade.</p>
<p>This is the midterm. A variant on the old midterm will probably become the final.</p>
<p>##Step 01: Create an express project.</p>
<p>Go to the command line and create an express project:</p>
<pre><code>express Week07RoutingData
<span class="hljs-built_in">cd</span> Week07RoutingData
npm install
</code></pre><p>If you want to edit this in Eclipse:</p>
<ul>
<li><strong>File | Import | Existing <em>Folder</em> into Eclipse</strong></li>
<li>Browse to your folder on disk</li>
<li>Set the Project name to <strong>Week07RoutingData-LastName</strong> where <strong>LastName</strong> is your last name.</li>
<li>Click finish</li>
<li>Optionally set up a working set for your project</li>
</ul>
<p><img src="http://www.elvenware.com/charlie/books/CloudNotes/Images/EclipseImportProject.png" alt="Import"></p>
<p>If the above fails. Copy the .project file from <a href="https://github.com/charliecalvert/JsObjects/blob/master/JavaScript/NodeCode/jsonRead/.project">JsonRead</a> into your project and change the name field to Week07RoutingData-LastName where LastName is your last name. Then use <strong>File | Import | General | Existing <em>Project</em> into Workspace</strong>.</p>
<p>##Step 02: Project Name and Port</p>
<p>Open <strong>index.js</strong> in Eclipse or Geany. </p>
<p><strong>Note</strong>: <em>If you want to use Geany, remember to first open Geany from the desktop (GUI). Then open the file in geany from the command line like this:</em></p>
<pre><code>geany routes/<span class="hljs-keyword">index</span>.js
</code></pre><p><em>If you type the above without first opening Geany from the desktop, then you won&#39;t be able to use the command line until you close Geany. It may be possible to avoid this need to first open Geany in the Gui by typing something like this: <a href="http://bashitout.com/2013/05/18/Ampersands-on-the-command-line.html">geany myfile.txt &amp;</a>.</em></p>
<p>Change the title. Change <strong>req</strong> and <strong>res</strong> to <strong>request</strong> and <strong>response</strong>. Indent <strong>response.render</strong> four spaces or one tab instead of two spaces:</p>
<pre><code><span class="hljs-comment">/* GET home page. */</span>
router.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(request, response)</span> </span>{
    response.render(<span class="hljs-string">'index'</span>, { title: <span class="hljs-string">'Week07 Routing Data Calvert'</span> });
});
</code></pre><p>Can you see the white space (tabs, spaces, line endings) in your editor?</p>
<ul>
<li>In Geany: <strong>View | Editor | Show Whitespace</strong></li>
<li>In Eclipse: <strong>Window | Preferences | General | Editors | Text Editors | Show Whitespace</strong></li>
</ul>
<p>Now let&#39;s set the port. Open up www in your editor:</p>
<ul>
<li><strong>geany bin/www</strong> or just open it in Eclipse</li>
<li>change the port to 30025</li>
</ul>
<p>Here is the edit:</p>
<pre><code>app.set(<span class="hljs-symbol">'port</span>', <span class="hljs-keyword">process</span>.env.<span class="hljs-keyword">PORT</span> || <span class="hljs-number">30025</span>);
</code></pre><p>##Step 03: Set up a route on the server:</p>
<p>Add a <strong>sayHello</strong> route to <strong>index.js</strong>:</p>
<pre><code>router.get(<span class="hljs-string">'/sayHello'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(request, response)</span> </span>{
    response.send({ result: <span class="hljs-string">"The server says Hello"</span> });
});
</code></pre><p>Test it:</p>
<ul>
<li>npm start</li>
<li>Open your browser and browse to <a href="http://localhost:30025/sayHello">http://localhost:30025/sayHello</a></li>
<li>You should see: {&quot;result&quot;:&quot;Hello&quot;}</li>
</ul>
<p>Go to port 30025 and set the route to <strong>sayHello</strong>:</p>
<p><img src="http://www.elvenware.com/charlie/books/CloudNotes/Images/Routing01.png" alt="RoutingHello"></p>
<p>##Step04: Set up the Client</p>
<p>First, let&#39;s create a button and paragraph element:</p>
<ul>
<li>Open views/index.jade</li>
<li>Add a button with an id of <strong>sayHello</strong>: button#sayHello Say Hello</li>
<li>Add a paragraph with an id of <strong>paragraph01</strong>: p#paragraph01</li>
</ul>
<p>The contents of <strong>index.jade</strong>:</p>
<pre><code>extends layout

block content
  h1= <span class="hljs-keyword">title</span>
  p Welcome to <span class="hljs-meta">#{title}</span>

  <span class="hljs-keyword">button</span><span class="hljs-meta">#buttonSayHello Say Hello</span>
  p<span class="hljs-meta">#paragraph01</span>
</code></pre><p>Open up <strong>layout.jade</strong> and set up require.</p>
<p>Get Main.js, require and jquery:</p>
<pre><code>cd public/javascripts
wget <span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/requirejs.org/docs</span><span class="hljs-regexp">/release/</span><span class="hljs-number">2.1</span>.<span class="hljs-number">11</span>/comments/<span class="hljs-keyword">require</span>.js
wget <span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/code.jquery.com/jquery</span>-<span class="hljs-number">2.1</span>.<span class="hljs-number">1</span>.js
wget <span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/elvenware.com/charlie</span><span class="hljs-regexp">/development/web</span><span class="hljs-regexp">/JavaScript/</span>Scripts/Main.js 
</code></pre><p><strong>Note</strong>: <em>The <strong>wget</strong> program ships with Linux. For Windows it is <a href="http://wget.addictivecode.org/FrequentlyAskedQuestions?action=show&amp;redirect=Faq#download">here</a>. I store the above commands as scripts on <a href="https://github.com/charliecalvert/JsObjects/tree/master/Utilities/InstallScripts">JsObjects</a> in <strong>RequiryJQuery.bat</strong> and <strong>RequireJquery.sh</strong>. You should copy one of these scripts to some place on your path, such as your <strong>$HOME/bin</strong> directory. After copying it, you might need to set its executable permissions</em>:</p>
<pre><code><span class="hljs-selector-tag">chmod</span> +<span class="hljs-selector-tag">x</span> <span class="hljs-selector-tag">RequireJquery</span><span class="hljs-selector-class">.sh</span>
</code></pre><p><em>Alternatively, you can browse to it using the GUI file explorer, right click on it, and use the permissions to set the permissions for the file to executable. (If you skip this step, you might get a permissions error when you try to run the file.)</em></p>
<p><em>Once the script is set up, then the commands to use it are</em>:</p>
<pre><code><span class="hljs-keyword">cd</span> public/javascripts
RequireJQuery.<span class="hljs-keyword">sh</span>
</code></pre><p><em>You can simplify the above by creating a <a href="http://www.cyberciti.biz/faq/creating-soft-link-or-symbolic-link/">symbolic link</a> between bin/requirejq and the JsObjects source</em>:</p>
<pre><code>ln -s <span class="hljs-regexp">/home/</span>bcuser<span class="hljs-regexp">/Git/</span>JsObjects<span class="hljs-regexp">/Utilities/</span>InstallScripts<span class="hljs-regexp">/RequireJquery.sh requirejq</span>
</code></pre><p><em>Now you should be able to download all three files from anywhere you have file creation rights by just typing <strong>requirejq</strong>.</em></p>
<p>The RequireJquery script will download require, jquery and <strong>Main.js</strong>. Your <strong>Main.js</strong> file should look like this:</p>
<pre><code><span class="hljs-built_in">require</span>.config({
    <span class="hljs-attr">paths</span> : {
        <span class="hljs-string">"jquery"</span> : <span class="hljs-string">"jquery-2.1.1"</span>
    }
});

<span class="hljs-built_in">require</span>([<span class="hljs-string">'jquery'</span>], 

    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">jq</span>) </span>{
<span class="hljs-meta">        'use strict'</span>;
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Main called"</span>);
    }

);
</code></pre><p>Modify the callback to look like this:</p>
<pre><code><span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">jq</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Main called"</span>);
    $.getJSON(<span class="hljs-string">'/sayHello'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">helloObject</span>) </span>{
        $(<span class="hljs-string">'#paragraph01'</span>).html(helloObject.result);
    });
}
</code></pre><p>Refresh the browser. The output should look something like this:</p>
<p><img src="http://www.elvenware.com/charlie/books/CloudNotes/Images/Routing02.png" alt="Route02"></p>
<p>We can see the data from the server below the button. Now let&#39;s get it to respond to a button click:</p>
<pre><code><span class="hljs-built_in">require</span>.config({
    <span class="hljs-attr">paths</span> : {
        <span class="hljs-string">"jquery"</span> : <span class="hljs-string">"jquery-2.1.1"</span>
    }
});

<span class="hljs-built_in">require</span>([<span class="hljs-string">'jquery'</span>], 

    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">jq</span>) </span>{
<span class="hljs-meta">        'use strict'</span>;
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Main called"</span>);
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getHello</span>(<span class="hljs-params"></span>) </span>{
            $.getJSON(<span class="hljs-string">'/sayHello'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">helloObject</span>) </span>{
                $(<span class="hljs-string">'#paragraph01'</span>).html(helloObject.result);
            });
        }

        $(<span class="hljs-string">"#buttonSayHello"</span>).click(getHello);
    }
</code></pre><p>);</p>
<p>Now you see the text only when you click on the button.</p>
<p>##Pass Data to the Server</p>
<p>Modify getHello to pass in some information about your browser:</p>
<pre><code>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">errorHandler</span>(<span class="hljs-params">fx, status, error</span>) </span>{
        $(<span class="hljs-string">'#debug01'</span>).html(fx.responseText);
        $(<span class="hljs-string">'#debug02'</span>).html(<span class="hljs-string">'error'</span> + error);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getHello</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> nav = <span class="hljs-built_in">window</span>.navigator;
        <span class="hljs-keyword">var</span> browserInfo = {
            <span class="hljs-attr">codeName</span> : nav.appCodeName,
            <span class="hljs-attr">appName</span> : nav.appName,
            <span class="hljs-attr">version</span> : nav.appVersion,
            <span class="hljs-attr">platform</span> : nav.platform,
            <span class="hljs-attr">vendor</span> : nav.vendor,
            <span class="hljs-attr">product</span> : nav.product,
            <span class="hljs-attr">userAgent</span>: nav.userAgent
        };

    $.getJSON(<span class="hljs-string">'/sayHello'</span>, browserInfo, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">helloObject</span>) </span>{
        $(<span class="hljs-string">'#paragraph01'</span>).html(helloObject.result);
        $(<span class="hljs-string">'#paragraph02'</span>).html(helloObject.codeName);
        $(<span class="hljs-string">'#paragraph03'</span>).html(helloObject.version);
        $(<span class="hljs-string">'#paragraph04'</span>).html(helloObject.product);
        $(<span class="hljs-string">'#paragraph05'</span>).html(helloObject.userAgent);
    }).error = errorHandler;
}

    $(<span class="hljs-string">"#buttonSayHello"</span>).click(getHello);
</code></pre><p>Handle the Data on the Server something like this:</p>
<pre><code>router.<span class="hljs-built_in">get</span>('/sayHello', function(request, response) {    
    console.<span class="hljs-built_in">log</span>(request.<span class="hljs-keyword">query</span>);    

     response.send({ 
        <span class="hljs-string">"result"</span>: <span class="hljs-string">"The server says Hello"</span>,
        <span class="hljs-string">"codeName"</span>: request.<span class="hljs-keyword">query</span>.codeName,
        <span class="hljs-string">"product"</span>: request.<span class="hljs-keyword">query</span>.product,
        <span class="hljs-string">"version"</span>: request.<span class="hljs-keyword">query</span>.<span class="hljs-keyword">version</span>,
        <span class="hljs-string">"userAgent"</span>: request.<span class="hljs-keyword">query</span>.userAgent
     });
});
</code></pre><p>Note that we get the data passed from the server by examining <strong>request.query</strong>. Be sure to look at the command prompt on the server side so you can see what request.query looks like when printed to the console:</p>
<pre><code>    <span class="hljs-selector-tag">console</span><span class="hljs-selector-class">.log</span>(<span class="hljs-selector-tag">request</span><span class="hljs-selector-class">.query</span>);    
</code></pre><p>The result should look like this in Chrome, but it will differ depending on browser and server platform:</p>
<p><img src="http://www.elvenware.com/charlie/books/CloudNotes/Images/Routing03.png" alt="Route03"></p>
<p>##Add a new Page</p>
<p>Create a copy of routes/index.js called routes/NewPage.js.
Create a copy of views/index.jade called views/NewPage.jade</p>
<p>Add the following code to index.jade:</p>
<p>  a(href=&quot;/NewPage&quot;) New Page</p>
<p>Modify line 6 of <strong>NewPage.js</strong> to load your new page rather than the old page:</p>
<pre><code>router.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(request, response)</span> </span>{
    response.render(<span class="hljs-string">'NewPage'</span>, { title: <span class="hljs-string">'Week07 Routing Data Calvert'</span> });
});
</code></pre><p>Notice that we are now rendering <strong>NewPage</strong>, not <strong>index</strong>.</p>
<p>Modify two places in app.js:</p>
<pre><code><span class="hljs-keyword">var</span> express = <span class="hljs-keyword">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">var</span> path = <span class="hljs-keyword">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> favicon = <span class="hljs-keyword">require</span>(<span class="hljs-string">'static-favicon'</span>);
<span class="hljs-keyword">var</span> logger = <span class="hljs-keyword">require</span>(<span class="hljs-string">'morgan'</span>);
<span class="hljs-keyword">var</span> cookieParser = <span class="hljs-keyword">require</span>(<span class="hljs-string">'cookie-parser'</span>);
<span class="hljs-keyword">var</span> bodyParser = <span class="hljs-keyword">require</span>(<span class="hljs-string">'body-parser'</span>);

<span class="hljs-keyword">var</span> routes = <span class="hljs-keyword">require</span>(<span class="hljs-string">'./routes/index'</span>);
<span class="hljs-keyword">var</span> users = <span class="hljs-keyword">require</span>(<span class="hljs-string">'./routes/users'</span>);
<span class="hljs-keyword">var</span> newPage = <span class="hljs-keyword">require</span>(<span class="hljs-string">'./routes/NewPage'</span>);   <span class="hljs-comment">// Here is edit one</span>

<span class="hljs-keyword">var</span> app = express();

<span class="hljs-comment">// view engine setup</span>
app.set(<span class="hljs-string">'views'</span>, path.join(__dirname, <span class="hljs-string">'views'</span>));
app.set(<span class="hljs-string">'view engine'</span>, <span class="hljs-string">'jade'</span>);

app.<span class="hljs-keyword">use</span>(favicon());
app.<span class="hljs-keyword">use</span>(logger(<span class="hljs-string">'dev'</span>));
app.<span class="hljs-keyword">use</span>(bodyParser.json());
app.<span class="hljs-keyword">use</span>(bodyParser.urlencoded());
app.<span class="hljs-keyword">use</span>(cookieParser());
app.<span class="hljs-keyword">use</span>(express.<span class="hljs-keyword">static</span>(path.join(__dirname, <span class="hljs-string">'public'</span>)));

app.<span class="hljs-keyword">use</span>(<span class="hljs-string">'/'</span>, routes);
app.<span class="hljs-keyword">use</span>(<span class="hljs-string">'/users'</span>, users);
app.<span class="hljs-keyword">use</span>(<span class="hljs-string">'/NewPage'</span>, newPage);             <span class="hljs-comment">// Here is edit two</span>
</code></pre><p>These are the two new lines that appear in the above code:</p>
<pre><code><span class="hljs-keyword">var</span> <span class="hljs-keyword">new</span><span class="hljs-type">Page</span> = require(<span class="hljs-string">'./routes/NewPage'</span>);   <span class="hljs-comment">// Here is edit one</span>
app.use(<span class="hljs-string">'/NewPage'</span>, <span class="hljs-keyword">new</span><span class="hljs-type">Page</span>);       <span class="hljs-comment">// Here is edit two</span>
</code></pre><p>Modify NewPage.jade so that it looks like this:</p>
<pre><code>extends layout

<span class="hljs-built_in">block</span> <span class="hljs-built_in">content</span>
  h1= <span class="hljs-built_in">title</span>
  p Welcome to #{<span class="hljs-built_in">title</span>}

  h2 This <span class="hljs-built_in">is</span> the <span class="hljs-built_in">new</span> page!
</code></pre><p>Restart the server, click on your link on the main page. You should be taken to the second page:</p>
<p><img src="http://www.elvenware.com/charlie/books/CloudNotes/Images/Routing04.png" alt="Route04"></p>
<p>##Create a Application Control Page</p>
<p>Each object that we create should do one thing, and have one reason to change. Right now, <strong>Main.js</strong> is where we set up <strong>require</strong> and where we respond to button clicks. That&#39;s two things and two reasons to change the page as we develop the app. To fix this, we need to move code from <strong>Main.js</strong> into a file called <strong>Control.js</strong>. Here is <strong>control.js</strong>:</p>
<pre><code>define(['jquery'], function(<span class="hljs-name">jq</span>) {

    var Control = (<span class="hljs-name">function</span>() {

        function Control() {
            $(<span class="hljs-string">"#buttonSayHello"</span>).click(<span class="hljs-name">getHello</span>)<span class="hljs-comment">;</span>
        }

        function errorHandler(<span class="hljs-name">fx</span>, status, error) {
            $('#debug01').html(<span class="hljs-name">fx</span>.responseText)<span class="hljs-comment">;</span>
            $('#debug02').html('error' + error)<span class="hljs-comment">;</span>
        }

        function getHello() {
            var nav = window.navigator<span class="hljs-comment">;</span>
            var browserInfo = {
                codeName : nav.appCodeName,
                appName : nav.appName,
                version : nav.appVersion,
                platform : nav.platform,
                vendor : nav.vendor,
                product : nav.product,
                userAgent : nav.userAgent
            }<span class="hljs-comment">;</span>

            $.getJSON('/sayHello', browserInfo, function(<span class="hljs-name">helloObject</span>) {
                $('#paragraph01').html(<span class="hljs-name">helloObject</span>.result)<span class="hljs-comment">;</span>
                $('#paragraph02').html(<span class="hljs-name">helloObject</span>.codeName)<span class="hljs-comment">;</span>
                $('#paragraph03').html(<span class="hljs-name">helloObject</span>.version)<span class="hljs-comment">;</span>
                $('#paragraph04').html(<span class="hljs-name">helloObject</span>.product)<span class="hljs-comment">;</span>
                $('#paragraph05').html(<span class="hljs-name">helloObject</span>.userAgent)<span class="hljs-comment">;</span>
            }).error = errorHandler<span class="hljs-comment">;</span>
        }

        return Control<span class="hljs-comment">;</span>

    }())

    return Control<span class="hljs-comment">;</span>
})
</code></pre><p>Now we have much simplified <strong>Main.js</strong> file:</p>
<pre><code><span class="hljs-built_in">require</span>.config({
    <span class="hljs-attr">paths</span> : {
        <span class="hljs-string">"jquery"</span> : <span class="hljs-string">"jquery-2.1.1"</span>
    }
});

<span class="hljs-built_in">require</span>([ <span class="hljs-string">'jquery'</span>, <span class="hljs-string">'Control'</span> ], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">jq, Control</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;    
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Main called"</span>);

    <span class="hljs-keyword">var</span> control = <span class="hljs-keyword">new</span> Control();
});
</code></pre><p>Run you code and make sure it still works. Be sure that you added Control to the list of Objects you load with require:</p>
<pre><code><span class="hljs-built_in">require</span>([ <span class="hljs-string">'jquery'</span>, <span class="hljs-string">'Control'</span> ], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">jq, Control</span>) </span>{
</code></pre><p>##Create a Factory</p>
<p>The problem now is that the coupling between <strong>Main.js</strong> and <strong>Control.js</strong> is much too intimate. We need a Factory.</p>
<p>Create a file called <strong>Factory.js</strong> that looks like this:</p>
<pre><code><span class="hljs-comment">/**
 * @author Charlie Calvert
 */</span>

define([ <span class="hljs-string">'Control'</span> ], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">Control</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;

    <span class="hljs-keyword">var</span> Factory = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Factory</span>(<span class="hljs-params"></span>) </span>{
        }

        <span class="hljs-comment">// Our factories product is an empty object by default</span>
        Factory.prototype.product = { <span class="hljs-string">'error'</span>: <span class="hljs-string">'The factory created nothing'</span> };

        <span class="hljs-comment">// Create a products</span>
        Factory.prototype.create = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">options</span>) </span>{

            <span class="hljs-keyword">switch</span> (options.productType) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">"Control"</span>:
                <span class="hljs-keyword">this</span>.product = <span class="hljs-keyword">new</span> Control();
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">default</span>:
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Returning default object."</span>);
            }

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.product;

        };

        <span class="hljs-keyword">return</span> Factory;
    }())

    <span class="hljs-keyword">return</span> Factory
});
</code></pre><p>We specify that Control needs to have new called on it by using Pascal case:</p>
<pre><code>define([ <span class="hljs-string">'Control'</span> ], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(Control)</span> </span>{
</code></pre><p>The factory is completely responsible for creating the object. If the object needs to have new called on it, then the factory does that, because it is the Factory&#39;s job to create the object completely:</p>
<pre><code><span class="hljs-keyword">case</span> <span class="hljs-string">"Control"</span>:<span class="hljs-type"></span>
    <span class="hljs-built_in">this</span>.product = <span class="hljs-keyword">new</span> <span class="hljs-type">Control</span>();
    <span class="hljs-keyword">break</span>;
</code></pre><p>By the time we get to the return statement in the factory, we just return the product. We don&#39;t need to call new on it. We decide that kind of thing in the <strong>switch</strong> statement:</p>
<pre><code><span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.product;
</code></pre><p>This is what your factories should look like from here on out, until further notification.</p>
<p>Back in <strong>Main.js</strong> we do, however, have to call new on the Factory itself:</p>
<pre><code><span class="hljs-built_in">require</span>.config({
    <span class="hljs-attr">paths</span> : {
        <span class="hljs-string">"jquery"</span> : <span class="hljs-string">"jquery-2.1.1"</span>
    }
});

<span class="hljs-built_in">require</span>([ <span class="hljs-string">'jquery'</span>, <span class="hljs-string">'Factory'</span> ], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">jq, Factory</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;    
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Main called"</span>);

    <span class="hljs-keyword">var</span> factory = <span class="hljs-keyword">new</span> Factory();
    factory.create({ <span class="hljs-string">'productType'</span>: <span class="hljs-string">'Control'</span>})
});
</code></pre><p>At this stage we can see that we are loading a total of seven files: </p>
<ul>
<li>Our html and css</li>
<li>require and jquery</li>
<li>Main, Factory and Control</li>
</ul>
<p>Here is what they look like in the Chrome developer tools:</p>
<p><img src="http://www.elvenware.com/charlie/books/CloudNotes/Images/Routing05.png" alt="Route05"></p>
<a class="anchor" id="call-into-newpage"></a>
<h2>Call into NewPage</h2>
<p>Let&#39;s add a button to our second page, the one called NewPage.jade:</p>
<pre><code>extends layout

block <span class="hljs-attribute">content</span>
  h1= title
  <span class="hljs-selector-tag">p</span> Welcome to #{title}

  <span class="hljs-selector-tag">h2</span> This is the new page!

  p<span class="hljs-selector-id">#directory</span>

  button<span class="hljs-selector-id">#buttomDirName</span> Get __dirname
</code></pre><p>Define a handler for the new dirName button in Control.js:</p>
<pre><code><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Control</span>(<span class="hljs-params"></span>) </span>{
    $(<span class="hljs-string">"#buttonSayHello"</span>).click(getHello);
    $(<span class="hljs-string">"#buttomDirName"</span>).click(dirName);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dirName</span>(<span class="hljs-params"></span>) </span>{
    alert(<span class="hljs-string">"dirName"</span>);
}
</code></pre><p>Now ask the server for the current directory by adding a route to <strong>NewPage.js</strong>:</p>
<pre><code><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">var</span> router = express.Router();

<span class="hljs-comment">/* GET home page. */</span>
router.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
    response.render(<span class="hljs-string">'NewPage'</span>, {
        <span class="hljs-attr">title</span> : <span class="hljs-string">'Routing New Page'</span>
    });
});

router.get(<span class="hljs-string">'/dirName'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
    response.send({ <span class="hljs-attr">dirName</span> : __dirname });
});

<span class="hljs-built_in">module</span>.exports = router;
</code></pre><p>The express <strong>__dirname</strong> property returns the current directory on the server.</p>
<p>Now call the the new route, being sure that you go through <strong>/NewPage</strong> and not <strong>/</strong>:</p>
<pre><code>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dirName</span>(<span class="hljs-params"></span>) </span>{
        $.getJSON(<span class="hljs-string">'/NewPage/dirName'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">serverResponse</span>) </span>{
            $(<span class="hljs-string">'#directory'</span>).html(serverResponse.dirName);
        }).error = errorHandler;
    }
</code></pre><p>The result looks like this on my Windows machine:</p>
<p><img src="http://www.elvenware.com/charlie/books/CloudNotes/Images/Routing06.png" alt="Route06"></p>
<p>As you can see, my server is set up to run in the <strong>/Temp/Week07RoutingData</strong> folder. Note that we also see the <strong>routes</strong> folder because that is where <strong>NewPage.js</strong> lives.</p>
<p>##Refactor</p>
<p>Our problem now is that Control.js does two or three things, and hence has multiple reasons to change:</p>
<ul>
<li>It calls Hello</li>
<li>It gets a directory</li>
<li>It serves as the main control page for our program.</li>
</ul>
<p>To fix this, we need to refactor our code into three objects in three files:</p>
<ul>
<li>Control.js: run the app</li>
<li>Hello.js: Handle the hello route</li>
<li>Directory: Handle the directory name call</li>
</ul>
<p>Here are the objects. First DirName:</p>
<pre><code>define([ <span class="hljs-string">'jquery'</span> ], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">jq</span>) </span>{

    <span class="hljs-keyword">var</span> DirName = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">DirName</span>(<span class="hljs-params"></span>) </span>{
        }        

        DirName.prototype.getDirName = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            $.getJSON(<span class="hljs-string">'/NewPage/dirName'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">serverResponse</span>) </span>{
                $(<span class="hljs-string">'#directory'</span>).html(serverResponse.dirName);
            }).error = errorHandler;
        }

        <span class="hljs-keyword">return</span> DirName;
    }());

    <span class="hljs-keyword">return</span> DirName;
});
</code></pre><p>And then here is Hello:</p>
<pre><code>define([ <span class="hljs-string">'jquery'</span> ], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">jq</span>) </span>{

    <span class="hljs-keyword">var</span> Hello = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Hello</span>(<span class="hljs-params"></span>) </span>{
        }

        Hello.prototype.getHello = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> nav = <span class="hljs-built_in">window</span>.navigator;
            <span class="hljs-keyword">var</span> browserInfo = {
                <span class="hljs-attr">codeName</span> : nav.appCodeName,
                <span class="hljs-attr">appName</span> : nav.appName,
                <span class="hljs-attr">version</span> : nav.appVersion,
                <span class="hljs-attr">platform</span> : nav.platform,
                <span class="hljs-attr">vendor</span> : nav.vendor,
                <span class="hljs-attr">product</span> : nav.product,
                <span class="hljs-attr">userAgent</span> : nav.userAgent
            };

            $.getJSON(<span class="hljs-string">'/sayHello'</span>, browserInfo, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">helloObject</span>) </span>{
                $(<span class="hljs-string">'#paragraph01'</span>).html(helloObject.result);
                $(<span class="hljs-string">'#paragraph02'</span>).html(helloObject.codeName);
                $(<span class="hljs-string">'#paragraph03'</span>).html(helloObject.version);
                $(<span class="hljs-string">'#paragraph04'</span>).html(helloObject.product);
                $(<span class="hljs-string">'#paragraph05'</span>).html(helloObject.userAgent);
            }).error = errorHandler;
        }

        <span class="hljs-keyword">return</span> Hello;
    }());

    <span class="hljs-keyword">return</span> Hello;
});
</code></pre><p>You can see that they both use <strong>errorHandler</strong>, yet neither defines it. So lets move it into its own Object:</p>
<pre><code>define(<span class="hljs-name">function</span>(<span class="hljs-name">require</span>) {

    var Utilities = {
        errorHandler: function(<span class="hljs-name">fx</span>, status, error) {
            $('#debug01').html(<span class="hljs-name">fx</span>.responseText)<span class="hljs-comment">;</span>
            $('#debug02').html('error' + error)<span class="hljs-comment">;</span>
        }
    }<span class="hljs-comment">;</span>

    return Utilities<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre><p>Now redefine DirName and Hello to use it:</p>
<p>define([ &#39;jquery&#39;, &#39;Utilities&#39; ], function(jq, utilities) {</p>
<pre><code><span class="hljs-keyword">var</span> DirName = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">DirName</span>(<span class="hljs-params"></span>) </span>{
    }        

    DirName.prototype.getDirName = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        $.getJSON(<span class="hljs-string">'/NewPage/dirName'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">serverResponse</span>) </span>{
            $(<span class="hljs-string">'#directory'</span>).html(serverResponse.dirName);
        }).error = utilities.errorHandler;
    }

    <span class="hljs-keyword">return</span> DirName;
}());

<span class="hljs-keyword">return</span> DirName;
</code></pre><p>});</p>
<p>Notice that we are now requiring both jquery and Utilities:</p>
<pre><code>define([ <span class="hljs-string">'jquery'</span>, <span class="hljs-string">'Utilities'</span> ], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(jq, utilities)</span> </span>{
</code></pre><p>Lets put all three of our new classes in a their own directory called Tools:</p>
<pre><code><span class="hljs-built_in">require</span>.config({
    <span class="hljs-attr">paths</span> : {
        <span class="hljs-string">"jquery"</span> : <span class="hljs-string">"jquery-2.1.1"</span>,
        <span class="hljs-string">"Hello"</span>: <span class="hljs-string">"Tools/Hello"</span>,
        <span class="hljs-string">"DirName"</span>: <span class="hljs-string">"Tools/DirName"</span>,
        <span class="hljs-string">"Utilities"</span>: <span class="hljs-string">"Tools/Utilities"</span>
    }
});

<span class="hljs-built_in">require</span>([ <span class="hljs-string">'jquery'</span>, <span class="hljs-string">'Factory'</span> ], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">jq, Factory</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;    
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Main called"</span>);

    <span class="hljs-keyword">var</span> factory = <span class="hljs-keyword">new</span> Factory();
    factory.create({ <span class="hljs-string">'productType'</span>: <span class="hljs-string">'Control'</span>});
});
</code></pre><p>And let&#39;s teach the factory to load them:</p>
<pre><code>define([ <span class="hljs-string">'Control'</span>, <span class="hljs-string">"DirName"</span>, <span class="hljs-string">"Hello"</span> ], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">Control, DirName, Hello</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;

    <span class="hljs-keyword">var</span> Factory = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Factory</span>(<span class="hljs-params"></span>) </span>{
        }

        <span class="hljs-comment">// Our factories product is an empty object by default</span>
        Factory.prototype.product = { <span class="hljs-string">'error'</span>: <span class="hljs-string">'The factory created nothing'</span> };

        <span class="hljs-comment">// Create a products</span>
        Factory.prototype.create = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">options</span>) </span>{

            <span class="hljs-keyword">switch</span> (options.productType) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">"Control"</span>:
                <span class="hljs-keyword">this</span>.product = <span class="hljs-keyword">new</span> Control(<span class="hljs-keyword">this</span>);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">"Hello"</span>:
                <span class="hljs-keyword">this</span>.product = <span class="hljs-keyword">new</span> Hello();
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">"DirName"</span>: 
                <span class="hljs-keyword">this</span>.product = <span class="hljs-keyword">new</span> DirName();
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">default</span>:
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Returning default object."</span>);
            }

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.product;

        };

        <span class="hljs-keyword">return</span> Factory;
    }())

    <span class="hljs-keyword">return</span> Factory;
});
</code></pre><p>Notice that we are now able to create <strong>Control</strong>, <strong>Hello</strong> and <strong>DirName</strong>. Notice also, that we are now passing the factory into the Control:</p>
<p>case &quot;Control&quot;:
    this.product = new Control(this); // Pass in the Factory (that is, pass in this)
    break;</p>
<p>And here is what Control looks like, now that we have our code all nicely factored into separate modules:</p>
<pre><code>define([ <span class="hljs-string">'jquery'</span>, <span class="hljs-string">"Factory"</span>], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">jq</span>) </span>{

    <span class="hljs-keyword">var</span> Control = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">var</span> factory;

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Control</span>(<span class="hljs-params">initFactory</span>) </span>{
            $(<span class="hljs-string">"#buttonSayHello"</span>).click(getHello);            
            $(<span class="hljs-string">"#buttonDirName"</span>).click(dirName);
            factory = initFactory;
        }

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dirName</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> dirName = factory.create({<span class="hljs-attr">productType</span>: <span class="hljs-string">'DirName'</span>});
            dirName.getDirName();
        }

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getHello</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> hello = factory.create({<span class="hljs-attr">productType</span>: <span class="hljs-string">'Hello'</span>});
            hello.getHello();
        }

        <span class="hljs-keyword">return</span> Control;

    }())

    <span class="hljs-keyword">return</span> Control;
});
</code></pre><p><strong>Control</strong> now serves as the cockpit for our program. We control things from here.</p>
<p>Run your program and make sure it still works after refactoring. There is no new functionality, the HTML pages still look the same. The only change is that now the program is well organized.</p>
<p>To understand one of the benefits of our refactoring, open up each of your classes. Notice the small size and simplicity of each of our classes.</p>
<p>##Do It</p>
<p>Now we have the set up done. You now get a chance to show what you have learned. Here is the assignment.</p>
<p>Create three new HTML pages with Jade using the <strong>views</strong> directory:</p>
<ul>
<li>CalculatePage</li>
<li>ConvertPage</li>
<li>PositionPage</li>
</ul>
<p>Create three new routes to go with your pages:</p>
<ul>
<li>CalculatePage</li>
<li>ConvertPage</li>
<li>Positionpage</li>
</ul>
<p>Modify <strong>app.js</strong> appropriately. Modify index.jade to provide a link to your new pages.</p>
<p>Modify the factory to create your new pages. Add links or buttons to index.jade that launch your new pages.</p>
<a class="anchor" id="the-calculatepage"></a>
<h2>The CalculatePage</h2>
<p>Put three buttons on your page called:</p>
<ul>
<li>getNine</li>
<li>add</li>
<li>multiply</li>
</ul>
<p>Place two input controls on your page:</p>
<pre><code>input<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">operanda</span><span class="hljs-params">(<span class="hljs-variable">type</span>='<span class="hljs-variable">text</span>', <span class="hljs-variable">placeholder</span>='<span class="hljs-variable">operanda</span>')</span></span>
input<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">operandb</span><span class="hljs-params">(<span class="hljs-variable">type</span>='<span class="hljs-variable">text</span>', <span class="hljs-variable">placeholder</span>='<span class="hljs-variable">operandb</span>')</span></span>
</code></pre><p>You might want to make them of Type <strong>number</strong> instead. It&#39;s up to you. If you want, you can pre-initialize them to the numbers 3 and 7.</p>
<p>Don&#39;t forget how to get data from an input control:</p>
<pre><code><span class="hljs-attribute">var a</span> = $(<span class="hljs-string">"#operanda"</span>).val();
</code></pre><p>Do the following when the user clicks on the:</p>
<ul>
<li>getNine button: Call a route to /CalculatePage/getNine and return the number nine from the server</li>
<li>add button: Pass in the two numbers entered by the user to the /CalculatePage/add route on the server and return their sum. Display it to the user.</li>
<li>multiply button: Pass in two numbers entered by the user to the /CalculatePage/multiply route on the server and return their product. Display it to the user.</li>
</ul>
<p>Right now we have the pages themselves named with <strong>PascalCase</strong> and the methods are <strong>camelCase</strong>. This may change over the course of the quarter. If your case is different than mine, that is okay, but keep the names the same. And make sure it works!</p>
<a class="anchor" id="the-convert-page"></a>
<h2>The convert page</h2>
<p>Same as above, but only one input control and return from the /ConvertPage server:</p>
<ul>
<li>Feet converted to miles</li>
<li>Hours converted to seconds</li>
<li>Fahrenheit converted to Celsius</li>
</ul>
<p>##Position Page</p>
<p>This one is a bit tricky, as not all browsers support getting position and you have to give permission before you can do it. Even if you can&#39;t get it to work, get your page and files set up as best you can.</p>
<ul>
<li>Take the following code. Put it in a class called <strong>Position.js</strong>.</li>
</ul>
<pre><code>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">showError</span>(<span class="hljs-params">error</span>) </span>{
        alert(<span class="hljs-string">'error: '</span> + error);
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">success</span>(<span class="hljs-params">position</span>) </span>{
        alert(<span class="hljs-string">'success'</span> + <span class="hljs-built_in">JSON</span>.stringify(position));
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">position</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> latlng;

        <span class="hljs-keyword">var</span> waitTime = <span class="hljs-number">3000</span>;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                        <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">position</span>) </span>{
                            success(position);
                        }, showError);
            } <span class="hljs-keyword">else</span> {
                showError(<span class="hljs-string">"NOT-SUPPORTED"</span>);
            }
            <span class="hljs-keyword">var</span> t = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">if</span> ($(<span class="hljs-string">"#getZip div.loading"</span>).css(<span class="hljs-string">"display"</span>) != <span class="hljs-string">"none"</span>) {
                    $(<span class="hljs-string">"#getZip div.loading"</span>).hide();
                    $(<span class="hljs-string">"#errorZip"</span>).show();
                }
            }, waitTime);
        } <span class="hljs-keyword">catch</span> (evt) {
            alert(evt);
        }
    }        
</code></pre><p>When you run this code, your browser should prompt you to ask if you grant permission for Week07RoutingData to access your GPS. </p>
<p>##Turn It In</p>
<p>When you are done, put your code in a folder called <strong>Week08RoutingData</strong>. Make sure you create all objects with the factory. Make sure you are doing the addition, multiplication and conversion on the server. Make sure every route on the server includes a call like this as its first line:</p>
<p>console.log(&quot;Read called&quot;);</p>
<p>Or like this:</p>
<p>console.log(&quot;CalculatePage.add called&quot;);</p>
<p>Include screen shots of:</p>
<ul>
<li>You main page running in a browser</li>
<li>The Hello Page running in a browser</li>
<li>The Add page running in a browser</li>
<li>The command line of the server after you have opened all the pages and clicked all the buttons in your app.</li>
</ul>
<p>This is the midterm, and counts for 33 percent of your grade.</p>
<blockquote>
<p>Written with <a href="https://stackedit.io/">StackEdit</a>.</p>
</blockquote>
</div></body></html>