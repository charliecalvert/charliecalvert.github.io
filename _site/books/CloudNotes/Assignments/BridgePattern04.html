<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width initial-scale=1.0"><title>BridgePattern04</title><link href="/css/first-style.css" rel="stylesheet"><link rel="shortcut icon" href="/images/favicon.png"><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet"><link href="/css/highlight/googlecode.css" rel="stylesheet" type="text/css"><link href="/css/style.css" rel="stylesheet"><script src="https://code.jquery.com/jquery-1.12.0.min.js"></script><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- Latest compiled and minified CSS --><script src="/js/elven-help.js"></script></head><body><nav class="navbar navbar-inverse"><div class="container"><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/">Elvenware</a></div><div class="navbar-collapse collapse" id="navbar"><ul class="nav navbar-nav"><li class="trigger-collapse" ng-class="{ active: isActive('/')}"><a href="/">Home</a></li><li><a href="/about.html">About</a></li></ul></div></div></nav><div class="container"><figure><img class="elf-normal" alt="Elvenware" src="/images/elvenwarelogo.png"/></figure><h1>BridgePattern04</h1><p>Welcome to BridgePattern04</p><ul><!--TOC_Start--><li><a href="#step-02-add-in-require">Step 02: Add in Require</a></li>
<li><a href="#step-03-make-sure-it-works">Step 03: Make sure it works</a></li>
<li><a href="#step-04-add-in-control-">Step 04: Add in Control.</a></li>
<li><a href="#step-05-set-up-tests">Step 05: Set up Tests</a></li>
<li><a href="#step-06-add-in-readers">Step 06: Add in Readers</a></li><!--TOC_End--></ul></div><div class="container"><p>#BridgePattern 04</p>
<p>Primary goals:</p>
<ol>
<li>Run on AWS</li>
<li>Singleton</li>
<li>Session Management</li>
</ol>
<p>Below I step you through the creation of the entire app. You may, however want to start with existing code. There is an argument, I think, for rebuilding from scratch so that you are sure you get the architecture right.</p>
<p>Our theme: Defining responsibilities is the key step in software development. We use objects, modules, patterns and methods to separate the tasks our software performs, and to link these tasks to one another as loosely as possible.</p>
<p>##Step 01: Create a Project</p>
<p>Use express to create the project:</p>
<pre><code>express Week<span class="hljs-number">08</span>BridgePatter<span class="hljs-symbol">n04</span>
</code></pre><p>Add in <strong>.project</strong> file and set the name field to <strong>Week08BridgePattern-LastName</strong>, where last name is your last name.</p>
<pre><code><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-tag">&lt;<span class="hljs-name">projectDescription</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Week08Bridgepattern-Calvert<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
</code></pre><p>Set the project name in <strong>routes/index.js</strong>:</p>
<pre><code>router.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res)</span> </span>{
  res.render(<span class="hljs-string">'index'</span>, { title: <span class="hljs-string">'Week08BridgePattern'</span> });
});
</code></pre><p>Set the port in <strong>bin/www</strong>:</p>
<pre><code>app.set(<span class="hljs-symbol">'port</span>', <span class="hljs-keyword">process</span>.env.<span class="hljs-keyword">PORT</span> || <span class="hljs-number">30025</span>);
</code></pre><a class="anchor" id="step-02-add-in-require"></a>
<h2>Step 02: Add in Require</h2>
<p>Get Main.js, require and jquery:</p>
<pre><code>cd public/javascripts
wget <span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/requirejs.org/docs</span><span class="hljs-regexp">/release/</span><span class="hljs-number">2.1</span>.<span class="hljs-number">11</span>/comments/<span class="hljs-keyword">require</span>.js
wget <span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/code.jquery.com/jquery</span>-<span class="hljs-number">2.1</span>.<span class="hljs-number">1</span>.js
wget <span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/elvenware.com/charlie</span><span class="hljs-regexp">/development/web</span><span class="hljs-regexp">/JavaScript/</span>Scripts/Main.js 
</code></pre><p>Or, if you want to automate the above, create a symbolic link in your <strong>bin</strong> directory to the <a href="https://github.com/charliecalvert/JsObjects/blob/master/Utilities/InstallScripts/RequireJquery.sh">JsObjects RequireJquery.sh</a> script:</p>
<pre><code>ln -s ~<span class="hljs-regexp">/Git/</span>JsObjects<span class="hljs-regexp">/Utilities/</span>InstallScripts<span class="hljs-regexp">/RequireJquery.sh ~/</span>bin<span class="hljs-regexp">/requirejq</span>
</code></pre><p>Then you can just type: requirejq from your <strong>/public/javascripts</strong> folder.</p>
<p>Modify <strong>views/layout.jade</strong>:</p>
<pre><code>doctype html
html
  head
    title= title
    link(<span class="hljs-attribute">rel</span>=<span class="hljs-string">'stylesheet'</span>, <span class="hljs-attribute">href</span>=<span class="hljs-string">'/stylesheets/style.css'</span>)
    script(<span class="hljs-attribute">src</span>=<span class="hljs-string">"javascripts/require.js"</span> <span class="hljs-attribute">data-main</span>=<span class="hljs-string">"javascripts/Main"</span>)
  body
    block content
</code></pre><a class="anchor" id="step-03-make-sure-it-works"></a>
<h2>Step 03: Make sure it works</h2>
<p>Navigate to the root folder for your project and:</p>
<pre><code><span class="hljs-built_in">npm</span> install
<span class="hljs-built_in">npm</span> start
</code></pre><p>Start your browser and navigate to localhost:30025. Check the <strong>Network</strong> page in Chrome or Chromium:</p>
<p><img src="http://www.elvenware.com/charlie/books/CloudNotes/Images/Routing07.png" alt="Routing"></p>
<p>If your view does not look something like this, and particularly if your view shows any red, then something is wrong. The key things to look for, of course, are <strong>jquery</strong>, <strong>require</strong> and <strong>Main.js</strong>.</p>
<p>Summary diagram:</p>
<p><img src="http://www.elvenware.com/charlie/books/CloudNotes/Images/BridgeReader04-01.png" alt="BridgePattern01"></p>
<a class="anchor" id="step-04-add-in-control-"></a>
<h2>Step 04: Add in Control.</h2>
<p>Create a default Control object and add it in:</p>
<pre><code>define(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(require)</span> </span>{

    <span class="hljs-keyword">var</span> Control = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Control</span><span class="hljs-params">()</span> </span>{

        }

        <span class="hljs-keyword">return</span> Control;

    }())

    <span class="hljs-keyword">return</span> Control;
})
</code></pre><p>And in <strong>Main</strong>:</p>
<pre><code><span class="hljs-built_in">require</span>.config({
    <span class="hljs-attr">paths</span> : {
        <span class="hljs-string">"jquery"</span> : <span class="hljs-string">"jquery-2.1.1"</span>
    }
});

<span class="hljs-built_in">require</span>([<span class="hljs-string">'jquery'</span>, <span class="hljs-string">"Control"</span>], 

    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">jq, Control</span>) </span>{
<span class="hljs-meta">        'use strict'</span>;
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Main called"</span>);

        $(<span class="hljs-built_in">document</span>).ready(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> control = <span class="hljs-keyword">new</span> Control();
        });

    }

);
</code></pre><p>Restart your app and check your work and confirm that <strong>Control</strong> is loaded:</p>
<p><img src="http://www.elvenware.com/charlie/books/CloudNotes/Images/Routing08.png" alt="routes"></p>
<p><strong>NOTE</strong>: <em>If you are tired of restarting the server each time you change code on the server side, use <strong>nodemon</strong>. Like this</em>:</p>
<pre><code>sudo npm <span class="hljs-keyword">install</span> -g nodemon
nodemon <span class="hljs-keyword">bin</span>/www
</code></pre><p><em>Notice that youare are typing <strong>nodemon</strong> instead of <strong>node</strong>. Now each time you start you change your server side code your application will be restarted automatically.</em></p>
<p>Summary diagram:</p>
<p><img src="http://www.elvenware.com/charlie/books/CloudNotes/Images/BridgeReader04-02.png" alt="BridgePattern02"></p>
<p>In my loosely defined UML-like syntax, the above diagram shows that <strong>Main</strong> aggregates <strong>Control</strong>. This means that <strong>Main</strong> has a property that points at <strong>Control</strong>:</p>
<pre><code><span class="hljs-keyword">var</span> control = <span class="hljs-keyword">new</span> <span class="hljs-type">Control</span>();
</code></pre><a class="anchor" id="step-05-set-up-tests"></a>
<h2>Step 05: Set up Tests</h2>
<p>Create your <strong>UnitTests</strong> page:</p>
<ul>
<li>routes/UnitTests.js</li>
<li>views/UnitTests.jade</li>
<li>/Tests/MainTest.js</li>
<li>/Tests/jasmine-2.0.0/*</li>
</ul>
<p>Getting the jasmine folder can be tricky. Be sure your case is correct, and that there actually are files in the jasmine folder. Other projects we have used have Jasmine included, so you can just borrow the folder from another project.</p>
<p>In <strong>app.js</strong> add these lines:</p>
<pre><code><span class="hljs-keyword">var</span> unitTests = <span class="hljs-keyword">require</span>(<span class="hljs-string">'./routes/UnitTests'</span>);
app.<span class="hljs-keyword">use</span>(express.<span class="hljs-keyword">static</span>(path.join(__dirname, <span class="hljs-string">'Tests'</span>)));
app.<span class="hljs-keyword">use</span>(<span class="hljs-string">'/UnitTests'</span>, unitTests);
</code></pre><p>The first line above links in (requires) our new /routes/UnitTests.js file. The second line helps express find the Tests directory, and to treat requests for files in that directory as if they were in the root of the project. This means we don&#39;t have to explicitly use the route &#39;/Tests/ when we want to see files that are physically stored in the tests directory. We can serve files from that directory to help us organize our code on the server, but the client can just think of those files as being in the root. The final line of code tells Express to use our UnitTests function, that is, to consider it as a possible route, as a little bit of middleware running on our server. All the code in our Express app is considered middleware. We have client code on the browser, middleware in our Express app, and database code in our MongoDb database. </p>
<p>Here is how to use all three of the statements mentioned above in their proper context:</p>
<pre><code><span class="hljs-keyword">var</span> express = <span class="hljs-keyword">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">var</span> path = <span class="hljs-keyword">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> favicon = <span class="hljs-keyword">require</span>(<span class="hljs-string">'static-favicon'</span>);
<span class="hljs-keyword">var</span> logger = <span class="hljs-keyword">require</span>(<span class="hljs-string">'morgan'</span>);
<span class="hljs-keyword">var</span> cookieParser = <span class="hljs-keyword">require</span>(<span class="hljs-string">'cookie-parser'</span>);
<span class="hljs-keyword">var</span> bodyParser = <span class="hljs-keyword">require</span>(<span class="hljs-string">'body-parser'</span>);

<span class="hljs-keyword">var</span> routes = <span class="hljs-keyword">require</span>(<span class="hljs-string">'./routes/index'</span>);
<span class="hljs-keyword">var</span> unitTests = <span class="hljs-keyword">require</span>(<span class="hljs-string">'./routes/UnitTests'</span>);

<span class="hljs-keyword">var</span> app = express();

<span class="hljs-comment">// view engine setup</span>
app.set(<span class="hljs-string">'views'</span>, path.join(__dirname, <span class="hljs-string">'views'</span>));
app.set(<span class="hljs-string">'view engine'</span>, <span class="hljs-string">'jade'</span>);

app.<span class="hljs-keyword">use</span>(favicon());
app.<span class="hljs-keyword">use</span>(logger(<span class="hljs-string">'dev'</span>));
app.<span class="hljs-keyword">use</span>(bodyParser.json());
app.<span class="hljs-keyword">use</span>(bodyParser.urlencoded());
app.<span class="hljs-keyword">use</span>(cookieParser());
app.<span class="hljs-keyword">use</span>(express.<span class="hljs-keyword">static</span>(path.join(__dirname, <span class="hljs-string">'public'</span>)));
app.<span class="hljs-keyword">use</span>(express.<span class="hljs-keyword">static</span>(path.join(__dirname, <span class="hljs-string">'Tests'</span>)));

app.<span class="hljs-keyword">use</span>(<span class="hljs-string">'/'</span>, routes);
app.<span class="hljs-keyword">use</span>(<span class="hljs-string">'/UnitTests'</span>, unitTests);

<span class="hljs-comment">/// catch 404 and forwarding to error handler</span>
app.<span class="hljs-keyword">use</span>(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res, next)</span> </span>{ 
etc....
</code></pre><p>Then <strong>views/UnitTests.jade</strong>:</p>
<pre><code>doctype html
html
  head
    title= title
    &lt;meta <span class="hljs-attribute">charset</span>=<span class="hljs-string">"utf-8"</span> /&gt;
    link(<span class="hljs-attribute">href</span>=<span class="hljs-string">"jasmine-2.0.0/jasmine.css"</span>, <span class="hljs-attribute">type</span>=<span class="hljs-string">"text/css"</span>, <span class="hljs-attribute">rel</span>=<span class="hljs-string">"stylesheet"</span>)
    script(<span class="hljs-attribute">data-main</span>=<span class="hljs-string">"MainTest"</span> <span class="hljs-attribute">src</span>=<span class="hljs-string">"javascripts/require.js"</span>)
  h1= title
  p Welcome <span class="hljs-keyword">to</span> #{title}
</code></pre><p>And <strong>routes/UnitTest.js</strong>:</p>
<pre><code><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">var</span> router = express.Router();

<span class="hljs-comment">/* GET home page. */</span>
router.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
  res.render(<span class="hljs-string">'UnitTests'</span>, { <span class="hljs-attr">title</span>: <span class="hljs-string">'UnitTests for Bridge04'</span> });
});

<span class="hljs-built_in">module</span>.exports = router;
</code></pre><p>And of course we need to launch our tests from <strong>views/index.jade</strong> by adding a simple hyperlink:</p>
<pre><code>extends layout

<span class="hljs-built_in">block</span> <span class="hljs-built_in">content</span>
  h1= <span class="hljs-built_in">title</span>
  p Welcome to #{<span class="hljs-built_in">title</span>}

  a(href=<span class="hljs-string">"UnitTests"</span>) Unit Tests
</code></pre><p>And we need <strong>Tests/MainTest.js</strong> so that require will know where to find our files. Note that we don&#39;t have to say that a file is in either the public or Tests directory, per the lengthy description of app.use given above:</p>
<pre><code><span class="hljs-built_in">require</span>.config({
    <span class="hljs-attr">baseUrl</span> : <span class="hljs-string">"/"</span>,
    <span class="hljs-attr">paths</span> : {
        <span class="hljs-string">"jquery"</span> : <span class="hljs-string">"javascripts/jquery-2.1.1"</span>,
        <span class="hljs-string">"Control"</span> : <span class="hljs-string">"javascripts/Control"</span>,
        <span class="hljs-string">'jasmine'</span> : <span class="hljs-string">'jasmine-2.0.0/jasmine'</span>,
        <span class="hljs-string">'jasmine-html'</span> : <span class="hljs-string">'jasmine-2.0.0/jasmine-html'</span>,
        <span class="hljs-string">'boot'</span> : <span class="hljs-string">'jasmine-2.0.0/boot'</span>
    },
    <span class="hljs-attr">shim</span> : {
        <span class="hljs-string">'jasmine'</span> : {
            <span class="hljs-attr">exports</span> : <span class="hljs-string">'jasmine'</span>
        },
        <span class="hljs-string">'jasmine-html'</span> : {
            <span class="hljs-attr">deps</span> : [ <span class="hljs-string">'jasmine'</span> ],
            <span class="hljs-attr">exports</span> : <span class="hljs-string">'jasmine'</span>
        },
        <span class="hljs-string">'boot'</span> : {
            <span class="hljs-attr">deps</span> : [ <span class="hljs-string">'jasmine'</span>, <span class="hljs-string">'jasmine-html'</span> ],
            <span class="hljs-attr">exports</span> : <span class="hljs-string">'jasmine'</span>
        }
    }
});

<span class="hljs-built_in">require</span>([ <span class="hljs-string">'boot'</span> ], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">jasmine</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;

    <span class="hljs-built_in">require</span>([ <span class="hljs-string">"jquery"</span>, <span class="hljs-string">"BridgeTests"</span>], 
        <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">jq, BridgeTests</span>) </span>{
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Main called."</span>);
        $(<span class="hljs-string">"p"</span>).hide();
        <span class="hljs-built_in">window</span>.onload();
    });
});
</code></pre><p>And finally we write our Jasmine test of the simple <strong>Control</strong> module. In <strong>Tests/BridgeTests.js</strong> we create a test that confirms that we can create an instance of the <strong>Control</strong> object.:</p>
<pre><code>define([ <span class="hljs-string">"Control"</span>], 
    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">Control</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;

    describe(<span class="hljs-string">"Bridge Tests"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        it(<span class="hljs-string">"proves we can run a test"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            expect(<span class="hljs-literal">true</span>).toBe(<span class="hljs-literal">true</span>);
        });

        it(<span class="hljs-string">"proves we can create Control"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> control = <span class="hljs-keyword">new</span> Control();
            expect(control).toBeTruthy();
        });


    });
});
</code></pre><p> There are actually two tests in the above code: the default &quot;proves we can run a test&quot; code, and then the test that proves we can create a control.</p>
<p>When we run our app and click on the Unit Tests link we see this:</p>
<p><img src="http://www.elvenware.com/charlie/books/CloudNotes/Images/Routing09.png" alt="routes"></p>
<p>Summary diagram:</p>
<p><img src="http://www.elvenware.com/charlie/books/CloudNotes/Images/BridgeReader04-03.png" alt="Unit Tests"></p>
<p>In the diagram above I treat Core and UnitTests as equals. They are both pages that are launched directly from the server via simple route. In one case the route is the root: &#39;/&#39;. In the other it looks like this: &#39;/UnitTests&#39;. See the URL in the image depicting the running UnitTests to see the route in practice: <a href="http://localhost:30025/UnitTests">http://localhost:30025/UnitTests</a>.</p>
<a class="anchor" id="step-06-add-in-readers"></a>
<h2>Step 06: Add in Readers</h2>
<p>The next step will be to add in <strong>Readers</strong>. Let&#39;s begin by creating a test to see if we can create a <strong>JsonReader</strong>:</p>
<pre><code>define([<span class="hljs-string">"Control"</span>, <span class="hljs-string">"JsonReader"</span>], 
    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">Control, JsonReader</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;

    describe(<span class="hljs-string">"Bridge Tests"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        it(<span class="hljs-string">"proves we can run a test"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            expect(<span class="hljs-literal">true</span>).toBe(<span class="hljs-literal">true</span>);
        });

        it(<span class="hljs-string">"proves we can create Control"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> control = <span class="hljs-keyword">new</span> Control();
            expect(control).toBeTruthy();
        });

        it(<span class="hljs-string">"proves we can create a JsonReader"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> jsonReader = <span class="hljs-keyword">new</span> JsonReader();
            expect(jsonReader).toBeTruthy();
        });
    });
});
</code></pre><p>In this code we require a <strong>JsonReader</strong>:</p>
<pre><code>define([<span class="hljs-string">"Control"</span>, <span class="hljs-string">"JsonReader"</span>], 
    <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(Control, JsonReader)</span> </span>{
</code></pre><p>We also write a test to see if we can create one:</p>
<pre><code>it(<span class="hljs-string">"proves we can create a JsonReader"</span>, function() {
    var jsonReader = new JsonReader()<span class="hljs-comment">;</span>
    expect(<span class="hljs-name">jsonReader</span>).toBeTruthy()<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre><p>It goes without saying that this test will fail. </p>
<p><img src="http://www.elvenware.com/charlie/books/CloudNotes/Images/Routing10.png" alt="UnitTests"></p>
<p>To fix the problem, we need to add our JsonReader from our earlier projects to our current project:</p>
<pre><code><span class="hljs-regexp">/public/</span>javascripts<span class="hljs-regexp">/Readers/</span>JsonReader.js
</code></pre><p>Here is the most recent copy of JsonReader:</p>
<pre><code>define([ <span class="hljs-string">'jquery'</span>, <span class="hljs-string">'Utilities'</span>, <span class="hljs-string">'DisplayAddress'</span>, <span class="hljs-string">'DisplayFileList'</span> ], 
        <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">jquery, utilities, DisplayAddress, DisplayFileList</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;

    <span class="hljs-keyword">var</span> JsonReader = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">var</span> that;

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">JsonReader</span>(<span class="hljs-params"></span>) </span>{
            that = <span class="hljs-keyword">this</span>;
        }

        <span class="hljs-keyword">var</span> clear = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            $(<span class="hljs-string">'#displayList'</span>).empty();
        }

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nativeCallback</span>(<span class="hljs-params">fileList</span>) </span>{
            <span class="hljs-keyword">var</span> serverData = fileList;
            that.display(serverData);
        }

        <span class="hljs-comment">// If the customCallback exists, then use it, else use ours nativeCallback. </span>
        <span class="hljs-comment">// If there is an error handler, use it, else use our errorHandler</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getCallback</span>(<span class="hljs-params">customCallback</span>) </span>{
            <span class="hljs-keyword">var</span> callback = utilities.isTruthy(customCallback) ? customCallback : nativeCallback;
            <span class="hljs-keyword">if</span> (utilities.isFalsy(callback.error)) {
                callback.error = utilities.errorHandler;
            }
            <span class="hljs-keyword">return</span> callback;
        }

        JsonReader.prototype.readFile = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fileName, customCallback</span>) </span>{
            <span class="hljs-keyword">var</span> fileObject = { <span class="hljs-string">'fileName'</span> : fileName };
            <span class="hljs-keyword">var</span> callback = getCallback(customCallback);
            $.getJSON(<span class="hljs-string">'/read'</span>, fileObject, callback);
        };

        JsonReader.prototype.display = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">serverData</span>) </span>{
            clear();
            <span class="hljs-keyword">if</span> (serverData.type === <span class="hljs-string">'address'</span>) {
                <span class="hljs-keyword">var</span> displayAddress = <span class="hljs-keyword">new</span> DisplayAddress();
                displayAddress.display(serverData.content);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (serverData.type === <span class="hljs-string">'fileList'</span>) {
                <span class="hljs-keyword">var</span> displayFileList = <span class="hljs-keyword">new</span> DisplayFileList();
                displayFileList.display(serverData.content);
            }
        };

        <span class="hljs-keyword">return</span> JsonReader;
    }());

    <span class="hljs-keyword">return</span> JsonReader;
});
</code></pre><p>We can now add code to <strong>MainTest.js</strong> so that this file can be loaded:</p>
<pre><code><span class="hljs-selector-tag">require</span><span class="hljs-selector-class">.config</span>({
    <span class="hljs-attribute">baseUrl </span>: <span class="hljs-string">"/"</span>,
    paths : {
        <span class="hljs-string">"jquery"</span> : <span class="hljs-string">"javascripts/jquery-2.1.1"</span>,
        <span class="hljs-string">"Control"</span> : <span class="hljs-string">"javascripts/Control"</span>,
        <span class="hljs-string">"JsonReader"</span>: <span class="hljs-string">"javascripts/Readers/JsonReader"</span>,
</code></pre><p>Now let&#39;s run our tests and see what happens:</p>
<p><img src="http://www.elvenware.com/charlie/books/CloudNotes/Images/Routing11.png" alt="Test 11"></p>
<p><a href="http://en.wiktionary.org/wiki/Gott_im_Himmel#German">Gott im himmel</a>! What is to be done! Disaster! As we could plainly see, if we had only looked, <strong>JsonReader</strong> is dependent on three other objects! This will enver do. Our unit tests are meant to test one object at a time. What will we do now?</p>
<p>After our breathing returns to normal, the first step is to assess the damage. Where is the trouble comming from? Well, it is here: at the start of <strong>JsonReader</strong>:</p>
<pre><code>define([ <span class="hljs-string">'jquery'</span>, <span class="hljs-string">'Utilities'</span>, <span class="hljs-string">'DisplayAddress'</span>, <span class="hljs-string">'DisplayFileList'</span> ], 
    <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(jquery, utilities, DisplayAddress, DisplayFileList)</span> </span>{
</code></pre><p>We use require to link in three objects. Before we do too much, let&#39;s look at our code and see where these objects are used. Here is the only use of Utilities:</p>
<pre><code>    <span class="hljs-keyword">function</span> <span class="hljs-title">getCallback</span>(customCallback) {
        var callback = utilities.<span class="hljs-keyword">is</span>Truthy(customCallback) ? customCallback : <span class="hljs-type">nativeCallback</span>;
        <span class="hljs-keyword">if</span> (utilities.isFalsy(callback.error)) {
            callback.error = utilities.errorHandler;
        }
        <span class="hljs-keyword">return</span> callback;
    }
</code></pre><p>You know, perhaps I have lived in a permissive society for too long, but I&#39;m just not very worried about these calls. This is not a heavy dependency, so I&#39;m going to ignore it for now. After all, these are just simple utility functions, and no heavy lifting is involved.</p>
<p>But what about the DisplayObjects, how are they used:</p>
<pre><code>JsonReader.prototype.display = <span class="hljs-function"><span class="hljs-keyword">function</span></span>(serverData) {
    clear();
    <span class="hljs-keyword">if</span> (serverData.type === <span class="hljs-string">'address'</span>) {
        <span class="hljs-keyword">var</span> displayAddress = <span class="hljs-keyword">new</span> <span class="hljs-type">DisplayAddress</span>();
        displayAddress.display(serverData.content);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (serverData.type === <span class="hljs-string">'fileList'</span>) {
        <span class="hljs-keyword">var</span> displayFileList = <span class="hljs-keyword">new</span> <span class="hljs-type">DisplayFileList</span>();
        displayFileList.display(serverData.content);
    }
};
</code></pre><p>Looking at this code again, I can see that it is all wrong. We are asking the JsonReader to decide what <strong>DisplayObject</strong> it should use. That isn&#39;t right. But gosh, its funny to see how clear this becomes when we start writing tests! So let&#39;s just comment this code out for now, and revisit it later.</p>
<pre><code>JsonReader.prototype.display = <span class="hljs-keyword">function</span>(serverData) {
    clear();
    /* <span class="hljs-keyword">if</span> (serverData.<span class="hljs-keyword">type</span> <span class="hljs-type">=== </span><span class="hljs-symbol">'address</span>') {
        var displayAddress = <span class="hljs-keyword">new</span> DisplayAddress();
        displayAddress.display(serverData.content);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (serverData.<span class="hljs-keyword">type</span> <span class="hljs-type">=== </span><span class="hljs-symbol">'fileList</span>') {
        var displayFileList = <span class="hljs-keyword">new</span> DisplayFileList();
        displayFileList.display(serverData.content);
    } */
};
</code></pre><p>Now let&#39;s go back and look at those dependencies again:</p>
<pre><code>define([ <span class="hljs-string">'jquery'</span>, <span class="hljs-string">'Utilities'</span>, <span class="hljs-string">'DisplayAddress'</span>, <span class="hljs-string">'DisplayFileList'</span> ], 
    <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(jquery, utilities, DisplayAddress, DisplayFileList)</span> </span>{
</code></pre><p>Why don&#39;t we just keep <strong>jquery</strong> and <strong>Utilities</strong>, and get rid of the other two for now, since we don&#39;t need them with all their associated code commented out:</p>
<pre><code>define([ <span class="hljs-string">'jquery'</span>, <span class="hljs-string">'Utilities'</span>], 
    <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(jquery, utilities)</span> </span>{
</code></pre><p>Now let&#39;s copy in the <strong>Utilities</strong> object from our previous project. For now, we can put it in <strong>public/javascripts</strong>:</p>
<pre><code>define(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">require</span>) </span>{

    <span class="hljs-keyword">var</span> utilities = {

        <span class="hljs-attr">errorHandler</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fx, status, error</span>) </span>{
            $(<span class="hljs-string">'#debug01'</span>).html(fx.responseText);
            $(<span class="hljs-string">'#debug02'</span>).html(<span class="hljs-string">'error'</span> + error);
        },

        <span class="hljs-attr">isTruthy</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
            <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">false</span>) {
                <span class="hljs-keyword">return</span> value;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'undefined'</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
        },

        <span class="hljs-attr">isFalsy</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.isTruthy(value) ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>;
        },

        <span class="hljs-attr">displayOptions</span>:  <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">options</span>) </span>{
            $(<span class="hljs-string">'#debug01'</span>).html(<span class="hljs-string">"Type: "</span> + options.objectType)
            $(<span class="hljs-string">'#debug02'</span>).html(<span class="hljs-string">"File: "</span> + options.fileName);
        },

        <span class="hljs-attr">setClick</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">func</span>) </span>{
            $(<span class="hljs-string">"#displayList"</span>).off(<span class="hljs-string">'click'</span>);
            $(<span class="hljs-string">"#displayList"</span>).click(func);
        },

        <span class="hljs-attr">setFileName</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">options, event</span>) </span>{
            <span class="hljs-keyword">if</span> (options.useDefaultFile) {
                options.fileName = options.defaultFileName;
            } <span class="hljs-keyword">else</span> {
                options.fileName = event.target.attributes.data.value;
            }            
            options.objectType = options.readers[<span class="hljs-number">0</span>];
            <span class="hljs-keyword">return</span> !options.useDefaultFile;
        }
    }

    <span class="hljs-keyword">return</span> utilities;

});
</code></pre><p>And let&#39;s tell require about <strong>Utilities</strong>:</p>
<pre><code><span class="hljs-selector-tag">require</span><span class="hljs-selector-class">.config</span>({
    <span class="hljs-attribute">baseUrl </span>: <span class="hljs-string">"/"</span>,
    paths : {
        <span class="hljs-string">"jquery"</span> : <span class="hljs-string">"javascripts/jquery-2.1.1"</span>,
        <span class="hljs-string">"Control"</span> : <span class="hljs-string">"javascripts/Control"</span>,
        <span class="hljs-string">"JsonReader"</span>: <span class="hljs-string">"javascripts/Readers/JsonReader"</span>,
        <span class="hljs-string">"Utilities"</span>: <span class="hljs-string">"javascripts/Utilities"</span>,
</code></pre><p>Now what happens when we run our tests?</p>
<p><img src="http://www.elvenware.com/charlie/books/CloudNotes/Images/Routing12.png" alt="Tests"></p>
<p><a href="http://www.collinsdictionary.com/dictionary/english-spanish/miracle">Milagrosamente aprobo el examen</a>! By some miracle we have passed the test! Our hope is but a flickering candle, and yet it still burns! </p>
<p>But what are we going to do about the offending code? How can we fix this mess that we commented out:</p>
<pre><code><span class="hljs-keyword">if</span> (serverData.<span class="hljs-keyword">type</span> <span class="hljs-type">=== </span><span class="hljs-symbol">'address</span>') {
    var displayAddress = <span class="hljs-keyword">new</span> DisplayAddress();
    displayAddress.display(serverData.content);
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (serverData.<span class="hljs-keyword">type</span> <span class="hljs-type">=== </span><span class="hljs-symbol">'fileList</span>') {
    var displayFileList = <span class="hljs-keyword">new</span> DisplayFileList();
    displayFileList.display(serverData.content);
}
</code></pre><p>Here by the dim light of our lamp, it is hard to see clearly.... And yet, there is a shape that emerges from the darkness. It is only dimly perceivable at first, but as we squint into the darkness, a rough shape is faintly visible. What do we see? Smoke? Iron rails? Brick walls? What is it? Could it be -- yes! -- is it possible, the code we have commented out looks so much like something we have seen before! The billowing smoke, the sound of grinding engines....</p>
<p>What do we see? Branching code, and in-between a series of calls to <strong>new</strong>? All at once the smoke seems to clear, the brick walls come clearly into view, the billowing smokestacks of a <strong>Factory</strong> hove into view! </p>
<p>Of course! This code is very much like a <strong>Factory</strong>. And we are, as we well know, supposed to create objects not by calling <strong>new</strong>, but by using a <strong>Factory</strong>! Why didn&#39;t we see this before? What had blinded us? All we can do is be thankful for our unit tests that force us to take stock and actually think!</p>
<p>Summary diagram of tests:</p>
<p><img src="http://www.elvenware.com/charlie/books/CloudNotes/Images/BridgeReader04-04.png" alt="sum"></p>
<p>##Step07: The DisplayFactory</p>
<p>For now we will set aside the code for our <strong>BridgeTests</strong>. Instead, let&#39;s create a test for a <strong>DisplayFactory</strong>. Here is the current state of <strong>MainTest.js</strong>:</p>
<pre><code><span class="hljs-comment">/**
 * @author Charlie Calvert
 */</span>

<span class="hljs-built_in">require</span>.config({
    <span class="hljs-attr">baseUrl</span> : <span class="hljs-string">"/"</span>,
    <span class="hljs-attr">paths</span> : {
        <span class="hljs-string">"jquery"</span> : <span class="hljs-string">"javascripts/jquery-2.1.1"</span>,
        <span class="hljs-string">"Control"</span> : <span class="hljs-string">"javascripts/Control"</span>,
        <span class="hljs-string">"DisplayFactory"</span>: <span class="hljs-string">"javascripts/Factories/DisplayFactory"</span>,
        <span class="hljs-string">"JsonReader"</span>: <span class="hljs-string">"javascripts/Readers/JsonReader"</span>,
        <span class="hljs-string">"Utilities"</span>: <span class="hljs-string">"javascripts/Utilities"</span>,
        <span class="hljs-string">'jasmine'</span> : <span class="hljs-string">'jasmine-2.0.0/jasmine'</span>,
        <span class="hljs-string">'jasmine-html'</span> : <span class="hljs-string">'jasmine-2.0.0/jasmine-html'</span>,
        <span class="hljs-string">'boot'</span> : <span class="hljs-string">'jasmine-2.0.0/boot'</span>
    },
    <span class="hljs-attr">shim</span> : {
        <span class="hljs-string">'jasmine'</span> : {
            <span class="hljs-attr">exports</span> : <span class="hljs-string">'jasmine'</span>
        },
        <span class="hljs-string">'jasmine-html'</span> : {
            <span class="hljs-attr">deps</span> : [ <span class="hljs-string">'jasmine'</span> ],
            <span class="hljs-attr">exports</span> : <span class="hljs-string">'jasmine'</span>
        },
        <span class="hljs-string">'boot'</span> : {
            <span class="hljs-attr">deps</span> : [ <span class="hljs-string">'jasmine'</span>, <span class="hljs-string">'jasmine-html'</span> ],
            <span class="hljs-attr">exports</span> : <span class="hljs-string">'jasmine'</span>
        }
    }
});

<span class="hljs-built_in">require</span>([ <span class="hljs-string">'boot'</span> ], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">jasmine</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;

    <span class="hljs-built_in">require</span>([ <span class="hljs-string">"jquery"</span>, <span class="hljs-string">"BridgeTests"</span>, <span class="hljs-string">"DisplayTests"</span>], 
        <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">jq, BridgeTests</span>) </span>{
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Main called."</span>);
        $(<span class="hljs-string">"p"</span>).hide();
        <span class="hljs-built_in">window</span>.onload();
    });
});
</code></pre><p>You can see the new line that requires the <strong>DisplayFactory</strong> and <strong>DisplayTests</strong> in the code shown above. </p>
<p>In DisplayTests we define a new suite for testing the <strong>DisplayFactory</strong>:</p>
<pre><code>define([<span class="hljs-string">"DisplayFactory"</span>], 
    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">DisplayFactory</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;

    describe(<span class="hljs-string">"Display Tests"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        it(<span class="hljs-string">"proves we can run a test"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            expect(<span class="hljs-literal">true</span>).toBe(<span class="hljs-literal">true</span>);
        });

        it(<span class="hljs-string">"proves we can create a DisplayFactory"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> displayFactory = <span class="hljs-keyword">new</span> DisplayFactory();
            expect(displayFactory).toBeTruthy();
        });

    });
});
</code></pre><p>Wiathout a <strong>DisplayFactory</strong>, these tests fail. So let&#39;s create one:</p>
<pre><code>define(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">require</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;

    <span class="hljs-comment">// Define a SailBoat factory constructor function</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">DisplayFactory</span>(<span class="hljs-params"></span>) </span>{
    }

    DisplayFactory.prototype.product = {};

    <span class="hljs-comment">// Create a Boat with this function</span>
    DisplayFactory.prototype.create = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">options</span>) </span>{        

        <span class="hljs-keyword">switch</span> (options.objectType) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">"fileList"</span>:
            <span class="hljs-keyword">this</span>.product = {};
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">"address"</span>:
            <span class="hljs-keyword">this</span>.product = {};
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">default</span>:
            <span class="hljs-keyword">this</span>.product = {};
        }

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.product;

    };

    <span class="hljs-keyword">return</span> DisplayFactory;
});
</code></pre><p>Let&#39;s run our tests and make sure they work:</p>
<p><img src="http://www.elvenware.com/charlie/books/CloudNotes/Images/Routing13.png" alt="r3"></p>
<p>At this stage, one would be entitled to complain: &quot;Hey, but you aren&#39;t creating real objects! These are just fake DisplayAddress and DisplayFileList objects:</p>
<pre><code>case <span class="hljs-string">"fileList"</span>:
    <span class="hljs-keyword">this</span>.product = {};
    <span class="hljs-keyword">break</span>;
case <span class="hljs-string">"address"</span>:
    <span class="hljs-keyword">this</span>.product = {};
    <span class="hljs-keyword">break</span>;
</code></pre><p>Yes, that is a valid point. And yet, our tests pass! Our goal here is to get our tests to pass. It is not only not necessary to write code that does more than enable our tests to pass, it is a mistake! In agile programming, we always write the minimal amount of code necessary to pass tests, to create working code. What does it say in the <strong>Agile Manifest?</strong> The statement is simple enough:</p>
<p><strong>Working software is the primary measure of progress.</strong></p>
<p>Right now, our software is supposed to pass a test. It works. That is the measure of our progress, not the ability to pass some test that hasn&#39;t even been written yet!</p>
<p>##Step 08: JsonReader Redux</p>
<p>Once again, let&#39;s review the code from <strong>JsonReader</strong> that we commented out:</p>
<pre><code><span class="hljs-keyword">if</span> (serverData.<span class="hljs-keyword">type</span> <span class="hljs-type">=== </span><span class="hljs-symbol">'address</span>') {
    var displayAddress = <span class="hljs-keyword">new</span> DisplayAddress();
    displayAddress.display(serverData.content);
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (serverData.<span class="hljs-keyword">type</span> <span class="hljs-type">=== </span><span class="hljs-symbol">'fileList</span>') {
    var displayFileList = <span class="hljs-keyword">new</span> DisplayFileList();
    displayFileList.display(serverData.content);
}
</code></pre><p>Here is what the display method looks like after we replace the above code with our Factory:</p>
<pre><code>define([ <span class="hljs-string">'jquery'</span>, <span class="hljs-string">'Utilities'</span>, <span class="hljs-string">'DisplayFactory'</span>], 
        <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">jquery, utilities, DisplayFactory</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;

    <span class="hljs-keyword">var</span> JsonReader = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

    <span class="hljs-comment">// Code omitted here, but defined above</span>

    JsonReader.prototype.display = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">serverData</span>) </span>{
        clear();
        <span class="hljs-keyword">var</span> displayFactory = <span class="hljs-keyword">new</span> DisplayFactory();
        <span class="hljs-keyword">var</span> displayObject = displayFactory.create({<span class="hljs-attr">objectType</span>: serverData.type});
        displayObject.display(serverData.content);
    };

        <span class="hljs-keyword">return</span> JsonReader;

    }());

    <span class="hljs-keyword">return</span> JsonReader;
});
</code></pre><p>As you can see, we have created our <strong>DisplayFactory</strong>, then used it to create a <strong>DisplayObject</strong>, then displayed it. After adding this code, if we run our tests, they pass. But this isn&#39;t much of a test. After all, we are doing nothing more than creating a <strong>JsonReader</strong>. What happens if we try to read something with it?</p>
<p>First, let&#39;s copy our FileList.json file into the <strong>public</strong> directory:</p>
<pre><code>{
    <span class="hljs-attr">"type"</span>: <span class="hljs-string">"fileList"</span>,
    <span class="hljs-attr">"content"</span>: {
        <span class="hljs-attr">"President01.json"</span>: <span class="hljs-string">"/home/charlie/Documents/Data/Presidents01.json"</span>,
        <span class="hljs-attr">"President02.json"</span>: <span class="hljs-string">"/home/charlie/Documents/Data/Presidents02.json"</span>,
        <span class="hljs-attr">"President03.json"</span>: <span class="hljs-string">"/home/charlie/Documents/Data/Presidents03.json"</span>,
        <span class="hljs-attr">"President04.json"</span>: <span class="hljs-string">"/home/charlie/Documents/Data/Presidents04.json"</span>
    }
}
</code></pre><p>Now let&#39;s write an asynchronous test and put it in <strong>BridgeTests</strong>:</p>
<pre><code>    it(<span class="hljs-string">"proves we can create a JsonReader and read something"</span>, function(<span class="hljs-name">done</span>) {
        var jsonReader = new JsonReader()<span class="hljs-comment">;</span>
        jsonReader.readFile(<span class="hljs-string">"FileList.json"</span>, function(<span class="hljs-name">dataFromServer</span>) {
            expect(<span class="hljs-name">dataFromServer</span>.content[<span class="hljs-string">"President01.json"</span>]).toBe(<span class="hljs-string">"/home/charlie/Documents/Data/Presidents01.json"</span>)<span class="hljs-comment">;</span>
            done()<span class="hljs-comment">;</span>
        })<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
</code></pre><p>It fails, of course, with a big red Jasmine error and an Obamacare 404 server side error that looks something like this:</p>
<pre><code><span class="hljs-builtin-name">GET</span> /read?<span class="hljs-attribute">fileName</span>=FileList.json 404 47ms - 1.55kb
</code></pre><p>The culprit is a missing <strong>read</strong> route, which we can supply from our previous code, and place in <strong>/routes/index.js</strong>:</p>
<pre><code><span class="hljs-comment">// Code omitted</span>
<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);

<span class="hljs-comment">// Code omitted</span>

router.get(<span class="hljs-string">'/read'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'root read called: '</span> + <span class="hljs-built_in">JSON</span>.stringify(request.query));
    <span class="hljs-keyword">var</span> fileName = request.query.fileName;
    fs.readFile(fileName, <span class="hljs-string">'utf8'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, data</span>) </span>{
        <span class="hljs-keyword">if</span> (error) {
            response.send({ <span class="hljs-string">"Could_Not_Find_File"</span>: error, <span class="hljs-attr">fileName</span>: fileName});
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">var</span> jsonObject = <span class="hljs-built_in">JSON</span>.parse(data);
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Sending error"</span>);
            response.send(jsonObject);
        } <span class="hljs-keyword">catch</span>(e) {            
            response.send({ <span class="hljs-string">"error"</span>: <span class="hljs-string">"Could not parse"</span>, <span class="hljs-string">"Could_Not_Parse_JSON"</span>: <span class="hljs-string">"error"</span>});
        };        
    });

});
</code></pre><p>Now our tests pass:</p>
<p><img src="http://www.elvenware.com/charlie/books/CloudNotes/Images/Routing14.png" alt="JsonReader reads!"></p>
<p>Summary Diagram: </p>
<p><img src="http://www.elvenware.com/charlie/books/CloudNotes/Images/BridgeReader04-05.png" alt="Brider Reader 05"></p>
<p>##Step 09: FastForward with the Observer!</p>
<p>We are now going to rush forward, and plug in all our code from BridgePattern02. The code is complex enough that communication between objects can become tricky. In particular, when a <strong>DisplayObject</strong> finishes refreshing screen, we need to be notified so that we can react to events created when new elements are placed on the screen. In particular, a <strong>DisplayObject</strong> might create a list of items, or other controls. When it does so, we might want to respond to events that occur when the user clicks on a new button or list item. We can&#39;t set up these events until the controls are created, so we have to be notified when the events are created. </p>
<p>This -- of course -- is the classic place where intermediate level programmers go wrong. All their work to ensure loose coupling between objects can collapse when one object suddenly needs to notify another object that something has happened. In that case, most intermediate level developers break down and start hard coding a tightly coupled link between the object that makes the announcement, and the object that wants to hear that the event occurred.</p>
<p>Beware such treachery! For at that moment the Lords of Development will stretch out their hand upon you and leave your code a tangled ruin of error messages!</p>
<p>Fortunately, there is a way for one object to talk to another without requiring that one object have carnal knowledge of another. To the rescue comes a pattern called the Observer Here is Ben Alman&#39;s nice publish subscribe jQuery plugin, which is a variant on the <strong>Observer</strong> pattern:</p>
<pre><code>(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;

    <span class="hljs-keyword">var</span> o = $({});

    $.subscribe = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        o.on.apply(o, <span class="hljs-built_in">arguments</span>);
    };

    $.unsubscribe = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        o.off.apply(o, <span class="hljs-built_in">arguments</span>);
    };

    $.publish = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        o.trigger.apply(o, <span class="hljs-built_in">arguments</span>);
    };

}(jQuery)); 
</code></pre><p>Place this file in the <strong>javascripts</strong> directory as <strong>TinyPubSub.js</strong>. We can use it in the <strong>javascripts/Display/DisplayAddress.js</strong> and <strong>javascripts/Display/DisplayFileList.js</strong> objects which are created by the <strong>DisplayFactory</strong>:</p>
<pre><code>define(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">require</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;

    <span class="hljs-keyword">var</span> DisplayAddress = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">DisplayAddress</span>(<span class="hljs-params"></span>) </span>{

        }

        DisplayAddress.prototype.display = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">serverData</span>) </span>{
            <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> file <span class="hljs-keyword">in</span> serverData) {
                <span class="hljs-keyword">var</span> content = file + <span class="hljs-string">': '</span> + serverData[file];
                <span class="hljs-keyword">var</span> listItem = <span class="hljs-string">'&lt;li data="address"&gt;'</span> + content + <span class="hljs-string">'&lt;/li&gt;'</span>;
                $(<span class="hljs-string">'#displayList'</span>).append(listItem);
            }
            $.publish(<span class="hljs-string">'pageRefresh'</span>, { <span class="hljs-attr">message</span> : <span class="hljs-string">"Refreshed Address"</span> });
        }

        <span class="hljs-keyword">return</span> DisplayAddress;
    }());

    <span class="hljs-keyword">return</span> DisplayAddress;

});
</code></pre><p>The relevant line is this one:</p>
<pre><code><span class="hljs-meta">$</span><span class="bash">.publish(<span class="hljs-string">'pageRefresh'</span>, { message : <span class="hljs-string">"Refreshed Address"</span> });</span>
</code></pre><p>It broadcasts a message to all those who have subscribed, telling them that the page has been refreshed. The same line of code can appear in our <strong>Display/DisplayFileList</strong> object:</p>
<pre><code>define(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">require</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;

    <span class="hljs-keyword">var</span> DisplayFileList = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">DisplayFileList</span>(<span class="hljs-params"></span>) </span>{

        }

        DisplayFileList.prototype.display = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fileList</span>) </span>{
            <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> file <span class="hljs-keyword">in</span> fileList) {
                <span class="hljs-keyword">var</span> dataContent = fileList[file] + <span class="hljs-string">'&gt;'</span> + file;
                dataContent = <span class="hljs-string">'&lt;li class="displayItem" data='</span> + dataContent + <span class="hljs-string">'&lt;/li&gt;'</span>
                $(<span class="hljs-string">'#displayList'</span>).append(dataContent);
            }
            $.publish(<span class="hljs-string">'pageRefresh'</span>, { <span class="hljs-attr">message</span> : <span class="hljs-string">"Refreshed FileList"</span> });
        }

        <span class="hljs-keyword">return</span> DisplayFileList;
    }());

    <span class="hljs-keyword">return</span> DisplayFileList;

});
</code></pre><p>I leave it up to you to modify <strong>DisplayFactory</strong> to create these objects rather than the default empty objects we created before. If these two <strong>DisplayObjects</strong> publish an event, then it seems reasonable that there will be another object that will subscribe to it. In our case, it will be the <strong>Control</strong> object, which we update to look like this:</p>
<pre><code>define([ <span class="hljs-string">"ReaderFactory"</span>, <span class="hljs-string">"BridgeFactory"</span>, <span class="hljs-string">"Utilities"</span> ], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">
        ReaderFactory, BridgeFactory, utilities</span>) </span>{

    <span class="hljs-keyword">var</span> Control = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">var</span> fancyReader = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">var</span> factory = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">var</span> options = {
            <span class="hljs-attr">defaultFileName</span> : <span class="hljs-string">"public/FileList.json"</span>,
            <span class="hljs-attr">useDefaultFile</span> : <span class="hljs-literal">true</span>,
        };
        options.readers = [ <span class="hljs-string">"JsonReader"</span>, <span class="hljs-string">"MarkdownReader"</span> ];
        options.objectType = options.readers[<span class="hljs-number">0</span>];
        options.fileName = options.defaultFileName;

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Control</span>(<span class="hljs-params"></span>) </span>{
            factory = <span class="hljs-keyword">new</span> ReaderFactory();
            fancyReader = <span class="hljs-keyword">new</span> BridgeFactory().create({ <span class="hljs-attr">objectType</span> : <span class="hljs-string">"FancyReaderBridge"</span> });
            $.subscribe(<span class="hljs-string">'pageRefresh'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ $(<span class="hljs-string">"li"</span>).click(run); });
            run();
        }

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">runReader</span>(<span class="hljs-params">options</span>) </span>{
            utilities.displayOptions(options);
            <span class="hljs-keyword">var</span> reader = factory.create(options);
            fancyReader.setReader(reader);
            fancyReader.readFile(options.fileName);
        }

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params">event</span>) </span>{
            options.useDefaultFile = utilities.setFileName(options, event);
            runReader(options);
        }

        <span class="hljs-keyword">return</span> Control;

    }())

    <span class="hljs-keyword">return</span> Control;
})
</code></pre><p>As you can see, whenever a <strong>DisplayOject</strong> updates the display our code sets up an event handler for clicks on the new list items:</p>
<pre><code>$.subscribe(<span class="hljs-string">'pageRefresh'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ $(<span class="hljs-string">"li"</span>).click(run); });
</code></pre><p>The control object finds out what file the user clicked on in the list item, and then it loads that file. It uses the <strong>setFileName</strong> method from the <strong>Utilities</strong> object to switchback to loading the default file (FileList.json) if the user clicks on the display list:</p>
<pre><code>setFileName: function(<span class="hljs-keyword">options</span>, event) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">options</span>.useDefaultFile) {
        <span class="hljs-keyword">options</span>.fileName = <span class="hljs-keyword">options</span>.defaultFileName;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">options</span>.fileName = event.target.attributes.data.value;
    }            
    <span class="hljs-keyword">options</span>.objectType = <span class="hljs-keyword">options</span>.readers[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">return</span> !<span class="hljs-keyword">options</span>.useDefaultFile;
}
</code></pre><p>It will probably prove to be a temporary solution, but it keeps us going for now. Remember. We care about creating working code. We don&#39;t try to plan for all contingencies we imagine might occur!</p>
<p>The main point, of course, is that our program, when reduced to its essence, is run with these four lines of code:</p>
<pre><code><span class="hljs-keyword">options</span>.useDefaultFile = utilities.setFileName(<span class="hljs-keyword">options</span>, event); <span class="hljs-comment">// What file to read?</span>
var reader = factory.create(<span class="hljs-keyword">options</span>);
fancyReader.setReader(reader);
fancyReader.readFile(<span class="hljs-keyword">options</span>.fileName);
</code></pre><p>It&#39;s the fruit of all our work, and its simplicity helps to keep our project maintainable. </p>
<p>You&#39;ve probably seen all this before, but here is the rest of our program. The <strong>javascripts/Factories/ReaderFactory</strong>:</p>
<pre><code>define([ <span class="hljs-string">'DefaultReader'</span>, <span class="hljs-string">'JsonReader'</span>, <span class="hljs-string">"MarkdownReader"</span> ], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">
        DefaultReader, JsonReader, MarkdownReader</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;

    <span class="hljs-keyword">var</span> ReaderFactory = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ReaderFactory</span>(<span class="hljs-params"></span>) </span>{
        }

        ReaderFactory.prototype.product = {};

        ReaderFactory.prototype.create = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">options</span>) </span>{

            <span class="hljs-keyword">switch</span> (options.objectType) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">"JsonReader"</span>:
                <span class="hljs-keyword">this</span>.product = <span class="hljs-keyword">new</span> JsonReader();
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">"MarkdownReader"</span>:
                <span class="hljs-keyword">this</span>.product = <span class="hljs-keyword">new</span> MarkdownReader();
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">"DefaultReader"</span>:
                <span class="hljs-keyword">this</span>.product = <span class="hljs-keyword">new</span> DefaultReader();
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">this</span>.product = {};
            }

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.product;

        };

        <span class="hljs-keyword">return</span> ReaderFactory;

    }());

    <span class="hljs-keyword">return</span> ReaderFactory;
});
</code></pre><p>The <strong>javascripts/Factories/BridgeFactory</strong>:</p>
<pre><code>define([ <span class="hljs-string">'ReaderBridge'</span>, <span class="hljs-string">'FancyReaderBridge'</span> ], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ReaderBridge, FancyReaderBridge</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;

    <span class="hljs-comment">// Define a SailBoat factory constructor function</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BridgeFactory</span>(<span class="hljs-params"></span>) </span>{
    }

    BridgeFactory.prototype.product = {};

    <span class="hljs-comment">// Create a Boat with this function</span>
    BridgeFactory.prototype.create = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">options</span>) </span>{        

        <span class="hljs-keyword">switch</span> (options.objectType) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">"JsonReader"</span>:
            <span class="hljs-keyword">this</span>.product = <span class="hljs-keyword">new</span> ReaderBridge;
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">"FancyReaderBridge"</span>:
            <span class="hljs-keyword">this</span>.product = <span class="hljs-keyword">new</span> FancyReaderBridge()
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">default</span>:
            <span class="hljs-keyword">this</span>.product = {};
        }

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.product;

    };

    <span class="hljs-keyword">return</span> BridgeFactory;
});
</code></pre><p>The <strong>javascripts/Bridges/ReaderBridge</strong>:</p>
<pre><code>define(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">require</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;

    <span class="hljs-keyword">var</span> Readers = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Readers</span>(<span class="hljs-params">reader</span>) </span>{
            <span class="hljs-keyword">this</span>.setReader(reader);
        }

        Readers.prototype.setReader = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">reader</span>) </span>{
            <span class="hljs-keyword">this</span>.reader = reader;
        };

        Readers.prototype.readFile = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fileName, customCallback</span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.reader.readFile(fileName, customCallback);
        };

        Readers.prototype.display = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">serverData</span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.reader.display(serverData);
        };

        <span class="hljs-keyword">return</span> Readers;
    }());

    <span class="hljs-keyword">return</span> Readers;
});
</code></pre><p>And of course the <strong>javascripts/Bridges/FancyReaderBridge</strong>, which does nothing for us at this time:</p>
<pre><code>define([<span class="hljs-string">"ReaderBridge"</span>], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ReaderBridge</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;

<span class="hljs-keyword">var</span> FancyReader = ( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">FancyReader</span>(<span class="hljs-params">reader</span>) </span>{             
            <span class="hljs-keyword">this</span>.setReader(reader);
        }        

        FancyReader.prototype = <span class="hljs-keyword">new</span> ReaderBridge();

        <span class="hljs-keyword">return</span> FancyReader;
    }());

    <span class="hljs-keyword">return</span> FancyReader;

});
</code></pre><p>The <strong>DefaultReader</strong>:</p>
<pre><code>define(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">require</span>) </span>{<span class="hljs-string">'use strict'</span>;

    <span class="hljs-keyword">var</span> DefaultReader = ( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">DefaultReader</span>(<span class="hljs-params"></span>) </span>{

            }


            DefaultReader.prototype.readFile = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">return</span> <span class="hljs-string">"I'm the default reader"</span>;
            };

            DefaultReader.prototype.display = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">var</span> data = <span class="hljs-keyword">this</span>.readFile();
                $(<span class="hljs-string">"#display"</span>).text(data);
            };

            <span class="hljs-keyword">return</span> DefaultReader;
        }());

    <span class="hljs-keyword">return</span> DefaultReader;

}); 
</code></pre><p>And for now, we will use this simple <strong>javascripts/Readers/MarkdownReader</strong>, and wait until Monday to see how to integrate the real reader into our program:</p>
<pre><code>define(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">require</span>) </span>{<span class="hljs-string">'use strict'</span>;

    <span class="hljs-keyword">var</span> MarkdownReader = ( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">MarkdownReader</span>(<span class="hljs-params"></span>) </span>{

            }

            MarkdownReader.prototype.readFile = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">this</span>.display(<span class="hljs-string">"#Title\n- Item01\n- Item02"</span>);                
            };

            MarkdownReader.prototype.display = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{                
                <span class="hljs-keyword">var</span> text = <span class="hljs-built_in">JSON</span>.stringify(data, <span class="hljs-literal">null</span>, <span class="hljs-number">4</span>);
                $(<span class="hljs-string">"#display"</span>).text(text);
            };

            <span class="hljs-keyword">return</span> MarkdownReader;
        }());

    <span class="hljs-keyword">return</span> MarkdownReader;
});
</code></pre><p>I think that is everything except our updated, Main.js file, which you should be able to fix up. The body of it, is unchanged, except that it is a good place to load &#39;PubSub&#39;:</p>
<pre><code><span class="hljs-built_in">require</span>([<span class="hljs-string">'jquery'</span>, <span class="hljs-string">"Control"</span>, <span class="hljs-string">"PubSub"</span>], 

    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">jq, Control, PubSub</span>) </span>{
<span class="hljs-meta">        'use strict'</span>;
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Main called"</span>);

        $(<span class="hljs-built_in">document</span>).ready(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> control = <span class="hljs-keyword">new</span> Control();
        });
    }

);
</code></pre><p>The top part of the file is where you configure require to load: &quot;jquery&quot;, &quot;DefaultReader&quot;, &quot;JsonReader&quot;, &quot;MarkdownReader&quot;, &quot;ReaderFactory&quot;, &quot;BridgeFactory&quot;, &quot;DisplayFactory&quot;, &quot;ReaderBridge&quot;, &quot;FancyReaderBridge&quot;, &quot;DisplayFileList&quot;, &quot;DisplayAddress&quot;, &quot;Utilities&quot;, &quot;Control&quot;, and &quot;PubSub&quot;. </p>
<p>Only Utilities, Control and PubSub are in the javascripts folder. The rest are subdirectories of <strong>javascripts</strong> such as <strong>Bridges</strong>, <strong>Display</strong>, <strong>Factories</strong> and <strong>Readers</strong>.</p>
<p>And the Presidents. <strong>Presidents01.json</strong>:</p>
<pre><code>{
    <span class="hljs-attr">"type"</span>: <span class="hljs-string">"address"</span>,
    <span class="hljs-attr">"content"</span>: {
        <span class="hljs-attr">"firstName"</span>: <span class="hljs-string">"George"</span>,
        <span class="hljs-attr">"lastName"</span>: <span class="hljs-string">"Washington"</span>,
        <span class="hljs-attr">"address"</span>: <span class="hljs-string">"101 June Street"</span>,
        <span class="hljs-attr">"city"</span>: <span class="hljs-string">"Bellevue"</span>,
        <span class="hljs-attr">"state"</span>: <span class="hljs-string">"WA"</span>
    }
}
</code></pre><p><strong>Presidents02.json</strong>:</p>
<pre><code>{
    <span class="hljs-attr">"type"</span>: <span class="hljs-string">"address"</span>,
    <span class="hljs-attr">"content"</span>: {
        <span class="hljs-attr">"firstName"</span>: <span class="hljs-string">"John"</span>,
        <span class="hljs-attr">"lastName"</span>: <span class="hljs-string">"Adams"</span>,
        <span class="hljs-attr">"address"</span>: <span class="hljs-string">"101 June Street"</span>,
        <span class="hljs-attr">"city"</span>: <span class="hljs-string">"Bellevue"</span>,
        <span class="hljs-attr">"state"</span>: <span class="hljs-string">"WA"</span>
    }
}
</code></pre><p><strong>Presidents03.json</strong>:</p>
<pre><code>{
    <span class="hljs-attr">"type"</span>: <span class="hljs-string">"address"</span>,
    <span class="hljs-attr">"content"</span>: {
        <span class="hljs-attr">"firstName"</span>: <span class="hljs-string">"Thomas"</span>,
        <span class="hljs-attr">"lastName"</span>: <span class="hljs-string">"Jefferson"</span>,
        <span class="hljs-attr">"address"</span>: <span class="hljs-string">"101 June Street"</span>,
        <span class="hljs-attr">"city"</span>: <span class="hljs-string">"Bellevue"</span>,
        <span class="hljs-attr">"state"</span>: <span class="hljs-string">"WA"</span>
    }
}
</code></pre><p><strong>Presidents04.json</strong>:</p>
<pre><code>{
    <span class="hljs-attr">"type"</span>: <span class="hljs-string">"address"</span>,
    <span class="hljs-attr">"content"</span>: {
        <span class="hljs-attr">"firstName"</span>: <span class="hljs-string">"James"</span>,
        <span class="hljs-attr">"lastName"</span>: <span class="hljs-string">"Madison"</span>,
        <span class="hljs-attr">"address"</span>: <span class="hljs-string">"101 June Street"</span>,
        <span class="hljs-attr">"city"</span>: <span class="hljs-string">"Bellevue"</span>,
        <span class="hljs-attr">"state"</span>: <span class="hljs-string">"WA"</span>
    }
}
</code></pre><p>##Step 10: Singleton</p>
<p>The purpose of the Singleton pattern is to assure that only one instance of a particular object is created. We will discuss the <strong>Singleton</strong> pattern on Monday. However, you can get started with it now. </p>
<p>Here is the <strong>Singleton</strong> example from the <strong>JavaScript/Design</strong> folder of <strong>JsObjects</strong>:</p>
<pre><code>define(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">var</span> elf = {};

    elf.SingletonModule = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">        'use strict'</span>;

        <span class="hljs-keyword">var</span> _instance = <span class="hljs-literal">null</span>;

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SingletonModule</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">if</span> (_instance === <span class="hljs-literal">null</span>) {
                _instance = <span class="hljs-keyword">this</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> _instance;
            }
        }

        SingletonModule.prototype.publicMethod = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-string">"I'm the SingletonModule.publicMethod."</span>;
        };

        SingletonModule.prototype.display = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
            $(<span class="hljs-string">'#debug01'</span>).append(<span class="hljs-string">'&lt;li&gt;'</span> + value + <span class="hljs-string">'&lt;/li&gt;'</span>);
        };

        <span class="hljs-keyword">return</span> SingletonModule;

    }());

    <span class="hljs-keyword">return</span> elf.SingletonModule;
});
</code></pre><p>As you can see, we declare a variable called <strong>_instance</strong>. When the <strong>constructor</strong> is called, we check if <strong>_instance</strong> is <strong>null</strong>. If it is, then we assume this is the first time the <strong>constructor</strong> has been called. We set <strong>_instance</strong> to <strong>this</strong>. The <strong>constructor</strong> then exits, which means it performs the default task of all constructors, which is to return <strong>this.</strong> If <strong>_instance</strong> is not <strong>null</strong>, we assume an instance of the object has already been created, so we have the constructor return <strong>_instance</strong> and just throw away the new <strong>this</strong> object. The end result is to assure that only one instance of the object can ever be created.</p>
<p>Let&#39;s apply it to the default Reader: </p>
<pre><code>define(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">require</span>) </span>{<span class="hljs-string">'use strict'</span>;

    <span class="hljs-keyword">var</span> DefaultReader = ( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

            <span class="hljs-keyword">var</span> _instance = <span class="hljs-literal">null</span>;

            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">DefaultReader</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">if</span> (_instance === <span class="hljs-literal">null</span>) {
                    _instance = <span class="hljs-keyword">this</span>;
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">return</span> _instance;
                }
            }


            DefaultReader.prototype.readFile = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">return</span> <span class="hljs-string">"I'm the default reader"</span>;
            };

            DefaultReader.prototype.display = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">var</span> data = <span class="hljs-keyword">this</span>.readFile();
                $(<span class="hljs-string">"#display"</span>).text(data);
            };

            <span class="hljs-keyword">return</span> DefaultReader;
        }());

    <span class="hljs-keyword">return</span> DefaultReader;

}); 
</code></pre><p>And here are a suite of tests designed to help us see if it is working. Save it as <strong>/Tests/DefaultSingletonTests.js</strong>:</p>
<pre><code><span class="hljs-comment">/*globals describe:true, it:true, expect:true, define: true */</span>

define([<span class="hljs-string">'DefaultReader'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">DefaultReader</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;

    describe(<span class="hljs-string">"Default Singleton Module Suite"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">var</span> a, b, c, d, f;

        beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            a = <span class="hljs-keyword">new</span> DefaultReader();
            b = <span class="hljs-keyword">new</span> DefaultReader();
            c = <span class="hljs-keyword">new</span> DefaultReader();
            d = <span class="hljs-keyword">new</span> DefaultReader();
            f = [];
        });

        it(<span class="hljs-string">"proves we can run a test"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            expect(<span class="hljs-literal">true</span>).toBe(<span class="hljs-literal">true</span>);
        });

        it(<span class="hljs-string">"proves we can run a sanity check that we expect to fail"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> e = {};
            expect(a === e).toBe(<span class="hljs-literal">false</span>);
        });

        it(<span class="hljs-string">"proves we can create a DefaultReader01"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{        
            expect(a === b).toBe(<span class="hljs-literal">true</span>);
        });

        it(<span class="hljs-string">"proves we can create a DefaultReader02"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            expect(a === c).toBe(<span class="hljs-literal">true</span>);
        });

        it(<span class="hljs-string">"proves we can create a DefaultReader03"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

            expect(a === d).toBe(<span class="hljs-literal">true</span>);
        });

        it(<span class="hljs-string">"proves we can create a DefaultReader04"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            expect(b === c).toBe(<span class="hljs-literal">true</span>);
        });

        it(<span class="hljs-string">"proves we can create a DefaultReader05"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            expect(c === d).toBe(<span class="hljs-literal">true</span>);
        });

        it(<span class="hljs-string">"proves we can run another sanity check"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            expect(a === f).toBe(<span class="hljs-literal">false</span>);
        });

    });

});
</code></pre><p>Integrate this test with all your other tests. Make sure they are working:</p>
<p><img src="http://www.elvenware.com/charlie/books/CloudNotes/Images/Routing15.png" alt="Unit Tests Singleton"></p>
<p>Don&#39;t forget the <strong>JsonReader</strong> now relies on <strong>TinyPubSub</strong> so it will need to be loaded if you want to test that object.</p>
<p>##Step 11: More Tests, more Singletons</p>
<p>Some additional steps you should perform on your own to complete the assignment:</p>
<ul>
<li>Make all the Readers <strong>Singletons</strong>.  </li>
<li>Make <strong>Control</strong> a <strong>Singleton</strong>.</li>
<li>Write Unit Tests like the DefaultSingletonTests for <strong>Control</strong> and the other <strong>Readers</strong>.</li>
<li>Set up <strong>Presidents01.json</strong> etc, and write tests proving that <strong>JsonReader</strong> can read them.</li>
<li>Write tests proving that you can create:<ul>
<li>ReaderBridge</li>
<li>FancyReaderBridge</li>
<li>ReaderFactory</li>
<li>BridgeFactory<ul>
<li>Call <strong>DisplayAddress.display</strong> and <strong>DisplayFileList.display</strong> and write tests proving that they fire an event.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Make sure your main program works. The program should load <strong>FileList.json</strong> when it starts. When you click on a file from <strong>FileList.json</strong> it should load that file on the main page. Click again, and it should go back to displaying <strong>FileList.json</strong>.</p>
<p>##Step 12: Turn it in</p>
<p>Place your work in a folder called <strong>Week09BridgePattern04</strong> and check it in to your repository.</p>
<p>Include a screenshot of your program running its tests.</p>
</div></body></html>