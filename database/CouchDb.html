<!DOCTYPE html><html lang="en" dir="ltr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><title>CouchDb</title><link rel="shortcut icon" href="/charlie/images/favicon.png"><!-- Latest compiled and minified CSS--><link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap.min.css"><!-- Optional theme--><link rel="stylesheet" href="/components/bootstrap/dist/css/bootstrap-theme.min.css"><link href="/libs/css/BootstrapIndex.css" rel="stylesheet" type="text/css"><link href="/css/style.css" rel="stylesheet" type="text/css"><script src="/components/jquery/dist/jquery.js"></script><script src="/components/angular/angular.js"></script><script src="/components/angular-route/angular-route.js"></script><script src="/components/bootstrap/dist/js/bootstrap.min.js"></script><script src="/libs/scripts/elvenware.js" type="text/javascript"></script><script src="/libs/scripts/Control.js"></script></head><body ng-app="elfApp"><div class="navbar navbar-inverse"><div class="container"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target=".navbar-collapse" class="navbar-toggle"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">Elvenware</a></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li class="active"><a href="/index.html">Home</a></li><li><a href="/about">About</a></li><li class="dropdown"><a href="#/" data-toggle="dropdown" class="dropdown-toggle">Dropdown<b class="caret"></b></a><ul class="dropdown-menu"><li class="dropdown-header">Core Code</li><li><a href="/development/index.html">Strongly Typed</a></li><li><a href="/development/web/index.html">Web & Scripts</a></li><li><a href="/development/cloud/index.shtml">Cloud</a></li><li class="divider"></li><li class="dropdown-header">OS and Tools</li><li><a href="/os/index.html">OS</a></li><li><a href="/development/database/index.html">Database</a></li><li><a href="/books/index.html">My Writing</a></li><li class="divider"></li><li class="dropdown-header">Art</li><li><a href="/charlie/Art/index.html">Poems & Photos</a></li><li><a href="/books/reading/index.html">Book Reviews</a></li><li><a href="/spirit/index.html">Spiritual</a></li><li class="divider"></li><li class="dropdown-header">Links</li><li><a href="/charlie/links.html">My Links</a></li><li><a href="http://www.github.com/charliecalvert">GitHub</a></li><li><a href="http://sourceforge.net/projects/elvenware/">Sourceforge</a></li></ul></li></ul></div><!-- /.nav-collapse--></div></div><div class="container"><figure><img alt="Elvenware" src="/charlie/images/elvenwarelogo.png"/></figure><h1>CouchDb</h1><h3>Table of Contents</h3><ul><!--TOC_Start--><li><a href="#couchdb">CouchDb</a></li>
<li><a href="#install">Install</a></li>
<li><a href="#couchdb-for-windows">CouchDb for Windows</a></li>
<li><a href="#couchdb-for-linux">CouchDb for Linux</a></li>
<li><a href="#logging-in-with-http-authentication">Logging in with HTTP Authentication</a></li>
<li><a href="#error-document-update-conflict">Error: Document Update Conflict</a></li>
<li><a href="#design-documents">Design Documents</a></li>
<li><a href="#couchdb-online-resources">CouchDb Online Resources</a></li>
<li><a href="#couchdb-attachments">CouchDb Attachments</a></li>
<li><a href="#sending-back-express-and-nano-errors">Sending Back Express and Nano Errors</a></li>
<li><a href="#erica">Erica</a></li>
<li><a href="#couchapp">CouchApp</a></li>
<li><a href="#install-couchapp">Install CouchApp</a></li>
<li><a href="#couchapp-pages">CouchApp Pages</a></li><!--TOC_End--></ul><h1 id="couchdb">CouchDb</h1>
<p><a href="http://couchdb.apache.org/" title="CouchDb home page">CouchDb</a> is a NoSQL database based on JSON documents rather than records. We do not use SQL to query it. It uses key/value pairs rather than structured relational data. It is a web focused database that we query using HTTP.</p>
<p>This is nothing fundamentally different about the internal structure of a SQL database and a NoSQL database. Underneath, they both consist of B-Trees or similar data structures and a series of indexes. The difference is not in the internals, but in the way that you access the data. In many cases, the data itself is structured differently.</p>
<p>CouchDb is based on JSON. Instead of using structured data with clearly defined sizes for each bit of data that you store, CouchDb simply accepts JSON.</p>
<p>You can, and probably will, define indexes on your JSON data. You can also set up filters so that it is impossible to insert records that do not support a particular structure. For instance, you can set up filters that ensure that you cannot insert a record that does not contain a first name field, etc. You can define a wide variety of filters covering most of your needs.</p>
<p>You can use CouchDb to define <a href="http://wiki.apache.org/couchdb/EntityRelationship">one to many and many to many</a> 
relationships. You use a different syntax than you would use in a relational database, but the it is easy to learn. Creating a unique constraint is more difficult in CouchDb.</p>
<p>A key difference between NoSQL and SQL database can be summed up with the word &quot;relaxed.&quot; When working in CouchDb, you don&#39;t have to obey the strict rules that are built into SQL databases. Sometimes, however, the rules in a relational database are useful. The trick is to choose the right tool for the right job.</p>
<p>CouchDb is a distributed database. This means you can scale up to work with big datasets or heavy demands by simply adding more machines or more processing power. CouchDb can transparently handle scaling across multiple machines, or you can define specifically how it should distribute your data. In most cases, the choice is up to you.</p>
<p>In general, use relational databases if you:</p>
<ul>
<li>Have many complex relationships between entities</li>
<li>Are very focused on creating unique data</li>
<li>Or have tightly structured data</li>
</ul>
<p>On the other hand, use NoSQL if you:</p>
<ul>
<li>Have a relatively simple data structure not focused on creating unique records</li>
<li>Have flexible data that might not follow a particular structure in all cases</li>
<li>Or have the need to work with huge amounts of data that needs to be inserted quickly</li>
</ul>
<p>This does not mean that you can&#39;t use NoSQL data to work with highly structured data, and vice versa. These are simply general guidelines.</p>
<h2 id="install">Install</h2>
<p>There is a Windows and Linux install process. Each has its own quirks,
but neither is difficult. </p>
<h2 id="couchdb-for-windows">CouchDb for Windows</h2>
<p><a href="http://apache.mirrors.pair.com/couchdb/binary/win/1.3.0/setup-couchdb-1.3.0_R15B03-1.exe">http://apache.mirrors.pair.com/couchdb/binary/win/1.3.0/setup-couchdb-1.3.0_R15B03-1.exe</a></p>
<p>CouchDb will probably be installed here:</p>
<p>C:\Program Files (x86)\Apache\CouchDB
C:\Program Files (x86)\Apache Software Foundation\CouchDB</p>
<p>CouchDb runs as a service, so use the Services panel to stop and start
it. You can control Windows services via the control panel:</p>
<pre><code>Control Panel\System and Security\Administrative Tools
</code></pre><p>The configuration file is likely stored here:</p>
<pre><code>C:\Program Files (x86)\Apache\CouchDB\etc\couchdb\default.ini
C:\Program Files (x86)\Apache\CouchDB\etc\couchdb\local.ini
</code></pre><p>Apparently default.ini can be overwritten during an upgrade or install,
so you might want to edit local.ini.</p>
<p>For details, see this, which describes a hierarchy of configuration files:</p>
<pre><code>&lt;http://docs.couchdb.org/en/latest/configuring.html&gt;
</code></pre><p>Ultimately, you will probably have to know how to edit these files, as
your IP address will change as you log into various wireless networks.
Be sure to see up an Admin Account!</p>
<h2 id="couchdb-for-linux">CouchDb for Linux</h2>
<p>For the Linux install:</p>
<pre><code>sudo apt-get install couchdb -y
</code></pre><p>After the install you will probably want to start working off your
server&#39;s IP, rather than off local host. This is especially true if 
you are running Linux on AWS, or running a &quot;headless&quot; (non-GUI) based
installation of Linux.</p>
<p>For help configuring CouchDb on Linux, try running couch-config. The 
linux config file is here:</p>
<pre><code>/etc/couchdb/default.ini
/etc/couchdb/local.ini
</code></pre><p>You can confirm the above by typing:</p>
<pre><code>couch-config --config-dir
</code></pre><p>Remember that local.ini will not be effected if you upgrade.</p>
<p>You want to find the <strong>bind_address</strong> and change it from <strong>localhost</strong>
(127.0.0.1) to the IP address of your server. </p>
<p>On AWS, and possibly on your local Linux server, set the IP to 0.0.0.0 in local.ini:</p>
<pre><code>[httpd]
port = 5984
bind_address = 0.0.0.0
</code></pre><p>The bind address by default is set to localhost (127.0.0.1). That is fine if you only access the database from your current server. But if you want to access it from another machine, you can change it to 0.0.0.0. I have a feeling this might not be very secure, but you should not be using the document as a guide to setting up your release server. I&#39;m just getting you up and running so you can do development in a relatively trusted environment.</p>
<p>Near the bottom of <strong>local.ini</strong> you can set the password for the administrator. The process is much the same as that described above. Look for the section called <strong>[admins]</strong> and set the <strong>admin</strong> password to something appropriate for you. I believe that it looks like this by default:</p>
<pre><code>[admins]
;admin = mysecretpassword
</code></pre><p>Since the semicolon is a comment in these kinds of files, change it to look like this:</p>
<pre><code>[admins]
admin = unbreakable
</code></pre><p>You can use <strong>nano</strong> or <strong>vim</strong> or the editor of your choice to edit the 
<strong>ini</strong> file. If you are trying to run curl on your AWS server to talk to CouchDb
after changing the IP address to 0.0.0.0 then you can just use localhost:</p>
<pre><code>curl http://localhost:5984
</code></pre><p>In your browser, you can use your AWS elastic ip. Don&#39;t forget to go to the EC2 console and open up port 5984
in the security group for your server.</p>
<p>You should probably also turn off the Admin Party in Futon for your AWS server. You are having an &quot;Admin Party&quot; because if you have not yet set up admin password, and thus enable anyone to get at your server. To set up the administrator account, just click on the link in the bottom right hand corner of Futon. Remember, you can reach Futon by appending <strong>_utils</strong> to the URL of your server. That might look something like this:</p>
<pre><code>http://54.XX.XX.XX:5984/_utils
</code></pre><p>Then assign a user name and password. In your server.js files, you will now 
have to use an address like this:</p>
<pre><code>http://username:password@elasticip:5984
</code></pre><p>This is probably not very secure, as I believe your password will be sent 
across the internet as clear text, so I would consider not picking a top 
level password that you use for really important accounts. I think there is 
way to turn on https for couchdb, and I will try to figure that out, as it
provides more security and should hide your password when it is sent.</p>
<p>After you edit the <strong>local.ini</strong> file, you should restart couchdb:</p>
<pre><code>sudo service couchdb stop
sudo service couchdb start
</code></pre><p>Old Method:</p>
<pre><code>sudo /etc/init.d/couchdb stop
sudo /etc/init.d/couchdb start
</code></pre><p>Test your work from the linux command line:</p>
<pre><code>curl http://192.168.2.19:5984/
</code></pre><p>If curl is not available or not your tool of choice, you can try it from a browser. That would probably be the preferred route to take on your Windows machine.</p>
<h2 id="logging-in-with-http-authentication">Logging in with HTTP Authentication</h2>
<p>You can access CouchDb with a library called <strong><a href="https://github.com/dscape/nano">nano</a></strong>. Do not confuse this library with the <strong>nano</strong> editor we use at he Linux command prompt. Here&#39;s how we normally log in with <strong>nano</strong>:</p>
<pre><code>var nano = require(&#39;nano&#39;)(&#39;http://192.168.2.21:5984&#39;);
</code></pre><p>Now let&#39;s log in as an adminstrator named <strong>ccalvert</strong> with an
unbreakable password of <strong>foobar</strong>:</p>
<pre><code>var nano = require(&#39;nano&#39;)(&#39;http://ccalvert:foobar@192.168.2.21:5984&#39;);
</code></pre><h2 id="error-document-update-conflict">Error: Document Update Conflict</h2>
<p>When you first start with CouchDb, you are likely to get &quot;Document 
Update Conflict&quot; errors when you try to insert data. This error 
occurs when you try to do an insert and the document you are trying to
insert already exists. To update the document, you have to add a revision
number to your insert. </p>
<p>Revision numbers (_rev) are clearly visible in Futon when you look at
existing database documents:</p>
<p>_rev: &quot;6-9a046bdac69072ed5075c3addfe015c8&quot;</p>
<p>One way to perform an update is to do this:</p>
<ul>
<li>First perform a Get to see if the document already exists.</li>
<li>If it does exist, get the _rev and then do the insert with the rev</li>
<li>If the document does not exist, do the insert without the rev</li>
</ul>
<p>Here is the code for doing the above. The parameters here are the 
Express response object, the JSON data you want to insert, and the name
you want to give your to document.</p>
<pre><code>var sendToCouch = function(response, data, docName) { 
    var prog = nano.db.use(dbName);
    prog.get(docName, function(error, existing) {
        if(!error) { 
            console.log(&quot;Document exists. Doing Update.&quot;);
            data._rev = existing._rev;
            doInsert(response, data, docName);
        }  else {
            console.log(&quot;Document does not exist. Doing insert.&quot;);
            doInsert(response, data, docName);
        }
    });
}
</code></pre><p>The key line in the above code is this one, where we add the rev to
the document we are inserting if it is an update scenario:</p>
<pre><code>data._rev = existing._rev;
</code></pre><p>Here is the doInsert method:</p>
<pre><code>var doInsert = function(response, data, docName) {&#39;use strict&#39;;
    var prog = nano.db.use(dbName);
    prog.insert(data, docName, function(err, body) {
        console.log(&#39;In sendToCouch callback&#39;);
        if (!err) {
            response.send({
                &quot;Result&quot; : &quot;Success&quot;
            });
            return;
        } else {
            response.send(500, err);
            return;
        }
    });
};
</code></pre><p>For a working example, see <a href="https://github.com/charliecalvert/JsObjects/tree/master/HtmlCssJavascript/UnitTestCouchDb01">UnitTestCouchDb01</a> in JsObjects.</p>
<h2 id="design-documents">Design Documents</h2>
<p>Use <a href="http://guide.couchdb.org/draft/design.html">design documents</a> to keep a list of your views. These are JSON documents tbat begin with an ID of <strong>_design/</strong>:</p>
<pre><code>&quot;id&quot;: &quot;_design/myApp&quot;
</code></pre><p>They contain a series of sections with names like <strong>views</strong>, <strong>shows</strong>, &quot;_attachments&quot;, &quot;lib.&quot; An example is shown here:</p>
<ul>
<li><a href="http://guide.couchdb.org/draft/design.html#figure/1">http://guide.couchdb.org/draft/design.html#figure/1</a></li>
</ul>
<p>You can use <strong>nano</strong> to insert design documents. </p>
<h2 id="couchdb-online-resources">CouchDb Online Resources</h2>
<p>More information:</p>
<ul>
<li><a href="http://couchdb.apache.org/">http://couchdb.apache.org/</a></li>
<li><a href="http://wiki.apache.org/couchdb/">http://wiki.apache.org/couchdb/</a></li>
<li><a href="http://wiki.apache.org/couchdb/Installing_on_Ubuntu">http://wiki.apache.org/couchdb/Installing_on_Ubuntu</a></li>
<li><a href="http://guide.couchdb.org/editions/1/en/index.html">http://guide.couchdb.org/editions/1/en/index.html</a></li>
<li><a href="http://guide.couchdb.org/">http://guide.couchdb.org/</a></li>
<li><a href="http://kkovacs.eu/cassandra-vs-mongodb-vs-couchdb-vs-redis">http://kkovacs.eu/cassandra-vs-mongodb-vs-couchdb-vs-redis</a></li>
</ul>
<p>We will access the database via HTTP and use request:</p>
<p><a href="https://github.com/mikeal/request">https://github.com/mikeal/request</a></p>
<p>Getting started:</p>
<p><a href="http://guide.couchdb.org/draft/tour.html">http://guide.couchdb.org/draft/tour.html</a></p>
<p>Once you have it installed on Windows, use the browser:</p>
<ul>
<li><a href="http://127.0.0.1:5984/">http://127.0.0.1:5984/</a></li>
<li><a href="http://localhost:5984/_utils/">futon</a></li>
</ul>
<p>We want to go to config.html, which is reachable from futon, and set 
allow_jsonp to true. It is in the http section, about half way down the
page:</p>
<p><a href="http://localhost:5984/_utils/config.html">http://localhost:5984/_utils/config.html</a></p>
<h2 id="couchdb-attachments">CouchDb Attachments</h2>
<p>We often want to add attachments such as an HTML document or image file
to our CouchDb database.</p>
<ul>
<li><a href="https://github.com/dscape/nano#attachments-functions">https://github.com/dscape/nano#attachments-functions</a></li>
<li><a href="http://wiki.apache.org/couchdb/HTTP_Document_API#Attachments">http://wiki.apache.org/couchdb/HTTP_Document_API#Attachments</a></li>
</ul>
<pre><code>app.get(&quot;/attachHtml&quot;, function(request, response) {&#39;use strict&#39;;
   console.log(&#39;/attachHtml called&#39;);

   var fs = require(&#39;fs&#39;);

    fs.readFile(__dirname + &#39;/Templates/Basic.html&#39;, function(err, data) {
        if (!err) {
            var prog = nano.db.use(dbName);
            prog.attachment.insert(&#39;basic&#39;, &#39;basic.html&#39;, data, &#39;text/html&#39;,
                function(err1, body) {
                if (!err1) {
                    console.log(body);
                } else {
                    console.log(err1);
                    response.send(500, err1);
                }
            });
        } else {
            console.log(err);
            response.send(500, err);
        }
    }); 
});
</code></pre><h2 id="sending-back-express-and-nano-errors">Sending Back Express and Nano Errors</h2>
<p>Send a 500 (Internal Server Error) HTTP Error code:</p>
<pre><code>    function(err, body) {
        if (!err) {
            console.log(body);
            response.send(body);
        } else {
            var cscMessage = &quot;No such record as: &quot; + request.query.docName +
                &quot;. Use a the Get Doc Names button to find &quot; +
                &quot;the name of an existing document.&quot;
            err.p282special = cscMessage;
            response.send(500, err);
        }
    }
</code></pre><p>All that needs to be done is send the error code as the first parameter
to response.send:</p>
<pre><code>response.send(500, err);
</code></pre><p>Here is more information on HTTP code. As you can see, some are error
codes, some -- such as 200 -- signify success. Your code (and many other
tools) can decide what to do with an HTTP message depending on the 
code that is send with it:</p>
<p>Note also that I am adding a special field onto the error message. This
allows me to send back custom error messages along with any details
generated by the Nano error message system.</p>
<p>One the client side we do this:</p>
<pre><code>    var create = function() {
        $.ajax({
            type : &#39;GET&#39;,
            url : &#39;/create&#39;,
            dataType : &#39;json&#39;,
            success : function(data) {
                showDebug(data.Result);
            },
            error : showNanoError
        });
    };

    var showNanoError = function(request, ajaxOptions, thrownError) {
        var responseText = JSON.parse(request.responseText);
        if (typeof responseText.p282special !== &#39;undefined&#39;) {
            showDebug(responseText.p282special);
        }
        showDebug(responseText.message);
        showError(request, ajaxOptions, thrownError);
    };
</code></pre><p>Notice that I have create a special error handler for this kind of
message. By sending back a 500 HTTP Error Code we ensure that our
error handler will be called. The <strong>showNanoError</strong> has special 
processing for Nano messages, then we pass the whole error onto our
regular Prog282 error handler. As you recall, it looks like this:</p>
<pre><code>    var showError = function(request, ajaxOptions, thrownError) {
        showDebug(&quot;Error occurred: = &quot; + ajaxOptions + &quot; &quot; + thrownError);
        showDebug(request.status);
        showDebug(request.statusText);
        showDebug(request.getAllResponseHeaders());
        showDebug(request.responseText);
    };
</code></pre><p>Clear there are ways to streamline this process, but even if it is 
overkill, it is nonetheless likely to give you good error support during
the development process.</p>
<h2 id="erica">Erica</h2>
<pre><code>&lt;https://github.com/benoitc/erica&gt;
</code></pre><p>Install erica:</p>
<pre><code>git clone git://github.com/benoitc/erica.git
sudo apt-get install erlang
</code></pre><p>Or, if you want to get into erlang, do this:</p>
<pre><code>sudo apt-get install erlang erlang-doc
</code></pre><p>Then create something</p>
<pre><code>erica create-webapp
cd myapp
erica push http://192.168.2.18:5984/myapp
</code></pre><p>Create an app called bar:</p>
<pre><code>erica create-webapp appid=bar
cd bar
erica push http://192.168.2.18:5984/bar
</code></pre><p>A script to install Erica on Linux.</p>
<pre><code>#!/bin/sh

sudo apt-get install erlang

GIT_DIR=~/git
ERICA_DIR=$GIT_DIR/erica

if [ ! -d &quot;$GIT_DIR&quot; ]; then
    /bin/mkdir $GIT_DIR
fi

if [ ! -d &quot;$ERICA_DIR&quot; ]; then
    cd $GIT_DIR
    git clone git://github.com/benoitc/erica.git
    cd erica
    make
    sudo make install
fi

# build an app
WORK_DIR=~/dev
APP_DIR=$WORK_DIR/goober1

if [ ! -d &quot;$WORK_DIR&quot; ]; then
    /bin/mkdir $WORK_DIR
fi

cd $WORK_DIR
if [ ! -d &quot;$APP_DIR&quot; ]; then
    mkdir $APP_DIR
    pwd
    cd $APP_DIR
    pwd
    erica create-webapp
    cd myapp
    erica push http://127.0.0.1:5984/myapp
fi
</code></pre><h2 id="couchapp">CouchApp</h2>
<p>To install on Linux:</p>
<pre><code>sudo apt-get install couchdb -y
</code></pre><p>Or, if you want to try the node version:</p>
<pre><code>npm install -g couchapp
</code></pre><ul>
<li><a href="http://couchapp.org/page/index">http://couchapp.org/page/index</a></li>
<li><a href="http://couchapp.org/page/getting-started">http://couchapp.org/page/getting-started</a></li>
<li><a href="http://garden20.com/">http://garden20.com/</a></li>
</ul>
<h3 id="install-couchapp">Install CouchApp</h3>
<p>Here is how to install CouchApp for use with <strong>Node:</strong></p>
<pre><code>npm install -g couchapp
</code></pre><p>To install couchapp without Node: </p>
<ul>
<li><a href="http://sourceforge.net/projects/pywin32/">http://sourceforge.net/projects/pywin32/</a></li>
<li><a href="https://github.com/couchapp/couchapp/downloads">https://github.com/couchapp/couchapp/downloads</a></li>
</ul>
<p>When you are done, make sure couchapp.bat or couchapp.exe is on your path. If you installed
via Python (rather than the totally stand alone option), this might mean
you do add something like this to your path</p>
<pre><code>c:\Python27\Scripts
</code></pre><p>It will be the scripts directory that holds you couchapp.bat file.</p>
<h2 id="couchapp-pages">CouchApp Pages</h2>
<p><a href="http://couchapp.org/page/pages-install">http://couchapp.org/page/pages-install</a>
<a href="https://github.com/couchapp/couchapp">https://github.com/couchapp/couchapp</a></p>
<p>ez_setup.py
distribute_setup.py
set VS90COMNTOOLS=%VS110COMNTOOLS%
python-2.7.5.msi
pywin32-218.win32-py2.7.exe
py2exe-0.6.9.win32-py2.7.exe</p>
<p>couchapp init<br>couchapp push . <a href="http://localhost:5984/pages">http://localhost:5984/pages</a></p>
</div></body></html>